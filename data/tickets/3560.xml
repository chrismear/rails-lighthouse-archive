<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">8406</assigned-user-id>
  <attachments-count type="integer">3</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2009-12-11T02:35:50+00:00</created-at>
  <creator-id type="integer">78726</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">3560</number>
  <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>resolved</state>
  <tag>accepts_nested_attributes_for active_record locking optimistic patch touch</tag>
  <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
  <updated-at type="datetime">2010-01-07T15:18:04+00:00</updated-at>
  <user-id type="integer">8406</user-id>
  <version type="integer">17</version>
  <user-name>Eloy Duran</user-name>
  <creator-name>tankwanghow</creator-name>
  <assigned-user-name>Eloy Duran</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
  <priority-name>Low</priority-name>
  <original-body>I have the following models, I have optimistic locking ON using( adding lock_version to Invoice model)  :-

@@@ ruby
class Invoice &lt; ActiveRecord::Base
  has_many :line_items
  accepts_nested_attributes_for :line_items
end

class LineItem &lt; ActiveRecord::Base
  belongs_to :invoice, :touch =&gt; true
end
@@@

And I am using a multiple-models form, with javascript to add or remove LineItem (base on http://github.com/ryanb/complex-form-examples)

Without :touch =&gt; true, the code work fine.
With :touch =&gt; true, I can add one LineItem with more than one LineItem, ActiveRecord::StaleObjectError will be raise

After looking at the log file, I found out the the lock_version was being updated multiple times.

Is there a way to touch the parent model once ??</original-body>
  <latest-body>I have the following models, I have optimistic locking ON using( adding lock_version to Invoice model)  :-

@@@ ruby
class Invoice &lt; ActiveRecord::Base
  has_many :line_items
  accepts_nested_attributes_for :line_items
end

class LineItem &lt; ActiveRecord::Base
  belongs_to :invoice, :touch =&gt; true
end
@@@

And I am using a multiple-models form, with javascript to add or remove LineItem (base on http://github.com/ryanb/complex-form-examples)

Without :touch =&gt; true, the code work fine.
With :touch =&gt; true, I can add one LineItem with more than one LineItem, ActiveRecord::StaleObjectError will be raise

After looking at the log file, I found out the the lock_version was being updated multiple times.

Is there a way to touch the parent model once ??</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;I have the following models, I have optimistic locking ON using(
adding lock_version to Invoice model) :-&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;class Invoice &amp;lt; ActiveRecord::Base
  has_many :line_items
  accepts_nested_attributes_for :line_items
end

class LineItem &amp;lt; ActiveRecord::Base
  belongs_to :invoice, :touch =&amp;gt; true
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;And I am using a multiple-models form, with javascript to add or
remove LineItem (base on &lt;a href=
&quot;http://github.com/ryanb/complex-form-examples&quot;&gt;http://github.com/ryanb/complex-form-examples&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;Without :touch =&amp;gt; true, the code work fine.&lt;br&gt;
With :touch =&amp;gt; true, I can add one LineItem with more than one
LineItem, ActiveRecord::StaleObjectError will be raise&lt;/p&gt;
&lt;p&gt;After looking at the log file, I found out the the lock_version
was being updated multiple times.&lt;/p&gt;
&lt;p&gt;Is there a way to touch the parent model once ??&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I have the following models, I have optimistic locking ON using( adding lock_version to Invoice model)  :-

@@@ ruby
class Invoice &lt; ActiveRecord::Base
  has_many :line_items
  accepts_nested_attributes_for :line_items
end

class LineItem &lt; ActiveRecord::Base
  belongs_to :invoice, :touch =&gt; true
end
@@@

And I am using a multiple-models form, with javascript to add or remove LineItem (base on http://github.com/ryanb/complex-form-examples)

Without :touch =&gt; true, the code work fine.
With :touch =&gt; true, I can add one LineItem with more than one LineItem, ActiveRecord::StaleObjectError will be raise

After looking at the log file, I found out the the lock_version was being updated multiple times.

Is there a way to touch the parent model once ??</body>
      <body-html>&lt;div&gt;&lt;p&gt;I have the following models, I have optimistic locking ON using(
adding lock_version to Invoice model) :-&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;class Invoice &amp;lt; ActiveRecord::Base
  has_many :line_items
  accepts_nested_attributes_for :line_items
end

class LineItem &amp;lt; ActiveRecord::Base
  belongs_to :invoice, :touch =&amp;gt; true
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;And I am using a multiple-models form, with javascript to add or
remove LineItem (base on &lt;a href=
&quot;http://github.com/ryanb/complex-form-examples&quot;&gt;http://github.com/ryanb/complex-form-examples&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;Without :touch =&amp;gt; true, the code work fine.&lt;br&gt;
With :touch =&amp;gt; true, I can add one LineItem with more than one
LineItem, ActiveRecord::StaleObjectError will be raise&lt;/p&gt;
&lt;p&gt;After looking at the log file, I found out the the lock_version
was being updated multiple times.&lt;/p&gt;
&lt;p&gt;Is there a way to touch the parent model once ??&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-11T02:35:50+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>accepts_nested_attributes_for active_record touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2009-12-28T17:22:01+00:00</updated-at>
      <user-id type="integer">78726</user-id>
      <version type="integer">1</version>
      <user-name>tankwanghow</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Sorry about the formatting, this is better.

@@@ ruby
class Invoice &lt; ActiveRecord::Base
  has_many :line_items 
  accepts_nested_attributes_for :line_items 
end

class LineItem &lt; ActiveRecord::Base
  belongs_to :invoice, :touch =&gt; true 
end
@@@

I have found a solution from UVSoft plugins :-

  http://github.com/UVSoft/improved_touch
  http://github.com/UVSoft/touching_nested_attributes

I found this plugin is very useful, can these plugins be made it to the rails core?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Sorry about the formatting, this is better.&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;class Invoice &amp;lt; ActiveRecord::Base
  has_many :line_items 
  accepts_nested_attributes_for :line_items 
end

class LineItem &amp;lt; ActiveRecord::Base
  belongs_to :invoice, :touch =&amp;gt; true 
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;I have found a solution from UVSoft plugins :-&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;http://github.com/UVSoft/improved_touch&quot;&gt;http://github.com/UVSoft/improved_touch&lt;/a&gt;
&lt;a href=
&quot;http://github.com/UVSoft/touching_nested_attributes&quot;&gt;http://github.com/UVSoft/touching_nested_attributes&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;I found this plugin is very useful, can these plugins be made it
to the rails core?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-11T02:54:03+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>accepts_nested_attributes_for active_record touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2009-12-11T02:54:08+00:00</updated-at>
      <user-id type="integer">78726</user-id>
      <version type="integer">2</version>
      <user-name>tankwanghow</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Here is my patch. This is also useful for fragment caching with cach-keys based on timestamps (&lt;% cache @record do %&gt; &lt;% end %&gt;). When fragments include information not only about the record itself, but also about its association, and when you update nested attributes without updating record, the fragments do not expire, but they should. This patch touch the record without saving when nested attributes are being changed.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Here is my patch. This is also useful for fragment caching with
cach-keys based on timestamps (&amp;lt;% cache @record do %&amp;gt; &amp;lt;%
end %&amp;gt;). When fragments include information not only about the
record itself, but also about its association, and when you update
nested attributes without updating record, the fragments do not
expire, but they should. This patch touch the record without saving
when nested attributes are being changed.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-11T08:17:57+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>accepts_nested_attributes_for active_record touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2009-12-11T08:18:02+00:00</updated-at>
      <user-id type="integer">34795</user-id>
      <version type="integer">3</version>
      <user-name>Ivan Ukhov</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Seems valid, however, you patch is lacking test coverage. Could you please add tests to the patch?

Also, it seems by glancing over the patch that this would _always_ touch the parent, whereas I'd expect that to only happen if `:touch =&gt; true' was set on the parent. Or did I misinterpret the code?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Seems valid, however, you patch is lacking test coverage. Could
you please add tests to the patch?&lt;/p&gt;
&lt;p&gt;Also, it seems by glancing over the patch that this would
&lt;em&gt;always&lt;/em&gt; touch the parent, whereas I'd expect that to only
happen if &lt;code&gt;:touch =&amp;gt; true' was set on the parent. Or did I
misinterpret the code?&lt;/code&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-11T10:21:17+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>accepts_nested_attributes_for active_record touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2009-12-11T10:21:19+00:00</updated-at>
      <user-id type="integer">8406</user-id>
      <version type="integer">4</version>
      <user-name>Eloy Duran</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Yes, the patch really touches always. In my case I don't use :touch =&gt; true at all, that's why I haven't implement this option. And about testing, to my shame, I dont know how to do it.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Yes, the patch really touches always. In my case I don't use
:touch =&amp;gt; true at all, that's why I haven't implement this
option. And about testing, to my shame, I dont know how to do
it.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-11T20:53:54+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>accepts_nested_attributes_for active_record touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2009-12-11T20:53:58+00:00</updated-at>
      <user-id type="integer">34795</user-id>
      <version type="integer">5</version>
      <user-name>Ivan Ukhov</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Using UVSoft timestamp.rb patch, I have added a feature in accepts_nested_attributes_for method in nested_attribute.rb, which will add an attr_accessor :_silent to the association model. Then added check condition in associations.rb in add_touch_callbacks method to check for _silent attribute is true, then the touch callback will execute the update_timestamp method in timestamp.rb, Yes touch will be call multiple time, with :_silent =&gt; true, save! will not  be call, thus solved the ActiveRecord::StaleObjectError

In the view files, just add a hidden field named :_silent

@@@ruby
  object.hidden_field :_silent, :value =&gt; true
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;Using UVSoft timestamp.rb patch, I have added a feature in
accepts_nested_attributes_for method in nested_attribute.rb, which
will add an attr_accessor :&lt;em&gt;silent to the association model.
Then added check condition in associations.rb in
add_touch_callbacks method to check for&lt;/em&gt; silent attribute is
true, then the touch callback will execute the update_timestamp
method in timestamp.rb, Yes touch will be call multiple time, with
:_silent =&amp;gt; true, save! will not be call, thus solved the
ActiveRecord::StaleObjectError&lt;/p&gt;
&lt;p&gt;In the view files, just add a hidden field named :_silent&lt;/p&gt;
&lt;p&gt;@@@ruby object.hidden_field :_silent, :value =&amp;gt; true&lt;/p&gt;
&lt;pre&gt;

&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-12T18:25:40+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>accepts_nested_attributes_for active_record touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2009-12-12T18:25:44+00:00</updated-at>
      <user-id type="integer">78726</user-id>
      <version type="integer">6</version>
      <user-name>tankwanghow</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>the belongs_to :invoice, :touch =&gt; true can still be use.</body>
      <body-html>&lt;div&gt;&lt;p&gt;the belongs_to :invoice, :touch =&amp;gt; true can still be use.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-12T18:28:17+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>accepts_nested_attributes_for active_record touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2009-12-12T18:28:20+00:00</updated-at>
      <user-id type="integer">78726</user-id>
      <version type="integer">7</version>
      <user-name>tankwanghow</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>##Sorry, I have submitted the wrong patch.##

###This is the correct one.###

Please Review, I think this feature is very useful for optimistic locking in nested_attributes and javascript style of multiple-models form.

If you are already using accepts_nested_attributes_for like the following :-

@@@ ruby
class Invoice &lt; ActiveRecord::Base
  has_many :line_items 
  accepts_nested_attributes_for :line_items 
end

class LineItem &lt; ActiveRecord::Base
  belongs_to :invoice, :touch =&gt; true 
end
@@@

No code need to be change in the model or the controller.

In your view just add a 
@@@ ruby
hidden_field :_silent_touch, :value =&gt; true
@@@
to your nested_attribute (ie. LineItem view)

Then optimistic locking will work on nested attributes form.

###I am not good in writing test-unit can anyone help!!!###

Thank You,</body>
      <body-html>&lt;div&gt;&lt;h2&gt;Sorry, I have submitted the wrong patch.&lt;/h2&gt;
&lt;h3&gt;This is the correct one.&lt;/h3&gt;
&lt;p&gt;Please Review, I think this feature is very useful for
optimistic locking in nested_attributes and javascript style of
multiple-models form.&lt;/p&gt;
&lt;p&gt;If you are already using accepts_nested_attributes_for like the
following :-&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;class Invoice &amp;lt; ActiveRecord::Base
  has_many :line_items 
  accepts_nested_attributes_for :line_items 
end

class LineItem &amp;lt; ActiveRecord::Base
  belongs_to :invoice, :touch =&amp;gt; true 
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;No code need to be change in the model or the controller.&lt;/p&gt;
&lt;p&gt;In your view just add a&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;hidden_field :_silent_touch, :value =&amp;gt; true&lt;/code&gt;
&lt;/pre&gt;
to your nested_attribute (ie. LineItem view)
&lt;p&gt;Then optimistic locking will work on nested attributes form.&lt;/p&gt;
&lt;h3&gt;I am not good in writing test-unit can anyone help!!!&lt;/h3&gt;
&lt;p&gt;Thank You,&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-13T07:11:57+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>accepts_nested_attributes_for active_record touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2009-12-13T07:12:06+00:00</updated-at>
      <user-id type="integer">78726</user-id>
      <version type="integer">8</version>
      <user-name>tankwanghow</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-13T07:16:11+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: accepts_nested_attributes_for active_record touch
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>accepts_nested_attributes_for active_record locking optimistic touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2009-12-13T07:16:13+00:00</updated-at>
      <user-id type="integer">78726</user-id>
      <version type="integer">9</version>
      <user-name>tankwanghow</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>It would be great if you could extract a small applications showing the problem and your solution. Then I'll be able to write the appropriate test coverage and judge the patch.</body>
      <body-html>&lt;div&gt;&lt;p&gt;It would be great if you could extract a small applications
showing the problem and your solution. Then I'll be able to write
the appropriate test coverage and judge the patch.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-28T17:31:42+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>accepts_nested_attributes_for active_record locking optimistic touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2009-12-28T17:31:42+00:00</updated-at>
      <user-id type="integer">8406</user-id>
      <version type="integer">10</version>
      <user-name>Eloy Duran</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Thank for your concern on my problem.

Here is the two rails application **opt_lock_nest_problem.tar.gz** and **opt_lock_nest_solution.tar.gz**

In order for the solution to work, you have to add the **nested_attributes_silent_touch** patch.

But I am still having problem with lock_version, in my last two spec.

Please review and advise.

Thank you</body>
      <body-html>&lt;div&gt;&lt;p&gt;Thank for your concern on my problem.&lt;/p&gt;
&lt;p&gt;Here is the two rails application
&lt;strong&gt;opt_lock_nest_problem.tar.gz&lt;/strong&gt; and
&lt;strong&gt;opt_lock_nest_solution.tar.gz&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In order for the solution to work, you have to add the
&lt;strong&gt;nested_attributes_silent_touch&lt;/strong&gt; patch.&lt;/p&gt;
&lt;p&gt;But I am still having problem with lock_version, in my last two
spec.&lt;/p&gt;
&lt;p&gt;Please review and advise.&lt;/p&gt;
&lt;p&gt;Thank you&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-02T02:29:12+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>accepts_nested_attributes_for active_record locking optimistic touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2010-01-02T02:29:15+00:00</updated-at>
      <user-id type="integer">78726</user-id>
      <version type="integer">11</version>
      <user-name>tankwanghow</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>I have found a problem with my patch, let me fix the bug and I will send a new patch.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I have found a problem with my patch, let me fix the bug and I
will send a new patch.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-02T06:50:01+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>accepts_nested_attributes_for active_record locking optimistic touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2010-01-02T06:50:03+00:00</updated-at>
      <user-id type="integer">78726</user-id>
      <version type="integer">12</version>
      <user-name>tankwanghow</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Thanks for the update. I'll await your new patch.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Thanks for the update. I'll await your new patch.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-02T13:26:57+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>accepts_nested_attributes_for active_record locking optimistic touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2010-01-02T13:26:58+00:00</updated-at>
      <user-id type="integer">8406</user-id>
      <version type="integer">13</version>
      <user-name>Eloy Duran</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Sorry for the delay, hopefully this time, I get it right...

Sample application **opt_lock_nest.zip** and the patch **fix_nested_opt_lock.diff**

Run the project_spec.rb before the patch -&gt; *all specs fail*
After the patch, run the spec again -&gt; *all specs pass*

Thank you</body>
      <body-html>&lt;div&gt;&lt;p&gt;Sorry for the delay, hopefully this time, I get it right...&lt;/p&gt;
&lt;p&gt;Sample application &lt;strong&gt;opt_lock_nest.zip&lt;/strong&gt; and the
patch &lt;strong&gt;fix_nested_opt_lock.diff&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Run the project_spec.rb before the patch -&amp;gt; &lt;em&gt;all specs
fail&lt;/em&gt;&lt;br&gt;
After the patch, run the spec again -&amp;gt; &lt;em&gt;all specs
pass&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Thank you&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-03T06:09:26+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: accepts_nested_attributes_for active_record locking optimistic touch
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>accepts_nested_attributes_for active_record locking optimistic patch touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2010-01-03T06:09:28+00:00</updated-at>
      <user-id type="integer">78726</user-id>
      <version type="integer">14</version>
      <user-name>tankwanghow</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>Thanks for the application. I;ve ran it against 2.3.5 and see the StaleObjectError's. However, if I run it against the current 2-3-stable branch, I don't get these errors. The specs still fail though, but it's because the lock_version doesn't match the expected versions.

The output I get:

@@@
% spec spec/models/project_spec.rb
FFFF

1)
'Project when save with nested attributes should not have STALE object error and :lock_version should be 0' FAILED
expected: 0,
     got: 3 (using ==)
./spec/models/project_spec.rb:15:

2)
'Project when save with nested attributes should not have STALE object error and :lock_version should be 7' FAILED
expected: 7,
     got: 8 (using ==)
./spec/models/project_spec.rb:38:

3)
'Project when save with nested attributes should not have STALE object error and :lock_version should be 0' FAILED
expected: 0,
     got: 2 (using ==)
./spec/models/project_spec.rb:48:

4)
'Project when save with nested attributes should not have STALE object error and :lock_version should be 4' FAILED
expected: 4,
     got: 5 (using ==)
./spec/models/project_spec.rb:66:

Finished in 0.332062 seconds

4 examples, 4 failures
@@@

Could you check that, if it now works as you'd want, and if the versions not matching exactly is irrelevant or not?

In order to check that out do the following in the application source root:

@@@
cd vendor
git clone git://github.com/rails/rails.git
cd rails
git checkout 2-3-stable
@@@

Thanks!</body>
      <body-html>&lt;div&gt;&lt;p&gt;Thanks for the application. I;ve ran it against 2.3.5 and see
the StaleObjectError's. However, if I run it against the current
2-3-stable branch, I don't get these errors. The specs still fail
though, but it's because the lock_version doesn't match the
expected versions.&lt;/p&gt;
&lt;p&gt;The output I get:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;% spec spec/models/project_spec.rb
FFFF

1)
'Project when save with nested attributes should not have STALE object error and :lock_version should be 0' FAILED
expected: 0,
     got: 3 (using ==)
./spec/models/project_spec.rb:15:

2)
'Project when save with nested attributes should not have STALE object error and :lock_version should be 7' FAILED
expected: 7,
     got: 8 (using ==)
./spec/models/project_spec.rb:38:

3)
'Project when save with nested attributes should not have STALE object error and :lock_version should be 0' FAILED
expected: 0,
     got: 2 (using ==)
./spec/models/project_spec.rb:48:

4)
'Project when save with nested attributes should not have STALE object error and :lock_version should be 4' FAILED
expected: 4,
     got: 5 (using ==)
./spec/models/project_spec.rb:66:

Finished in 0.332062 seconds

4 examples, 4 failures&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Could you check that, if it now works as you'd want, and if the
versions not matching exactly is irrelevant or not?&lt;/p&gt;
&lt;p&gt;In order to check that out do the following in the application
source root:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;cd vendor
git clone git://github.com/rails/rails.git
cd rails
git checkout 2-3-stable&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Thanks!&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-04T11:16:53+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>accepts_nested_attributes_for active_record locking optimistic patch touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2010-01-04T11:16:55+00:00</updated-at>
      <user-id type="integer">8406</user-id>
      <version type="integer">15</version>
      <user-name>Eloy Duran</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>As long as, optimistic locking is working with :touch =&gt; true for nested_attributes I don't worry about the lock_version number.

So the new rails 2-3-stable WORKS !!! 

Thank You</body>
      <body-html>&lt;div&gt;&lt;p&gt;As long as, optimistic locking is working with :touch =&amp;gt; true
for nested_attributes I don't worry about the lock_version
number.&lt;/p&gt;
&lt;p&gt;So the new rails 2-3-stable WORKS !!!&lt;/p&gt;
&lt;p&gt;Thank You&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-07T01:06:59+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>accepts_nested_attributes_for active_record locking optimistic patch touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2010-01-07T01:07:03+00:00</updated-at>
      <user-id type="integer">78726</user-id>
      <version type="integer">16</version>
      <user-name>tankwanghow</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">8406</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>Great, no problem :)</body>
      <body-html>&lt;div&gt;&lt;p&gt;Great, no problem :)&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-01-07T15:18:01+00:00</created-at>
      <creator-id type="integer">78726</creator-id>
      <diffable-attributes type="yaml">--- 
:state: incomplete
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3560</number>
      <permalink>accepts_nested_attributes_for-with-touch-ture-cause-activerecordstaleobjecterror</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>accepts_nested_attributes_for active_record locking optimistic patch touch</tag>
      <title>accepts_nested_attributes_for with :touch =&gt; ture cause ActiveRecord::StaleObjectError</title>
      <updated-at type="datetime">2010-01-07T15:18:04+00:00</updated-at>
      <user-id type="integer">8406</user-id>
      <version type="integer">17</version>
      <user-name>Eloy Duran</user-name>
      <creator-name>tankwanghow</creator-name>
      <assigned-user-name>Eloy Duran</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3560</url>
      <priority-name nil="true"></priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>079e43aee8111ce6ce3164500dc7442b22bcb8b0</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2009-12-11T08:17:57+00:00</created-at>
      <filename>touching_nested_attributes.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">349391</id>
      <size type="integer">4059</size>
      <uploader-id type="integer">34795</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/349391/touching_nested_attributes.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>240673b44c2b9b8e91462afa80c8a87edee99477</code>
      <content-type>application/zip</content-type>
      <created-at type="datetime">2010-01-03T06:09:26+00:00</created-at>
      <filename>opt_lock_nest.zip</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">366004</id>
      <size type="integer">508738</size>
      <uploader-id type="integer">78726</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/366004/opt_lock_nest.zip</url>
    </attachment>
    <attachment type="Attachment">
      <code>61c406b0ffe66adf978deff6faf20a7d2c80a3cd</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-01-03T06:09:27+00:00</created-at>
      <filename>fix_nested_opt_lock.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">366005</id>
      <size type="integer">4785</size>
      <uploader-id type="integer">78726</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/366005/fix_nested_opt_lock.diff</url>
    </attachment>
  </attachments>
</ticket>
