<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">15316</assigned-user-id>
  <attachments-count type="integer">0</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2010-10-02T10:43:56+01:00</created-at>
  <creator-id type="integer">113347</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer">71470</milestone-id>
  <number type="integer">5720</number>
  <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>wontfix</state>
  <tag nil="true"></tag>
  <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
  <updated-at type="datetime">2011-02-25T18:40:50+00:00</updated-at>
  <user-id type="integer">113347</user-id>
  <version type="integer">13</version>
  <user-name>Ben Hollis</user-name>
  <creator-name>Ben Hollis</creator-name>
  <assigned-user-name>Aaron Patterson</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
  <milestone-title>3.1</milestone-title>
  <priority-name>Low</priority-name>
  <original-body>This can be seen if you create a view that contains:
@@@
&lt;% benchmark(&quot;Bug&quot;) do %&gt;
  Hello
&lt;% end %&gt;
@@@
If you view that, you'll see &quot;Hello&quot; printed twice. I'd expect it to only show up once. It doesn't matter if you do it like this either (with an =):
@@@
&lt;%= benchmark(&quot;Bug&quot;) do %&gt;
  Hello
&lt;% end %&gt;
@@@</original-body>
  <latest-body>This can be seen if you create a view that contains:
@@@
&lt;% benchmark(&quot;Bug&quot;) do %&gt;
  Hello
&lt;% end %&gt;
@@@
If you view that, you'll see &quot;Hello&quot; printed twice. I'd expect it to only show up once. It doesn't matter if you do it like this either (with an =):
@@@
&lt;%= benchmark(&quot;Bug&quot;) do %&gt;
  Hello
&lt;% end %&gt;
@@@</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;This can be seen if you create a view that contains:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;&amp;lt;% benchmark(&quot;Bug&quot;) do %&amp;gt;
  Hello
&amp;lt;% end %&amp;gt;&lt;/code&gt;
&lt;/pre&gt;
If you view that, you'll see &quot;Hello&quot; printed twice. I'd expect it
to only show up once. It doesn't matter if you do it like this
either (with an =):&lt;br&gt;
&lt;pre&gt;
&lt;code&gt;&amp;lt;%= benchmark(&quot;Bug&quot;) do %&amp;gt;
  Hello
&amp;lt;% end %&amp;gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>This can be seen if you create a view that contains:
@@@
&lt;% benchmark(&quot;Bug&quot;) do %&gt;
  Hello
&lt;% end %&gt;
@@@
If you view that, you'll see &quot;Hello&quot; printed twice. I'd expect it to only show up once. It doesn't matter if you do it like this either (with an =):
@@@
&lt;%= benchmark(&quot;Bug&quot;) do %&gt;
  Hello
&lt;% end %&gt;
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;This can be seen if you create a view that contains:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;&amp;lt;% benchmark(&quot;Bug&quot;) do %&amp;gt;
  Hello
&amp;lt;% end %&amp;gt;&lt;/code&gt;
&lt;/pre&gt;
If you view that, you'll see &quot;Hello&quot; printed twice. I'd expect it
to only show up once. It doesn't matter if you do it like this
either (with an =):&lt;br&gt;
&lt;pre&gt;
&lt;code&gt;&amp;lt;%= benchmark(&quot;Bug&quot;) do %&amp;gt;
  Hello
&amp;lt;% end %&amp;gt;&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-09-28T09:01:32+01:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>activesupport activeview rendering</tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2010-09-28T09:01:35+01:00</updated-at>
      <user-id type="integer">113347</user-id>
      <version type="integer">1</version>
      <user-name>Ben Hollis</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Oops, forgot to mention, this is on 3.0.0.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Oops, forgot to mention, this is on 3.0.0.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-09-29T07:35:47+01:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>activesupport activeview rendering</tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2010-09-29T07:35:49+01:00</updated-at>
      <user-id type="integer">113347</user-id>
      <version type="integer">2</version>
      <user-name>Ben Hollis</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I run your example and I got the same result.

In fact, it seems to happen when yield is called within any helper method. For instance, having the following helper:

@@@ ruby
def wadus
  yield
end
@@@

and the following view:

@@@ ruby
&lt;% wadus do %&gt;
  Hello
&lt;% end %&gt;
@@@

the returned string is:

@@@
Hello Hello
@@@

Looking at actionpack/lib/action_view/template/handlers/erb.rb and putting some debugger statements I've seen that the resulting code for the block is 

@@@ ruby
@output_buffer = ActionView::OutputBuffer.new;@output_buffer.append_if_string=  wadus do \n@output_buffer.safe_concat('  Hello\n'); end ;@output_buffer.to_s
@@@

The string is concatenated to the output buffer twice, once through safe_concat and another time through append_if_string.

I think the class ActionView::Template::Handlers::Erubis just extends Erubis::Eruby to use ActionView::OutputBuffer as the output buffer instead of regular strings (or whatever Erubis uses), so it may be just the way Erubis works. 

I've also run the code on 2.3.5 and the string is concatenated to the output buffer just once, so I guess ERB behaves differently in this case.

I couldn't try in edge because of an annoying problem with arel dependency version.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I run your example and I got the same result.&lt;/p&gt;
&lt;p&gt;In fact, it seems to happen when yield is called within any
helper method. For instance, having the following helper:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;def wadus
  yield
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;and the following view:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;&amp;lt;% wadus do %&amp;gt;
  Hello
&amp;lt;% end %&amp;gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;the returned string is:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;Hello Hello&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Looking at actionpack/lib/action_view/template/handlers/erb.rb
and putting some debugger statements I've seen that the resulting
code for the block is&lt;/p&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;@output_buffer = ActionView::OutputBuffer.new;@output_buffer.append_if_string=  wadus do \n@output_buffer.safe_concat('  Hello\n'); end ;@output_buffer.to_s&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;The string is concatenated to the output buffer twice, once
through safe_concat and another time through append_if_string.&lt;/p&gt;
&lt;p&gt;I think the class ActionView::Template::Handlers::Erubis just
extends Erubis::Eruby to use ActionView::OutputBuffer as the output
buffer instead of regular strings (or whatever Erubis uses), so it
may be just the way Erubis works.&lt;/p&gt;
&lt;p&gt;I've also run the code on 2.3.5 and the string is concatenated
to the output buffer just once, so I guess ERB behaves differently
in this case.&lt;/p&gt;
&lt;p&gt;I couldn't try in edge because of an annoying problem with arel
dependency version.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-10T19:45:55+01:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>activesupport activeview rendering</tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2010-10-10T19:46:00+01:00</updated-at>
      <user-id type="integer">36857</user-id>
      <version type="integer">3</version>
      <user-name>&#193;lvaro Bautista</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I kind of found a workaround, it consists of wrapping the yield call with with_output_buffer:

@@@ ruby
def wadus
  with_output_buffer { yield }
end
@@@

That implies that anyone writing helpers should know about this and wrap every yield statement to use an auxiliar buffer. Is this a good way of avoiding the double render in these cases?

Would it be an acceptable solution to alias or extend the ActiveSupport::Benchmarkable#benchmark method in ActionView::Helpers?

Doing something like:

@@@ ruby
module ActionView::Helpers
  def benchmark(message = &quot;Benchmarking&quot;, options = {})
    with_output_buffer { super(message, options) }
  end
end
@@@

I wouldn't feel very comfortable with having to change all my yield statements with `something { yield }`.

I'm sure this issue must have already been discussed by core members or active committers, so I guess I'm just wandering.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I kind of found a workaround, it consists of wrapping the yield
call with with_output_buffer:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;def wadus
  with_output_buffer { yield }
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;That implies that anyone writing helpers should know about this
and wrap every yield statement to use an auxiliar buffer. Is this a
good way of avoiding the double render in these cases?&lt;/p&gt;
&lt;p&gt;Would it be an acceptable solution to alias or extend the
ActiveSupport::Benchmarkable#benchmark method in
ActionView::Helpers?&lt;/p&gt;
&lt;p&gt;Doing something like:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;module ActionView::Helpers
  def benchmark(message = &quot;Benchmarking&quot;, options = {})
    with_output_buffer { super(message, options) }
  end
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;I wouldn't feel very comfortable with having to change all my
yield statements with &lt;code&gt;something { yield }&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;I'm sure this issue must have already been discussed by core
members or active committers, so I guess I'm just wandering.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-10T23:27:58+01:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>activesupport activeview rendering</tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2010-10-10T23:28:01+01:00</updated-at>
      <user-id type="integer">36857</user-id>
      <version type="integer">4</version>
      <user-name>&#193;lvaro Bautista</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Automatic cleanup of spam.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Automatic cleanup of spam.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-19T08:23:52+01:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
:tag: activesupport activeview rendering
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2010-10-19T08:23:54+01:00</updated-at>
      <user-id type="integer">14998</user-id>
      <version type="integer">6</version>
      <user-name>Ryan Bigg</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>This issue has been automatically marked as stale because it has not been commented on for at least three months.

The resources of the Rails core team are limited, and so we are asking for your help. If you can still reproduce this error on the 3-0-stable branch or on master, please reply with all of the information you have about it and add &quot;[state:open]&quot; to your comment. This will reopen the ticket for review. Likewise, if you feel that this is a very important feature for Rails to include, please reply with your explanation so we can consider it.

Thank you for all your contributions, and we hope you will understand this step to focus our efforts where they are most helpful.</body>
      <body-html>&lt;div&gt;&lt;p&gt;This issue has been automatically marked as stale because it has
not been commented on for at least three months.&lt;/p&gt;
&lt;p&gt;The resources of the Rails core team are limited, and so we are
asking for your help. If you can still reproduce this error on the
3-0-stable branch or on master, please reply with all of the
information you have about it and add &quot;[state:open]&quot; to your
comment. This will reopen the ticket for review. Likewise, if you
feel that this is a very important feature for Rails to include,
please reply with your explanation so we can consider it.&lt;/p&gt;
&lt;p&gt;Thank you for all your contributions, and we hope you will
understand this step to focus our efforts where they are most
helpful.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-02-02T16:48:44+00:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag nil="true"></tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2011-02-02T18:05:44+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">7</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body nil="true"></body>
      <body-html nil="true"></body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-02T16:48:45+00:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>stale</state>
      <tag nil="true"></tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2011-02-02T18:05:55+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">8</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Reopening. This is a real bug that exists in 3-0-stable but not master. O_O</body>
      <body-html>&lt;div&gt;&lt;p&gt;Reopening. This is a real bug that exists in 3-0-stable but not
master. O_O&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-02-16T05:09:51+00:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- 
:state: stale
:assigned_user: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag nil="true"></tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2011-02-16T05:10:06+00:00</updated-at>
      <user-id type="integer">15316</user-id>
      <version type="integer">9</version>
      <user-name>Aaron Patterson</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I futzed around with git bisect, and it looks like ba52748d05da4f95a8f371d628af97b76644bdd3 was the commit that introduced the fix: https://github.com/rails/rails/commit/ba52748d05da4f95a8f371d628af97b76644bdd3</body>
      <body-html>&lt;div&gt;&lt;p&gt;I futzed around with git bisect, and it looks like
ba52748d05da4f95a8f371d628af97b76644bdd3 was the commit that
introduced the fix: &lt;a href=
&quot;https://github.com/rails/rails/commit/ba52748d05da4f95a8f371d628af97b76644bdd3&quot;&gt;
https://github.com/rails/rails/commit/ba52748d05da4f95a8f371d628af9...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-02-16T08:43:55+00:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag nil="true"></tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2011-02-16T08:44:10+00:00</updated-at>
      <user-id type="integer">113347</user-id>
      <version type="integer">10</version>
      <user-name>Ben Hollis</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>It appears that just applying the changes to actionpack/lib/action_view/template/handlers/erb.rb (deleting ActionView::OutputBuffer#append_if_string= and ActionView::Template::Handlers::Erubis#add_stmt) from that commit is enough to fix the bug. Looks like that'll get rid of the deprecation warning too, though.</body>
      <body-html>&lt;div&gt;&lt;p&gt;It appears that just applying the changes to
actionpack/lib/action_view/template/handlers/erb.rb (deleting
ActionView::OutputBuffer#append_if_string= and
ActionView::Template::Handlers::Erubis#add_stmt) from that commit
is enough to fix the bug. Looks like that'll get rid of the
deprecation warning too, though.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-02-16T09:00:56+00:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag nil="true"></tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2011-02-16T09:01:23+00:00</updated-at>
      <user-id type="integer">113347</user-id>
      <version type="integer">11</version>
      <user-name>Ben Hollis</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Alright, this bug exists because of backwards compatibility with rails 2.3.  The problem is that rails 2.3 would concatenate strings with `&lt;%` erb tags.  If you examine the compiled ERb, you'll see:

1. The body of the yield appends to the output.
2. The return value of the append call is the value.
3. The return value of the call is appended to the output.

The best thing to do in Rails 3.0 is use `capture`, like this:

@@@
def helper(&amp;block)
  capture(&amp;block)
end
@@@

Removing the backwards compat fixes this problem, so for now, please just use capture.  Sorry!  :-(</body>
      <body-html>&lt;div&gt;&lt;p&gt;Alright, this bug exists because of backwards compatibility with
rails 2.3. The problem is that rails 2.3 would concatenate strings
with &lt;code&gt;&amp;lt;%&lt;/code&gt; erb tags. If you examine the compiled ERb,
you'll see:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The body of the yield appends to the output.&lt;br&gt;&lt;/li&gt;
&lt;li&gt;The return value of the append call is the value.&lt;br&gt;&lt;/li&gt;
&lt;li&gt;The return value of the call is appended to the output.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The best thing to do in Rails 3.0 is use &lt;code&gt;capture&lt;/code&gt;,
like this:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;def helper(&amp;amp;block)
  capture(&amp;amp;block)
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Removing the backwards compat fixes this problem, so for now,
please just use capture. Sorry! :-(&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-25T00:43:35+00:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
:milestone: 
</diffable-attributes>
      <milestone-id type="integer">71470</milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>wontfix</state>
      <tag nil="true"></tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2011-02-25T00:43:53+00:00</updated-at>
      <user-id type="integer">15316</user-id>
      <version type="integer">12</version>
      <user-name>Aaron Patterson</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title>3.1</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Hey Aaron, thanks for taking another look at this. I agree that new helpers should just use &lt;tt&gt;capture&lt;/tt&gt;, but what about existing helpers (and methods that use &lt;tt&gt;yield&lt;/tt&gt; but aren't view-specific), like https://github.com/rails/rails/blob/master/activesupport/lib/active_support/benchmarkable.rb? Would the recommended usage for that be:
@@@
  &lt;%= benchmark(&quot;Bug&quot;) do %&gt;
    &lt;% capture do %&gt;
      Hello
    &lt;% end %&gt;
  &lt;% end %&gt;
@@@
Would it maybe make sense to change that template helper to automatically add the &lt;tt&gt;capture&lt;/tt&gt; to whenever we're using that backwards-compatibility mode?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Hey Aaron, thanks for taking another look at this. I agree that
new helpers should just use &lt;tt&gt;capture&lt;/tt&gt;, but what about
existing helpers (and methods that use &lt;tt&gt;yield&lt;/tt&gt; but aren't
view-specific), like &lt;a href=
&quot;https://github.com/rails/rails/blob/master/activesupport/lib/active_support/benchmarkable.rb&quot;&gt;
https://github.com/rails/rails/blob/master/activesupport/lib/active...&lt;/a&gt;?
Would the recommended usage for that be:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;  &amp;lt;%= benchmark(&quot;Bug&quot;) do %&amp;gt;
    &amp;lt;% capture do %&amp;gt;
      Hello
    &amp;lt;% end %&amp;gt;
  &amp;lt;% end %&amp;gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Would it maybe make sense to change that template helper to
automatically add the &lt;tt&gt;capture&lt;/tt&gt; to whenever we're using that
backwards-compatibility mode?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-25T18:40:33+00:00</created-at>
      <creator-id type="integer">113347</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71470</milestone-id>
      <number type="integer">5720</number>
      <permalink>activesupportbenchmarkablebenchmark-double-renders</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>wontfix</state>
      <tag nil="true"></tag>
      <title>ActiveSupport::Benchmarkable.benchmark double-renders</title>
      <updated-at type="datetime">2011-02-25T18:40:50+00:00</updated-at>
      <user-id type="integer">113347</user-id>
      <version type="integer">13</version>
      <user-name>Ben Hollis</user-name>
      <creator-name>Ben Hollis</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5720</url>
      <milestone-title>3.1</milestone-title>
      <priority-name>Low</priority-name>
    </version>
  </versions>
</ticket>
