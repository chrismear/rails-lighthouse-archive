<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer" nil="true"></assigned-user-id>
  <attachments-count type="integer">2</attachments-count>
  <closed type="boolean">false</closed>
  <created-at type="datetime">2010-12-26T23:35:07+00:00</created-at>
  <creator-id type="integer">38706</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">6225</number>
  <permalink>memcachestore-cant-deal-with-umlauts-and-special-characters</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>new</state>
  <tag>memcachestore patch</tag>
  <title>MemCacheStore can't deal with Umlauts and special characters</title>
  <updated-at type="datetime">2011-03-25T16:56:02+00:00</updated-at>
  <user-id type="integer">135031</user-id>
  <version type="integer">7</version>
  <user-name>Pan Thomakos</user-name>
  <creator-name>zoopzoop</creator-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/6225</url>
  <priority-name>Low</priority-name>
  <original-body>I get the following exception

    Encoding::CompatibilityError: incompatible encoding regexp match (ASCII-8BIT regexp with UTF-8 string)

Backtrace: https://gist.github.com/755724

Setup:

    # routes.rb
    MyApp::Application.routes.draw do
      get ':id' =&gt; 'events#show'
    end

    # events_controller.rb
    class EventsController &lt; ApplicationController
      caches_action :show

      def show
        @event = Event.find(params[:id])
      end
    end


Start Memcached and the Rails server and go to localhost:3000/&#225; (or &#232; or &#252;...)
Using Memcached v1.4.5</original-body>
  <latest-body>I get the following exception

    Encoding::CompatibilityError: incompatible encoding regexp match (ASCII-8BIT regexp with UTF-8 string)

Backtrace: https://gist.github.com/755724

Setup:

    # routes.rb
    MyApp::Application.routes.draw do
      get ':id' =&gt; 'events#show'
    end

    # events_controller.rb
    class EventsController &lt; ApplicationController
      caches_action :show

      def show
        @event = Event.find(params[:id])
      end
    end


Start Memcached and the Rails server and go to localhost:3000/&#225; (or &#232; or &#252;...)
Using Memcached v1.4.5</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;I get the following exception&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;Encoding::CompatibilityError: incompatible encoding regexp match (ASCII-8BIT regexp with UTF-8 string)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Backtrace: &lt;a href=
&quot;https://gist.github.com/755724&quot;&gt;https://gist.github.com/755724&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Setup:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;# routes.rb
MyApp::Application.routes.draw do
  get ':id' =&amp;gt; 'events#show'
end

# events_controller.rb
class EventsController &amp;lt; ApplicationController
  caches_action :show

  def show
    @event = Event.find(params[:id])
  end
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Start Memcached and the Rails server and go to
localhost:3000/&amp;aacute; (or &amp;egrave; or &amp;uuml;...)&lt;br&gt;
Using Memcached v1.4.5&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I get the following exception

    Encoding::CompatibilityError: incompatible encoding regexp match (ASCII-8BIT regexp with UTF-8 string)

Backtrace: https://gist.github.com/755724

Setup:

    # routes.rb
    MyApp::Application.routes.draw do
      get ':id' =&gt; 'events#show'
    end

    # events_controller.rb
    class EventsController &lt; ApplicationController
      caches_action :show

      def show
        @event = Event.find(params[:id])
      end
    end


Start Memcached and the Rails server and go to localhost:3000/&#225; (or &#232; or &#252;...)
Using Memcached v1.4.5</body>
      <body-html>&lt;div&gt;&lt;p&gt;I get the following exception&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;Encoding::CompatibilityError: incompatible encoding regexp match (ASCII-8BIT regexp with UTF-8 string)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Backtrace: &lt;a href=
&quot;https://gist.github.com/755724&quot;&gt;https://gist.github.com/755724&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Setup:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;# routes.rb
MyApp::Application.routes.draw do
  get ':id' =&amp;gt; 'events#show'
end

# events_controller.rb
class EventsController &amp;lt; ApplicationController
  caches_action :show

  def show
    @event = Event.find(params[:id])
  end
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Start Memcached and the Rails server and go to
localhost:3000/&amp;aacute; (or &amp;egrave; or &amp;uuml;...)&lt;br&gt;
Using Memcached v1.4.5&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-26T23:35:07+00:00</created-at>
      <creator-id type="integer">38706</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6225</number>
      <permalink>memcachestore-cant-deal-with-umlauts-and-special-characters</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>memcachestore</tag>
      <title>MemCacheStore can't deal with Umlauts and special characters</title>
      <updated-at type="datetime">2010-12-26T23:35:09+00:00</updated-at>
      <user-id type="integer">38706</user-id>
      <version type="integer">1</version>
      <user-name>zoopzoop</user-name>
      <creator-name>zoopzoop</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6225</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I ran into this same bug with UTF-8 special characters.

The issue is in the ActiveSupport::Cache::MemCacheStore#escape_key function where the key is checked against an ASCII-8BIT regular expression for special characters. I've created a patch to solve this issue by forcing the encoding to comply with the regular expression's encoding in Ruby 1.9. The tests I added also check that any strings formatted any in any other encoding also work. I checked that tests pass for Ruby 1.8.7 and Ruby 1.9.2.

Please try the patch and let me know if everything works.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I ran into this same bug with UTF-8 special characters.&lt;/p&gt;
&lt;p&gt;The issue is in the
ActiveSupport::Cache::MemCacheStore#escape_key function where the
key is checked against an ASCII-8BIT regular expression for special
characters. I've created a patch to solve this issue by forcing the
encoding to comply with the regular expression's encoding in Ruby
1.9. The tests I added also check that any strings formatted any in
any other encoding also work. I checked that tests pass for Ruby
1.8.7 and Ruby 1.9.2.&lt;/p&gt;
&lt;p&gt;Please try the patch and let me know if everything works.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-03-05T19:37:23+00:00</created-at>
      <creator-id type="integer">38706</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6225</number>
      <permalink>memcachestore-cant-deal-with-umlauts-and-special-characters</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>memcachestore</tag>
      <title>MemCacheStore can't deal with Umlauts and special characters</title>
      <updated-at type="datetime">2011-03-05T19:37:29+00:00</updated-at>
      <user-id type="integer">135031</user-id>
      <version type="integer">2</version>
      <user-name>Pan Thomakos</user-name>
      <creator-name>zoopzoop</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6225</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-03-05T21:13:42+00:00</created-at>
      <creator-id type="integer">38706</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: memcachestore
:priority: 0
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6225</number>
      <permalink>memcachestore-cant-deal-with-umlauts-and-special-characters</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>memcachestore patch</tag>
      <title>MemCacheStore can't deal with Umlauts and special characters</title>
      <updated-at type="datetime">2011-03-05T21:13:53+00:00</updated-at>
      <user-id type="integer">22589</user-id>
      <version type="integer">3</version>
      <user-name>Matt Jones</user-name>
      <creator-name>zoopzoop</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6225</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>I've update the patch.

After making the original change, I realized that the escape_key function forces the initial string into a new encoding. This means that the escape_key function changes the original encoding of the argument, which can cause problems further down the line in an application.

To fix this I have added another test that checks if the encoding of the original string changes.

Please use this updated patch that dups the argument to avoid this encoding change issue.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I've update the patch.&lt;/p&gt;
&lt;p&gt;After making the original change, I realized that the escape_key
function forces the initial string into a new encoding. This means
that the escape_key function changes the original encoding of the
argument, which can cause problems further down the line in an
application.&lt;/p&gt;
&lt;p&gt;To fix this I have added another test that checks if the
encoding of the original string changes.&lt;/p&gt;
&lt;p&gt;Please use this updated patch that dups the argument to avoid
this encoding change issue.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-03-05T22:25:28+00:00</created-at>
      <creator-id type="integer">38706</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6225</number>
      <permalink>memcachestore-cant-deal-with-umlauts-and-special-characters</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>memcachestore patch</tag>
      <title>MemCacheStore can't deal with Umlauts and special characters</title>
      <updated-at type="datetime">2011-03-05T22:25:38+00:00</updated-at>
      <user-id type="integer">135031</user-id>
      <version type="integer">4</version>
      <user-name>Pan Thomakos</user-name>
      <creator-name>zoopzoop</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6225</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>I created a pull request for this bug as well.

https://github.com/rails/rails/pull/219</body>
      <body-html>&lt;div&gt;&lt;p&gt;I created a pull request for this bug as well.&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;https://github.com/rails/rails/pull/219&quot;&gt;https://github.com/rails/rails/pull/219&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-03-13T01:35:16+00:00</created-at>
      <creator-id type="integer">38706</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6225</number>
      <permalink>memcachestore-cant-deal-with-umlauts-and-special-characters</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>memcachestore patch</tag>
      <title>MemCacheStore can't deal with Umlauts and special characters</title>
      <updated-at type="datetime">2011-03-13T01:35:29+00:00</updated-at>
      <user-id type="integer">135031</user-id>
      <version type="integer">5</version>
      <user-name>Pan Thomakos</user-name>
      <creator-name>zoopzoop</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6225</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>I had the same issue in Dalli and fixed it in a similar manner:

https://github.com/mperham/dalli/issues/78</body>
      <body-html>&lt;div&gt;&lt;p&gt;I had the same issue in Dalli and fixed it in a similar
manner:&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;https://github.com/mperham/dalli/issues/78&quot;&gt;https://github.com/mperham/dalli/issues/78&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-03-25T16:42:35+00:00</created-at>
      <creator-id type="integer">38706</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6225</number>
      <permalink>memcachestore-cant-deal-with-umlauts-and-special-characters</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>memcachestore patch</tag>
      <title>MemCacheStore can't deal with Umlauts and special characters</title>
      <updated-at type="datetime">2011-03-25T16:43:14+00:00</updated-at>
      <user-id type="integer">20854</user-id>
      <version type="integer">6</version>
      <user-name>Mike Perham</user-name>
      <creator-name>zoopzoop</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6225</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>That's very similar to what I do, but I use the encoding of the ESCAPE_KEY_CHARS, in case it ever changes. If you get a chance, please take a look at the patch or pull request and leave your comments if it works.</body>
      <body-html>&lt;div&gt;&lt;p&gt;That's very similar to what I do, but I use the encoding of the
ESCAPE_KEY_CHARS, in case it ever changes. If you get a chance,
please take a look at the patch or pull request and leave your
comments if it works.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-03-25T16:55:48+00:00</created-at>
      <creator-id type="integer">38706</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6225</number>
      <permalink>memcachestore-cant-deal-with-umlauts-and-special-characters</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>memcachestore patch</tag>
      <title>MemCacheStore can't deal with Umlauts and special characters</title>
      <updated-at type="datetime">2011-03-25T16:56:02+00:00</updated-at>
      <user-id type="integer">135031</user-id>
      <version type="integer">7</version>
      <user-name>Pan Thomakos</user-name>
      <creator-name>zoopzoop</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6225</url>
      <priority-name>Low</priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>d89a437707fbcd2173eb5b7129e3ea32ac5f6f28</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2011-03-05T19:37:23+00:00</created-at>
      <filename>memcache-encoding.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">944466</id>
      <size type="integer">3257</size>
      <uploader-id type="integer">135031</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/944466/memcache-encoding.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>113fa1a5bf2405640a5022e27705579415cdf7b7</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2011-03-05T22:25:28+00:00</created-at>
      <filename>memcache-encoding.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">944522</id>
      <size type="integer">3611</size>
      <uploader-id type="integer">135031</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/944522/memcache-encoding.diff</url>
    </attachment>
  </attachments>
</ticket>
