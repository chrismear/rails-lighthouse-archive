<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">424</assigned-user-id>
  <attachments-count type="integer">2</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2008-11-24T21:41:18+00:00</created-at>
  <creator-id type="integer">26024</creator-id>
  <milestone-due-on type="datetime">2009-01-31T00:00:00+00:00</milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">1462</number>
  <permalink>autoload-htmlnode</permalink>
  <priority type="integer">77</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>resolved</state>
  <tag>autoload patch</tag>
  <title>Autoload HTML::Node and Friends</title>
  <updated-at type="datetime">2008-11-25T16:06:21+00:00</updated-at>
  <user-id type="integer">17393</user-id>
  <version type="integer">5</version>
  <user-name>Repository</user-name>
  <creator-name>Craig Davey</creator-name>
  <assigned-user-name>Joshua Peek</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/1462</url>
  <priority-name nil="true"></priority-name>
  <original-body>assert_select depends on HTML::Node and but it&#8217;s not automatically loaded. This patch resolves that.</original-body>
  <latest-body>assert_select depends on HTML::Node and but it&#8217;s not automatically loaded. This patch resolves that.</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;assert_select depends on HTML::Node and but it&amp;#8217;s not
automatically loaded. This patch resolves that.&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>assert_select depends on HTML::Node and but it&#8217;s not automatically loaded. This patch resolves that.</body>
      <body-html>&lt;div&gt;&lt;p&gt;assert_select depends on HTML::Node and but it&amp;#8217;s not
automatically loaded. This patch resolves that.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-11-24T21:41:18+00:00</created-at>
      <creator-id type="integer">26024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">9903</milestone-id>
      <number type="integer">1462</number>
      <permalink>autoload-htmlnode</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>patch</tag>
      <title>Autoload HTML::Node</title>
      <updated-at type="datetime">2008-11-24T21:41:23+00:00</updated-at>
      <user-id type="integer">26024</user-id>
      <version type="integer">1</version>
      <user-name>Craig Davey</user-name>
      <creator-name>Craig Davey</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1462</url>
      <priority-name nil="true"></priority-name>
      <milestone-title>2.x</milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">424</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-11-24T21:50:02+00:00</created-at>
      <creator-id type="integer">26024</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
:milestone: 9903
:tag: patch
:assigned_user: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">1462</number>
      <permalink>autoload-htmlnode</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>autoload patch</tag>
      <title>Autoload HTML::Node</title>
      <updated-at type="datetime">2008-11-24T21:50:04+00:00</updated-at>
      <user-id type="integer">424</user-id>
      <version type="integer">2</version>
      <user-name>Joshua Peek</user-name>
      <creator-name>Craig Davey</creator-name>
      <assigned-user-name>Joshua Peek</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1462</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">424</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-11-25T10:35:48+00:00</created-at>
      <creator-id type="integer">26024</creator-id>
      <diffable-attributes type="yaml">--- 
:title: Autoload HTML::Node
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">1462</number>
      <permalink>autoload-htmlnode</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>autoload patch</tag>
      <title>Autoload HTML::Node and Friends</title>
      <updated-at type="datetime">2008-11-25T10:35:52+00:00</updated-at>
      <user-id type="integer">26024</user-id>
      <version type="integer">3</version>
      <user-name>Craig Davey</user-name>
      <creator-name>Craig Davey</creator-name>
      <assigned-user-name>Joshua Peek</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1462</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">424</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>When run individually (without rake) these html-scanner test cases all fail:

actionpack/test/controller/html-scanner/cdata_node_test.rb
actionpack/test/controller/html-scanner/node_test.rb
actionpack/test/controller/html-scanner/tag_node_test.rb
actionpack/test/controller/html-scanner/text_node_test.rb
actionpack/test/controller/html-scanner/tokenizer_test.rb 
actionpack/test/controller/html-scanner/sanitizer_test.rb

They fail becuase we expect HTML (defined in html-scanner.rb) to provide classes that cannot be loaded automatically. Currently, HTML only registers HTML::Document and four sanitizer classes for autoloading. Helpers like assert_select expect HTML to provide HTML::Node and HTML::Selector automatically but these classes are currently only available if HTML::Document has already been loaded.

Often, HTML::Document has already been loaded so its easy to miss these bugs. The test cases in question pass if you use rake because other test cases will reference HTML::Document first which requires all the other classes explicitely. 

The inaccessible classes in HTML that are tested and used by Rails are: HTML::CDATA, HTML::Node, HTML::Tag, HTML::Text, HTML::Tokenizer. The attached patch makes all these classes consistently accessible and satisfies all the broken test cases. The changes consisted of moving some classes into their own files and registering each for autoloading.</body>
      <body-html>&lt;div&gt;&lt;p&gt;When run individually (without rake) these html-scanner test
cases all fail:&lt;/p&gt;
&lt;p&gt;actionpack/test/controller/html-scanner/cdata_node_test.rb
actionpack/test/controller/html-scanner/node_test.rb
actionpack/test/controller/html-scanner/tag_node_test.rb
actionpack/test/controller/html-scanner/text_node_test.rb
actionpack/test/controller/html-scanner/tokenizer_test.rb
actionpack/test/controller/html-scanner/sanitizer_test.rb&lt;/p&gt;
&lt;p&gt;They fail becuase we expect HTML (defined in html-scanner.rb) to
provide classes that cannot be loaded automatically. Currently,
HTML only registers HTML::Document and four sanitizer classes for
autoloading. Helpers like assert_select expect HTML to provide
HTML::Node and HTML::Selector automatically but these classes are
currently only available if HTML::Document has already been
loaded.&lt;/p&gt;
&lt;p&gt;Often, HTML::Document has already been loaded so its easy to
miss these bugs. The test cases in question pass if you use rake
because other test cases will reference HTML::Document first which
requires all the other classes explicitely.&lt;/p&gt;
&lt;p&gt;The inaccessible classes in HTML that are tested and used by
Rails are: HTML::CDATA, HTML::Node, HTML::Tag, HTML::Text,
HTML::Tokenizer. The attached patch makes all these classes
consistently accessible and satisfies all the broken test cases.
The changes consisted of moving some classes into their own files
and registering each for autoloading.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-11-25T10:40:53+00:00</created-at>
      <creator-id type="integer">26024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">1462</number>
      <permalink>autoload-htmlnode</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>autoload patch</tag>
      <title>Autoload HTML::Node and Friends</title>
      <updated-at type="datetime">2008-11-25T10:40:55+00:00</updated-at>
      <user-id type="integer">26024</user-id>
      <version type="integer">4</version>
      <user-name>Craig Davey</user-name>
      <creator-name>Craig Davey</creator-name>
      <assigned-user-name>Joshua Peek</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1462</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">424</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>(from [f8558798d404f3373517a85fe9e3e8d519c8f3d9]) Ensure all HTML:: constants are available to autoload [#1462 state:resolved]

Signed-off-by: Joshua Peek &lt;josh@joshpeek.com&gt;
http://github.com/rails/rails/commit/f8558798d404f3373517a85fe9e3e8d519c8f3d9</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from [f8558798d404f3373517a85fe9e3e8d519c8f3d9]) Ensure all
HTML:: constants are available to autoload [&lt;a href=&quot;/projects/8994/tickets/1462&quot; title=&quot;Ticket #1462&quot;&gt;#1462&lt;/a&gt;
state:resolved]&lt;/p&gt;
&lt;p&gt;Signed-off-by: Joshua Peek &lt;a href=&quot;mailto:josh@joshpeek.com&quot;&gt;josh@joshpeek.com&lt;/a&gt; &lt;a href=&quot;http://github.com/rails/rails/commit/f8558798d404f3373517a85fe9e3e8d519c8f3d9&quot;&gt;
http://github.com/rails/rails/co...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2008-11-25T16:06:21+00:00</created-at>
      <creator-id type="integer">26024</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">1462</number>
      <permalink>autoload-htmlnode</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>autoload patch</tag>
      <title>Autoload HTML::Node and Friends</title>
      <updated-at type="datetime">2008-11-25T16:06:21+00:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">5</version>
      <user-name>Repository</user-name>
      <creator-name>Craig Davey</creator-name>
      <assigned-user-name>Joshua Peek</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1462</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>0d3d8f700587568418ef76740153ace088928086</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2008-11-24T21:41:18+00:00</created-at>
      <filename>fix_assert_select_by_autoloading_html_node.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">65143</id>
      <size type="integer">2185</size>
      <uploader-id type="integer">26024</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/65143/fix_assert_select_by_autoloading_html_node.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>b076bd7be486acf226f4c70046f67957db4db0d1</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2008-11-25T10:40:53+00:00</created-at>
      <filename>craig_refactored_html_scanner_to_our_expectations.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">65283</id>
      <size type="integer">26513</size>
      <uploader-id type="integer">26024</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/65283/craig_refactored_html_scanner_to_our_expectations.diff</url>
    </attachment>
  </attachments>
</ticket>
