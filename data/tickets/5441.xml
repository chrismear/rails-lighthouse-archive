<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">15316</assigned-user-id>
  <attachments-count type="integer">2</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2011-01-04T16:24:47+00:00</created-at>
  <creator-id type="integer">12728</creator-id>
  <milestone-due-on type="datetime">2010-11-15T00:00:00+00:00</milestone-due-on>
  <milestone-id type="integer">88038</milestone-id>
  <number type="integer">5441</number>
  <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>resolved</state>
  <tag>3.0.0.rc2 :select &quot;activerecord 3.0&quot; calculations patch</tag>
  <title>[PATCH] ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
  <updated-at type="datetime">2011-01-04T16:24:47+00:00</updated-at>
  <user-id type="integer">85</user-id>
  <version type="integer">14</version>
  <user-name>Jeremy Kemper</user-name>
  <creator-name>oleg dashevskii</creator-name>
  <assigned-user-name>Aaron Patterson</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
  <milestone-title>3.0.2</milestone-title>
  <priority-name>Low</priority-name>
  <original-body>I have the following code that works in 2.3.8

@@@ ruby
@dishes.count('order_items.id',
              :group =&gt; 'dishes.id',
              :joins =&gt; {:multi_dishes =&gt; { :menu_item =&gt; :order_items }})
@@@

`@dishes` is some `Dish` scope. This code counts how many times each dish appeared in orders.

When I try to run it under 3.0.0.rc2, it fails (`@dishes = Dish`):

   ActiveRecord::StatementInvalid: Mysql::Error: Unknown column 'dishes.order_items.id' in 'field list': 
SELECT     COUNT(`dishes`.`order_items.id`) 
AS `count_order_items_id`, dishes.id AS dishes_id FROM       `dishes`  
INNER JOIN `multi_dishes` ON `multi_dishes`.`dish_id` = `dishes`.`id` INNER JOIN `menu_items` ON `menu_items`.`id` = `multi_dishes`.`menu_item_id` 
INNER JOIN `order_items` ON `order_items`.`menu_item_id` = `menu_items`.`id` GROUP BY  dishes.id

The problem is apparent: unneeded 'dishes.' prepended to the column name.

I also tried to specify `:select` option, but it made no change.</original-body>
  <latest-body>I have the following code that works in 2.3.8

@@@ ruby
@dishes.count('order_items.id',
              :group =&gt; 'dishes.id',
              :joins =&gt; {:multi_dishes =&gt; { :menu_item =&gt; :order_items }})
@@@

`@dishes` is some `Dish` scope. This code counts how many times each dish appeared in orders.

When I try to run it under 3.0.0.rc2, it fails (`@dishes = Dish`):

   ActiveRecord::StatementInvalid: Mysql::Error: Unknown column 'dishes.order_items.id' in 'field list': 
SELECT     COUNT(`dishes`.`order_items.id`) 
AS `count_order_items_id`, dishes.id AS dishes_id FROM       `dishes`  
INNER JOIN `multi_dishes` ON `multi_dishes`.`dish_id` = `dishes`.`id` INNER JOIN `menu_items` ON `menu_items`.`id` = `multi_dishes`.`menu_item_id` 
INNER JOIN `order_items` ON `order_items`.`menu_item_id` = `menu_items`.`id` GROUP BY  dishes.id

The problem is apparent: unneeded 'dishes.' prepended to the column name.

I also tried to specify `:select` option, but it made no change.</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;I have the following code that works in 2.3.8&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;@dishes.count('order_items.id',
              :group =&amp;gt; 'dishes.id',
              :joins =&amp;gt; {:multi_dishes =&amp;gt; { :menu_item =&amp;gt; :order_items }})&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;@dishes&lt;/code&gt; is some &lt;code&gt;Dish&lt;/code&gt; scope. This code
counts how many times each dish appeared in orders.&lt;/p&gt;
&lt;p&gt;When I try to run it under 3.0.0.rc2, it fails (&lt;code&gt;@dishes =
Dish&lt;/code&gt;):&lt;/p&gt;
&lt;p&gt;ActiveRecord::StatementInvalid: Mysql::Error: Unknown column
'dishes.order_items.id' in 'field list': SELECT
COUNT(&lt;code&gt;dishes&lt;/code&gt;.&lt;code&gt;order_items.id&lt;/code&gt;)&lt;br&gt;
AS &lt;code&gt;count_order_items_id&lt;/code&gt;, dishes.id AS dishes_id FROM
&lt;code&gt;dishes&lt;/code&gt;&lt;br&gt;
INNER JOIN &lt;code&gt;multi_dishes&lt;/code&gt; ON
&lt;code&gt;multi_dishes&lt;/code&gt;.&lt;code&gt;dish_id&lt;/code&gt; =
&lt;code&gt;dishes&lt;/code&gt;.&lt;code&gt;id&lt;/code&gt; INNER JOIN
&lt;code&gt;menu_items&lt;/code&gt; ON &lt;code&gt;menu_items&lt;/code&gt;.&lt;code&gt;id&lt;/code&gt;
= &lt;code&gt;multi_dishes&lt;/code&gt;.&lt;code&gt;menu_item_id&lt;/code&gt;&lt;br&gt;
INNER JOIN &lt;code&gt;order_items&lt;/code&gt; ON
&lt;code&gt;order_items&lt;/code&gt;.&lt;code&gt;menu_item_id&lt;/code&gt; =
&lt;code&gt;menu_items&lt;/code&gt;.&lt;code&gt;id&lt;/code&gt; GROUP BY dishes.id&lt;/p&gt;
&lt;p&gt;The problem is apparent: unneeded 'dishes.' prepended to the
column name.&lt;/p&gt;
&lt;p&gt;I also tried to specify &lt;code&gt;:select&lt;/code&gt; option, but it made
no change.&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I have the following code that works in 2.3.8

@@@ ruby
@dishes.count('order_items.id',
              :group =&gt; 'dishes.id',
              :joins =&gt; {:multi_dishes =&gt; { :menu_item =&gt; :order_items }})
@@@

`@dishes` is some `Dish` scope. This code counts how many times each dish appeared in orders.

When I try to run it under 3.0.0.rc2, it fails (`@dishes = Dish`):

   ActiveRecord::StatementInvalid: Mysql::Error: Unknown column 'dishes.order_items.id' in 'field list': 
SELECT     COUNT(`dishes`.`order_items.id`) 
AS `count_order_items_id`, dishes.id AS dishes_id FROM       `dishes`  
INNER JOIN `multi_dishes` ON `multi_dishes`.`dish_id` = `dishes`.`id` INNER JOIN `menu_items` ON `menu_items`.`id` = `multi_dishes`.`menu_item_id` 
INNER JOIN `order_items` ON `order_items`.`menu_item_id` = `menu_items`.`id` GROUP BY  dishes.id

The problem is apparent: unneeded 'dishes.' prepended to the column name.

I also tried to specify `:select` option, but it made no change.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I have the following code that works in 2.3.8&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;@dishes.count('order_items.id',
              :group =&amp;gt; 'dishes.id',
              :joins =&amp;gt; {:multi_dishes =&amp;gt; { :menu_item =&amp;gt; :order_items }})&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;@dishes&lt;/code&gt; is some &lt;code&gt;Dish&lt;/code&gt; scope. This code
counts how many times each dish appeared in orders.&lt;/p&gt;
&lt;p&gt;When I try to run it under 3.0.0.rc2, it fails (&lt;code&gt;@dishes =
Dish&lt;/code&gt;):&lt;/p&gt;
&lt;p&gt;ActiveRecord::StatementInvalid: Mysql::Error: Unknown column
'dishes.order_items.id' in 'field list': SELECT
COUNT(&lt;code&gt;dishes&lt;/code&gt;.&lt;code&gt;order_items.id&lt;/code&gt;)&lt;br&gt;
AS &lt;code&gt;count_order_items_id&lt;/code&gt;, dishes.id AS dishes_id FROM
&lt;code&gt;dishes&lt;/code&gt;&lt;br&gt;
INNER JOIN &lt;code&gt;multi_dishes&lt;/code&gt; ON
&lt;code&gt;multi_dishes&lt;/code&gt;.&lt;code&gt;dish_id&lt;/code&gt; =
&lt;code&gt;dishes&lt;/code&gt;.&lt;code&gt;id&lt;/code&gt; INNER JOIN
&lt;code&gt;menu_items&lt;/code&gt; ON &lt;code&gt;menu_items&lt;/code&gt;.&lt;code&gt;id&lt;/code&gt;
= &lt;code&gt;multi_dishes&lt;/code&gt;.&lt;code&gt;menu_item_id&lt;/code&gt;&lt;br&gt;
INNER JOIN &lt;code&gt;order_items&lt;/code&gt; ON
&lt;code&gt;order_items&lt;/code&gt;.&lt;code&gt;menu_item_id&lt;/code&gt; =
&lt;code&gt;menu_items&lt;/code&gt;.&lt;code&gt;id&lt;/code&gt; GROUP BY dishes.id&lt;/p&gt;
&lt;p&gt;The problem is apparent: unneeded 'dishes.' prepended to the
column name.&lt;/p&gt;
&lt;p&gt;I also tried to specify &lt;code&gt;:select&lt;/code&gt; option, but it made
no change.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-08-24T14:19:39+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0.0.rc2 :select calculations</tag>
      <title>ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-08-24T15:24:56+01:00</updated-at>
      <user-id type="integer">12728</user-id>
      <version type="integer">1</version>
      <user-name>oleg dashevskii</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Can you post your Dish model with scope information? Also post schema info.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Can you post your Dish model with scope information? Also post
schema info.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-08-24T15:26:27+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0.0.rc2 :select calculations</tag>
      <title>ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-08-24T15:26:28+01:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">2</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Well, let's simplify the example:

@@@ ruby
User.count('orders.id', :joins =&gt; :orders, :group =&gt; 'users.id')
@@@

Schema: User has many orders. 

The `count()` call without `:group` works:
@@@ ruby
User.count('orders.id', :joins =&gt; :orders)
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;Well, let's simplify the example:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;User.count('orders.id', :joins =&amp;gt; :orders, :group =&amp;gt; 'users.id')&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Schema: User has many orders.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;count()&lt;/code&gt; call without &lt;code&gt;:group&lt;/code&gt;
works:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;User.count('orders.id', :joins =&amp;gt; :orders)&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-08-24T16:29:32+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0.0.rc2 :select calculations</tag>
      <title>ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-08-24T16:29:34+01:00</updated-at>
      <user-id type="integer">12728</user-id>
      <version type="integer">3</version>
      <user-name>oleg dashevskii</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-08-24T18:10:55+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
:milestone: 
:assigned_user: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>3.0.0.rc2 :select calculations</tag>
      <title>ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-08-24T18:10:56+01:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">4</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I made up a pair of tests which prove the bug.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I made up a pair of tests which prove the bug.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-08-25T09:53:38+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>3.0.0.rc2 :select calculations</tag>
      <title>ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-08-25T09:53:40+01:00</updated-at>
      <user-id type="integer">12728</user-id>
      <version type="integer">5</version>
      <user-name>oleg dashevskii</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>This would require changes in Arel because currently arel has following code.

@@@ ruby
def attribute(attribute)
  &quot;#{quote_table_name(name_for(attribute.original_relation))}.#{quote_column_name(attribute.name)}&quot; +
  (attribute.alias ? &quot; AS #{quote(attribute.alias.to_s)}&quot; : &quot;&quot;)
end
@@@

That needs to be changed to something like this

@@@ ruby
def attribute(attribute, prefix = true)
  table_name = &quot;#{quote_table_name(name_for(attribute.original_relation))}&quot;
  column_name = &quot;#{quote_column_name(attribute.name)}&quot;
  qualified_name = prefix ? &quot;#{table_name}.#{column_name}&quot; : column_name
  qualified_name + (attribute.alias ? &quot; AS #{quote(attribute.alias.to_s)}&quot; : &quot;&quot;)
end
@@@

Method execute_grouped_calculation in calculations.rb is executing 

@@@ ruby
  Arel::Attribute.new(r, column_name).send(operation).as(aggregate_alias).to_sql
@@@

That needs to be changed to pass additional parameter to to_sql to tell it not to add prefix. Something like

@@@ ruby
  Arel::Attribute.new(r, column_name).send(operation).as(aggregate_alias).to_sql(:table_name =&gt; false)
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;This would require changes in Arel because currently arel has
following code.&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;def attribute(attribute)
  &quot;#{quote_table_name(name_for(attribute.original_relation))}.#{quote_column_name(attribute.name)}&quot; +
  (attribute.alias ? &quot; AS #{quote(attribute.alias.to_s)}&quot; : &quot;&quot;)
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;That needs to be changed to something like this&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;def attribute(attribute, prefix = true)
  table_name = &quot;#{quote_table_name(name_for(attribute.original_relation))}&quot;
  column_name = &quot;#{quote_column_name(attribute.name)}&quot;
  qualified_name = prefix ? &quot;#{table_name}.#{column_name}&quot; : column_name
  qualified_name + (attribute.alias ? &quot; AS #{quote(attribute.alias.to_s)}&quot; : &quot;&quot;)
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Method execute_grouped_calculation in calculations.rb is
executing&lt;/p&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;  Arel::Attribute.new(r, column_name).send(operation).as(aggregate_alias).to_sql&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;That needs to be changed to pass additional parameter to to_sql
to tell it not to add prefix. Something like&lt;/p&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;  Arel::Attribute.new(r, column_name).send(operation).as(aggregate_alias).to_sql(:table_name =&amp;gt; false)&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-08-25T15:30:33+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>3.0.0.rc2 :select calculations</tag>
      <title>ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-08-25T15:30:34+01:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">6</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Since simple count (not grouped) works, I looked into its implementation:

@@@ ruby
    def execute_simple_calculation(operation, column_name, distinct) #:nodoc:
      column = if @klass.column_names.include?(column_name.to_s)
        Arel::Attribute.new(@klass.unscoped, column_name)
      else
        Arel::SqlLiteral.new(column_name == :all ? &quot;*&quot; : column_name.to_s)
      end

      # Postgresql doesn't like ORDER BY when there are no GROUP BY
      relation = except(:order).select(operation == 'count' ? column.count(distinct) : column.send(operation))
      type_cast_calculated_value(@klass.connection.select_value(relation.to_sql), column_for(column_name), operation)
    end
@@@

Could this `Arel::SqlLiteral` thing help here? I tried to copy this if-statement to `execute_grouped_calculation`, but got very strange error messages somewhere from Arel.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Since simple count (not grouped) works, I looked into its
implementation:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;    def execute_simple_calculation(operation, column_name, distinct) #:nodoc:
      column = if @klass.column_names.include?(column_name.to_s)
        Arel::Attribute.new(@klass.unscoped, column_name)
      else
        Arel::SqlLiteral.new(column_name == :all ? &quot;*&quot; : column_name.to_s)
      end

      # Postgresql doesn't like ORDER BY when there are no GROUP BY
      relation = except(:order).select(operation == 'count' ? column.count(distinct) : column.send(operation))
      type_cast_calculated_value(@klass.connection.select_value(relation.to_sql), column_for(column_name), operation)
    end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Could this &lt;code&gt;Arel::SqlLiteral&lt;/code&gt; thing help here? I
tried to copy this if-statement to
&lt;code&gt;execute_grouped_calculation&lt;/code&gt;, but got very strange
error messages somewhere from Arel.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-08-25T17:19:10+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>3.0.0.rc2 :select calculations</tag>
      <title>ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-08-25T17:19:14+01:00</updated-at>
      <user-id type="integer">12728</user-id>
      <version type="integer">7</version>
      <user-name>oleg dashevskii</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>[[bulk edit](/projects/8994/bulk_edits/27625)]</body>
      <body-html>&lt;div&gt;&lt;p&gt;[&lt;a href=&quot;/projects/8994/bulk_edits/27625&quot;&gt;bulk edit&lt;/a&gt;]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-08-30T04:10:34+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- 
:milestone: 27004
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>3.0.0.rc2 :select calculations</tag>
      <title>ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-08-30T04:10:34+01:00</updated-at>
      <user-id type="integer">85</user-id>
      <version type="integer">8</version>
      <user-name>Jeremy Kemper</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>I fixed the bug with a rather brute-force style. This `@klass.send(:relation)` thing apparently is a mess.

Patch is attached.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I fixed the bug with a rather brute-force style. This
&lt;code&gt;@klass.send(:relation)&lt;/code&gt; thing apparently is a mess.&lt;/p&gt;
&lt;p&gt;Patch is attached.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-08-31T18:12:12+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 3.0.0.rc2 :select calculations
:title: ActiveRecord::Calculations#count doesn't allow table names in column_name argument
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>3.0.0.rc2 :select &quot;activerecord 3.0&quot; calculations patch</tag>
      <title>[PATCH] ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-08-31T18:12:13+01:00</updated-at>
      <user-id type="integer">12728</user-id>
      <version type="integer">9</version>
      <user-name>oleg dashevskii</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Nice work Oleg. Your patch fixes the problem.

For some reason when I tried to apply your patch it said email is invalid.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Nice work Oleg. Your patch fixes the problem.&lt;/p&gt;
&lt;p&gt;For some reason when I tried to apply your patch it said email
is invalid.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-08-31T21:14:25+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>3.0.0.rc2 :select &quot;activerecord 3.0&quot; calculations patch</tag>
      <title>[PATCH] ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-08-31T21:14:30+01:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">10</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Neeraj, it works for me (`git am &lt; file`).</body>
      <body-html>&lt;div&gt;&lt;p&gt;Neeraj, it works for me (&lt;code&gt;git am &amp;lt; file&lt;/code&gt;).&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-09-01T04:40:53+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>3.0.0.rc2 :select &quot;activerecord 3.0&quot; calculations patch</tag>
      <title>[PATCH] ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-09-01T04:40:54+01:00</updated-at>
      <user-id type="integer">12728</user-id>
      <version type="integer">11</version>
      <user-name>oleg dashevskii</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>(from [fc1bd2bba49a8c3f424b9d6f4c13f430f5db3d5c]) [#5441 state:resolved] refactoring code to determine aggregate column
http://github.com/rails/rails/commit/fc1bd2bba49a8c3f424b9d6f4c13f430f5db3d5c</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from &lt;a href=
&quot;/projects/8994/changesets/fc1bd2bba49a8c3f424b9d6f4c13f430f5db3d5c&quot;
title=
&quot;Changeset [fc1bd2bba49a8c3f424b9d6f4c13f430f5db3d5c]&quot;&gt;[fc1bd2bba49a8c3f424b9d6f4c13f430f5db3d5c]&lt;/a&gt;)
[&lt;a href=&quot;/projects/8994/tickets/5441&quot; title=
&quot;Ticket #5441&quot;&gt;#5441&lt;/a&gt; state:resolved] refactoring code to
determine aggregate column &lt;a href=
&quot;http://github.com/rails/rails/commit/fc1bd2bba49a8c3f424b9d6f4c13f430f5db3d5c&quot;&gt;
http://github.com/rails/rails/commit/fc1bd2bba49a8c3f424b9d6f4c13f4...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-09-30T18:17:59+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>3.0.0.rc2 :select &quot;activerecord 3.0&quot; calculations patch</tag>
      <title>[PATCH] ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-09-30T18:18:01+01:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">12</version>
      <user-name>Repository</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>(from [a8a62f87f6777b1bad8f38cc4b0239b74a4f8a7a]) [#5441 state:resolved] refactoring code to determine aggregate column
http://github.com/rails/rails/commit/a8a62f87f6777b1bad8f38cc4b0239b74a4f8a7a</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from &lt;a href=
&quot;/projects/8994/changesets/a8a62f87f6777b1bad8f38cc4b0239b74a4f8a7a&quot;
title=
&quot;Changeset [a8a62f87f6777b1bad8f38cc4b0239b74a4f8a7a]&quot;&gt;[a8a62f87f6777b1bad8f38cc4b0239b74a4f8a7a]&lt;/a&gt;)
[&lt;a href=&quot;/projects/8994/tickets/5441&quot; title=
&quot;Ticket #5441&quot;&gt;#5441&lt;/a&gt; state:resolved] refactoring code to
determine aggregate column &lt;a href=
&quot;http://github.com/rails/rails/commit/a8a62f87f6777b1bad8f38cc4b0239b74a4f8a7a&quot;&gt;
http://github.com/rails/rails/commit/a8a62f87f6777b1bad8f38cc4b0239...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-09-30T18:17:59+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>3.0.0.rc2 :select &quot;activerecord 3.0&quot; calculations patch</tag>
      <title>[PATCH] ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-09-30T18:18:02+01:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">13</version>
      <user-name>Repository</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>[[bulk edit](/projects/8994/bulk_edits/31647)]</body>
      <body-html>&lt;div&gt;&lt;p&gt;[&lt;a href=&quot;/projects/8994/bulk_edits/31647&quot;&gt;bulk edit&lt;/a&gt;]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-10-15T23:02:01+01:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- 
:milestone: 82861
</diffable-attributes>
      <milestone-id type="integer">88038</milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>3.0.0.rc2 :select &quot;activerecord 3.0&quot; calculations patch</tag>
      <title>[PATCH] ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2010-10-15T23:02:01+01:00</updated-at>
      <user-id type="integer">85</user-id>
      <version type="integer">14</version>
      <user-name>Jeremy Kemper</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title>3.0.2</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;wholesale authentic nfl jerseys&lt;/a&gt;
&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;nfl throwback jerseys&lt;/a&gt;
&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;authentic nfl jerseys&lt;/a&gt;
&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;discount nfl jerseys&lt;/a&gt;
&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;cheap nfl jerseys&lt;/a&gt;
&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;wholesale nfl jerseys&lt;/a&gt;
&lt;a href=&quot;http://www.wholesale-nflshop.com/&quot;&gt;wholesale nfl jerseys&lt;/a&gt;</body>
      <body-html>&lt;div&gt;&lt;p&gt;&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;wholesale authentic
nfl jerseys&lt;/a&gt;&lt;br&gt;
&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;nfl throwback
jerseys&lt;/a&gt;&lt;br&gt;
&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;authentic nfl
jerseys&lt;/a&gt;&lt;br&gt;
&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;discount nfl
jerseys&lt;/a&gt;&lt;br&gt;
&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;cheap nfl
jerseys&lt;/a&gt;&lt;br&gt;
&lt;a href=&quot;http://www.wholesalenflstore.com/&quot;&gt;wholesale nfl
jerseys&lt;/a&gt;&lt;br&gt;
&lt;a href=&quot;http://www.wholesale-nflshop.com/&quot;&gt;wholesale nfl
jerseys&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-01-04T09:24:34+00:00</created-at>
      <creator-id type="integer">12728</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">88038</milestone-id>
      <number type="integer">5441</number>
      <permalink>activerecordcalculationscount-doesnt-allow-table-names-in-column_name-argument</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>3.0.0.rc2 :select &quot;activerecord 3.0&quot; calculations patch</tag>
      <title>[PATCH] ActiveRecord::Calculations#count doesn't allow table names in column_name argument</title>
      <updated-at type="datetime">2011-01-04T16:24:47+00:00</updated-at>
      <user-id type="integer">131088</user-id>
      <version type="integer">15</version>
      <user-name>icooky</user-name>
      <creator-name>oleg dashevskii</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5441</url>
      <milestone-title>3.0.2</milestone-title>
      <priority-name>Low</priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>b9e87be8e0ad60913b7038997001af7450c1c475</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-08-25T09:53:38+01:00</created-at>
      <filename>0001-tests-proving-5441.patch</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">644094</id>
      <size type="integer">1499</size>
      <uploader-id type="integer">12728</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/644094/0001-tests-proving-5441.patch</url>
    </attachment>
    <attachment type="Attachment">
      <code>f99329bf0962d92980e038a3cbaefd3f50727715</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-08-31T18:12:12+01:00</created-at>
      <filename>0001-a-brute-force-fix-for-5441.patch</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">653251</id>
      <size type="integer">2573</size>
      <uploader-id type="integer">12728</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/653251/0001-a-brute-force-fix-for-5441.patch</url>
    </attachment>
  </attachments>
</ticket>
