<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer" nil="true"></assigned-user-id>
  <attachments-count type="integer">2</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2010-09-01T16:59:56+01:00</created-at>
  <creator-id type="integer">52024</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">5522</number>
  <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>duplicate</state>
  <tag>cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot; verified</tag>
  <title>Model classes are loaded before I18n is set when running tests.</title>
  <updated-at type="datetime">2011-02-07T13:54:56+00:00</updated-at>
  <user-id type="integer">103670</user-id>
  <version type="integer">22</version>
  <user-name>Franco Catena</user-name>
  <creator-name>Robert Pankowecki</creator-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
  <priority-name>Low</priority-name>
  <original-body>Model classes should be always loaded after full framework configuration.

@@@

# config/locales/en.yml 
en:
  hello: &quot;Hello world&quot;

# config/locales/pl.yml 
pl:
  hello: &quot;Witaj swiecie&quot;

# app/models/my_model.rb
class MyModel &lt; ActiveRecord::Base
  raise I18n.available_locales.inspect # just to demonstrate the bug
end

# test/unit/my_model_test.rb 
require 'test_helper'

class MyModelTest &lt; ActiveSupport::TestCase
  test &quot;the truth&quot; { MyModel }
end
@@@

As you can see there are 2 files with 2 different locales and my class depends on them ex.:

@@@
class MyModel &lt; ActiveRecord::Base
  I18n.available_locales.each do |locale|
    define_method(&quot;name_#{locale}&quot;) { ... do something ...} # This is what I actually do.
  end
end
@@@

When running from the console

@@@
&gt; rails cosnole
Loading development environment (Rails 3.0.0)
ruby-1.9.2-head &gt; MyModel
RuntimeError: [:en, :pl] 
	from /home/rupert/test/r3koma0/app/models/my_model.rb:3:in `&lt;class:MyModel&gt;'
	from /home/rupert/test/r3koma0/app/models/my_model.rb:1:in `&lt;top (required)&gt;'
@@@

everything is fine. Both locales ([:en, :pl]) are found and I'm happy.

However when running test:

@@@
ruby -Ilib:test test/unit/my_model_test.rb 

/home/rupert/test/r3koma0/app/models/my_model.rb:3:in `&lt;class:MyModel&gt;': [:en] (RuntimeError)
	from /home/rupert/test/r3koma0/app/models/my_model.rb:1:in `&lt;top (required)&gt;'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `require'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `block in require'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:227:in `load_dependency'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `require'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:346:in `require_or_load'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:300:in `depend_on'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:216:in `require_dependency'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:138:in `block (2 levels) in eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:137:in `each'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:137:in `block in eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:135:in `each'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:135:in `eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:108:in `eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application/finisher.rb:41:in `block in &lt;module:Finisher&gt;'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:25:in `instance_exec'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:25:in `run'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:50:in `block in run_initializers'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:49:in `each'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:49:in `run_initializers'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:134:in `initialize!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:77:in `method_missing'
	from /home/rupert/test/r3koma0/config/environment.rb:5:in `&lt;top (required)&gt;'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from /home/rupert/test/r3koma0/test/test_helper.rb:2:in `&lt;top (required)&gt;'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from test/unit/my_model_test.rb:1:in `&lt;main&gt;
@@@

As you can see during the test something is loaded in a different order and I18n is not set yet, thus only one locale ([:en]) is found. Maybe eager_load! is called to early before loading everything that is related to I18n ?

Changing the files to :

@@@
# test/unit/my_model_test.rb 
require 'test_helper'
class MyModelTest &lt; ActiveSupport::TestCase
  test &quot;the truth&quot; {raise I18n.available_locales.inspect}
end

# app/models/my_model.rb 
class MyModel &lt; ActiveRecord::Base
end
@@@

shows that after everything is loaded in test environment, locales are again properly returned:

@@@
ruby -Ilib:test test/unit/my_model_test.rb 
Loaded suite test/unit/my_model_test
Started
E
Finished in 0.018779 seconds.

  1) Error:
test_the_truth(MyModelTest):
RuntimeError: [:en, :pl]
    test/unit/my_model_test.rb:6:in `block in &lt;class:MyModelTest&gt;'

@@@</original-body>
  <latest-body>Model classes should be always loaded after full framework configuration.

@@@

# config/locales/en.yml 
en:
  hello: &quot;Hello world&quot;

# config/locales/pl.yml 
pl:
  hello: &quot;Witaj swiecie&quot;

# app/models/my_model.rb
class MyModel &lt; ActiveRecord::Base
  raise I18n.available_locales.inspect # just to demonstrate the bug
end

# test/unit/my_model_test.rb 
require 'test_helper'

class MyModelTest &lt; ActiveSupport::TestCase
  test &quot;the truth&quot; { MyModel }
end
@@@

As you can see there are 2 files with 2 different locales and my class depends on them ex.:

@@@
class MyModel &lt; ActiveRecord::Base
  I18n.available_locales.each do |locale|
    define_method(&quot;name_#{locale}&quot;) { ... do something ...} # This is what I actually do.
  end
end
@@@

When running from the console

@@@
&gt; rails cosnole
Loading development environment (Rails 3.0.0)
ruby-1.9.2-head &gt; MyModel
RuntimeError: [:en, :pl] 
	from /home/rupert/test/r3koma0/app/models/my_model.rb:3:in `&lt;class:MyModel&gt;'
	from /home/rupert/test/r3koma0/app/models/my_model.rb:1:in `&lt;top (required)&gt;'
@@@

everything is fine. Both locales ([:en, :pl]) are found and I'm happy.

However when running test:

@@@
ruby -Ilib:test test/unit/my_model_test.rb 

/home/rupert/test/r3koma0/app/models/my_model.rb:3:in `&lt;class:MyModel&gt;': [:en] (RuntimeError)
	from /home/rupert/test/r3koma0/app/models/my_model.rb:1:in `&lt;top (required)&gt;'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `require'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `block in require'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:227:in `load_dependency'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `require'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:346:in `require_or_load'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:300:in `depend_on'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:216:in `require_dependency'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:138:in `block (2 levels) in eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:137:in `each'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:137:in `block in eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:135:in `each'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:135:in `eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:108:in `eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application/finisher.rb:41:in `block in &lt;module:Finisher&gt;'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:25:in `instance_exec'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:25:in `run'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:50:in `block in run_initializers'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:49:in `each'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:49:in `run_initializers'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:134:in `initialize!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:77:in `method_missing'
	from /home/rupert/test/r3koma0/config/environment.rb:5:in `&lt;top (required)&gt;'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from /home/rupert/test/r3koma0/test/test_helper.rb:2:in `&lt;top (required)&gt;'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from test/unit/my_model_test.rb:1:in `&lt;main&gt;
@@@

As you can see during the test something is loaded in a different order and I18n is not set yet, thus only one locale ([:en]) is found. Maybe eager_load! is called to early before loading everything that is related to I18n ?

Changing the files to :

@@@
# test/unit/my_model_test.rb 
require 'test_helper'
class MyModelTest &lt; ActiveSupport::TestCase
  test &quot;the truth&quot; {raise I18n.available_locales.inspect}
end

# app/models/my_model.rb 
class MyModel &lt; ActiveRecord::Base
end
@@@

shows that after everything is loaded in test environment, locales are again properly returned:

@@@
ruby -Ilib:test test/unit/my_model_test.rb 
Loaded suite test/unit/my_model_test
Started
E
Finished in 0.018779 seconds.

  1) Error:
test_the_truth(MyModelTest):
RuntimeError: [:en, :pl]
    test/unit/my_model_test.rb:6:in `block in &lt;class:MyModelTest&gt;'

@@@</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;Model classes should be always loaded after full framework
configuration.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;
# config/locales/en.yml 
en:
  hello: &quot;Hello world&quot;

# config/locales/pl.yml 
pl:
  hello: &quot;Witaj swiecie&quot;

# app/models/my_model.rb
class MyModel &amp;lt; ActiveRecord::Base
  raise I18n.available_locales.inspect # just to demonstrate the bug
end

# test/unit/my_model_test.rb 
require 'test_helper'

class MyModelTest &amp;lt; ActiveSupport::TestCase
  test &quot;the truth&quot; { MyModel }
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;As you can see there are 2 files with 2 different locales and my
class depends on them ex.:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class MyModel &amp;lt; ActiveRecord::Base
  I18n.available_locales.each do |locale|
    define_method(&quot;name_#{locale}&quot;) { ... do something ...} # This is what I actually do.
  end
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;When running from the console&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;&amp;gt; rails cosnole
Loading development environment (Rails 3.0.0)
ruby-1.9.2-head &amp;gt; MyModel
RuntimeError: [:en, :pl] 
    from /home/rupert/test/r3koma0/app/models/my_model.rb:3:in `&amp;lt;class:MyModel&amp;gt;'
    from /home/rupert/test/r3koma0/app/models/my_model.rb:1:in `&amp;lt;top (required)&amp;gt;'&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;everything is fine. Both locales ([:en, :pl]) are found and I'm
happy.&lt;/p&gt;
&lt;p&gt;However when running test:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;ruby -Ilib:test test/unit/my_model_test.rb 

/home/rupert/test/r3koma0/app/models/my_model.rb:3:in `&amp;lt;class:MyModel&amp;gt;': [:en] (RuntimeError)
    from /home/rupert/test/r3koma0/app/models/my_model.rb:1:in `&amp;lt;top (required)&amp;gt;'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `require'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `block in require'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:227:in `load_dependency'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `require'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:346:in `require_or_load'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:300:in `depend_on'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:216:in `require_dependency'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:138:in `block (2 levels) in eager_load!'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:137:in `each'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:137:in `block in eager_load!'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:135:in `each'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:135:in `eager_load!'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:108:in `eager_load!'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application/finisher.rb:41:in `block in &amp;lt;module:Finisher&amp;gt;'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:25:in `instance_exec'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:25:in `run'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:50:in `block in run_initializers'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:49:in `each'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:49:in `run_initializers'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:134:in `initialize!'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:77:in `method_missing'
    from /home/rupert/test/r3koma0/config/environment.rb:5:in `&amp;lt;top (required)&amp;gt;'
    from &amp;lt;internal:lib/rubygems/custom_require&amp;gt;:29:in `require'
    from &amp;lt;internal:lib/rubygems/custom_require&amp;gt;:29:in `require'
    from /home/rupert/test/r3koma0/test/test_helper.rb:2:in `&amp;lt;top (required)&amp;gt;'
    from &amp;lt;internal:lib/rubygems/custom_require&amp;gt;:29:in `require'
    from &amp;lt;internal:lib/rubygems/custom_require&amp;gt;:29:in `require'
    from test/unit/my_model_test.rb:1:in `&amp;lt;main&amp;gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;As you can see during the test something is loaded in a
different order and I18n is not set yet, thus only one locale
([:en]) is found. Maybe eager_load! is called to early before
loading everything that is related to I18n ?&lt;/p&gt;
&lt;p&gt;Changing the files to :&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;# test/unit/my_model_test.rb 
require 'test_helper'
class MyModelTest &amp;lt; ActiveSupport::TestCase
  test &quot;the truth&quot; {raise I18n.available_locales.inspect}
end

# app/models/my_model.rb 
class MyModel &amp;lt; ActiveRecord::Base
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;shows that after everything is loaded in test environment,
locales are again properly returned:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;ruby -Ilib:test test/unit/my_model_test.rb 
Loaded suite test/unit/my_model_test
Started
E
Finished in 0.018779 seconds.

  1) Error:
test_the_truth(MyModelTest):
RuntimeError: [:en, :pl]
    test/unit/my_model_test.rb:6:in `block in &amp;lt;class:MyModelTest&amp;gt;'&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Model classes should be always loaded after full framework configuration.

@@@

# config/locales/en.yml 
en:
  hello: &quot;Hello world&quot;

# config/locales/pl.yml 
pl:
  hello: &quot;Witaj swiecie&quot;

# app/models/my_model.rb
class MyModel &lt; ActiveRecord::Base
  raise I18n.available_locales.inspect # just to demonstrate the bug
end

# test/unit/my_model_test.rb 
require 'test_helper'

class MyModelTest &lt; ActiveSupport::TestCase
  test &quot;the truth&quot; { MyModel }
end
@@@

As you can see there are 2 files with 2 different locales and my class depends on them ex.:

@@@
class MyModel &lt; ActiveRecord::Base
  I18n.available_locales.each do |locale|
    define_method(&quot;name_#{locale}&quot;) { ... do something ...} # This is what I actually do.
  end
end
@@@

When running from the console

@@@
&gt; rails cosnole
Loading development environment (Rails 3.0.0)
ruby-1.9.2-head &gt; MyModel
RuntimeError: [:en, :pl] 
	from /home/rupert/test/r3koma0/app/models/my_model.rb:3:in `&lt;class:MyModel&gt;'
	from /home/rupert/test/r3koma0/app/models/my_model.rb:1:in `&lt;top (required)&gt;'
@@@

everything is fine. Both locales ([:en, :pl]) are found and I'm happy.

However when running test:

@@@
ruby -Ilib:test test/unit/my_model_test.rb 

/home/rupert/test/r3koma0/app/models/my_model.rb:3:in `&lt;class:MyModel&gt;': [:en] (RuntimeError)
	from /home/rupert/test/r3koma0/app/models/my_model.rb:1:in `&lt;top (required)&gt;'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `require'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `block in require'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:227:in `load_dependency'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `require'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:346:in `require_or_load'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:300:in `depend_on'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:216:in `require_dependency'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:138:in `block (2 levels) in eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:137:in `each'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:137:in `block in eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:135:in `each'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:135:in `eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:108:in `eager_load!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application/finisher.rb:41:in `block in &lt;module:Finisher&gt;'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:25:in `instance_exec'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:25:in `run'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:50:in `block in run_initializers'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:49:in `each'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:49:in `run_initializers'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:134:in `initialize!'
	from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:77:in `method_missing'
	from /home/rupert/test/r3koma0/config/environment.rb:5:in `&lt;top (required)&gt;'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from /home/rupert/test/r3koma0/test/test_helper.rb:2:in `&lt;top (required)&gt;'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from &lt;internal:lib/rubygems/custom_require&gt;:29:in `require'
	from test/unit/my_model_test.rb:1:in `&lt;main&gt;
@@@

As you can see during the test something is loaded in a different order and I18n is not set yet, thus only one locale ([:en]) is found. Maybe eager_load! is called to early before loading everything that is related to I18n ?

Changing the files to :

@@@
# test/unit/my_model_test.rb 
require 'test_helper'
class MyModelTest &lt; ActiveSupport::TestCase
  test &quot;the truth&quot; {raise I18n.available_locales.inspect}
end

# app/models/my_model.rb 
class MyModel &lt; ActiveRecord::Base
end
@@@

shows that after everything is loaded in test environment, locales are again properly returned:

@@@
ruby -Ilib:test test/unit/my_model_test.rb 
Loaded suite test/unit/my_model_test
Started
E
Finished in 0.018779 seconds.

  1) Error:
test_the_truth(MyModelTest):
RuntimeError: [:en, :pl]
    test/unit/my_model_test.rb:6:in `block in &lt;class:MyModelTest&gt;'

@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;Model classes should be always loaded after full framework
configuration.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;
# config/locales/en.yml 
en:
  hello: &quot;Hello world&quot;

# config/locales/pl.yml 
pl:
  hello: &quot;Witaj swiecie&quot;

# app/models/my_model.rb
class MyModel &amp;lt; ActiveRecord::Base
  raise I18n.available_locales.inspect # just to demonstrate the bug
end

# test/unit/my_model_test.rb 
require 'test_helper'

class MyModelTest &amp;lt; ActiveSupport::TestCase
  test &quot;the truth&quot; { MyModel }
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;As you can see there are 2 files with 2 different locales and my
class depends on them ex.:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class MyModel &amp;lt; ActiveRecord::Base
  I18n.available_locales.each do |locale|
    define_method(&quot;name_#{locale}&quot;) { ... do something ...} # This is what I actually do.
  end
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;When running from the console&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;&amp;gt; rails cosnole
Loading development environment (Rails 3.0.0)
ruby-1.9.2-head &amp;gt; MyModel
RuntimeError: [:en, :pl] 
    from /home/rupert/test/r3koma0/app/models/my_model.rb:3:in `&amp;lt;class:MyModel&amp;gt;'
    from /home/rupert/test/r3koma0/app/models/my_model.rb:1:in `&amp;lt;top (required)&amp;gt;'&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;everything is fine. Both locales ([:en, :pl]) are found and I'm
happy.&lt;/p&gt;
&lt;p&gt;However when running test:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;ruby -Ilib:test test/unit/my_model_test.rb 

/home/rupert/test/r3koma0/app/models/my_model.rb:3:in `&amp;lt;class:MyModel&amp;gt;': [:en] (RuntimeError)
    from /home/rupert/test/r3koma0/app/models/my_model.rb:1:in `&amp;lt;top (required)&amp;gt;'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `require'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `block in require'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:227:in `load_dependency'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:239:in `require'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:346:in `require_or_load'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:300:in `depend_on'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.0/lib/active_support/dependencies.rb:216:in `require_dependency'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:138:in `block (2 levels) in eager_load!'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:137:in `each'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:137:in `block in eager_load!'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:135:in `each'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/engine.rb:135:in `eager_load!'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:108:in `eager_load!'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application/finisher.rb:41:in `block in &amp;lt;module:Finisher&amp;gt;'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:25:in `instance_exec'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:25:in `run'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:50:in `block in run_initializers'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:49:in `each'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/initializable.rb:49:in `run_initializers'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:134:in `initialize!'
    from /home/rupert/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.0/lib/rails/application.rb:77:in `method_missing'
    from /home/rupert/test/r3koma0/config/environment.rb:5:in `&amp;lt;top (required)&amp;gt;'
    from &amp;lt;internal:lib/rubygems/custom_require&amp;gt;:29:in `require'
    from &amp;lt;internal:lib/rubygems/custom_require&amp;gt;:29:in `require'
    from /home/rupert/test/r3koma0/test/test_helper.rb:2:in `&amp;lt;top (required)&amp;gt;'
    from &amp;lt;internal:lib/rubygems/custom_require&amp;gt;:29:in `require'
    from &amp;lt;internal:lib/rubygems/custom_require&amp;gt;:29:in `require'
    from test/unit/my_model_test.rb:1:in `&amp;lt;main&amp;gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;As you can see during the test something is loaded in a
different order and I18n is not set yet, thus only one locale
([:en]) is found. Maybe eager_load! is called to early before
loading everything that is related to I18n ?&lt;/p&gt;
&lt;p&gt;Changing the files to :&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;# test/unit/my_model_test.rb 
require 'test_helper'
class MyModelTest &amp;lt; ActiveSupport::TestCase
  test &quot;the truth&quot; {raise I18n.available_locales.inspect}
end

# app/models/my_model.rb 
class MyModel &amp;lt; ActiveRecord::Base
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;shows that after everything is loaded in test environment,
locales are again properly returned:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;ruby -Ilib:test test/unit/my_model_test.rb 
Loaded suite test/unit/my_model_test
Started
E
Finished in 0.018779 seconds.

  1) Error:
test_the_truth(MyModelTest):
RuntimeError: [:en, :pl]
    test/unit/my_model_test.rb:6:in `block in &amp;lt;class:MyModelTest&amp;gt;'&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-09-01T16:59:56+01:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>eager_loading i18n rails3 test &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-09-01T16:59:58+01:00</updated-at>
      <user-id type="integer">52024</user-id>
      <version type="integer">1</version>
      <user-name>Robert Pankowecki</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I have the same problem, the i18n configuration is not loaded consistently across environmets. I create a patch that fix this, is for the master branch, but can be easily implemented in the other 3.X branches (only 3 lines of code).

I hope this helps anyone with the same problem.

Regards.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I have the same problem, the i18n configuration is not loaded
consistently across environmets. I create a patch that fix this, is
for the master branch, but can be easily implemented in the other
3.X branches (only 3 lines of code).&lt;/p&gt;
&lt;p&gt;I hope this helps anyone with the same problem.&lt;/p&gt;
&lt;p&gt;Regards.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-18T13:00:08+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: eager_loading i18n rails3 test &quot;testing environment&quot;
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>eager_loading i18n rails3</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-18T13:00:12+00:00</updated-at>
      <user-id type="integer">103670</user-id>
      <version type="integer">2</version>
      <user-name>Franco Catena</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Sorry, I accidentally delete the testing environment tag.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Sorry, I accidentally delete the testing environment tag.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-18T13:04:28+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: eager_loading i18n rails3
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>eager_loading i18n rails3 &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-18T13:04:30+00:00</updated-at>
      <user-id type="integer">103670</user-id>
      <version type="integer">3</version>
      <user-name>Franco Catena</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>It is nice to have a fix and it would be even better to have a test for this so it will not change accidentally in the future.</body>
      <body-html>&lt;div&gt;&lt;p&gt;It is nice to have a fix and it would be even better to have a
test for this so it will not change accidentally in the future.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-18T13:10:51+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>eager_loading i18n rails3 &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-18T13:10:55+00:00</updated-at>
      <user-id type="integer">52024</user-id>
      <version type="integer">4</version>
      <user-name>Robert Pankowecki</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Yes, I am working on the tests and an improvement of this patch, because only works when you have cache_classes = true (I just notice that, so is better avoid using it for now).</body>
      <body-html>&lt;div&gt;&lt;p&gt;Yes, I am working on the tests and an improvement of this patch,
because only works when you have cache_classes = true (I just
notice that, so is better avoid using it for now).&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-18T21:13:01+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>eager_loading i18n rails3 &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-18T21:13:02+00:00</updated-at>
      <user-id type="integer">103670</user-id>
      <version type="integer">5</version>
      <user-name>Franco Catena</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Thanks for your time and paying attention to this bug. I really appreciate that.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Thanks for your time and paying attention to this bug. I really
appreciate that.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-18T23:01:14+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>eager_loading i18n rails3 &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-18T23:01:15+00:00</updated-at>
      <user-id type="integer">52024</user-id>
      <version type="integer">6</version>
      <user-name>Robert Pankowecki</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>OK, there I go again.

* **Short version**: the patch fix this issue

* **Long version**: the configuration of the i18n railtie was in the after_initialize callback of the Rails configuration hooks, they are called *after* the classes eager load proccess. In the current schema of callbacks this can not be fixed, so I add the after_configuration method to the Rails configuration hooks (just when finisher starts). I make 2 new tests in the i18n initializer tests for this and include the new hook in the hook's tests.

Is a messy explanation, I know =).

Regards.</body>
      <body-html>&lt;div&gt;&lt;p&gt;OK, there I go again.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Short version&lt;/strong&gt;: the patch fix this issue&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;strong&gt;Long version&lt;/strong&gt;: the configuration of the i18n
railtie was in the after_initialize callback of the Rails
configuration hooks, they are called &lt;em&gt;after&lt;/em&gt; the classes
eager load proccess. In the current schema of callbacks this can
not be fixed, so I add the after_configuration method to the Rails
configuration hooks (just when finisher starts). I make 2 new tests
in the i18n initializer tests for this and include the new hook in
the hook's tests.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Is a messy explanation, I know =).&lt;/p&gt;
&lt;p&gt;Regards.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-23T16:10:00+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>eager_loading i18n rails3 &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-23T16:10:05+00:00</updated-at>
      <user-id type="integer">103670</user-id>
      <version type="integer">7</version>
      <user-name>Franco Catena</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>I wish I could test it but master branch is failing due to &quot;Rack::Session::Abstract::SessionHash&quot; when running `rails console`.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I wish I could test it but master branch is failing due to
&quot;Rack::Session::Abstract::SessionHash&quot; when running &lt;code&gt;rails
console&lt;/code&gt;.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-23T17:02:27+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>eager_loading i18n rails3 &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-23T17:02:30+00:00</updated-at>
      <user-id type="integer">52024</user-id>
      <version type="integer">8</version>
      <user-name>Robert Pankowecki</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-23T17:02:41+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: eager_loading i18n rails3 &quot;testing environment&quot;
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>eager_loading i18n patch rails3 &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-23T17:02:46+00:00</updated-at>
      <user-id type="integer">52024</user-id>
      <version type="integer">9</version>
      <user-name>Robert Pankowecki</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Robert, I make one patch for the 3.0 stable branch (because this must be fixed in 3.0 too), I hope you can try this.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Robert, I make one patch for the 3.0 stable branch (because this
must be fixed in 3.0 too), I hope you can try this.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-23T17:27:06+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>eager_loading i18n patch rails3 &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-23T17:27:14+00:00</updated-at>
      <user-id type="integer">103670</user-id>
      <version type="integer">10</version>
      <user-name>Franco Catena</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>I checked the patch for 3.0-stable and it works ok for the case described in this ticket.
Thank you!</body>
      <body-html>&lt;div&gt;&lt;p&gt;I checked the patch for 3.0-stable and it works ok for the case
described in this ticket.&lt;br&gt;
Thank you!&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-24T08:41:59+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>eager_loading i18n patch rails3 &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-24T08:42:01+00:00</updated-at>
      <user-id type="integer">52024</user-id>
      <version type="integer">11</version>
      <user-name>Robert Pankowecki</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-24T08:49:12+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: eager_loading i18n patch rails3 &quot;testing environment&quot;
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>cache_classes eager_loading i18n patch rails3 &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-24T08:49:14+00:00</updated-at>
      <user-id type="integer">52024</user-id>
      <version type="integer">12</version>
      <user-name>Robert Pankowecki</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>I checked that patch today at work, and it works for me ;)</body>
      <body-html>&lt;div&gt;&lt;p&gt;I checked that patch today at work, and it works for me ;)&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-24T08:51:42+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>cache_classes eager_loading i18n patch rails3 &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-24T08:51:45+00:00</updated-at>
      <user-id type="integer">122992</user-id>
      <version type="integer">13</version>
      <user-name>lewy313</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>OK, thank you for the confirmations, I will update the tags to add *verified* and *railties*.</body>
      <body-html>&lt;div&gt;&lt;p&gt;OK, thank you for the confirmations, I will update the tags to
add &lt;em&gt;verified&lt;/em&gt; and &lt;em&gt;railties&lt;/em&gt;.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-24T11:51:21+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: cache_classes eager_loading i18n patch rails3 &quot;testing environment&quot;
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot; verified</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-24T11:51:22+00:00</updated-at>
      <user-id type="integer">103670</user-id>
      <version type="integer">14</version>
      <user-name>Franco Catena</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>Ops I don't read well, It sais 3 people, tag verified removed</body>
      <body-html>&lt;div&gt;&lt;p&gt;Ops I don't read well, It sais 3 people, tag verified
removed&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-24T11:53:01+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot; verified
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-24T11:53:03+00:00</updated-at>
      <user-id type="integer">103670</user-id>
      <version type="integer">15</version>
      <user-name>Franco Catena</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>The patch works for me too.</body>
      <body-html>&lt;div&gt;&lt;p&gt;The patch works for me too.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-24T15:34:49+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot;</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-24T15:34:51+00:00</updated-at>
      <user-id type="integer">126536</user-id>
      <version type="integer">16</version>
      <user-name>Mi&#322;osz Jerkiewicz</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-25T11:38:54+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot;
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot; verified</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2010-11-25T11:38:55+00:00</updated-at>
      <user-id type="integer">103670</user-id>
      <version type="integer">17</version>
      <user-name>Franco Catena</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Is #6353 about the same issue as this ticket? In case one wants to coordinate the patches...</body>
      <body-html>&lt;div&gt;&lt;p&gt;Is &lt;a href=&quot;/projects/8994/tickets/6353&quot; title=
&quot;Ticket #6353&quot;&gt;#6353&lt;/a&gt; about the same issue as this ticket? In
case one wants to coordinate the patches...&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-02-07T13:03:34+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot; verified</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2011-02-07T13:03:43+00:00</updated-at>
      <user-id type="integer">135958</user-id>
      <version type="integer">18</version>
      <user-name>tbh</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Fixed on #6353.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Fixed on &lt;a href=&quot;/projects/8994/tickets/6353&quot; title=
&quot;Ticket #6353&quot;&gt;#6353&lt;/a&gt;.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-07T13:09:36+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>duplicate</state>
      <tag>cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot; verified</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2011-02-07T13:09:49+00:00</updated-at>
      <user-id type="integer">19965</user-id>
      <version type="integer">19</version>
      <user-name>Jos&#233; Valim</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>It is a shame, I do not know what is wrong with this path, why the one in #6353 was accepted and this is not.</body>
      <body-html>&lt;div&gt;&lt;p&gt;It is a shame, I do not know what is wrong with this path, why
the one in &lt;a href=&quot;/projects/8994/tickets/6353&quot; title=
&quot;Ticket #6353&quot;&gt;#6353&lt;/a&gt; was accepted and this is not.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-07T13:19:50+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>duplicate</state>
      <tag>cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot; verified</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2011-02-07T13:20:05+00:00</updated-at>
      <user-id type="integer">103670</user-id>
      <version type="integer">20</version>
      <user-name>Franco Catena</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Sorry Franco, but it was not intentional. Somehow, #6353 found his way to a Rails Core first. :( I just got to know about this one after someone dropped a comment on #6353.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Sorry Franco, but it was not intentional. Somehow, &lt;a href=
&quot;/projects/8994/tickets/6353&quot; title=&quot;Ticket #6353&quot;&gt;#6353&lt;/a&gt; found
his way to a Rails Core first. :( I just got to know about this one
after someone dropped a comment on &lt;a href=
&quot;/projects/8994/tickets/6353&quot; title=&quot;Ticket #6353&quot;&gt;#6353&lt;/a&gt;.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-07T13:36:13+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>duplicate</state>
      <tag>cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot; verified</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2011-02-07T13:36:27+00:00</updated-at>
      <user-id type="integer">19965</user-id>
      <version type="integer">21</version>
      <user-name>Jos&#233; Valim</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>OK Jos&#233;, no problem, thank you for you concern.</body>
      <body-html>&lt;div&gt;&lt;p&gt;OK Jos&amp;eacute;, no problem, thank you for you concern.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-07T13:54:41+00:00</created-at>
      <creator-id type="integer">52024</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5522</number>
      <permalink>model-classes-are-loaded-before-i18n-is-set-when-running-tests</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>duplicate</state>
      <tag>cache_classes eager_loading i18n patch rails3 railties &quot;testing environment&quot; verified</tag>
      <title>Model classes are loaded before I18n is set when running tests.</title>
      <updated-at type="datetime">2011-02-07T13:54:56+00:00</updated-at>
      <user-id type="integer">103670</user-id>
      <version type="integer">22</version>
      <user-name>Franco Catena</user-name>
      <creator-name>Robert Pankowecki</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5522</url>
      <priority-name>Low</priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>567c386f01323be573286a6f2e4a0d04743cd9f0</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-11-23T16:10:00+00:00</created-at>
      <filename>fix_active_support_i18n_load_2.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">785503</id>
      <size type="integer">6268</size>
      <uploader-id type="integer">103670</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/785503/fix_active_support_i18n_load_2.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>f358c7b85e6f47e0f5f72f6d49895fb5d7570867</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-11-23T17:27:06+00:00</created-at>
      <filename>3-0-stable_fix_active_support_i18n_load_2.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">785833</id>
      <size type="integer">6504</size>
      <uploader-id type="integer">103670</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/785833/3-0-stable_fix_active_support_i18n_load_2.diff</url>
    </attachment>
  </attachments>
</ticket>
