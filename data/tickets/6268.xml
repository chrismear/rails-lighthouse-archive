<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">15316</assigned-user-id>
  <attachments-count type="integer">0</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2011-01-08T20:18:18+00:00</created-at>
  <creator-id type="integer">80</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer">71472</milestone-id>
  <number type="integer">6268</number>
  <permalink>arel-offset-count-good</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>resolved</state>
  <tag>&quot;arel rails3&quot;</tag>
  <title>[Arel] Offset + Count != good</title>
  <updated-at type="datetime">2011-03-09T20:15:04+00:00</updated-at>
  <user-id type="integer">139717</user-id>
  <version type="integer">7</version>
  <user-name>John Mileham</user-name>
  <creator-name>Tobias L&#252;tke</creator-name>
  <assigned-user-name>Aaron Patterson</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/6268</url>
  <milestone-title>3.x</milestone-title>
  <priority-name>Low</priority-name>
  <original-body>Bug in query planner, produces poor SQL:


ree-1.8.7-2010.02 &gt; Order.offset(1).count #=&gt; 0 # (200 in table)
  SQL (0.3ms)  SELECT COUNT(*) FROM `orders` LIMIT 18446744073709551615 OFFSET 1</original-body>
  <latest-body>Bug in query planner, produces poor SQL:


ree-1.8.7-2010.02 &gt; Order.offset(1).count #=&gt; 0 # (200 in table)
  SQL (0.3ms)  SELECT COUNT(*) FROM `orders` LIMIT 18446744073709551615 OFFSET 1</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;Bug in query planner, produces poor SQL:&lt;/p&gt;
&lt;p&gt;ree-1.8.7-2010.02 &amp;gt; Order.offset(1).count #=&amp;gt; 0 # (200 in
table)&lt;br&gt;
SQL (0.3ms) SELECT COUNT(*) FROM &lt;code&gt;orders&lt;/code&gt; LIMIT
18446744073709551615 OFFSET 1&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Bug in query planner, produces poor SQL:


ree-1.8.7-2010.02 &gt; Order.offset(1).count #=&gt; 0 # (200 in table)
  SQL (0.3ms)  SELECT COUNT(*) FROM `orders` LIMIT 18446744073709551615 OFFSET 1</body>
      <body-html>&lt;div&gt;&lt;p&gt;Bug in query planner, produces poor SQL:&lt;/p&gt;
&lt;p&gt;ree-1.8.7-2010.02 &amp;gt; Order.offset(1).count #=&amp;gt; 0 # (200 in
table)&lt;br&gt;
SQL (0.3ms) SELECT COUNT(*) FROM &lt;code&gt;orders&lt;/code&gt; LIMIT
18446744073709551615 OFFSET 1&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-08T20:18:18+00:00</created-at>
      <creator-id type="integer">80</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6268</number>
      <permalink>arel-offset-count-good</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>&quot;arel rails3&quot;</tag>
      <title>[Arel] Offset + Count != good</title>
      <updated-at type="datetime">2011-01-08T20:18:29+00:00</updated-at>
      <user-id type="integer">80</user-id>
      <version type="integer">1</version>
      <user-name>Tobias L&#252;tke</user-name>
      <creator-name>Tobias L&#252;tke</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6268</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Hi Tobias, what database are you using?  From the SQL generated, I assume mysql?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Hi Tobias, what database are you using? From the SQL generated,
I assume mysql?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-14T18:40:00+00:00</created-at>
      <creator-id type="integer">80</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6268</number>
      <permalink>arel-offset-count-good</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>&quot;arel rails3&quot;</tag>
      <title>[Arel] Offset + Count != good</title>
      <updated-at type="datetime">2011-01-14T18:40:11+00:00</updated-at>
      <user-id type="integer">15316</user-id>
      <version type="integer">2</version>
      <user-name>Aaron Patterson</user-name>
      <creator-name>Tobias L&#252;tke</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6268</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>yes this is mysql. Frankly i think the right fix is to always clean out any offset if it's a .count query. I found quite a few current_orders.except(:offset).count like queries in the Shopify codebase already.</body>
      <body-html>&lt;div&gt;&lt;p&gt;yes this is mysql. Frankly i think the right fix is to always
clean out any offset if it's a .count query. I found quite a few
current_orders.except(:offset).count like queries in the Shopify
codebase already.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-14T20:03:51+00:00</created-at>
      <creator-id type="integer">80</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6268</number>
      <permalink>arel-offset-count-good</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>&quot;arel rails3&quot;</tag>
      <title>[Arel] Offset + Count != good</title>
      <updated-at type="datetime">2011-01-14T20:04:01+00:00</updated-at>
      <user-id type="integer">80</user-id>
      <version type="integer">3</version>
      <user-name>Tobias L&#252;tke</user-name>
      <creator-name>Tobias L&#252;tke</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6268</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Is AR setting the offset, or is that coming from your application code?

I tend to agree with you about removing the offset on count(*) queries.  I just wonder if anyone is relying on this functionality.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Is AR setting the offset, or is that coming from your
application code?&lt;/p&gt;
&lt;p&gt;I tend to agree with you about removing the offset on count(*)
queries. I just wonder if anyone is relying on this
functionality.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-18T22:39:10+00:00</created-at>
      <creator-id type="integer">80</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6268</number>
      <permalink>arel-offset-count-good</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>&quot;arel rails3&quot;</tag>
      <title>[Arel] Offset + Count != good</title>
      <updated-at type="datetime">2011-01-18T22:39:28+00:00</updated-at>
      <user-id type="integer">15316</user-id>
      <version type="integer">4</version>
      <user-name>Aaron Patterson</user-name>
      <creator-name>Tobias L&#252;tke</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6268</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>It comes from our application code, we have methods such as
shop.orders.filter_by_params(params) which looks at things like :page,
:order_status etc.

Because it looks at .page it has to add a offset, however we still need to
query the .count from the arel object after the filters have been applied,
hence .except(:offset).count.

I don't think anyone relies on this functionality. Offset + count(*) leads
to undefined behavior in most SQL servers.


- tobi</body>
      <body-html>&lt;div&gt;&lt;p&gt;It comes from our application code, we have methods such as&lt;br&gt;
shop.orders.filter_by_params(params) which looks at things like
:page,&lt;br&gt;
:order_status etc.&lt;/p&gt;
&lt;p&gt;Because it looks at .page it has to add a offset, however we
still need to&lt;br&gt;
query the .count from the arel object after the filters have been
applied,&lt;br&gt;
hence .except(:offset).count.&lt;/p&gt;
&lt;p&gt;I don't think anyone relies on this functionality. Offset +
count(*) leads&lt;br&gt;
to undefined behavior in most SQL servers.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;tobi&lt;/li&gt;
&lt;/ul&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-18T23:04:26+00:00</created-at>
      <creator-id type="integer">80</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6268</number>
      <permalink>arel-offset-count-good</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>&quot;arel rails3&quot;</tag>
      <title>[Arel] Offset + Count != good</title>
      <updated-at type="datetime">2011-01-18T23:04:36+00:00</updated-at>
      <user-id type="integer">80</user-id>
      <version type="integer">5</version>
      <user-name>Tobias L&#252;tke</user-name>
      <creator-name>Tobias L&#252;tke</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6268</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>(from [54a2bf66019d2694ff53f666765faf5bca927c09]) removing limits and offsets from COUNT queries unless both are specified. [#6268 state:resolved]
https://github.com/rails/rails/commit/54a2bf66019d2694ff53f666765faf5bca927c09</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from &lt;a href=
&quot;/projects/8994/changesets/54a2bf66019d2694ff53f666765faf5bca927c09&quot;
title=
&quot;Changeset [54a2bf66019d2694ff53f666765faf5bca927c09]&quot;&gt;[54a2bf66019d2694ff53f666765faf5bca927c09]&lt;/a&gt;)
removing limits and offsets from COUNT queries unless both are
specified. [&lt;a href=&quot;/projects/8994/tickets/6268&quot; title=
&quot;Ticket #6268&quot;&gt;#6268&lt;/a&gt; state:resolved] &lt;a href=
&quot;https://github.com/rails/rails/commit/54a2bf66019d2694ff53f666765faf5bca927c09&quot;&gt;
https://github.com/rails/rails/commit/54a2bf66019d2694ff53f666765fa...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-25T23:40:35+00:00</created-at>
      <creator-id type="integer">80</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6268</number>
      <permalink>arel-offset-count-good</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>&quot;arel rails3&quot;</tag>
      <title>[Arel] Offset + Count != good</title>
      <updated-at type="datetime">2011-02-25T23:40:46+00:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">6</version>
      <user-name>Repository</user-name>
      <creator-name>Tobias L&#252;tke</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6268</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Hi,

Just wanted to note here that I submitted a patch for #5060 that would change the semantics of #count to apply the :limit and :offset first.  If that approach were accepted, it would change the behavior associated with this ticket as well.  It would also make #count consistent in behavior with ActiveRecord's other aggregate calculations (like sum).  Tobias, it seems that such behavior would probably be what your app was expecting as well when passing in scopes with limits and offsets?  Any feedback would be appreciated.

https://rails.lighthouseapp.com/projects/8994/tickets/5060-activerelation-offsetempty-produces-unexpected-result#ticket-5060-23

Thanks,
-john</body>
      <body-html>&lt;div&gt;&lt;p&gt;Hi,&lt;/p&gt;
&lt;p&gt;Just wanted to note here that I submitted a patch for &lt;a href=
&quot;/projects/8994/tickets/5060&quot; title=&quot;Ticket #5060&quot;&gt;#5060&lt;/a&gt; that
would change the semantics of #count to apply the :limit and
:offset first. If that approach were accepted, it would change the
behavior associated with this ticket as well. It would also make
#count consistent in behavior with ActiveRecord's other aggregate
calculations (like sum). Tobias, it seems that such behavior would
probably be what your app was expecting as well when passing in
scopes with limits and offsets? Any feedback would be
appreciated.&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;https://rails.lighthouseapp.com/projects/8994/tickets/5060-activerelation-offsetempty-produces-unexpected-result#ticket-5060-23&quot;&gt;
https://rails.lighthouseapp.com/projects/8994/tickets/5060-activere...&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Thanks,&lt;br&gt;
-john&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-03-09T20:14:51+00:00</created-at>
      <creator-id type="integer">80</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6268</number>
      <permalink>arel-offset-count-good</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>&quot;arel rails3&quot;</tag>
      <title>[Arel] Offset + Count != good</title>
      <updated-at type="datetime">2011-03-09T20:15:04+00:00</updated-at>
      <user-id type="integer">139717</user-id>
      <version type="integer">7</version>
      <user-name>John Mileham</user-name>
      <creator-name>Tobias L&#252;tke</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6268</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
  </versions>
</ticket>
