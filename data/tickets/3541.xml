<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">19965</assigned-user-id>
  <attachments-count type="integer">1</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2010-07-26T08:44:38+01:00</created-at>
  <creator-id type="integer">10329</creator-id>
  <milestone-due-on type="datetime">2010-11-15T00:00:00+00:00</milestone-due-on>
  <milestone-id type="integer">88038</milestone-id>
  <number type="integer">3541</number>
  <permalink>content-negotiation-regression</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>committed</state>
  <tag>content_type rails3</tag>
  <title>Content Negotiation Regression</title>
  <updated-at type="datetime">2010-11-20T20:39:00+00:00</updated-at>
  <user-id type="integer">8551</user-id>
  <version type="integer">16</version>
  <user-name>Fjan</user-name>
  <creator-name>Paul Sadauskas (Rando)</creator-name>
  <assigned-user-name>Jos&#233; Valim</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
  <milestone-title>3.0.2</milestone-title>
  <priority-name>Low</priority-name>
  <original-body>A recent change in Rails3 rendering/respond_to code completely broke content negotiation. This commit[1] causes any request that 1) does not have a .format param, 2) is not xhr, and 3) CONTAINS A COMMA in the Accept header to return an html document.

So if, for example, you have a resource that provides html, xml, and json, and a web service client that accepts both xml and json, you get html. Also, if you have a web service similar to Sun's Cloud offering which uses custom mime-types to indicate various flavors of json, you would get html. If the resource does not provide an html content-type at all, you would get a 406 Not Acceptable response!

I discussed this with Yehuda, and this change was intended, to work around a bug in Safari's Accept header, which prefers xml over html. The way this was avoiding in Rails 2.x was to make sure the html block occured first in the respond_to block. I'm not sure if the recent changes to support respond_with prompted this change, but I hope that it be reverted to the old behaviour. 

The easiest solution is to just ignore the quality parameter of the accept header, and just serve the first acceptable response. This would still require users to specify the html first, but it should not be a problem if it is well-documented. Another solution, that is more magical, would be to always prefer html over everything else, if the client accepts html or */*.

I have attached[2] a failing test to demonstrate this behavior.

[1]: http://github.com/rails/rails/commit/1310231c15742bf7d99e2f143d88b383c32782d3#L2R172
[2]: http://gist.github.com/237075</original-body>
  <latest-body>A recent change in Rails3 rendering/respond_to code completely broke content negotiation. This commit[1] causes any request that 1) does not have a .format param, 2) is not xhr, and 3) CONTAINS A COMMA in the Accept header to return an html document.

So if, for example, you have a resource that provides html, xml, and json, and a web service client that accepts both xml and json, you get html. Also, if you have a web service similar to Sun's Cloud offering which uses custom mime-types to indicate various flavors of json, you would get html. If the resource does not provide an html content-type at all, you would get a 406 Not Acceptable response!

I discussed this with Yehuda, and this change was intended, to work around a bug in Safari's Accept header, which prefers xml over html. The way this was avoiding in Rails 2.x was to make sure the html block occured first in the respond_to block. I'm not sure if the recent changes to support respond_with prompted this change, but I hope that it be reverted to the old behaviour. 

The easiest solution is to just ignore the quality parameter of the accept header, and just serve the first acceptable response. This would still require users to specify the html first, but it should not be a problem if it is well-documented. Another solution, that is more magical, would be to always prefer html over everything else, if the client accepts html or */*.

I have attached[2] a failing test to demonstrate this behavior.

[1]: http://github.com/rails/rails/commit/1310231c15742bf7d99e2f143d88b383c32782d3#L2R172
[2]: http://gist.github.com/237075</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;A recent change in Rails3 rendering/respond_to code completely
broke content negotiation. This commit[1] causes any request that
1) does not have a .format param, 2) is not xhr, and 3) CONTAINS A
COMMA in the Accept header to return an html document.&lt;/p&gt;
&lt;p&gt;So if, for example, you have a resource that provides html, xml,
and json, and a web service client that accepts both xml and json,
you get html. Also, if you have a web service similar to Sun's
Cloud offering which uses custom mime-types to indicate various
flavors of json, you would get html. If the resource does not
provide an html content-type at all, you would get a 406 Not
Acceptable response!&lt;/p&gt;
&lt;p&gt;I discussed this with Yehuda, and this change was intended, to
work around a bug in Safari's Accept header, which prefers xml over
html. The way this was avoiding in Rails 2.x was to make sure the
html block occured first in the respond_to block. I'm not sure if
the recent changes to support respond_with prompted this change,
but I hope that it be reverted to the old behaviour.&lt;/p&gt;
&lt;p&gt;The easiest solution is to just ignore the quality parameter of
the accept header, and just serve the first acceptable response.
This would still require users to specify the html first, but it
should not be a problem if it is well-documented. Another solution,
that is more magical, would be to always prefer html over
everything else, if the client accepts html or &lt;em&gt;/&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;I have attached[2] a failing test to demonstrate this
behavior.&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer">12714</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>A recent change in Rails3 rendering/respond_to code completely broke content negotiation. This commit[1] causes any request that 1) does not have a .format param, 2) is not xhr, and 3) CONTAINS A COMMA in the Accept header to return an html document.

So if, for example, you have a resource that provides html, xml, and json, and a web service client that accepts both xml and json, you get html. Also, if you have a web service similar to Sun's Cloud offering which uses custom mime-types to indicate various flavors of json, you would get html. If the resource does not provide an html content-type at all, you would get a 406 Not Acceptable response!

I discussed this with Yehuda, and this change was intended, to work around a bug in Safari's Accept header, which prefers xml over html. The way this was avoiding in Rails 2.x was to make sure the html block occured first in the respond_to block. I'm not sure if the recent changes to support respond_with prompted this change, but I hope that it be reverted to the old behaviour. 

The easiest solution is to just ignore the quality parameter of the accept header, and just serve the first acceptable response. This would still require users to specify the html first, but it should not be a problem if it is well-documented. Another solution, that is more magical, would be to always prefer html over everything else, if the client accepts html or */*.

I have attached[2] a failing test to demonstrate this behavior.

[1]: http://github.com/rails/rails/commit/1310231c15742bf7d99e2f143d88b383c32782d3#L2R172
[2]: http://gist.github.com/237075</body>
      <body-html>&lt;div&gt;&lt;p&gt;A recent change in Rails3 rendering/respond_to code completely
broke content negotiation. This commit[1] causes any request that
1) does not have a .format param, 2) is not xhr, and 3) CONTAINS A
COMMA in the Accept header to return an html document.&lt;/p&gt;
&lt;p&gt;So if, for example, you have a resource that provides html, xml,
and json, and a web service client that accepts both xml and json,
you get html. Also, if you have a web service similar to Sun's
Cloud offering which uses custom mime-types to indicate various
flavors of json, you would get html. If the resource does not
provide an html content-type at all, you would get a 406 Not
Acceptable response!&lt;/p&gt;
&lt;p&gt;I discussed this with Yehuda, and this change was intended, to
work around a bug in Safari's Accept header, which prefers xml over
html. The way this was avoiding in Rails 2.x was to make sure the
html block occured first in the respond_to block. I'm not sure if
the recent changes to support respond_with prompted this change,
but I hope that it be reverted to the old behaviour.&lt;/p&gt;
&lt;p&gt;The easiest solution is to just ignore the quality parameter of
the accept header, and just serve the first acceptable response.
This would still require users to specify the html first, but it
should not be a problem if it is well-documented. Another solution,
that is more magical, would be to always prefer html over
everything else, if the client accepts html or &lt;em&gt;/&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;I have attached[2] a failing test to demonstrate this
behavior.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-05T00:18:51+00:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2009-12-05T00:18:52+00:00</updated-at>
      <user-id type="integer">10329</user-id>
      <version type="integer">1</version>
      <user-name>Paul Sadauskas (Rando)</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Yehuda Katz (wycats)</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">12714</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Looks like LH swallowed my markdown. Here's the links referenced above:

1: http://github.com/rails/rails/commit/1310231c15742bf7d99e2f143d88b383c32782d3#L2R172
2: http://gist.github.com/237075</body>
      <body-html>&lt;div&gt;&lt;p&gt;Looks like LH swallowed my markdown. Here's the links referenced
above:&lt;/p&gt;
&lt;p&gt;1: &lt;a href=
&quot;http://github.com/rails/rails/commit/1310231c15742bf7d99e2f143d88b383c32782d3#L2R172&quot;&gt;
http://github.com/rails/rails/commit/1310231c15742bf7d99e2f143d88b3...&lt;/a&gt;&lt;br&gt;
2: &lt;a href=
&quot;http://gist.github.com/237075&quot;&gt;http://gist.github.com/237075&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-02-08T18:05:13+00:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-02-08T18:05:15+00:00</updated-at>
      <user-id type="integer">10329</user-id>
      <version type="integer">2</version>
      <user-name>Paul Sadauskas (Rando)</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Yehuda Katz (wycats)</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">12714</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>And here's a patch that hacks around the hack. It pretty much is just a better was to detect browsers without also catching web-service clients.


Commit: http://github.com/paul/rails/commit/680762155921bbc42b0030807f34cb0d9af209ae
Topic branch, for merging: http://github.com/paul/rails/commits/accepts</body>
      <body-html>&lt;div&gt;&lt;p&gt;And here's a patch that hacks around the hack. It pretty much is
just a better was to detect browsers without also catching
web-service clients.&lt;/p&gt;
&lt;p&gt;Commit: &lt;a href=
&quot;http://github.com/paul/rails/commit/680762155921bbc42b0030807f34cb0d9af209ae&quot;&gt;
http://github.com/paul/rails/commit/680762155921bbc42b0030807f34cb0...&lt;/a&gt;&lt;br&gt;
Topic branch, for merging: &lt;a href=
&quot;http://github.com/paul/rails/commits/accepts&quot;&gt;http://github.com/paul/rails/commits/accepts&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-02-08T19:15:25+00:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-02-08T19:15:27+00:00</updated-at>
      <user-id type="integer">10329</user-id>
      <version type="integer">3</version>
      <user-name>Paul Sadauskas (Rando)</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Yehuda Katz (wycats)</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">12714</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>(from [dc5300adb6d46252c26e239ac67e3ca6e5e2d77b]) Slightly less annoying check for acceptable mime_types. This allows Accept: application/json, application/jsonp (and the like), but still blacklists browsers. Essentially, we use normal content negotiation unless you include */* in your list, in which case we assume you're a browser and send HTML [#3541 state:resolved]
http://github.com/rails/rails/commit/dc5300adb6d46252c26e239ac67e3ca6e5e2d77b</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from &lt;a href=
&quot;/projects/8994/changesets/dc5300adb6d46252c26e239ac67e3ca6e5e2d77b&quot;
title=
&quot;Changeset [dc5300adb6d46252c26e239ac67e3ca6e5e2d77b]&quot;&gt;[dc5300adb6d46252c26e239ac67e3ca6e5e2d77b]&lt;/a&gt;)
Slightly less annoying check for acceptable mime_types. This allows
Accept: application/json, application/jsonp (and the like), but
still blacklists browsers. Essentially, we use normal content
negotiation unless you include &lt;em&gt;/&lt;/em&gt; in your list, in which
case we assume you're a browser and send HTML [&lt;a href=
&quot;/projects/8994/tickets/3541&quot; title=&quot;Ticket #3541&quot;&gt;#3541&lt;/a&gt;
state:resolved] &lt;a href=
&quot;http://github.com/rails/rails/commit/dc5300adb6d46252c26e239ac67e3ca6e5e2d77b&quot;&gt;
http://github.com/rails/rails/commit/dc5300adb6d46252c26e239ac67e3c...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-04-02T01:42:55+01:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-04-02T01:42:56+01:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">4</version>
      <user-name>Repository</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Yehuda Katz (wycats)</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">12714</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Missing tests.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Missing tests.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-04-02T21:40:47+01:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- 
:state: resolved
:milestone: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-04-02T21:40:50+01:00</updated-at>
      <user-id type="integer">85</user-id>
      <version type="integer">5</version>
      <user-name>Jeremy Kemper</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Yehuda Katz (wycats)</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">12714</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Can a bugmasher add some tests?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Can a bugmasher add some tests?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-05-15T01:55:30+01:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: content_type rails3
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>bugmash content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-05-15T01:55:32+01:00</updated-at>
      <user-id type="integer">22242</user-id>
      <version type="integer">6</version>
      <user-name>Dan Pickett</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Yehuda Katz (wycats)</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">12714</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I've created a patched which add tests which I think tests the right thing. My first patch ever, so I hope it's useful.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I've created a patched which add tests which I think tests the
right thing. My first patch ever, so I hope it's useful.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-05-15T13:12:02+01:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>bugmash content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-05-15T13:12:05+01:00</updated-at>
      <user-id type="integer">32792</user-id>
      <version type="integer">7</version>
      <user-name>Patrik Stenmark</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Yehuda Katz (wycats)</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">12714</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Patrik, could you please create a patch using the guidelines specified here:

http://rails.lighthouseapp.com/projects/8994/sending-patches

This way it will preserve you as the author! Thanks!</body>
      <body-html>&lt;div&gt;&lt;p&gt;Patrik, could you please create a patch using the guidelines
specified here:&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;http://rails.lighthouseapp.com/projects/8994/sending-patches&quot;&gt;http://rails.lighthouseapp.com/projects/8994/sending-patches&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This way it will preserve you as the author! Thanks!&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-06-29T19:51:14+01:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>bugmash content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-06-29T19:51:29+01:00</updated-at>
      <user-id type="integer">19965</user-id>
      <version type="integer">8</version>
      <user-name>Jos&#233; Valim</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Yehuda Katz (wycats)</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Jos&#233;, Patrik patch applies clean for me, and all the tests pass</body>
      <body-html>&lt;div&gt;&lt;p&gt;Jos&amp;eacute;, Patrik patch applies clean for me, and all the
tests pass&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-07-01T03:33:06+01:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: bugmash content_type rails3
:state: incomplete
:assigned_user: 12714
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>verified</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-07-01T03:33:16+01:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">9</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Applied tests here http://github.com/rails/rails/commit/7f7480f6fc1e88ce19bee8ac7f6fb2243343495e</body>
      <body-html>&lt;div&gt;&lt;p&gt;Applied tests here &lt;a href=
&quot;http://github.com/rails/rails/commit/7f7480f6fc1e88ce19bee8ac7f6fb2243343495e&quot;&gt;
http://github.com/rails/rails/commit/7f7480f6fc1e88ce19bee8ac7f6fb2...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-07-04T19:26:19+01:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- 
:state: verified
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-07-04T19:26:21+01:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">10</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>[[bulk edit](/projects/8994/bulk_edits/31647)]</body>
      <body-html>&lt;div&gt;&lt;p&gt;[&lt;a href=&quot;/projects/8994/bulk_edits/31647&quot;&gt;bulk edit&lt;/a&gt;]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-10-15T23:01:38+01:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- 
:milestone: 27004
</diffable-attributes>
      <milestone-id type="integer">88038</milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-10-15T23:01:38+01:00</updated-at>
      <user-id type="integer">85</user-id>
      <version type="integer">11</version>
      <user-name>Jeremy Kemper</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title>3.0.2</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Hi,

Have opened a ticket at https://rails.lighthouseapp.com/projects/8994/tickets/5991-406-unacceptable-received-for-something-the-accept-header-has-said-it-can-take - I'm still not sure this is behaving in a way which is reasonable HTTP (or whether or not I've opened a duplicate ticket ;)).  If we have an HTML form which POSTs to an action which can only return `application/atom+xml` we end up with a 406, even though the browser has said it will accept `*/*`.  A patch which demonstrates this is attached at the link above.

This 406 happens whether or not `respond_with` or the old-style `respond_to` is used.

I'm not sure I understand the line from Paul's commit message above &quot;Essentially, we use normal content negotiation unless you include / in your list, in which case we assume you're a browser and send HTML&quot; - that seems to say that we're assuming that browsers can only handle HTML?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Hi,&lt;/p&gt;
&lt;p&gt;Have opened a ticket at &lt;a href=
&quot;https://rails.lighthouseapp.com/projects/8994/tickets/5991-406-unacceptable-received-for-something-the-accept-header-has-said-it-can-take&quot;&gt;
https://rails.lighthouseapp.com/projects/8994/tickets/5991-406-unac...&lt;/a&gt;
- I'm still not sure this is behaving in a way which is reasonable
HTTP (or whether or not I've opened a duplicate ticket ;)). If we
have an HTML form which POSTs to an action which can only return
&lt;code&gt;application/atom+xml&lt;/code&gt; we end up with a 406, even though
the browser has said it will accept &lt;code&gt;*/*&lt;/code&gt;. A patch which
demonstrates this is attached at the link above.&lt;/p&gt;
&lt;p&gt;This 406 happens whether or not &lt;code&gt;respond_with&lt;/code&gt; or the
old-style &lt;code&gt;respond_to&lt;/code&gt; is used.&lt;/p&gt;
&lt;p&gt;I'm not sure I understand the line from Paul's commit message
above &quot;Essentially, we use normal content negotiation unless you
include / in your list, in which case we assume you're a browser
and send HTML&quot; - that seems to say that we're assuming that
browsers can only handle HTML?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-11-19T08:57:33+00:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">88038</milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-11-19T08:57:34+00:00</updated-at>
      <user-id type="integer">124337</user-id>
      <version type="integer">12</version>
      <user-name>Russell Garner</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title>3.0.2</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>I'm also not convinced this is how we want this to behave. Here are a few Accept Headers I found in my production log over the last few days that get served a &quot;Missing Template&quot; error:

 * HTTP_ACCEPT: text/*
 * HTTP_ACCEPT: */*, auth/sicily
 * HTTP_ACCEPT: */*, application/youtube-client

As far as I can tell those should have been served an HTML page. If I set my browser header to &quot;*/*&quot; it works as expected, but if I add garbage to the header it won't work. perhaps we should have an option somewhere that says &quot;when in doubt serve HTML&quot; that you could switch on when you are certain you are not serving web services? Should I put in a new ticket for this?</body>
      <body-html>&lt;div&gt;&lt;p&gt;I'm also not convinced this is how we want this to behave. Here
are a few Accept Headers I found in my production log over the last
few days that get served a &quot;Missing Template&quot; error:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;HTTP_ACCEPT: text/*&lt;/li&gt;
&lt;li&gt;HTTP_ACCEPT: &lt;em&gt;/&lt;/em&gt;, auth/sicily&lt;/li&gt;
&lt;li&gt;HTTP_ACCEPT: &lt;em&gt;/&lt;/em&gt;, application/youtube-client&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;As far as I can tell those should have been served an HTML page.
If I set my browser header to &quot;&lt;em&gt;/&lt;/em&gt;&quot; it works as expected,
but if I add garbage to the header it won't work. perhaps we should
have an option somewhere that says &quot;when in doubt serve HTML&quot; that
you could switch on when you are certain you are not serving web
services? Should I put in a new ticket for this?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-11-20T20:15:31+00:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">88038</milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-11-20T20:15:34+00:00</updated-at>
      <user-id type="integer">8551</user-id>
      <version type="integer">13</version>
      <user-name>Fjan</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title>3.0.2</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Sorry, LH ate the asterisks on the posting above, wherever it says &quot;/&quot; please read star / star</body>
      <body-html>&lt;div&gt;&lt;p&gt;Sorry, LH ate the asterisks on the posting above, wherever it
says &quot;/&quot; please read star / star&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-11-20T20:16:54+00:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">88038</milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-11-20T20:16:57+00:00</updated-at>
      <user-id type="integer">8551</user-id>
      <version type="integer">14</version>
      <user-name>Fjan</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title>3.0.2</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Fjan, your case indeed seems to be a regression. Whenever rails sees &quot;star / star&quot;, it should deliver HTML if available. Feel free to open a new ticket. A patch with tests (or even a fix) is extremely welcome.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Fjan, your case indeed seems to be a regression. Whenever rails
sees &quot;star / star&quot;, it should deliver HTML if available. Feel free
to open a new ticket. A patch with tests (or even a fix) is
extremely welcome.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-11-20T20:18:54+00:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">88038</milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-11-20T20:19:09+00:00</updated-at>
      <user-id type="integer">19965</user-id>
      <version type="integer">15</version>
      <user-name>Jos&#233; Valim</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title>3.0.2</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Ok, new ticket is [here](https://rails.lighthouseapp.com/projects/8994-ruby-on-rails/tickets/6022-content-negotiation-fails-for-some-headers-regression). I don't have time for proper patch I'm afraid, but I'll add the monkey patch that I created for myself.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Ok, new ticket is &lt;a href=
&quot;https://rails.lighthouseapp.com/projects/8994-ruby-on-rails/tickets/6022-content-negotiation-fails-for-some-headers-regression&quot;&gt;
here&lt;/a&gt;. I don't have time for proper patch I'm afraid, but I'll
add the monkey patch that I created for myself.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-11-20T20:38:57+00:00</created-at>
      <creator-id type="integer">10329</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">88038</milestone-id>
      <number type="integer">3541</number>
      <permalink>content-negotiation-regression</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>content_type rails3</tag>
      <title>Content Negotiation Regression</title>
      <updated-at type="datetime">2010-11-20T20:39:00+00:00</updated-at>
      <user-id type="integer">8551</user-id>
      <version type="integer">16</version>
      <user-name>Fjan</user-name>
      <creator-name>Paul Sadauskas (Rando)</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3541</url>
      <milestone-title>3.0.2</milestone-title>
      <priority-name>Low</priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>a3fd8a2a5e965dc3aded19c7f1301bfab7e2b916</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-05-15T13:12:02+01:00</created-at>
      <filename>content-negotiation-tests.patch</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">522558</id>
      <size type="integer">1610</size>
      <uploader-id type="integer">32792</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/522558/content-negotiation-tests.patch</url>
    </attachment>
  </attachments>
</ticket>
