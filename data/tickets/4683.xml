<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer" nil="true"></assigned-user-id>
  <attachments-count type="integer">2</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2010-05-24T18:26:20+01:00</created-at>
  <creator-id type="integer">10618</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">4683</number>
  <permalink>ascii-8bit-and-utf-8-in-hell</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>duplicate</state>
  <tag>error logger &quot;rails3 encoding ruby1.9 mysql&quot;</tag>
  <title>ASCII-8BIT and  UTF-8 in hell</title>
  <updated-at type="datetime">2010-06-22T16:28:48+01:00</updated-at>
  <user-id type="integer">19965</user-id>
  <version type="integer">8</version>
  <user-name>Jos&#233; Valim</user-name>
  <creator-name>Jaroslaw Zabiello</creator-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/4683</url>
  <priority-name>Low</priority-name>
  <original-body>MySQL drive does not recognize nor enforce UTF-8 encoding for Ruby 1.9. There is a problem with MySQL text and varchar fields for Rails3 and Ruby 1.9. They are not correctly encoded. Instead of UTF-8 they come as ASCII-8BIT, binary data, and when it is mixed with other UTF-8 text, Rails will raise an exception. 

field = MyModel.first.field

field.encoding # =&gt; ASCII-8BIT

currently it has to dirty fix:

field = MyModel.first.field.force_encoding('UTF-8').encoding # =&gt; UTF-8

The patch enforce UTF-8 encoding for Active Record and MySQL.</original-body>
  <latest-body>MySQL drive does not recognize nor enforce UTF-8 encoding for Ruby 1.9. There is a problem with MySQL text and varchar fields for Rails3 and Ruby 1.9. They are not correctly encoded. Instead of UTF-8 they come as ASCII-8BIT, binary data, and when it is mixed with other UTF-8 text, Rails will raise an exception. 

field = MyModel.first.field

field.encoding # =&gt; ASCII-8BIT

currently it has to dirty fix:

field = MyModel.first.field.force_encoding('UTF-8').encoding # =&gt; UTF-8

The patch enforce UTF-8 encoding for Active Record and MySQL.</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;MySQL drive does not recognize nor enforce UTF-8 encoding for
Ruby 1.9. There is a problem with MySQL text and varchar fields for
Rails3 and Ruby 1.9. They are not correctly encoded. Instead of
UTF-8 they come as ASCII-8BIT, binary data, and when it is mixed
with other UTF-8 text, Rails will raise an exception.&lt;/p&gt;
&lt;p&gt;field = MyModel.first.field&lt;/p&gt;
&lt;p&gt;field.encoding # =&amp;gt; ASCII-8BIT&lt;/p&gt;
&lt;p&gt;currently it has to dirty fix:&lt;/p&gt;
&lt;p&gt;field = MyModel.first.field.force_encoding('UTF-8').encoding #
=&amp;gt; UTF-8&lt;/p&gt;
&lt;p&gt;The patch enforce UTF-8 encoding for Active Record and
MySQL.&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>MySQL drive does not recognize nor enforce UTF-8 encoding for Ruby 1.9. There is a problem with MySQL text and varchar fields for Rails3 and Ruby 1.9. They are not correctly encoded. Instead of UTF-8 they come as ASCII-8BIT, binary data, and when it is mixed with other UTF-8 text, Rails will raise an exception. 

field = MyModel.first.field

field.encoding # =&gt; ASCII-8BIT

currently it has to dirty fix:

field = MyModel.first.field.force_encoding('UTF-8').encoding # =&gt; UTF-8

The patch enforce UTF-8 encoding for Active Record and MySQL.</body>
      <body-html>&lt;div&gt;&lt;p&gt;MySQL drive does not recognize nor enforce UTF-8 encoding for
Ruby 1.9. There is a problem with MySQL text and varchar fields for
Rails3 and Ruby 1.9. They are not correctly encoded. Instead of
UTF-8 they come as ASCII-8BIT, binary data, and when it is mixed
with other UTF-8 text, Rails will raise an exception.&lt;/p&gt;
&lt;p&gt;field = MyModel.first.field&lt;/p&gt;
&lt;p&gt;field.encoding # =&amp;gt; ASCII-8BIT&lt;/p&gt;
&lt;p&gt;currently it has to dirty fix:&lt;/p&gt;
&lt;p&gt;field = MyModel.first.field.force_encoding('UTF-8').encoding #
=&amp;gt; UTF-8&lt;/p&gt;
&lt;p&gt;The patch enforce UTF-8 encoding for Active Record and
MySQL.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-05-24T18:26:20+01:00</created-at>
      <creator-id type="integer">10618</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4683</number>
      <permalink>ascii-8bit-and-utf-8-in-hell</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>&quot;rails3 encoding ruby1.9 mysql&quot;</tag>
      <title>ASCII-8BIT and  UTF-8 in hell</title>
      <updated-at type="datetime">2010-05-24T18:26:24+01:00</updated-at>
      <user-id type="integer">10618</user-id>
      <version type="integer">1</version>
      <user-name>Jaroslaw Zabiello</user-name>
      <creator-name>Jaroslaw Zabiello</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4683</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>The previous patch file was wrong.</body>
      <body-html>&lt;div&gt;&lt;p&gt;The previous patch file was wrong.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-05-24T18:45:19+01:00</created-at>
      <creator-id type="integer">10618</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4683</number>
      <permalink>ascii-8bit-and-utf-8-in-hell</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>&quot;rails3 encoding ruby1.9 mysql&quot;</tag>
      <title>ASCII-8BIT and  UTF-8 in hell</title>
      <updated-at type="datetime">2010-05-24T18:45:21+01:00</updated-at>
      <user-id type="integer">10618</user-id>
      <version type="integer">2</version>
      <user-name>Jaroslaw Zabiello</user-name>
      <creator-name>Jaroslaw Zabiello</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4683</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>+1. I use it in my rails3 application and it works! The change is quite small and easy to understand. I like it.</body>
      <body-html>&lt;div&gt;&lt;ol&gt;
&lt;li&gt;I use it in my rails3 application and it works! The change is
quite small and easy to understand. I like it.&lt;/li&gt;
&lt;/ol&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-05-31T10:03:14+01:00</created-at>
      <creator-id type="integer">10618</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4683</number>
      <permalink>ascii-8bit-and-utf-8-in-hell</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>&quot;rails3 encoding ruby1.9 mysql&quot;</tag>
      <title>ASCII-8BIT and  UTF-8 in hell</title>
      <updated-at type="datetime">2010-05-31T10:03:17+01:00</updated-at>
      <user-id type="integer">101176</user-id>
      <version type="integer">3</version>
      <user-name>Rafa&#322; Lisowski</user-name>
      <creator-name>Jaroslaw Zabiello</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4683</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>If you do an eval, put the RUBY_VERSION =~ /1.9/ somewhere outside the eval'd string.</body>
      <body-html>&lt;div&gt;&lt;p&gt;If you do an eval, put the RUBY_VERSION =~ /1.9/ somewhere
outside the eval'd string.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-06-01T12:48:06+01:00</created-at>
      <creator-id type="integer">10618</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4683</number>
      <permalink>ascii-8bit-and-utf-8-in-hell</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>&quot;rails3 encoding ruby1.9 mysql&quot;</tag>
      <title>ASCII-8BIT and  UTF-8 in hell</title>
      <updated-at type="datetime">2010-06-01T12:48:12+01:00</updated-at>
      <user-id type="integer">87610</user-id>
      <version type="integer">4</version>
      <user-name>Simon Hafner</user-name>
      <creator-name>Jaroslaw Zabiello</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4683</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Simon: my patch is no more needed since that code has been completely rewritten in 3.0b4. But he problem with Ruby 1.9 and ASCII-8BIT, vs UTF-8 still exists and it breaks the application making Rails 3 useless for using with Ruby 1.9, MySQL and non-ASCII characters. You can replicate the error in the following way:

@@@
$ rails new tescior -d mysql
$ cd tescior
$ bundle install
$ rails g model Message msg:string
$ rake db:migrate
@@@

Small change in ~/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb file:

@@@
def flush
  @guard.synchronize do
    unless buffer.empty?
      old_buffer = buffer
      p old_buffer # MY CHANGE
      @log.write(old_buffer.join)
    end
    # Important to do this even if buffer was empty or else @buffer will
    # accumulate empty arrays for each request where nothing was logged.
    clear_buffer
  end
end
@@@

Now, let's start console:

@@@
$ rails c
ruby-1.9.2-preview3 &gt; msg =  &quot;za\xc5\xbc\xc3\xb3\xc5\x82\xc4\x87 g\xc4\x99\xc5\x9bl\xc4\x85 ja\xc5\xba\xc5\x84&quot;
=&gt; &quot;za&#380;&#243;&#322;&#263; g&#281;&#347;l&#261; ja&#378;&#324;&quot;
ruby-1.9.2-preview3 &gt; Message.create :msg =&gt; msg

[&quot;  \e[1m\e[36mSQL (0.3ms)\e[0m  \e[1mINSERT INTO `messages` (`created_at`, `msg`, `updated_at`) VALUES ('2010-06-14 19:40:40', 'za\xC5\xBC\xC3\xB3\xC5\x82\xC4\x87 g\xC4\x99\xC5\x9Bl\xC4\x85 ja\xC5\xBA\xC5\x84', '2010-06-14 19:40:40')\e[0m\n&quot;, &quot;Could not log \&quot;sql.active_record\&quot; event. Encoding::UndefinedConversionError: \&quot;\\xC5\&quot; from ASCII-8BIT to UTF-8\n&quot;, &quot;Encoding::UndefinedConversionError: \&quot;\\xC5\&quot; from ASCII-8BIT to UTF-8: INSERT INTO `messages` (`created_at`, `msg`, `updated_at`) VALUES ('2010-06-14 19:40:40', 'za\xC5\xBC\xC3\xB3\xC5\x82\xC4\x87 g\xC4\x99\xC5\x9Bl\xC4\x85 ja\xC5\xBA\xC5\x84', '2010-06-14 19:40:40')\n&quot;, &quot;  \e[1m\e[35mSQL (1.5ms)\e[0m  ROLLBACK\n&quot;, &quot;Could not log \&quot;sql.active_record\&quot; event. Encoding::UndefinedConversionError: \&quot;\\xC5\&quot; from ASCII-8BIT to UTF-8\n&quot;, &quot;Encoding::UndefinedConversionError: \&quot;\\xC5\&quot; from ASCII-8BIT to UTF-8: ROLLBACK\n&quot;]

Encoding::UndefinedConversionError: &quot;\xC5&quot; from ASCII-8BIT to UTF-8
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:106:in `write'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:106:in `block in flush'
  from &lt;internal:prelude&gt;:10:in `synchronize'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:101:in `flush'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:123:in `auto_flush'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:66:in `add'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:77:in `debug'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract_adapter.rb:209:in `rescue in log'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract_adapter.rb:200:in `log'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/mysql_adapter.rb:286:in `execute'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract/database_statements.rb:263:in `insert_sql'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/mysql_adapter.rb:297:in `insert_sql'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract/database_statements.rb:44:in `insert'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract/query_cache.rb:16:in `insert'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/arel-0.4.0/lib/arel/engines/sql/engine.rb:36:in `create'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/arel-0.4.0/lib/arel/algebra/relations/writes.rb:20:in `call'
... 14 levels...
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/attribute_methods/dirty.rb:21:in `save'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:235:in `block (2 levels) in save'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:287:in `block in with_transaction_returning_status'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract/database_statements.rb:139:in `transaction'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:202:in `transaction'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:285:in `with_transaction_returning_status'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:235:in `block in save'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:246:in `rollback_active_record_state!'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:234:in `save'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/base.rb:462:in `create'
  from (irb):3
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/railties-3.0.0.beta4/lib/rails/commands/console.rb:47:in `start'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/railties-3.0.0.beta4/lib/rails/commands/console.rb:8:in `start'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/railties-3.0.0.beta4/lib/rails/commands.rb:23:in `&lt;top (required)&gt;'
  from script/rails:6:in `require'
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;Simon: my patch is no more needed since that code has been
completely rewritten in 3.0b4. But he problem with Ruby 1.9 and
ASCII-8BIT, vs UTF-8 still exists and it breaks the application
making Rails 3 useless for using with Ruby 1.9, MySQL and non-ASCII
characters. You can replicate the error in the following way:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;$ rails new tescior -d mysql
$ cd tescior
$ bundle install
$ rails g model Message msg:string
$ rake db:migrate&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Small change in
~/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb
file:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;def flush
  @guard.synchronize do
    unless buffer.empty?
      old_buffer = buffer
      p old_buffer # MY CHANGE
      @log.write(old_buffer.join)
    end
    # Important to do this even if buffer was empty or else @buffer will
    # accumulate empty arrays for each request where nothing was logged.
    clear_buffer
  end
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Now, let's start console:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;$ rails c
ruby-1.9.2-preview3 &amp;gt; msg =  &quot;za\xc5\xbc\xc3\xb3\xc5\x82\xc4\x87 g\xc4\x99\xc5\x9bl\xc4\x85 ja\xc5\xba\xc5\x84&quot;
=&amp;gt; &quot;za&amp;#380;&amp;oacute;&amp;#322;&amp;#263; g&amp;#281;&amp;#347;l&amp;#261; ja&amp;#378;&amp;#324;&quot;
ruby-1.9.2-preview3 &amp;gt; Message.create :msg =&amp;gt; msg

[&quot;  \e[1m\e[36mSQL (0.3ms)\e[0m  \e[1mINSERT INTO `messages` (`created_at`, `msg`, `updated_at`) VALUES ('2010-06-14 19:40:40', 'za\xC5\xBC\xC3\xB3\xC5\x82\xC4\x87 g\xC4\x99\xC5\x9Bl\xC4\x85 ja\xC5\xBA\xC5\x84', '2010-06-14 19:40:40')\e[0m\n&quot;, &quot;Could not log \&quot;sql.active_record\&quot; event. Encoding::UndefinedConversionError: \&quot;\\xC5\&quot; from ASCII-8BIT to UTF-8\n&quot;, &quot;Encoding::UndefinedConversionError: \&quot;\\xC5\&quot; from ASCII-8BIT to UTF-8: INSERT INTO `messages` (`created_at`, `msg`, `updated_at`) VALUES ('2010-06-14 19:40:40', 'za\xC5\xBC\xC3\xB3\xC5\x82\xC4\x87 g\xC4\x99\xC5\x9Bl\xC4\x85 ja\xC5\xBA\xC5\x84', '2010-06-14 19:40:40')\n&quot;, &quot;  \e[1m\e[35mSQL (1.5ms)\e[0m  ROLLBACK\n&quot;, &quot;Could not log \&quot;sql.active_record\&quot; event. Encoding::UndefinedConversionError: \&quot;\\xC5\&quot; from ASCII-8BIT to UTF-8\n&quot;, &quot;Encoding::UndefinedConversionError: \&quot;\\xC5\&quot; from ASCII-8BIT to UTF-8: ROLLBACK\n&quot;]

Encoding::UndefinedConversionError: &quot;\xC5&quot; from ASCII-8BIT to UTF-8
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:106:in `write'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:106:in `block in flush'
  from &amp;lt;internal:prelude&amp;gt;:10:in `synchronize'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:101:in `flush'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:123:in `auto_flush'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:66:in `add'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:77:in `debug'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract_adapter.rb:209:in `rescue in log'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract_adapter.rb:200:in `log'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/mysql_adapter.rb:286:in `execute'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract/database_statements.rb:263:in `insert_sql'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/mysql_adapter.rb:297:in `insert_sql'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract/database_statements.rb:44:in `insert'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract/query_cache.rb:16:in `insert'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/arel-0.4.0/lib/arel/engines/sql/engine.rb:36:in `create'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/arel-0.4.0/lib/arel/algebra/relations/writes.rb:20:in `call'
... 14 levels...
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/attribute_methods/dirty.rb:21:in `save'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:235:in `block (2 levels) in save'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:287:in `block in with_transaction_returning_status'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/connection_adapters/abstract/database_statements.rb:139:in `transaction'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:202:in `transaction'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:285:in `with_transaction_returning_status'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:235:in `block in save'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:246:in `rollback_active_record_state!'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/transactions.rb:234:in `save'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activerecord-3.0.0.beta4/lib/active_record/base.rb:462:in `create'
  from (irb):3
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/railties-3.0.0.beta4/lib/rails/commands/console.rb:47:in `start'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/railties-3.0.0.beta4/lib/rails/commands/console.rb:8:in `start'
  from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/railties-3.0.0.beta4/lib/rails/commands.rb:23:in `&amp;lt;top (required)&amp;gt;'
  from script/rails:6:in `require'&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-06-14T21:02:28+01:00</created-at>
      <creator-id type="integer">10618</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: &quot;\&quot;rails3 encoding ruby1.9 mysql\&quot;&quot;
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4683</number>
      <permalink>ascii-8bit-and-utf-8-in-hell</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>error &quot;rails3 encoding ruby1.9 mysql&quot;</tag>
      <title>ASCII-8BIT and  UTF-8 in hell</title>
      <updated-at type="datetime">2010-06-14T21:02:36+01:00</updated-at>
      <user-id type="integer">10618</user-id>
      <version type="integer">5</version>
      <user-name>Jaroslaw Zabiello</user-name>
      <creator-name>Jaroslaw Zabiello</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4683</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>I found, that mentioned error dissapeared if I logger level was higher than 0.

@@@
$ rails c
ruby-1.9.2-preview3 &gt; Rails.logger.level
 =&gt; 0 
ruby-1.9.2-preview3 &gt; Rails.logger.level = Logger::INFO
 =&gt; 1 
ruby-1.9.2-preview3 &gt; Message.create :msg =&gt; 'za&#380;&#243;&#322;&#263;&#160;g&#281;&#347;l&#261; ja&#378;&#324;'
 =&gt; #&lt;Message id: 11, msg: &quot;za&#380;&#243;&#322;&#263;&#160;g&#281;&#347;l&#261; ja&#378;&#324;&quot;, created_at: &quot;2010-06-14 21:54:31&quot;, updated_at: &quot;2010-06-14 21:54:31&quot;&gt; 
ruby-1.9.2-preview3 &gt; Rails.logger.level = Logger::DEBUG
 =&gt; 0 
ruby-1.9.2-preview3 &gt; Message.create :msg =&gt; 'za&#380;&#243;&#322;&#263;&#160;g&#281;&#347;l&#261; ja&#378;&#324;'
Encoding::UndefinedConversionError: &quot;\xC4&quot; from ASCII-8BIT to UTF-8
	from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:104:in `write'
...
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;I found, that mentioned error dissapeared if I logger level was
higher than 0.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;$ rails c
ruby-1.9.2-preview3 &amp;gt; Rails.logger.level
 =&amp;gt; 0 
ruby-1.9.2-preview3 &amp;gt; Rails.logger.level = Logger::INFO
 =&amp;gt; 1 
ruby-1.9.2-preview3 &amp;gt; Message.create :msg =&amp;gt; 'za&amp;#380;&amp;oacute;&amp;#322;&amp;#263; g&amp;#281;&amp;#347;l&amp;#261; ja&amp;#378;&amp;#324;'
 =&amp;gt; #&amp;lt;Message id: 11, msg: &quot;za&amp;#380;&amp;oacute;&amp;#322;&amp;#263; g&amp;#281;&amp;#347;l&amp;#261; ja&amp;#378;&amp;#324;&quot;, created_at: &quot;2010-06-14 21:54:31&quot;, updated_at: &quot;2010-06-14 21:54:31&quot;&amp;gt; 
ruby-1.9.2-preview3 &amp;gt; Rails.logger.level = Logger::DEBUG
 =&amp;gt; 0 
ruby-1.9.2-preview3 &amp;gt; Message.create :msg =&amp;gt; 'za&amp;#380;&amp;oacute;&amp;#322;&amp;#263; g&amp;#281;&amp;#347;l&amp;#261; ja&amp;#378;&amp;#324;'
Encoding::UndefinedConversionError: &quot;\xC4&quot; from ASCII-8BIT to UTF-8
    from /Users/zbiru/.rvm/gems/ruby-1.9.2-preview3/gems/activesupport-3.0.0.beta4/lib/active_support/buffered_logger.rb:104:in `write'
...&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-06-14T23:00:41+01:00</created-at>
      <creator-id type="integer">10618</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4683</number>
      <permalink>ascii-8bit-and-utf-8-in-hell</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>error &quot;rails3 encoding ruby1.9 mysql&quot;</tag>
      <title>ASCII-8BIT and  UTF-8 in hell</title>
      <updated-at type="datetime">2010-06-14T23:00:47+01:00</updated-at>
      <user-id type="integer">10618</user-id>
      <version type="integer">6</version>
      <user-name>Jaroslaw Zabiello</user-name>
      <creator-name>Jaroslaw Zabiello</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4683</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-06-14T23:00:59+01:00</created-at>
      <creator-id type="integer">10618</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: error &quot;rails3 encoding ruby1.9 mysql&quot;
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4683</number>
      <permalink>ascii-8bit-and-utf-8-in-hell</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>error logger &quot;rails3 encoding ruby1.9 mysql&quot;</tag>
      <title>ASCII-8BIT and  UTF-8 in hell</title>
      <updated-at type="datetime">2010-06-14T23:01:04+01:00</updated-at>
      <user-id type="integer">10618</user-id>
      <version type="integer">7</version>
      <user-name>Jaroslaw Zabiello</user-name>
      <creator-name>Jaroslaw Zabiello</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4683</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>I believe this is a duplicate of #4807 now. Yehuda is working on a fix.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I believe this is a duplicate of &lt;a href=
&quot;/projects/8994/tickets/4807&quot; title=&quot;Ticket #4807&quot;&gt;#4807&lt;/a&gt; now.
Yehuda is working on a fix.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-06-22T16:28:38+01:00</created-at>
      <creator-id type="integer">10618</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4683</number>
      <permalink>ascii-8bit-and-utf-8-in-hell</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>duplicate</state>
      <tag>error logger &quot;rails3 encoding ruby1.9 mysql&quot;</tag>
      <title>ASCII-8BIT and  UTF-8 in hell</title>
      <updated-at type="datetime">2010-06-22T16:28:48+01:00</updated-at>
      <user-id type="integer">19965</user-id>
      <version type="integer">8</version>
      <user-name>Jos&#233; Valim</user-name>
      <creator-name>Jaroslaw Zabiello</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4683</url>
      <priority-name nil="true"></priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>b0773de69211dee95c86fbde25c3048bcd37ae29</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-05-24T18:26:20+01:00</created-at>
      <filename>0001-enforced-utf-8-encoding-for-wrong-ascii-8bit-encodin.patch</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">532244</id>
      <size type="integer">2610</size>
      <uploader-id type="integer">10618</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/532244/0001-enforced-utf-8-encoding-for-wrong-ascii-8bit-encodin.patch</url>
    </attachment>
    <attachment type="Attachment">
      <code>33eb35e2513a66b80b9fd7fd788a8bc5c7b2e7ef</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-05-24T18:45:19+01:00</created-at>
      <filename>0001-enforced-utf-8-encoding-for-ruby-19-and-mysql-text.patch</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">532279</id>
      <size type="integer">2741</size>
      <uploader-id type="integer">10618</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/532279/0001-enforced-utf-8-encoding-for-ruby-19-and-mysql-text.patch</url>
    </attachment>
  </attachments>
</ticket>
