<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">85</assigned-user-id>
  <attachments-count type="integer">0</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2009-10-18T02:14:54+01:00</created-at>
  <creator-id type="integer">23341</creator-id>
  <milestone-due-on type="datetime">2010-11-15T00:00:00+00:00</milestone-due-on>
  <milestone-id type="integer">88038</milestone-id>
  <number type="integer">3388</number>
  <permalink>activerecord-splits-log-records-across-multiple-lines</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>resolved</state>
  <tag nil="true"></tag>
  <title>ActiveRecord splits log records across multiple lines</title>
  <updated-at type="datetime">2010-11-08T08:22:34+00:00</updated-at>
  <user-id type="integer">94458</user-id>
  <version type="integer">9</version>
  <user-name>Jeff Kreeftmeijer</user-name>
  <creator-name>Sam Ruby</creator-name>
  <assigned-user-name>Jeremy Kemper</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/3388</url>
  <milestone-title>3.0.2</milestone-title>
  <priority-name>Low</priority-name>
  <original-body>Given the following statement:

@@@
order = Order.find(:first)
@@@

Rails 2.3.4 produces the following log entry:

@@@
  Order Load (1.5ms)   SELECT * FROM &quot;orders&quot; LIMIT 1
@@@

Now that ARel has landed, Rails 3.0pre produces the following log entries:

@@@
  Order Load (1.1ms)   SELECT *
FROM &quot;orders&quot;
LIMIT 1
@@@

This clearly isn't a bug, but arguably is a fit and finish item, as putting log entries on one line would make it easier to scan.  At a minimum, subsequent lines should be indented or otherwise easily identified as a continuation.</original-body>
  <latest-body>Given the following statement:

@@@
order = Order.find(:first)
@@@

Rails 2.3.4 produces the following log entry:

@@@
  Order Load (1.5ms)   SELECT * FROM &quot;orders&quot; LIMIT 1
@@@

Now that ARel has landed, Rails 3.0pre produces the following log entries:

@@@
  Order Load (1.1ms)   SELECT *
FROM &quot;orders&quot;
LIMIT 1
@@@

This clearly isn't a bug, but arguably is a fit and finish item, as putting log entries on one line would make it easier to scan.  At a minimum, subsequent lines should be indented or otherwise easily identified as a continuation.</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;Given the following statement:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;order = Order.find(:first)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Rails 2.3.4 produces the following log entry:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;  Order Load (1.5ms)   SELECT * FROM &quot;orders&quot; LIMIT 1&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Now that ARel has landed, Rails 3.0pre produces the following
log entries:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;  Order Load (1.1ms)   SELECT *
FROM &quot;orders&quot;
LIMIT 1&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;This clearly isn't a bug, but arguably is a fit and finish item,
as putting log entries on one line would make it easier to scan. At
a minimum, subsequent lines should be indented or otherwise easily
identified as a continuation.&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer">12714</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Given the following statement:

@@@
order = Order.find(:first)
@@@

Rails 2.3.4 produces the following log entry:

@@@
  Order Load (1.5ms)   SELECT * FROM &quot;orders&quot; LIMIT 1
@@@

Now that ARel has landed, Rails 3.0pre produces the following log entries:

@@@
  Order Load (1.1ms)   SELECT *
FROM &quot;orders&quot;
LIMIT 1
@@@

This clearly isn't a bug, but arguably is a fit and finish item, as putting log entries on one line would make it easier to scan.  At a minimum, subsequent lines should be indented or otherwise easily identified as a continuation.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Given the following statement:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;order = Order.find(:first)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Rails 2.3.4 produces the following log entry:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;  Order Load (1.5ms)   SELECT * FROM &quot;orders&quot; LIMIT 1&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Now that ARel has landed, Rails 3.0pre produces the following
log entries:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;  Order Load (1.1ms)   SELECT *
FROM &quot;orders&quot;
LIMIT 1&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;This clearly isn't a bug, but arguably is a fit and finish item,
as putting log entries on one line would make it easier to scan. At
a minimum, subsequent lines should be indented or otherwise easily
identified as a continuation.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-10-18T02:14:54+01:00</created-at>
      <creator-id type="integer">23341</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3388</number>
      <permalink>activerecord-splits-log-records-across-multiple-lines</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>ActiveRecord splits log records across multiple lines</title>
      <updated-at type="datetime">2009-10-18T02:15:00+01:00</updated-at>
      <user-id type="integer">23341</user-id>
      <version type="integer">1</version>
      <user-name>Sam Ruby</user-name>
      <creator-name>Sam Ruby</creator-name>
      <assigned-user-name>Yehuda Katz (wycats)</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3388</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Yup - one line is preferable.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Yup - one line is preferable.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-11-24T17:39:57+00:00</created-at>
      <creator-id type="integer">23341</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
:milestone: 
:assigned_user: 12714
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3388</number>
      <permalink>activerecord-splits-log-records-across-multiple-lines</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag nil="true"></tag>
      <title>ActiveRecord splits log records across multiple lines</title>
      <updated-at type="datetime">2009-11-24T17:39:59+00:00</updated-at>
      <user-id type="integer">85</user-id>
      <version type="integer">2</version>
      <user-name>Jeremy Kemper</user-name>
      <creator-name>Sam Ruby</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3388</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>It has since gotten even less usable, as ANSI screen control characters are now included in the log itself.

@@@
  *[4;36;1msql (0.0ms)*[0m   *[0;1mSELECT *
FROM &quot;products&quot;
ORDER BY title*[0m
@@@

A few well placed gsubs could clean this right up.

@@@
line.gsub! &quot;\n&quot;, ' '
line.gsub! /\x1b\[\d(;\d+)*m/, ''
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;It has since gotten even less usable, as ANSI screen control
characters are now included in the log itself.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;  *[4;36;1msql (0.0ms)*[0m   *[0;1mSELECT *
FROM &quot;products&quot;
ORDER BY title*[0m&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;A few well placed gsubs could clean this right up.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;line.gsub! &quot;\n&quot;, ' '
line.gsub! /\x1b\[\d(;\d+)*m/, ''&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-12-09T15:22:04+00:00</created-at>
      <creator-id type="integer">23341</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3388</number>
      <permalink>activerecord-splits-log-records-across-multiple-lines</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag nil="true"></tag>
      <title>ActiveRecord splits log records across multiple lines</title>
      <updated-at type="datetime">2009-12-09T15:22:05+00:00</updated-at>
      <user-id type="integer">23341</user-id>
      <version type="integer">3</version>
      <user-name>Sam Ruby</user-name>
      <creator-name>Sam Ruby</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3388</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>You can solve the ANSI control characters issue with `config.colorize_logging = false`.

As for the multiline SQL, I would almost say it's an easy fix in ActiveRecord::Railties::Subscriber:

    - sql  = event.payload[:sql].squeeze(' ')
    + sql  = event.payload[:sql].gsub(/\s+/, ' ').strip

The only problem with this (and with the current use of #squeeze) is that there is the possibility you'll inadvertently change the SQL statement itself! For instance, queries with intentional extra spaces in a condition:

    &quot;SELECT * FROM table_a WHERE col1 LIKE 'something  something else'&quot; # Note the double space in LIKE clause

This is probably a rare case, but I think it's pretty important for the logger to log the same SQL that was presented to the connection adapter. Maybe the white space can be trimmed ahead of time, before it reaches the logger?</body>
      <body-html>&lt;div&gt;&lt;p&gt;You can solve the ANSI control characters issue with
&lt;code&gt;config.colorize_logging = false&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;As for the multiline SQL, I would almost say it's an easy fix in
ActiveRecord::Railties::Subscriber:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;- sql  = event.payload[:sql].squeeze(' ')
+ sql  = event.payload[:sql].gsub(/\s+/, ' ').strip&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;The only problem with this (and with the current use of
#squeeze) is that there is the possibility you'll inadvertently
change the SQL statement itself! For instance, queries with
intentional extra spaces in a condition:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;&quot;SELECT * FROM table_a WHERE col1 LIKE 'something  something else'&quot; # Note the double space in LIKE clause&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;This is probably a rare case, but I think it's pretty important
for the logger to log the same SQL that was presented to the
connection adapter. Maybe the white space can be trimmed ahead of
time, before it reaches the logger?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-17T21:35:53+00:00</created-at>
      <creator-id type="integer">23341</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3388</number>
      <permalink>activerecord-splits-log-records-across-multiple-lines</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag nil="true"></tag>
      <title>ActiveRecord splits log records across multiple lines</title>
      <updated-at type="datetime">2010-01-17T21:35:57+00:00</updated-at>
      <user-id type="integer">21894</user-id>
      <version type="integer">4</version>
      <user-name>Ben Marini</user-name>
      <creator-name>Sam Ruby</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3388</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I cannot reproduce this; logs look fine to me using the latest version of rails. I tried both sqlite and mysql.

@@@
Migrating to CreateOrders (20100118042221)
  SQL (0.2ms)  select sqlite_version(*)
  SQL (0.6ms)  CREATE TABLE &quot;orders&quot; (&quot;id&quot; INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, &quot;name&quot; varchar(255), &quot;created_at&quot; datetime, &quot;updated_at&quot; datetime) 
  Order Load (0.3ms)  SELECT &quot;orders&quot;.&quot;id&quot;, &quot;orders&quot;.&quot;name&quot;, &quot;orders&quot;.&quot;created_at&quot;, &quot;orders&quot;.&quot;updated_at&quot; FROM &quot;orders&quot; LIMIT 1

Migrating to CreateOrders (20100118042221)
  SQL (95.3ms)  CREATE TABLE `schema_migrations` (`version` varchar(255) NOT NULL) ENGINE=InnoDB
  SQL (47.8ms)  CREATE UNIQUE INDEX `unique_schema_migrations` ON `schema_migrations` (`version`)
  SQL (0.3ms)  SET SQL_AUTO_IS_NULL=0
  orders Columns (74.2ms)  SHOW FIELDS FROM `orders`
  Order Load (0.3ms)  SELECT `orders`.`id`, `orders`.`name`, `orders`.`created_at`, `orders`.`updated_at` FROM `orders` LIMIT 1
@@@

Am I missing something here?</body>
      <body-html>&lt;div&gt;&lt;p&gt;I cannot reproduce this; logs look fine to me using the latest
version of rails. I tried both sqlite and mysql.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;Migrating to CreateOrders (20100118042221)
  SQL (0.2ms)  select sqlite_version(*)
  SQL (0.6ms)  CREATE TABLE &quot;orders&quot; (&quot;id&quot; INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL, &quot;name&quot; varchar(255), &quot;created_at&quot; datetime, &quot;updated_at&quot; datetime) 
  Order Load (0.3ms)  SELECT &quot;orders&quot;.&quot;id&quot;, &quot;orders&quot;.&quot;name&quot;, &quot;orders&quot;.&quot;created_at&quot;, &quot;orders&quot;.&quot;updated_at&quot; FROM &quot;orders&quot; LIMIT 1

Migrating to CreateOrders (20100118042221)
  SQL (95.3ms)  CREATE TABLE `schema_migrations` (`version` varchar(255) NOT NULL) ENGINE=InnoDB
  SQL (47.8ms)  CREATE UNIQUE INDEX `unique_schema_migrations` ON `schema_migrations` (`version`)
  SQL (0.3ms)  SET SQL_AUTO_IS_NULL=0
  orders Columns (74.2ms)  SHOW FIELDS FROM `orders`
  Order Load (0.3ms)  SELECT `orders`.`id`, `orders`.`name`, `orders`.`created_at`, `orders`.`updated_at` FROM `orders` LIMIT 1&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Am I missing something here?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-18T04:28:34+00:00</created-at>
      <creator-id type="integer">23341</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3388</number>
      <permalink>activerecord-splits-log-records-across-multiple-lines</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag nil="true"></tag>
      <title>ActiveRecord splits log records across multiple lines</title>
      <updated-at type="datetime">2010-01-18T04:28:36+00:00</updated-at>
      <user-id type="integer">2529</user-id>
      <version type="integer">5</version>
      <user-name>Daniel Guettler</user-name>
      <creator-name>Sam Ruby</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3388</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-02-03T12:57:22+00:00</created-at>
      <creator-id type="integer">23341</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3388</number>
      <permalink>activerecord-splits-log-records-across-multiple-lines</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag nil="true"></tag>
      <title>ActiveRecord splits log records across multiple lines</title>
      <updated-at type="datetime">2010-02-03T12:57:25+00:00</updated-at>
      <user-id type="integer">23341</user-id>
      <version type="integer">6</version>
      <user-name>Sam Ruby</user-name>
      <creator-name>Sam Ruby</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3388</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>[[bulk edit](/projects/8994/bulk_edits/31647)]</body>
      <body-html>&lt;div&gt;&lt;p&gt;[&lt;a href=&quot;/projects/8994/bulk_edits/31647&quot;&gt;bulk edit&lt;/a&gt;]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-10-15T23:01:37+01:00</created-at>
      <creator-id type="integer">23341</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
:milestone: 27004
</diffable-attributes>
      <milestone-id type="integer">88038</milestone-id>
      <number type="integer">3388</number>
      <permalink>activerecord-splits-log-records-across-multiple-lines</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag nil="true"></tag>
      <title>ActiveRecord splits log records across multiple lines</title>
      <updated-at type="datetime">2010-10-15T23:01:37+01:00</updated-at>
      <user-id type="integer">85</user-id>
      <version type="integer">7</version>
      <user-name>Jeremy Kemper</user-name>
      <creator-name>Sam Ruby</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3388</url>
      <milestone-title>3.0.2</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Automatic cleanup of spam.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Automatic cleanup of spam.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-11-08T08:22:26+00:00</created-at>
      <creator-id type="integer">23341</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">88038</milestone-id>
      <number type="integer">3388</number>
      <permalink>activerecord-splits-log-records-across-multiple-lines</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag nil="true"></tag>
      <title>ActiveRecord splits log records across multiple lines</title>
      <updated-at type="datetime">2010-11-08T08:22:34+00:00</updated-at>
      <user-id type="integer">94458</user-id>
      <version type="integer">9</version>
      <user-name>Jeff Kreeftmeijer</user-name>
      <creator-name>Sam Ruby</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3388</url>
      <milestone-title>3.0.2</milestone-title>
      <priority-name>Low</priority-name>
    </version>
  </versions>
</ticket>
