<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer" nil="true"></assigned-user-id>
  <attachments-count type="integer">0</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2010-12-15T09:57:55+00:00</created-at>
  <creator-id type="integer">117097</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">6165</number>
  <permalink>foreign-key-is-not-set-on-nested-record</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>invalid</state>
  <tag nil="true"></tag>
  <title>Foreign key is not set on nested record</title>
  <updated-at type="datetime">2011-01-27T12:24:52+00:00</updated-at>
  <user-id type="integer">89656</user-id>
  <version type="integer">8</version>
  <user-name>Rohit Arondekar</user-name>
  <creator-name>Alexander Zubkov</creator-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/6165</url>
  <priority-name>Low</priority-name>
  <original-body>I have two nested resources:
    resources :photo_albums do
      resources :photos
    end
These two models are correctly linked with has_many and belongs_to.

When adding a photo I get this error:
    Mysql2::Error: Column 'photo_album_id' cannot be null

The workaround is to add this line to my controller:
    @photo.photo_album_id = params[:photo_album_id]

But in rails 2.3 it was done automatically. Another application has broken only after update to Rails 3.0.3, I did not change anything else.</original-body>
  <latest-body>I have two nested resources:
    resources :photo_albums do
      resources :photos
    end
These two models are correctly linked with has_many and belongs_to.

When adding a photo I get this error:
    Mysql2::Error: Column 'photo_album_id' cannot be null

The workaround is to add this line to my controller:
    @photo.photo_album_id = params[:photo_album_id]

But in rails 2.3 it was done automatically. Another application has broken only after update to Rails 3.0.3, I did not change anything else.</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;I have two nested resources:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;resources :photo_albums do
  resources :photos
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;These two models are correctly linked with has_many and
belongs_to.&lt;/p&gt;
&lt;p&gt;When adding a photo I get this error:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;Mysql2::Error: Column 'photo_album_id' cannot be null&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;The workaround is to add this line to my controller:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;@photo.photo_album_id = params[:photo_album_id]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;But in rails 2.3 it was done automatically. Another application
has broken only after update to Rails 3.0.3, I did not change
anything else.&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I have two nested resources:
    resources :photo_albums do
      resources :photos
    end
These two models are correctly linked with has_many and belongs_to.

When adding a photo I get this error:
    Mysql2::Error: Column 'photo_album_id' cannot be null

The workaround is to add this line to my controller:
    @photo.photo_album_id = params[:photo_album_id]

But in rails 2.3 it was done automatically. Another application has broken only after update to Rails 3.0.3, I did not change anything else.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I have two nested resources:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;resources :photo_albums do
  resources :photos
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;These two models are correctly linked with has_many and
belongs_to.&lt;/p&gt;
&lt;p&gt;When adding a photo I get this error:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;Mysql2::Error: Column 'photo_album_id' cannot be null&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;The workaround is to add this line to my controller:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;@photo.photo_album_id = params[:photo_album_id]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;But in rails 2.3 it was done automatically. Another application
has broken only after update to Rails 3.0.3, I did not change
anything else.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-14T19:51:57+00:00</created-at>
      <creator-id type="integer">117097</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6165</number>
      <permalink>foreign-key-is-not-set-on-nested-record</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>Foreign key is not set on nested record</title>
      <updated-at type="datetime">2010-12-14T19:52:04+00:00</updated-at>
      <user-id type="integer">117097</user-id>
      <version type="integer">1</version>
      <user-name>Alexander Zubkov</user-name>
      <creator-name>Alexander Zubkov</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6165</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>off as just a plain bracelet and then &lt;strong&gt;&lt;A href=&quot;http://www.ukonlinejewelry.com&quot;&gt;buy cheap pandora jewelry&lt;/A&gt;&lt;/strong&gt;
 the fun starts as you select the beads &lt;strong&gt;&lt;A href=&quot;http://www.ukonlinejewelry.com&quot;&gt;buy pandora beads&lt;/A&gt;&lt;/strong&gt;
 to go on it. There are many colors and shapes  to choose from, you could &lt;strong&gt;&lt;A href=&quot;http://www.ukonlinejewelry.com&quot;&gt;cheap pandora beads&lt;/A&gt;&lt;/strong&gt; even add your initials. 
Lets hope these Christmas gift ideas help &lt;strong&gt;&lt;A href=&quot;http://www.ukonlinejewelry.com&quot;&gt;authentic pandora charms&lt;/A&gt;&lt;/strong&gt;
 you when doing your shopping and maybe the women in your life may find a Coach purse, ToyWatch or Pandora bracelet under their tree.</body>
      <body-html>&lt;div&gt;&lt;p&gt;off as just a plain bracelet and then &lt;strong&gt;&lt;a href=
&quot;http://www.ukonlinejewelry.com&quot;&gt;buy cheap pandora
jewelry&lt;/a&gt;&lt;/strong&gt;&lt;br&gt;
the fun starts as you select the beads &lt;strong&gt;&lt;a href=
&quot;http://www.ukonlinejewelry.com&quot;&gt;buy pandora beads&lt;/a&gt;&lt;/strong&gt; to
go on it. There are many colors and shapes to choose from, you
could &lt;strong&gt;&lt;a href=&quot;http://www.ukonlinejewelry.com&quot;&gt;cheap
pandora beads&lt;/a&gt;&lt;/strong&gt; even add your initials. Lets hope these
Christmas gift ideas help &lt;strong&gt;&lt;a href=
&quot;http://www.ukonlinejewelry.com&quot;&gt;authentic pandora
charms&lt;/a&gt;&lt;/strong&gt;&lt;br&gt;
you when doing your shopping and maybe the women in your life may
find a Coach purse, ToyWatch or Pandora bracelet under their
tree.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-15T07:41:12+00:00</created-at>
      <creator-id type="integer">117097</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6165</number>
      <permalink>foreign-key-is-not-set-on-nested-record</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>Foreign key is not set on nested record</title>
      <updated-at type="datetime">2010-12-15T09:57:55+00:00</updated-at>
      <user-id type="integer">129082</user-id>
      <version type="integer">2</version>
      <user-name>mqf1989</user-name>
      <creator-name>Alexander Zubkov</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6165</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Don't you agree it is a bug? Any comments?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Don't you agree it is a bug? Any comments?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-26T08:26:59+00:00</created-at>
      <creator-id type="integer">117097</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6165</number>
      <permalink>foreign-key-is-not-set-on-nested-record</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>Foreign key is not set on nested record</title>
      <updated-at type="datetime">2011-01-26T08:27:01+00:00</updated-at>
      <user-id type="integer">117097</user-id>
      <version type="integer">3</version>
      <user-name>Alexander Zubkov</user-name>
      <creator-name>Alexander Zubkov</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6165</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Alexander, could you please paste the relevant code of the models as well for completeness. Also are you using &lt;code&gt;@photo.photo_albums.build(params[:photo_album])&lt;/code&gt; &amp;mdash; since &lt;code&gt;#create&lt;/code&gt; &amp; &lt;code&gt;#new&lt;/code&gt; will not fill the &lt;code&gt;photo_album_id&lt;/code&gt; automatically while &lt;code&gt;#build&lt;/code&gt; will.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Alexander, could you please paste the relevant code of the
models as well for completeness. Also are you using
&lt;code&gt;@photo.photo_albums.build(params[:photo_album])&lt;/code&gt;
&amp;mdash; since &lt;code&gt;#create&lt;/code&gt; &amp;amp; &lt;code&gt;#new&lt;/code&gt; will not
fill the &lt;code&gt;photo_album_id&lt;/code&gt; automatically while
&lt;code&gt;#build&lt;/code&gt; will.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-26T09:57:28+00:00</created-at>
      <creator-id type="integer">117097</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6165</number>
      <permalink>foreign-key-is-not-set-on-nested-record</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>Foreign key is not set on nested record</title>
      <updated-at type="datetime">2011-01-26T09:57:44+00:00</updated-at>
      <user-id type="integer">89656</user-id>
      <version type="integer">4</version>
      <user-name>Rohit Arondekar</user-name>
      <creator-name>Alexander Zubkov</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6165</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>class PhotoAlbum &lt; ActiveRecord::Base
  attr_accessible :name, :description, :visible

  has_many :photos, :dependent =&gt; :destroy

  validates_presence_of :name

  scope :visible, lambda { |admin| where(:visible =&gt; true) unless admin }

  cattr_reader :per_page
  @@per_page = 6
end

class Photo &lt; ActiveRecord::Base
  attr_accessible :name, :position, :photo, :visible, :photo_album_id

  belongs_to :photo_album

  has_attached_file :photo, :styles =&gt; {
      :cover =&gt; '100x100#',
      :thumb =&gt; '150x150#',
      :original =&gt; '980x720&gt;' }

  before_post_process { translit_paperclip_file_name self.photo }

  scope :visible, lambda { |admin| where(:visible =&gt; true) unless admin }

  before_save :set_position, :on =&gt; :create

  protected
  def set_position
    self.position = 1 + Photo.where(:photo_album_id =&gt; self.photo_album_id).maximum(:position).to_i
  end
end

Well, I use cancan with load_resource, so I skip that line: 
  @photo.photo_albums.build(params[:photo_album])
in my controller. I don't know, if cancan is using #new or #build, but probably it is a cancan bug, I will check and answer later. Thank you.</body>
      <body-html>&lt;div&gt;&lt;p&gt;class PhotoAlbum &amp;lt; ActiveRecord::Base&lt;br&gt;
attr_accessible :name, :description, :visible&lt;/p&gt;
&lt;p&gt;has_many :photos, :dependent =&amp;gt; :destroy&lt;/p&gt;
&lt;p&gt;validates_presence_of :name&lt;/p&gt;
&lt;p&gt;scope :visible, lambda { |admin| where(:visible =&amp;gt; true)
unless admin }&lt;/p&gt;
&lt;p&gt;cattr_reader :per_page @@per_page = 6 end&lt;/p&gt;
&lt;p&gt;class Photo &amp;lt; ActiveRecord::Base&lt;br&gt;
attr_accessible :name, :position, :photo, :visible,
:photo_album_id&lt;/p&gt;
&lt;p&gt;belongs_to :photo_album&lt;/p&gt;
&lt;p&gt;has_attached_file :photo, :styles =&amp;gt; {&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;  :cover =&amp;gt; '100x100#',
  :thumb =&amp;gt; '150x150#',
  :original =&amp;gt; '980x720&amp;gt;' }&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;before_post_process { translit_paperclip_file_name self.photo
}&lt;/p&gt;
&lt;p&gt;scope :visible, lambda { |admin| where(:visible =&amp;gt; true)
unless admin }&lt;/p&gt;
&lt;p&gt;before_save :set_position, :on =&amp;gt; :create&lt;/p&gt;
&lt;p&gt;protected def set_position&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;self.position = 1 + Photo.where(:photo_album_id =&amp;gt; self.photo_album_id).maximum(:position).to_i&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;end end&lt;/p&gt;
&lt;p&gt;Well, I use cancan with load_resource, so I skip that line:&lt;br&gt;
@photo.photo_albums.build(params[:photo_album]) in my controller. I
don't know, if cancan is using #new or #build, but probably it is a
cancan bug, I will check and answer later. Thank you.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-26T11:33:03+00:00</created-at>
      <creator-id type="integer">117097</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6165</number>
      <permalink>foreign-key-is-not-set-on-nested-record</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>Foreign key is not set on nested record</title>
      <updated-at type="datetime">2011-01-26T11:33:14+00:00</updated-at>
      <user-id type="integer">117097</user-id>
      <version type="integer">5</version>
      <user-name>Alexander Zubkov</user-name>
      <creator-name>Alexander Zubkov</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6165</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I have not used cancan before but just browsing it's source code on Github I found https://github.com/ryanb/cancan/blob/master/lib/cancan/controller_additions.rb#L112:

@@@ ruby
  # [:+new+]
  #   Specify which actions are new resource actions in addition to :+new+ and :+create+.
  #   Pass an action name into here if you would like to build a new resource instead of
  #   fetch one.
  #
  #     load_resource :new =&gt; :build
@@@

Are you using that? If not it might be what you are looking for.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I have not used cancan before but just browsing it's source code
on Github I found &lt;a href=
&quot;https://github.com/ryanb/cancan/blob/master/lib/cancan/controller_additions.rb#L112&quot;&gt;
https://github.com/ryanb/cancan/blob/master/lib/cancan/controller_a...&lt;/a&gt;:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;  # [:+new+]
  #   Specify which actions are new resource actions in addition to :+new+ and :+create+.
  #   Pass an action name into here if you would like to build a new resource instead of
  #   fetch one.
  #
  #     load_resource :new =&amp;gt; :build&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Are you using that? If not it might be what you are looking
for.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-27T06:12:52+00:00</created-at>
      <creator-id type="integer">117097</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6165</number>
      <permalink>foreign-key-is-not-set-on-nested-record</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>Foreign key is not set on nested record</title>
      <updated-at type="datetime">2011-01-27T06:13:02+00:00</updated-at>
      <user-id type="integer">89656</user-id>
      <version type="integer">6</version>
      <user-name>Rohit Arondekar</user-name>
      <creator-name>Alexander Zubkov</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6165</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Yes, you're right. #new does not set foreign key, even on Rails 2.3. So probably cancan behavior has changed, so I had to add that line. Thank you for explanations. It's not Rails bug, let's close this ticket.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Yes, you're right. #new does not set foreign key, even on Rails
2.3. So probably cancan behavior has changed, so I had to add that
line. Thank you for explanations. It's not Rails bug, let's close
this ticket.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-27T11:12:46+00:00</created-at>
      <creator-id type="integer">117097</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6165</number>
      <permalink>foreign-key-is-not-set-on-nested-record</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>Foreign key is not set on nested record</title>
      <updated-at type="datetime">2011-01-27T11:12:57+00:00</updated-at>
      <user-id type="integer">117097</user-id>
      <version type="integer">7</version>
      <user-name>Alexander Zubkov</user-name>
      <creator-name>Alexander Zubkov</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6165</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Cheers :)</body>
      <body-html>&lt;div&gt;&lt;p&gt;Cheers :)&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-01-27T12:24:43+00:00</created-at>
      <creator-id type="integer">117097</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6165</number>
      <permalink>foreign-key-is-not-set-on-nested-record</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>invalid</state>
      <tag nil="true"></tag>
      <title>Foreign key is not set on nested record</title>
      <updated-at type="datetime">2011-01-27T12:24:52+00:00</updated-at>
      <user-id type="integer">89656</user-id>
      <version type="integer">8</version>
      <user-name>Rohit Arondekar</user-name>
      <creator-name>Alexander Zubkov</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6165</url>
      <priority-name>Low</priority-name>
    </version>
  </versions>
</ticket>
