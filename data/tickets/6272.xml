<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">7697</assigned-user-id>
  <attachments-count type="integer">0</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2011-01-10T14:19:15+00:00</created-at>
  <creator-id type="integer">30238</creator-id>
  <milestone-due-on type="datetime">2011-03-27T00:00:00+00:00</milestone-due-on>
  <milestone-id type="integer">103410</milestone-id>
  <number type="integer">6272</number>
  <permalink>cookie-value-set-in-functional-test-key-present-in-controller-but-unreadable</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>resolved</state>
  <tag>cookies testing &quot;testing environment&quot;</tag>
  <title>Cookie value set in functional test, key present in controller but unreadable</title>
  <updated-at type="datetime">2011-03-06T15:03:41+00:00</updated-at>
  <user-id type="integer">17393</user-id>
  <version type="integer">4</version>
  <user-name>Repository</user-name>
  <creator-name>Marko Anastasov</creator-name>
  <assigned-user-name>Andrew White</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/6272</url>
  <milestone-title>3.0.6</milestone-title>
  <priority-name>Low</priority-name>
  <original-body>Initially I posted a message on rspec-users, but was told[0] that this sounds like a Rails bug.

I set a value in controller spec using @request.cookies:
https://gist.github.com/371356ba0a19666fd3b5

but when the controller reads it, it's nil somehow, even though the key is present, as this screenshot from the debugger shows:
http://dl.dropbox.com/u/830772/p/Selection_033.jpeg

This happens in test environment only. Eventually I figured out that I can use request.cookies in controller to make it work. But it's strange that I need to.

I'm using RSpec 2.4 and Rails 3.0.3.

[0] http://rubyforge.org/pipermail/rspec-users/2011-January/019143.html</original-body>
  <latest-body>Initially I posted a message on rspec-users, but was told[0] that this sounds like a Rails bug.

I set a value in controller spec using @request.cookies:
https://gist.github.com/371356ba0a19666fd3b5

but when the controller reads it, it's nil somehow, even though the key is present, as this screenshot from the debugger shows:
http://dl.dropbox.com/u/830772/p/Selection_033.jpeg

This happens in test environment only. Eventually I figured out that I can use request.cookies in controller to make it work. But it's strange that I need to.

I'm using RSpec 2.4 and Rails 3.0.3.

[0] http://rubyforge.org/pipermail/rspec-users/2011-January/019143.html</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;Initially I posted a message on rspec-users, but was told[0]
that this sounds like a Rails bug.&lt;/p&gt;
&lt;p&gt;I set a value in controller spec using @request.cookies:&lt;br&gt;
&lt;a href=
&quot;https://gist.github.com/371356ba0a19666fd3b5&quot;&gt;https://gist.github.com/371356ba0a19666fd3b5&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;but when the controller reads it, it's nil somehow, even though
the key is present, as this screenshot from the debugger shows:&lt;br&gt;
&lt;a href=
&quot;http://dl.dropbox.com/u/830772/p/Selection_033.jpeg&quot;&gt;http://dl.dropbox.com/u/830772/p/Selection_033.jpeg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This happens in test environment only. Eventually I figured out
that I can use request.cookies in controller to make it work. But
it's strange that I need to.&lt;/p&gt;
&lt;p&gt;I'm using RSpec 2.4 and Rails 3.0.3.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/projects/8994/changesets/0&quot; title=
&quot;Changeset [0]&quot;&gt;[0]&lt;/a&gt; &lt;a href=
&quot;http://rubyforge.org/pipermail/rspec-users/2011-January/019143.html&quot;&gt;
http://rubyforge.org/pipermail/rspec-users/2011-January/019143.html&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Initially I posted a message on rspec-users, but was told[0] that this sounds like a Rails bug.

I set a value in controller spec using @request.cookies:
https://gist.github.com/371356ba0a19666fd3b5

but when the controller reads it, it's nil somehow, even though the key is present, as this screenshot from the debugger shows:
http://dl.dropbox.com/u/830772/p/Selection_033.jpeg

This happens in test environment only. Eventually I figured out that I can use request.cookies in controller to make it work. But it's strange that I need to.

I'm using RSpec 2.4 and Rails 3.0.3.

[0] http://rubyforge.org/pipermail/rspec-users/2011-January/019143.html</body>
      <body-html>&lt;div&gt;&lt;p&gt;Initially I posted a message on rspec-users, but was told[0]
that this sounds like a Rails bug.&lt;/p&gt;
&lt;p&gt;I set a value in controller spec using @request.cookies:&lt;br&gt;
&lt;a href=
&quot;https://gist.github.com/371356ba0a19666fd3b5&quot;&gt;https://gist.github.com/371356ba0a19666fd3b5&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;but when the controller reads it, it's nil somehow, even though
the key is present, as this screenshot from the debugger shows:&lt;br&gt;
&lt;a href=
&quot;http://dl.dropbox.com/u/830772/p/Selection_033.jpeg&quot;&gt;http://dl.dropbox.com/u/830772/p/Selection_033.jpeg&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This happens in test environment only. Eventually I figured out
that I can use request.cookies in controller to make it work. But
it's strange that I need to.&lt;/p&gt;
&lt;p&gt;I'm using RSpec 2.4 and Rails 3.0.3.&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;/projects/8994/changesets/0&quot; title=
&quot;Changeset [0]&quot;&gt;[0]&lt;/a&gt; &lt;a href=
&quot;http://rubyforge.org/pipermail/rspec-users/2011-January/019143.html&quot;&gt;
http://rubyforge.org/pipermail/rspec-users/2011-January/019143.html&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-10T14:19:15+00:00</created-at>
      <creator-id type="integer">30238</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6272</number>
      <permalink>cookie-value-set-in-functional-test-key-present-in-controller-but-unreadable</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>cookies testing &quot;testing environment&quot;</tag>
      <title>Cookie value set in functional test, key present in controller but unreadable</title>
      <updated-at type="datetime">2011-01-10T14:19:18+00:00</updated-at>
      <user-id type="integer">30238</user-id>
      <version type="integer">1</version>
      <user-name>Marko Anastasov</user-name>
      <creator-name>Marko Anastasov</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6272</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">7697</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>It looks as though this has been [addressed in master somewhat][1], but you still need to use string keys when assigning the cookie in the request. The cookies hash is cached in the request and the symbol key is assigned. However the access in the controller is done using a string key and the nil value is cached in the hash so you end up with both the string and symbol keys in the cookies hash.

The fix is to clear the cookies instance variable when the request object is recycled, after first writing out the cookies to HTTP_COOKIE in the environment hash. AD::TestRequest.write_cookies! also needs fixing so that it escapes the cookie values as well.

I'll come up with a patch this weekend, in the meantime just assign cookie value using a string key.

[1]: https://github.com/rails/rails/commit/990f52ebd78df77d73a2187751c6e1bb6d4b6033</body>
      <body-html>&lt;div&gt;&lt;p&gt;It looks as though this has been &lt;a href=
&quot;https://github.com/rails/rails/commit/990f52ebd78df77d73a2187751c6e1bb6d4b6033&quot;&gt;
addressed in master somewhat&lt;/a&gt;, but you still need to use string
keys when assigning the cookie in the request. The cookies hash is
cached in the request and the symbol key is assigned. However the
access in the controller is done using a string key and the nil
value is cached in the hash so you end up with both the string and
symbol keys in the cookies hash.&lt;/p&gt;
&lt;p&gt;The fix is to clear the cookies instance variable when the
request object is recycled, after first writing out the cookies to
HTTP_COOKIE in the environment hash. AD::TestRequest.write_cookies!
also needs fixing so that it escapes the cookie values as well.&lt;/p&gt;
&lt;p&gt;I'll come up with a patch this weekend, in the meantime just
assign cookie value using a string key.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-03-05T12:19:04+00:00</created-at>
      <creator-id type="integer">30238</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
:state: new
:milestone: 
:assigned_user: 
</diffable-attributes>
      <milestone-id type="integer">103410</milestone-id>
      <number type="integer">6272</number>
      <permalink>cookie-value-set-in-functional-test-key-present-in-controller-but-unreadable</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>cookies testing &quot;testing environment&quot;</tag>
      <title>Cookie value set in functional test, key present in controller but unreadable</title>
      <updated-at type="datetime">2011-03-05T12:19:13+00:00</updated-at>
      <user-id type="integer">7697</user-id>
      <version type="integer">2</version>
      <user-name>Andrew White</user-name>
      <creator-name>Marko Anastasov</creator-name>
      <assigned-user-name>Andrew White</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6272</url>
      <milestone-title>3.0.6</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">7697</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>(from [e2523ff68309f444cd052031c1fe8a3030d2865a]) Improve testing of cookies in functional tests:
- cookies can be set using string or symbol keys
- cookies are preserved across calls to get, post, etc.
- cookie names and values are escaped
- cookies can be cleared using @request.cookies.clear

[#6272 state:resolved]
https://github.com/rails/rails/commit/e2523ff68309f444cd052031c1fe8a3030d2865a</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from &lt;a href=
&quot;/projects/8994/changesets/e2523ff68309f444cd052031c1fe8a3030d2865a&quot;
title=
&quot;Changeset [e2523ff68309f444cd052031c1fe8a3030d2865a]&quot;&gt;[e2523ff68309f444cd052031c1fe8a3030d2865a]&lt;/a&gt;)
Improve testing of cookies in functional tests: - cookies can be
set using string or symbol keys - cookies are preserved across
calls to get, post, etc. - cookie names and values are escaped -
cookies can be cleared using @request.cookies.clear&lt;/p&gt;
&lt;p&gt;[&lt;a href=&quot;/projects/8994/tickets/6272&quot; title=
&quot;Ticket #6272&quot;&gt;#6272&lt;/a&gt; state:resolved] &lt;a href=
&quot;https://github.com/rails/rails/commit/e2523ff68309f444cd052031c1fe8a3030d2865a&quot;&gt;
https://github.com/rails/rails/commit/e2523ff68309f444cd052031c1fe8...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-03-06T15:03:21+00:00</created-at>
      <creator-id type="integer">30238</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer">103410</milestone-id>
      <number type="integer">6272</number>
      <permalink>cookie-value-set-in-functional-test-key-present-in-controller-but-unreadable</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>cookies testing &quot;testing environment&quot;</tag>
      <title>Cookie value set in functional test, key present in controller but unreadable</title>
      <updated-at type="datetime">2011-03-06T15:03:31+00:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">3</version>
      <user-name>Repository</user-name>
      <creator-name>Marko Anastasov</creator-name>
      <assigned-user-name>Andrew White</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6272</url>
      <milestone-title>3.0.6</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">7697</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>(from [31f09f9dbc1b8e598fc82d86b622167bfc01d18a]) Improve testing of cookies in functional tests:
- cookies can be set using string or symbol keys
- cookies are preserved across calls to get, post, etc.
- cookie names and values are escaped
- cookies can be cleared using @request.cookies.clear

[#6272 state:resolved]
https://github.com/rails/rails/commit/31f09f9dbc1b8e598fc82d86b622167bfc01d18a</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from &lt;a href=
&quot;/projects/8994/changesets/31f09f9dbc1b8e598fc82d86b622167bfc01d18a&quot;
title=
&quot;Changeset [31f09f9dbc1b8e598fc82d86b622167bfc01d18a]&quot;&gt;[31f09f9dbc1b8e598fc82d86b622167bfc01d18a]&lt;/a&gt;)
Improve testing of cookies in functional tests: - cookies can be
set using string or symbol keys - cookies are preserved across
calls to get, post, etc. - cookie names and values are escaped -
cookies can be cleared using @request.cookies.clear&lt;/p&gt;
&lt;p&gt;[&lt;a href=&quot;/projects/8994/tickets/6272&quot; title=
&quot;Ticket #6272&quot;&gt;#6272&lt;/a&gt; state:resolved] &lt;a href=
&quot;https://github.com/rails/rails/commit/31f09f9dbc1b8e598fc82d86b622167bfc01d18a&quot;&gt;
https://github.com/rails/rails/commit/31f09f9dbc1b8e598fc82d86b6221...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-03-06T15:03:31+00:00</created-at>
      <creator-id type="integer">30238</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">103410</milestone-id>
      <number type="integer">6272</number>
      <permalink>cookie-value-set-in-functional-test-key-present-in-controller-but-unreadable</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>cookies testing &quot;testing environment&quot;</tag>
      <title>Cookie value set in functional test, key present in controller but unreadable</title>
      <updated-at type="datetime">2011-03-06T15:03:41+00:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">4</version>
      <user-name>Repository</user-name>
      <creator-name>Marko Anastasov</creator-name>
      <assigned-user-name>Andrew White</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6272</url>
      <milestone-title>3.0.6</milestone-title>
      <priority-name>Low</priority-name>
    </version>
  </versions>
</ticket>
