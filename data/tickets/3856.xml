<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">40272</assigned-user-id>
  <attachments-count type="integer">2</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2010-02-05T00:16:29+00:00</created-at>
  <creator-id type="integer">40272</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">3856</number>
  <permalink>patch-more-html_safe-strings-now-use-the-safe_concat-method</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>committed</state>
  <tag>2.3-stable 3.0pre action_view helpers patch performance</tag>
  <title>[PATCH] More html_safe strings now use the safe_concat method</title>
  <updated-at type="datetime">2010-04-02T02:23:52+01:00</updated-at>
  <user-id type="integer">40272</user-id>
  <version type="integer">4</version>
  <user-name>Santiago Pastorino</user-name>
  <creator-name>Santiago Pastorino</creator-name>
  <assigned-user-name>Santiago Pastorino</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/3856</url>
  <priority-name>Low</priority-name>
  <original-body></original-body>
  <latest-body></latest-body>
  <original-body-html></original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer">12714</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-02-05T00:16:29+00:00</created-at>
      <creator-id type="integer">40272</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3856</number>
      <permalink>patch-more-html_safe-strings-now-use-the-safe_concat-method</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0pre action_view helpers patch performance</tag>
      <title>[PATCH] More html_safe strings now use the safe_concat method</title>
      <updated-at type="datetime">2010-02-05T00:16:34+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">1</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Santiago Pastorino</creator-name>
      <assigned-user-name>Yehuda Katz (wycats)</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3856</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">12714</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>(from [e115eb097e3e5704b9861b6f2b92cc25d23de07c]) More html_safe strings now use the safe_concat method

[#3856 state:committed]

Signed-off-by: Jeremy Kemper &lt;jeremy@bitsweat.net&gt;
http://github.com/rails/rails/commit/e115eb097e3e5704b9861b6f2b92cc25d23de07c</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from &lt;a href=
&quot;/projects/8994/changesets/e115eb097e3e5704b9861b6f2b92cc25d23de07c&quot;
title=
&quot;Changeset [e115eb097e3e5704b9861b6f2b92cc25d23de07c]&quot;&gt;[e115eb097e3e5704b9861b6f2b92cc25d23de07c]&lt;/a&gt;)
More html_safe strings now use the safe_concat method&lt;/p&gt;
&lt;p&gt;[&lt;a href=&quot;/projects/8994/tickets/3856&quot; title=
&quot;Ticket #3856&quot;&gt;#3856&lt;/a&gt; state:committed]&lt;/p&gt;
&lt;p&gt;Signed-off-by: Jeremy Kemper &lt;a&gt;jeremy@bitsweat.net&lt;/a&gt;&lt;br&gt;
&lt;a href=
&quot;http://github.com/rails/rails/commit/e115eb097e3e5704b9861b6f2b92cc25d23de07c&quot;&gt;
http://github.com/rails/rails/commit/e115eb097e3e5704b9861b6f2b92cc...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-02-05T21:29:46+00:00</created-at>
      <creator-id type="integer">40272</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3856</number>
      <permalink>patch-more-html_safe-strings-now-use-the-safe_concat-method</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>3.0pre action_view helpers patch performance</tag>
      <title>[PATCH] More html_safe strings now use the safe_concat method</title>
      <updated-at type="datetime">2010-02-05T21:29:48+00:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">2</version>
      <user-name>Repository</user-name>
      <creator-name>Santiago Pastorino</creator-name>
      <assigned-user-name>Yehuda Katz (wycats)</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3856</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>I think this commit might have broken something. I'm on 2.3-stable, freshly vendor'd from github, and I'm getting this error from any template calling `form_for`: &quot;undefined method `safe_concat' for &quot;&quot;:String&quot;. It's pretty easy to recreate from a tosser app, and Rails own tests currently fail for this. I am using Haml to render the bare-bones form_for inside &quot;new.html.haml&quot;, like everybody does, and this error occurs when using either haml stable or haml-edge.

&lt;pre&gt;
# gem list|grep -E 'rails|haml'
# haml (2.2.22)
# haml-edge (2.3.184)
# rails (2.3.5)

rails foobar
cd foobar/vendor
git clone git://github.com/rails/rails.git
cd rails
git checkout -b 2-3-stable origin/2-3-stable

cd actionpack
rake test_action_pack
&lt;/pre&gt;

After fifty-something FormHelper errors for &quot;Expected block to return true value&quot;, the test output fails:

&lt;pre&gt;
55) Error: test_safe_concat(TextHelperTest): NoMethodError: undefined method `safe_concat' for #&lt;TextHelperTest:0x0000000650e5f8&gt;
    /home/korch/safe_concat_broke/vendor/rails/actionpack/lib/action_controller/test_process.rb:511:in `method_missing'
    /home/korch/safe_concat_broke/vendor/rails/actionpack/lib/action_view/test_case.rb:158:in `method_missing'
    /home/korch/safe_concat_broke/vendor/rails/actionpack/test/template/text_helper_test.rb:27:in `test_safe_concat'
    /usr/local/ruby19/lib/ruby/gems/1.9.1/gems/mocha-0.9.8/lib/mocha/integration/mini_test/version_131_and_above.rb:26:in `run'
    /home/korch/safe_concat_broke/vendor/rails/activesupport/lib/active_support/testing/setup_and_teardown.rb:24:in `run'
&lt;/pre&gt;

Looking at actionpack/lib/action_view/helpers/text_helper.rb, I see it is now calling out to safe_concat. I thought this was a method only for Rails 3, so I'm not sure why it's appearing in the 2.3-stable branch(2.3.6)?

This safe_concat helper error goes away if I change line #29 in actionpack/lib/action_view/helpers/text_helper.rb like so:
&lt;pre&gt;
-        output_buffer.safe_concat(string)
+    
&lt;/pre&gt;    output_buffer.concat(string)


Test case attached and I think I got it right, as this is my first time submitting to Rails.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I think this commit might have broken something. I'm on
2.3-stable, freshly vendor'd from github, and I'm getting this
error from any template calling &lt;code&gt;form_for&lt;/code&gt;: &quot;undefined
method &lt;code&gt;safe_concat' for &quot;&quot;:String&quot;. It's pretty easy to
recreate from a tosser app, and Rails own tests currently fail for
this. I am using Haml to render the bare-bones form_for inside
&quot;new.html.haml&quot;, like everybody does, and this error occurs when
using either haml stable or haml-edge.&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;
# gem list|grep -E 'rails|haml'
# haml (2.2.22)
# haml-edge (2.3.184)
# rails (2.3.5)

rails foobar
cd foobar/vendor
git clone git://github.com/rails/rails.git
cd rails
git checkout -b 2-3-stable origin/2-3-stable

cd actionpack
rake test_action_pack
&lt;/pre&gt;
&lt;p&gt;After fifty-something FormHelper errors for &quot;Expected block to
return true value&quot;, the test output fails:&lt;/p&gt;
&lt;pre&gt;
55) Error: test_safe_concat(TextHelperTest): NoMethodError: undefined method `safe_concat' for #
    /home/korch/safe_concat_broke/vendor/rails/actionpack/lib/action_controller/test_process.rb:511:in `method_missing'
    /home/korch/safe_concat_broke/vendor/rails/actionpack/lib/action_view/test_case.rb:158:in `method_missing'
    /home/korch/safe_concat_broke/vendor/rails/actionpack/test/template/text_helper_test.rb:27:in `test_safe_concat'
    /usr/local/ruby19/lib/ruby/gems/1.9.1/gems/mocha-0.9.8/lib/mocha/integration/mini_test/version_131_and_above.rb:26:in `run'
    /home/korch/safe_concat_broke/vendor/rails/activesupport/lib/active_support/testing/setup_and_teardown.rb:24:in `run'
&lt;/pre&gt;
&lt;p&gt;Looking at actionpack/lib/action_view/helpers/text_helper.rb, I
see it is now calling out to safe_concat. I thought this was a
method only for Rails 3, so I'm not sure why it's appearing in the
2.3-stable branch(2.3.6)?&lt;/p&gt;
&lt;p&gt;This safe_concat helper error goes away if I change line
&lt;a href=&quot;/projects/8994/tickets/29&quot; title=&quot;Ticket #29&quot;&gt;#29&lt;/a&gt; in
actionpack/lib/action_view/helpers/text_helper.rb like so:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
-        output_buffer.safe_concat(string)
+  &lt;br&gt;
&lt;/pre&gt;
output_buffer.concat(string)
&lt;p&gt;Test case attached and I think I got it right, as this is my
first time submitting to Rails.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-04-02T00:01:29+01:00</created-at>
      <creator-id type="integer">40272</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 3.0pre action_view helpers patch performance
:assigned_user: 12714
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3856</number>
      <permalink>patch-more-html_safe-strings-now-use-the-safe_concat-method</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>2.3-stable 3.0pre action_view helpers patch performance</tag>
      <title>[PATCH] More html_safe strings now use the safe_concat method</title>
      <updated-at type="datetime">2010-04-02T00:01:38+01:00</updated-at>
      <user-id type="integer">31340</user-id>
      <version type="integer">3</version>
      <user-name>korch</user-name>
      <creator-name>Santiago Pastorino</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3856</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>The test you mention aren't failing and your patch doesn't work and doesn't make your test pass.
Can you send me another probe of a failure?.
Thanks for helping.</body>
      <body-html>&lt;div&gt;&lt;p&gt;The test you mention aren't failing and your patch doesn't work
and doesn't make your test pass.&lt;br&gt;
Can you send me another probe of a failure?.&lt;br&gt;
Thanks for helping.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-04-02T02:23:50+01:00</created-at>
      <creator-id type="integer">40272</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3856</number>
      <permalink>patch-more-html_safe-strings-now-use-the-safe_concat-method</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>2.3-stable 3.0pre action_view helpers patch performance</tag>
      <title>[PATCH] More html_safe strings now use the safe_concat method</title>
      <updated-at type="datetime">2010-04-02T02:23:52+01:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">4</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Santiago Pastorino</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3856</url>
      <priority-name nil="true"></priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>36da894e57391af20a92c6f2d094b1ad39f53534</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-02-05T00:16:29+00:00</created-at>
      <filename>more_safe_concat.patch</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">401643</id>
      <size type="integer">4148</size>
      <uploader-id type="integer">40272</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/401643/more_safe_concat.patch</url>
    </attachment>
    <attachment type="Attachment">
      <code>83b65c9c4917b079ef07b5b23657b327d7724529</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-04-02T00:01:29+01:00</created-at>
      <filename>safe_concat.patch</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">469180</id>
      <size type="integer">1274</size>
      <uploader-id type="integer">31340</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/469180/safe_concat.patch</url>
    </attachment>
  </attachments>
</ticket>
