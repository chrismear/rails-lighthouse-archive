<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">1366</assigned-user-id>
  <attachments-count type="integer">2</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2009-10-31T15:49:27+00:00</created-at>
  <creator-id type="integer">75022</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">3446</number>
  <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
  <priority type="integer">129427</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>wontfix</state>
  <tag>2.3.10 3.0.3 active_record tables_in_string</tag>
  <title>tables_in_string matches literal string containing dot</title>
  <updated-at type="datetime">2010-12-09T20:05:04+00:00</updated-at>
  <user-id type="integer">141</user-id>
  <version type="integer">23</version>
  <user-name>Michael Koziarski</user-name>
  <creator-name>xpmatteo</creator-name>
  <assigned-user-name>Pratik</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
  <priority-name nil="true"></priority-name>
  <original-body>When a query string contains dots, such as @@@&quot;x = 'foo.bar'&quot;@@@, the code that tries to understand which tables are mentioned in the query will mistake &quot;foo&quot; for a table name.  The consequence is that sometimes, a query with :include will be executed with a join rather than with separate queries.  And that can make the behaviour of ActiveRecord depend on user input. For example, 
@@@
:conditions =&gt; [&quot;x = ?&quot;, params[:input]]
@@@

In rare cases, this can cause a query to fail.

I provide a patch that tests for the problem and fixes it.  Although I'm not comfortable with this solution; it seems to me the code in tables_in_string is too naive.  This problem is similar to the one reported in ticket #532, which was fixed by improving the regexp.</original-body>
  <latest-body>When a query string contains dots, such as @@@&quot;x = 'foo.bar'&quot;@@@, the code that tries to understand which tables are mentioned in the query will mistake &quot;foo&quot; for a table name.  The consequence is that sometimes, a query with :include will be executed with a join rather than with separate queries.  And that can make the behaviour of ActiveRecord depend on user input. For example, 
@@@
:conditions =&gt; [&quot;x = ?&quot;, params[:input]]
@@@

In rare cases, this can cause a query to fail.

I provide a patch that tests for the problem and fixes it.  Although I'm not comfortable with this solution; it seems to me the code in tables_in_string is too naive.  This problem is similar to the one reported in ticket #532, which was fixed by improving the regexp.</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;When a query string contains dots, such as @@@&quot;x =
'foo.bar'&quot;@@@, the code that tries to understand which tables are
mentioned in the query will mistake &quot;foo&quot; for a table name. The
consequence is that sometimes, a query with :include will be
executed with a join rather than with separate queries. And that
can make the behaviour of ActiveRecord depend on user input. For
example,&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;:conditions =&amp;gt; [&quot;x = ?&quot;, params[:input]]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;In rare cases, this can cause a query to fail.&lt;/p&gt;
&lt;p&gt;I provide a patch that tests for the problem and fixes it.
Although I'm not comfortable with this solution; it seems to me the
code in tables_in_string is too naive. This problem is similar to
the one reported in ticket &lt;a href=&quot;/projects/8994/tickets/532&quot;
title=&quot;Ticket #532&quot;&gt;#532&lt;/a&gt;, which was fixed by improving the
regexp.&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer">14890</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>When a query string contains dots, such as @@@&quot;x = 'foo.bar'&quot;@@@, the code that tries to understand which tables are mentioned in the query will mistake &quot;foo&quot; for a table name.  The consequence is that sometimes, a query with :include will be executed with a join rather than with separate queries.  And that can make the behaviour of ActiveRecord depend on user input. For example, 
@@@
:conditions =&gt; [&quot;x = ?&quot;, params[:input]]
@@@

In rare cases, this can cause a query to fail.

I provide a patch that tests for the problem and fixes it.  Although I'm not comfortable with this solution; it seems to me the code in tables_in_string is too naive.  This problem is similar to the one reported in ticket #532, which was fixed by improving the regexp.</body>
      <body-html>&lt;div&gt;&lt;p&gt;When a query string contains dots, such as @@@&quot;x =
'foo.bar'&quot;@@@, the code that tries to understand which tables are
mentioned in the query will mistake &quot;foo&quot; for a table name. The
consequence is that sometimes, a query with :include will be
executed with a join rather than with separate queries. And that
can make the behaviour of ActiveRecord depend on user input. For
example,&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;:conditions =&amp;gt; [&quot;x = ?&quot;, params[:input]]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;In rare cases, this can cause a query to fail.&lt;/p&gt;
&lt;p&gt;I provide a patch that tests for the problem and fixes it.
Although I'm not comfortable with this solution; it seems to me the
code in tables_in_string is too naive. This problem is similar to
the one reported in ticket &lt;a href=&quot;/projects/8994/tickets/532&quot;
title=&quot;Ticket #532&quot;&gt;#532&lt;/a&gt;, which was fixed by improving the
regexp.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-10-31T15:49:27+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2009-10-31T15:49:32+00:00</updated-at>
      <user-id type="integer">75022</user-id>
      <version type="integer">1</version>
      <user-name>xpmatteo</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Tarmo T&#228;nav</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-10-31T15:51:42+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- 
:assigned_user: 14890
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2009-10-31T15:51:45+00:00</updated-at>
      <user-id type="integer">75022</user-id>
      <version type="integer">2</version>
      <user-name>xpmatteo</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Improved the regexp (and test) to filter out *all* string literals.  (I think...)</body>
      <body-html>&lt;div&gt;&lt;p&gt;Improved the regexp (and test) to filter out &lt;em&gt;all&lt;/em&gt; string
literals. (I think...)&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-11-05T13:29:11+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2009-11-05T13:29:14+00:00</updated-at>
      <user-id type="integer">75022</user-id>
      <version type="integer">3</version>
      <user-name>xpmatteo</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>I've just run across this issue. I created a test case which shows it off, using searchlogic, because I initially assumed the error was in there:

http://gist.github.com/439071

I'll give xpmatteo's patch a try, see if that fixes my test case.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I've just run across this issue. I created a test case which
shows it off, using searchlogic, because I initially assumed the
error was in there:&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;http://gist.github.com/439071&quot;&gt;http://gist.github.com/439071&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;I'll give xpmatteo's patch a try, see if that fixes my test
case.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-06-15T15:05:11+01:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-06-15T15:05:21+01:00</updated-at>
      <user-id type="integer">749</user-id>
      <version type="integer">4</version>
      <user-name>Graeme Mathieson</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Yep, works for me. +1</body>
      <body-html>&lt;div&gt;&lt;p&gt;Yep, works for me. +1&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-06-15T15:19:38+01:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-06-15T15:19:44+01:00</updated-at>
      <user-id type="integer">749</user-id>
      <version type="integer">5</version>
      <user-name>Graeme Mathieson</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Dodgy monkey patch for anyone else who stumbles across this:

@@@ ruby
ActiveRecord::Associations::ClassMethods.module_eval do
  def tables_in_string(string)
    return [] if string.blank?
    string.gsub(/'(\\'|[^'])*'|&quot;(\\&quot;|[^&quot;])*&quot;/, '').scan(/([a-zA-Z_][\.\w]+).?\./).flatten
  end
end
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;Dodgy monkey patch for anyone else who stumbles across this:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;ActiveRecord::Associations::ClassMethods.module_eval do
  def tables_in_string(string)
    return [] if string.blank?
    string.gsub(/'(\\'|[^'])*'|&quot;(\\&quot;|[^&quot;])*&quot;/, '').scan(/([a-zA-Z_][\.\w]+).?\./).flatten
  end
end&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-06-15T15:21:14+01:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-06-15T15:21:22+01:00</updated-at>
      <user-id type="integer">749</user-id>
      <version type="integer">6</version>
      <user-name>Graeme Mathieson</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>The patch creates other issues. tables_in_string needs to return actual tables names:

@@@ ruby
  def tables_in_string(string)
    return [] if string.blank?
    string.gsub(/'(.*)'/) {|s| s.gsub('.', '_')}.scan(/([\.a-zA-Z_]+).?\./).flatten
  end
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;The patch creates other issues. tables_in_string needs to return
actual tables names:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;  def tables_in_string(string)
    return [] if string.blank?
    string.gsub(/'(.*)'/) {|s| s.gsub('.', '_')}.scan(/([\.a-zA-Z_]+).?\./).flatten
  end&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-06-23T17:16:19+01:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-06-23T17:16:30+01:00</updated-at>
      <user-id type="integer">104378</user-id>
      <version type="integer">7</version>
      <user-name>Simon Kaczor</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>This is still an open issue in ActiveRecord 3.0.3 and 2.3.10

bad = &quot;((((((LOWER(events.`name`) LIKE '%ga.fs%')))) AND (events.delete_flag = 0)) AND (events.date &gt;= curdate()))&quot;

In AR 3.0.3
bad.scan(/([a-zA-Z_][\.\w]+).?\./).flatten.map{ |s| s.downcase }.uniq =&gt; [&quot;events&quot;, &quot;ga&quot;]

In  AR 2.3.10
bad.scan(/([\.a-zA-Z_]+).?\./).flatten =&gt; [&quot;events&quot;, &quot;ga&quot;, &quot;events&quot;, &quot;events&quot;]</body>
      <body-html>&lt;div&gt;&lt;p&gt;This is still an open issue in ActiveRecord 3.0.3 and 2.3.10&lt;/p&gt;
&lt;p&gt;bad = &quot;((((((LOWER(events.&lt;code&gt;name&lt;/code&gt;) LIKE '%ga.fs%'))))
AND (events.delete_flag = 0)) AND (events.date &amp;gt;=
curdate()))&quot;&lt;/p&gt;
&lt;p&gt;In AR 3.0.3&lt;br&gt;
bad.scan(/([a-zA-Z_][.\w]+).?./).flatten.map{ |s| s.downcase }.uniq
=&amp;gt; [&quot;events&quot;, &quot;ga&quot;]&lt;/p&gt;
&lt;p&gt;In AR 2.3.10&lt;br&gt;
bad.scan(/([.a-zA-Z_]+).?./).flatten =&amp;gt; [&quot;events&quot;, &quot;ga&quot;,
&quot;events&quot;, &quot;events&quot;]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-08T23:15:37+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 
:priority: 0
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-08T23:15:54+00:00</updated-at>
      <user-id type="integer">19734</user-id>
      <version type="integer">8</version>
      <user-name>Andrew Selder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Simon's regex above is not sufficient unfortunately.

Two problems:

1. The first gsub's pattern is greedy, so if you have multiple literals table names can get missed

example
bad2 = &quot;((((((LOWER(events.`name`) LIKE '%ga.fs%')))) AND ((((((LOWER(venues.`name`) LIKE '%ga.fs%')))) AND (events.delete_flag = 0)) AND (events.date &gt;= curdate()))&quot;

bad2.gsub(/'(.*)'/) {|s| s.gsub('.', '_')}.scan(/([\.a-zA-Z_]+).?\./).flatten =&gt; [&quot;events&quot;, &quot;events&quot;, &quot;events&quot;]

Here it lost the venues table.

2. This only works for literals enclosed by single quotes. Literals could also be enclosed by double quotes.

Here is my proposed updated regex:

string.gsub(/(['&quot;])(.*?)(\1)/) {|s| s.gsub('.', '_')}.scan(/([\.a-zA-Z_]+).?\./).flatten

I'll be ginning up a patch against 2.3.10 and 3.0.3 shortly</body>
      <body-html>&lt;div&gt;&lt;p&gt;Simon's regex above is not sufficient unfortunately.&lt;/p&gt;
&lt;p&gt;Two problems:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;The first gsub's pattern is greedy, so if you have multiple
literals table names can get missed&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;example&lt;br&gt;
bad2 = &quot;((((((LOWER(events.&lt;code&gt;name&lt;/code&gt;) LIKE '%ga.fs%'))))
AND ((((((LOWER(venues.&lt;code&gt;name&lt;/code&gt;) LIKE '%ga.fs%')))) AND
(events.delete_flag = 0)) AND (events.date &amp;gt;= curdate()))&quot;&lt;/p&gt;
&lt;p&gt;bad2.gsub(/'(.*)'/) {|s| s.gsub('.',
'&lt;em&gt;')}.scan(/([.a-zA-Z&lt;/em&gt;]+).?./).flatten =&amp;gt; [&quot;events&quot;,
&quot;events&quot;, &quot;events&quot;]&lt;/p&gt;
&lt;p&gt;Here it lost the venues table.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;This only works for literals enclosed by single quotes.
Literals could also be enclosed by double quotes.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Here is my proposed updated regex:&lt;/p&gt;
&lt;p&gt;string.gsub(/(['&quot;])(.*?)(\1)/) {|s| s.gsub('.',
'&lt;em&gt;')}.scan(/([.a-zA-Z&lt;/em&gt;]+).?./).flatten&lt;/p&gt;
&lt;p&gt;I'll be ginning up a patch against 2.3.10 and 3.0.3 shortly&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-08T23:36:11+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-08T23:36:29+00:00</updated-at>
      <user-id type="integer">19734</user-id>
      <version type="integer">9</version>
      <user-name>Andrew Selder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Here are a couple of patches against master and 2-3-stable.

It implements the regex I mentioned above.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Here are a couple of patches against master and 2-3-stable.&lt;/p&gt;
&lt;p&gt;It implements the regex I mentioned above.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T00:50:00+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T00:50:20+00:00</updated-at>
      <user-id type="integer">19734</user-id>
      <version type="integer">10</version>
      <user-name>Andrew Selder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Let's actually try attaching this time.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Let's actually try attaching this time.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T00:55:53+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3.10 3.0.3 active_record tables_in_string
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record patch tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T00:56:13+00:00</updated-at>
      <user-id type="integer">19734</user-id>
      <version type="integer">11</version>
      <user-name>Andrew Selder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>+1</body>
      <body-html>&lt;div&gt;&lt;p&gt;+1&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T00:58:16+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record patch tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T00:58:34+00:00</updated-at>
      <user-id type="integer">12060</user-id>
      <version type="integer">12</version>
      <user-name>Ed Ruder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>Looks good. I'm glad one of the tests included the `tablename`.`columnname` case as it looks like the current regexp cares about that.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Looks good. I'm glad one of the tests included the
&lt;code&gt;tablename&lt;/code&gt;.&lt;code&gt;columnname&lt;/code&gt; case as it looks
like the current regexp cares about that.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T01:01:54+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record patch tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T01:02:13+00:00</updated-at>
      <user-id type="integer">128362</user-id>
      <version type="integer">13</version>
      <user-name>Mark Towfiq</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>Good catch, Andrew.  Worked perfectly for me.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Good catch, Andrew. Worked perfectly for me.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T01:02:44+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record patch tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T01:03:04+00:00</updated-at>
      <user-id type="integer">128363</user-id>
      <version type="integer">14</version>
      <user-name>nate b</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>+1 (Adding comment, this time.) My project got bit by this problem--I think this patch addresses the problem better than the previous patch.</body>
      <body-html>&lt;div&gt;&lt;p&gt;+1 (Adding comment, this time.) My project got bit by this
problem--I think this patch addresses the problem better than the
previous patch.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T01:03:37+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record patch tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T01:03:55+00:00</updated-at>
      <user-id type="integer">12060</user-id>
      <version type="integer">15</version>
      <user-name>Ed Ruder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T01:09:42+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3.10 3.0.3 active_record patch tables_in_string
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record patch tables_in_string verified</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T01:10:01+00:00</updated-at>
      <user-id type="integer">12060</user-id>
      <version type="integer">16</version>
      <user-name>Ed Ruder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>readding patches with the ticket update keyword stuff in commit comment</body>
      <body-html>&lt;div&gt;&lt;p&gt;readding patches with the ticket update keyword stuff in commit
comment&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T01:15:04+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3.10 3.0.3 active_record patch tables_in_string verified
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record patch tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T01:15:23+00:00</updated-at>
      <user-id type="integer">19734</user-id>
      <version type="integer">17</version>
      <user-name>Andrew Selder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T01:15:17+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3.10 3.0.3 active_record patch tables_in_string
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record patch tables_in_string verified</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T01:15:41+00:00</updated-at>
      <user-id type="integer">19734</user-id>
      <version type="integer">18</version>
      <user-name>Andrew Selder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body>state:resolved</body>
      <body-html>&lt;div&gt;&lt;p&gt;state:resolved&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T01:16:24+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record patch tables_in_string verified</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T01:16:43+00:00</updated-at>
      <user-id type="integer">19734</user-id>
      <version type="integer">19</version>
      <user-name>Andrew Selder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Jeremy Evans found a case where the regex doesn't work (embedded escaped quote in literal).

I'll have the regex fixed and new patches up shortly.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Jeremy Evans found a case where the regex doesn't work (embedded
escaped quote in literal).&lt;/p&gt;
&lt;p&gt;I'll have the regex fixed and new patches up shortly.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T02:42:08+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3.10 3.0.3 active_record patch tables_in_string verified
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T02:42:58+00:00</updated-at>
      <user-id type="integer">19734</user-id>
      <version type="integer">20</version>
      <user-name>Andrew Selder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>After talking to some of the guys over on the core mailing list, this tables_in string was a temporary hack in the move to preloading. It will probably be coming out altogether in 

In Rails 3, use .preload(:bars) rather than include.

In Rails 2, we'll just have to stick with the monkey patch method.

Here's what I've come up with that seems to work with all the stuff people have mentioned.

    ActiveRecord::Associations::ClassMethods.module_eval do
      def tables_in_string(string)
        return [] if string.blank?
        literals_without_dots(string).scan(/([\.a-zA-Z_]+).?\./).flatten
      end

      def literals_without_dots(string) 
        string.gsub(/(['&quot;])(([^\\]|(\\.))*?)(\1)/) {|s| s.gsub('.', '_')} 
      end
    end</body>
      <body-html>&lt;div&gt;&lt;p&gt;After talking to some of the guys over on the core mailing list,
this tables_in string was a temporary hack in the move to
preloading. It will probably be coming out altogether in&lt;/p&gt;
&lt;p&gt;In Rails 3, use .preload(:bars) rather than include.&lt;/p&gt;
&lt;p&gt;In Rails 2, we'll just have to stick with the monkey patch
method.&lt;/p&gt;
&lt;p&gt;Here's what I've come up with that seems to work with all the
stuff people have mentioned.&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;ActiveRecord::Associations::ClassMethods.module_eval do
  def tables_in_string(string)
    return [] if string.blank?
    literals_without_dots(string).scan(/([\.a-zA-Z_]+).?\./).flatten
  end

  def literals_without_dots(string) 
    string.gsub(/(['&quot;])(([^\\]|(\\.))*?)(\1)/) {|s| s.gsub('.', '_')} 
  end
end&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T04:25:15+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T04:25:37+00:00</updated-at>
      <user-id type="integer">19734</user-id>
      <version type="integer">21</version>
      <user-name>Andrew Selder</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>As Andrew says, I'm loathe to climb further down the rabbit hole of trying to parse SQL with regexps.  It's destined to fail.  

If you're bitten by this in 2-3-stable apps you can either monkey patch in an initializer, or use will's patch in #3683</body>
      <body-html>&lt;div&gt;&lt;p&gt;As Andrew says, I'm loathe to climb further down the rabbit hole
of trying to parse SQL with regexps. It's destined to fail.&lt;br&gt;&lt;/p&gt;
&lt;p&gt;If you're bitten by this in 2-3-stable apps you can either
monkey patch in an initializer, or use will's patch in &lt;a href=
&quot;/projects/8994/tickets/3683&quot; title=&quot;Ticket #3683&quot;&gt;#3683&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T19:36:14+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.10 3.0.3 active_record tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T19:36:38+00:00</updated-at>
      <user-id type="integer">141</user-id>
      <version type="integer">22</version>
      <user-name>Michael Koziarski</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-12-09T20:04:41+00:00</created-at>
      <creator-id type="integer">75022</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3446</number>
      <permalink>tables_in_string-matches-literal-string-containing-dot</permalink>
      <priority type="integer">129427</priority>
      <project-id type="integer">8994</project-id>
      <state>wontfix</state>
      <tag>2.3.10 3.0.3 active_record tables_in_string</tag>
      <title>tables_in_string matches literal string containing dot</title>
      <updated-at type="datetime">2010-12-09T20:05:04+00:00</updated-at>
      <user-id type="integer">141</user-id>
      <version type="integer">23</version>
      <user-name>Michael Koziarski</user-name>
      <creator-name>xpmatteo</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3446</url>
      <priority-name nil="true"></priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>0c4b07bce3f46dc77b345cfffb22b6b16e65e45c</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2009-10-31T15:49:27+00:00</created-at>
      <filename>patch-dots-in-literals.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">310479</id>
      <size type="integer">2567</size>
      <uploader-id type="integer">75022</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/310479/patch-dots-in-literals.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>883420063659cd37fbb3b7986e48f216a8de1c13</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2009-11-05T13:29:11+00:00</created-at>
      <filename>patch-dots-in-literals-improved.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">313102</id>
      <size type="integer">4439</size>
      <uploader-id type="integer">75022</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/313102/patch-dots-in-literals-improved.diff</url>
    </attachment>
  </attachments>
</ticket>
