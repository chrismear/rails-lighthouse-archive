<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">40272</assigned-user-id>
  <attachments-count type="integer">2</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2010-11-12T10:16:43+00:00</created-at>
  <creator-id type="integer">34795</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer">71472</milestone-id>
  <number type="integer">5958</number>
  <permalink>collection-rendering-with-superfluous-database-queries</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>committed</state>
  <tag>patched</tag>
  <title>Collection rendering with superfluous database queries</title>
  <updated-at type="datetime">2010-11-13T17:23:45+00:00</updated-at>
  <user-id type="integer">40263</user-id>
  <version type="integer">19</version>
  <user-name>Neeraj Singh</user-name>
  <creator-name>Ivan Ukhov</creator-name>
  <assigned-user-name>Santiago Pastorino</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
  <milestone-title>3.x</milestone-title>
  <priority-name>Low</priority-name>
  <original-body>When passing some *Relation* to *render :collection =&gt; ...*, it produces two queries. One for counting (*SELECT COUNT*) and another for fetching (just *SELECT*). For example:

@@@ ruby
render :partial =&gt; 'some_partial', :collection =&gt; SomeModel.some_scope
@@@

Suppose this is because of the following line:

https://github.com/rails/rails/blob/master/actionpack/lib/action_view/renderer/partial_renderer.rb#L48

My workaround:

@@@ ruby
module ActionView
  module Partials
    class PartialRenderer
      private
      def collection
        c = if @object.respond_to?(:to_ary)
          @object
        elsif @options.key?(:collection)
          @options[:collection] || []
        end
        c.try :length
        c
      end
    end
  end
end
@@@</original-body>
  <latest-body>When passing some *Relation* to *render :collection =&gt; ...*, it produces two queries. One for counting (*SELECT COUNT*) and another for fetching (just *SELECT*). For example:

@@@ ruby
render :partial =&gt; 'some_partial', :collection =&gt; SomeModel.some_scope
@@@

Suppose this is because of the following line:

https://github.com/rails/rails/blob/master/actionpack/lib/action_view/renderer/partial_renderer.rb#L48

My workaround:

@@@ ruby
module ActionView
  module Partials
    class PartialRenderer
      private
      def collection
        c = if @object.respond_to?(:to_ary)
          @object
        elsif @options.key?(:collection)
          @options[:collection] || []
        end
        c.try :length
        c
      end
    end
  end
end
@@@</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;When passing some &lt;em&gt;Relation&lt;/em&gt; to &lt;em&gt;render :collection
=&amp;gt; ...&lt;/em&gt;, it produces two queries. One for counting
(&lt;em&gt;SELECT COUNT&lt;/em&gt;) and another for fetching (just
&lt;em&gt;SELECT&lt;/em&gt;). For example:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;render :partial =&amp;gt; 'some_partial', :collection =&amp;gt; SomeModel.some_scope&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Suppose this is because of the following line:&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;https://github.com/rails/rails/blob/master/actionpack/lib/action_view/renderer/partial_renderer.rb#L48&quot;&gt;
https://github.com/rails/rails/blob/master/actionpack/lib/action_vi...&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;My workaround:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;module ActionView
  module Partials
    class PartialRenderer
      private
      def collection
        c = if @object.respond_to?(:to_ary)
          @object
        elsif @options.key?(:collection)
          @options[:collection] || []
        end
        c.try :length
        c
      end
    end
  end
end&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>When passing some *Relation* to *render :collection =&gt; ...*, it produces two queries. One for counting (*SELECT COUNT*) and another for fetching (just *SELECT*). For example:

@@@ ruby
render :partial =&gt; 'some_partial', :collection =&gt; SomeModel.some_scope
@@@

Suppose this is because of the following line:

https://github.com/rails/rails/blob/master/actionpack/lib/action_view/renderer/partial_renderer.rb#L48

My workaround:

@@@ ruby
module ActionView
  module Partials
    class PartialRenderer
      private
      def collection
        c = if @object.respond_to?(:to_ary)
          @object
        elsif @options.key?(:collection)
          @options[:collection] || []
        end
        c.try :length
        c
      end
    end
  end
end
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;When passing some &lt;em&gt;Relation&lt;/em&gt; to &lt;em&gt;render :collection
=&amp;gt; ...&lt;/em&gt;, it produces two queries. One for counting
(&lt;em&gt;SELECT COUNT&lt;/em&gt;) and another for fetching (just
&lt;em&gt;SELECT&lt;/em&gt;). For example:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;render :partial =&amp;gt; 'some_partial', :collection =&amp;gt; SomeModel.some_scope&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Suppose this is because of the following line:&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;https://github.com/rails/rails/blob/master/actionpack/lib/action_view/renderer/partial_renderer.rb#L48&quot;&gt;
https://github.com/rails/rails/blob/master/actionpack/lib/action_vi...&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;My workaround:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;module ActionView
  module Partials
    class PartialRenderer
      private
      def collection
        c = if @object.respond_to?(:to_ary)
          @object
        elsif @options.key?(:collection)
          @options[:collection] || []
        end
        c.try :length
        c
      end
    end
  end
end&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T10:16:43+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T10:17:19+00:00</updated-at>
      <user-id type="integer">34795</user-id>
      <version type="integer">1</version>
      <user-name>Ivan Ukhov</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Can you provide a failing test case and a patch following http://rails.lighthouseapp.com/projects/8994/sending-patches</body>
      <body-html>&lt;div&gt;&lt;p&gt;Can you provide a failing test case and a patch following
&lt;a href=
&quot;http://rails.lighthouseapp.com/projects/8994/sending-patches&quot;&gt;http://rails.lighthouseapp.com/projects/8994/sending-patches&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T15:08:40+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T15:08:44+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">2</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T15:09:01+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
:milestone: 
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag nil="true"></tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T15:09:05+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">3</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Sorry, I'm really not good at writing test cases, to my shame I haven't even written one. I just want you to know about the problem. Please don't put it aside, everyone who is interested in performance will be especially upset observing two queries instead of one... It could save a bunch of time.

The issue isn't hard to understand, so I hope someone will takes responsibility to fix it.

Thank you.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Sorry, I'm really not good at writing test cases, to my shame I
haven't even written one. I just want you to know about the
problem. Please don't put it aside, everyone who is interested in
performance will be especially upset observing two queries instead
of one... It could save a bunch of time.&lt;/p&gt;
&lt;p&gt;The issue isn't hard to understand, so I hope someone will takes
responsibility to fix it.&lt;/p&gt;
&lt;p&gt;Thank you.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T15:25:25+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag nil="true"></tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T15:25:27+00:00</updated-at>
      <user-id type="integer">34795</user-id>
      <version type="integer">4</version>
      <user-name>Ivan Ukhov</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Attached is code patch. Not sure how to count how many sql statements have been generated in the whole view.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Attached is code patch. Not sure how to count how many sql
statements have been generated in the whole view.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T16:23:15+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T16:23:19+00:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">5</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>The patch is not correct, because it still calls *size*, but should call *length*. *size* in case of not loaded collection fires a counting query.

So, in the patch instead of:
@@@ ruby
size = @collection.size
@@@

should be:
@@@ ruby
size = @collection.length
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;The patch is not correct, because it still calls &lt;em&gt;size&lt;/em&gt;,
but should call &lt;em&gt;length&lt;/em&gt;. &lt;em&gt;size&lt;/em&gt; in case of not
loaded collection fires a counting query.&lt;/p&gt;
&lt;p&gt;So, in the patch instead of:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;size = @collection.size&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;should be:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;size = @collection.length&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T16:32:58+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T16:33:04+00:00</updated-at>
      <user-id type="integer">34795</user-id>
      <version type="integer">6</version>
      <user-name>Ivan Ukhov</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>*[PATCH] Do not execute query to get count of records twice.*

The problem is not in how many times it counts, but in the fact that it produces two different queries: one is specially for just counting, another for fetching data (rows from a table). But if we anyway are going to render the whole collection, why shouldn't we just pull the data and count the number of records? For me it is an obvious wasting of time.</body>
      <body-html>&lt;div&gt;&lt;p&gt;&lt;em&gt;&lt;a href=&quot;/projects/8994/changesets/PATCH&quot; title=
&quot;Changeset [PATCH]&quot;&gt;[PATCH]&lt;/a&gt; Do not execute query to get count
of records twice.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The problem is not in how many times it counts, but in the fact
that it produces two different queries: one is specially for just
counting, another for fetching data (rows from a table). But if we
anyway are going to render the whole collection, why shouldn't we
just pull the data and count the number of records? For me it is an
obvious wasting of time.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T16:41:53+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T16:41:58+00:00</updated-at>
      <user-id type="integer">34795</user-id>
      <version type="integer">7</version>
      <user-name>Ivan Ukhov</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>When the execution comes to @collection, at that time @collection is a Relation and that is not loaded. Since it is not loaded whether you call .length or .size it will make a call to sql.

Other thing is that if the collection is not already loaded then .size internally calls .length .


I tested the patch. Before the patch it was making two calls. After the patch it is making one call. 

Assigning it to Santiago since he is watching this ticket. :-)</body>
      <body-html>&lt;div&gt;&lt;p&gt;When the execution comes to @collection, at that time
@collection is a Relation and that is not loaded. Since it is not
loaded whether you call .length or .size it will make a call to
sql.&lt;/p&gt;
&lt;p&gt;Other thing is that if the collection is not already loaded then
.size internally calls .length .&lt;/p&gt;
&lt;p&gt;I tested the patch. Before the patch it was making two calls.
After the patch it is making one call.&lt;/p&gt;
&lt;p&gt;Assigning it to Santiago since he is watching this ticket.
:-)&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T16:55:21+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- 
:assigned_user: 
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T16:55:24+00:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">8</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>And what about the following line?

https://github.com/rails/rails/blob/eeb9b379f9dba0c692856b2f5576cd30a12887e1/activerecord/lib/active_record/relation.rb#L83</body>
      <body-html>&lt;div&gt;&lt;p&gt;And what about the following line?&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;https://github.com/rails/rails/blob/eeb9b379f9dba0c692856b2f5576cd30a12887e1/activerecord/lib/active_record/relation.rb#L83&quot;&gt;
https://github.com/rails/rails/blob/eeb9b379f9dba0c692856b2f5576cd3...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T17:05:51+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T17:05:54+00:00</updated-at>
      <user-id type="integer">34795</user-id>
      <version type="integer">9</version>
      <user-name>Ivan Ukhov</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>That's what I was saying. May be I was not clear enough.

This blog has more info on the same topic with greater clarity http://blog.hasmanythrough.com/2008/2/27/count-length-size .</body>
      <body-html>&lt;div&gt;&lt;p&gt;That's what I was saying. May be I was not clear enough.&lt;/p&gt;
&lt;p&gt;This blog has more info on the same topic with greater clarity
&lt;a href=
&quot;http://blog.hasmanythrough.com/2008/2/27/count-length-size&quot;&gt;http://blog.hasmanythrough.com/2008/2/27/count-length-size&lt;/a&gt;
.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T17:38:10+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T17:38:12+00:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">10</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>You say:
*Other thing is that if the collection is not already loaded then .size internally calls .length .*

Josh says:
*If the collection has already been loaded, it will return its length just like calling #length. If it hasn't been loaded yet, it's like calling #count*

We should **always** call *length* in order to **always** count an assiciation by loading *the contents of the association into memory and then returning the number of elements loaded*.

So, you still insist on using *size*?</body>
      <body-html>&lt;div&gt;&lt;p&gt;You say:&lt;br&gt;
&lt;em&gt;Other thing is that if the collection is not already loaded
then .size internally calls .length .&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Josh says:&lt;br&gt;
&lt;em&gt;If the collection has already been loaded, it will return its
length just like calling #length. If it hasn't been loaded yet,
it's like calling #count&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;We should &lt;strong&gt;always&lt;/strong&gt; call &lt;em&gt;length&lt;/em&gt; in order
to &lt;strong&gt;always&lt;/strong&gt; count an assiciation by loading &lt;em&gt;the
contents of the association into memory and then returning the
number of elements loaded&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;So, you still insist on using &lt;em&gt;size&lt;/em&gt;?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T17:48:57+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T17:49:01+00:00</updated-at>
      <user-id type="integer">34795</user-id>
      <version type="integer">11</version>
      <user-name>Ivan Ukhov</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>You are right. It should be .length. I usually avoid length because it does select * and not select count * but in this case if the number of records is more than one then anyway we are going to load all the records.

@@@ ruby
# fires three queries select count * ...
def self.lab
  brakes = Car.first.brakes
  puts brakes.size
  puts brakes.size
  puts brakes.size
end

# fires only one query but it is select * 
def self.lab2
  brakes = Car.first.brakes
  puts brakes.length
  puts brakes.length
  puts brakes.length
end
@@@

Sorry for being thick. Appreciate your patience.

I will  add a new patch.</body>
      <body-html>&lt;div&gt;&lt;p&gt;You are right. It should be .length. I usually avoid length
because it does select &lt;em&gt;and not select count&lt;/em&gt; but in this
case if the number of records is more than one then anyway we are
going to load all the records.&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;# fires three queries select count * ...
def self.lab
  brakes = Car.first.brakes
  puts brakes.size
  puts brakes.size
  puts brakes.size
end

# fires only one query but it is select * 
def self.lab2
  brakes = Car.first.brakes
  puts brakes.length
  puts brakes.length
  puts brakes.length
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Sorry for being thick. Appreciate your patience.&lt;/p&gt;
&lt;p&gt;I will add a new patch.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T18:57:58+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T18:58:00+00:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">12</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>My previous patch reduced the number of sql queries from 3 to 2.

Then new attached patch is reducing the number of sql queries from 3 to 1.</body>
      <body-html>&lt;div&gt;&lt;p&gt;My previous patch reduced the number of sql queries from 3 to
2.&lt;/p&gt;
&lt;p&gt;Then new attached patch is reducing the number of sql queries
from 3 to 1.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T19:03:02+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T19:03:04+00:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">13</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15316</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T19:58:21+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- 
:assigned_user: 40272
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T19:58:23+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">14</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Aaron Patterson</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T21:51:43+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- 
:assigned_user: 15316
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T21:51:48+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">15</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Neeraj Singh, not a problem at all, it's a pleasure for me to contribute a bit to this great framework) Thank you for your consideration and quick responce.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Neeraj Singh, not a problem at all, it's a pleasure for me to
contribute a bit to this great framework) Thank you for your
consideration and quick responce.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-12T23:16:44+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-12T23:16:46+00:00</updated-at>
      <user-id type="integer">34795</user-id>
      <version type="integer">16</version>
      <user-name>Ivan Ukhov</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>(from [27f4ffd11a91b534fde9b484cb7c4e515ec0fe77]) Make collection and collection_from_object methods return an array

This transforms for instance scoped objects into arrays and avoid unneeded queries

[#5958 state:committed]
https://github.com/rails/rails/commit/27f4ffd11a91b534fde9b484cb7c4e515ec0fe77</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from &lt;a href=
&quot;/projects/8994/changesets/27f4ffd11a91b534fde9b484cb7c4e515ec0fe77&quot;
title=
&quot;Changeset [27f4ffd11a91b534fde9b484cb7c4e515ec0fe77]&quot;&gt;[27f4ffd11a91b534fde9b484cb7c4e515ec0fe77]&lt;/a&gt;)
Make collection and collection_from_object methods return an
array&lt;/p&gt;
&lt;p&gt;This transforms for instance scoped objects into arrays and
avoid unneeded queries&lt;/p&gt;
&lt;p&gt;[&lt;a href=&quot;/projects/8994/tickets/5958&quot; title=
&quot;Ticket #5958&quot;&gt;#5958&lt;/a&gt; state:committed] &lt;a href=
&quot;https://github.com/rails/rails/commit/27f4ffd11a91b534fde9b484cb7c4e515ec0fe77&quot;&gt;
https://github.com/rails/rails/commit/27f4ffd11a91b534fde9b484cb7c4...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-11-13T06:03:47+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-13T06:03:48+00:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">17</version>
      <user-name>Repository</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>(from [b8701933453c82bdb968532bdd7dee8cec775b72]) Make collection and collection_from_object methods return an array

This transforms for instance scoped objects into arrays and avoid
unneeded queries

[#5958 state:committed]
https://github.com/rails/rails/commit/b8701933453c82bdb968532bdd7dee8cec775b72</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from &lt;a href=
&quot;/projects/8994/changesets/b8701933453c82bdb968532bdd7dee8cec775b72&quot;
title=
&quot;Changeset [b8701933453c82bdb968532bdd7dee8cec775b72]&quot;&gt;[b8701933453c82bdb968532bdd7dee8cec775b72]&lt;/a&gt;)
Make collection and collection_from_object methods return an
array&lt;/p&gt;
&lt;p&gt;This transforms for instance scoped objects into arrays and
avoid&lt;br&gt;
unneeded queries&lt;/p&gt;
&lt;p&gt;[&lt;a href=&quot;/projects/8994/tickets/5958&quot; title=
&quot;Ticket #5958&quot;&gt;#5958&lt;/a&gt; state:committed] &lt;a href=
&quot;https://github.com/rails/rails/commit/b8701933453c82bdb968532bdd7dee8cec775b72&quot;&gt;
https://github.com/rails/rails/commit/b8701933453c82bdb968532bdd7de...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-11-13T06:07:56+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-13T06:07:57+00:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">18</version>
      <user-name>Repository</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>@Santiago

I tested your patch and it works great. Great solution. Thanks for teaching.</body>
      <body-html>&lt;div&gt;&lt;p&gt;@Santiago&lt;/p&gt;
&lt;p&gt;I tested your patch and it works great. Great solution. Thanks
for teaching.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-11-13T17:23:42+00:00</created-at>
      <creator-id type="integer">34795</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">5958</number>
      <permalink>collection-rendering-with-superfluous-database-queries</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>patched</tag>
      <title>Collection rendering with superfluous database queries</title>
      <updated-at type="datetime">2010-11-13T17:23:45+00:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">19</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Ivan Ukhov</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5958</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>c1c05ba6b93d453e7422a822d33e61b0ad28adff</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-11-12T16:23:15+00:00</created-at>
      <filename>5958-fix-against_rails-edge.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">768209</id>
      <size type="integer">1394</size>
      <uploader-id type="integer">40263</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/768209/5958-fix-against_rails-edge.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>c5a10fd455b0b5434a8703d946245b498d2f3f2f</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-11-12T19:03:02+00:00</created-at>
      <filename>5958-fix-against-edge.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">768533</id>
      <size type="integer">1373</size>
      <uploader-id type="integer">40263</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/768533/5958-fix-against-edge.diff</url>
    </attachment>
  </attachments>
</ticket>
