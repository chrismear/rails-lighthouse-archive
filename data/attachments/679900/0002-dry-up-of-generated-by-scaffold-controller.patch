From d3783fac7a2676d9e75220eb92a23ab872b39191 Mon Sep 17 00:00:00 2001
From: Krekoten' Marjan <krekoten@gmail.com>
Date: Sat, 18 Sep 2010 20:57:14 +0300
Subject: [PATCH 2/2] DRY-up of generated by scaffold controller

---
 .../scaffold_controller/templates/controller.rb    |   19 ++++----
 .../scaffold_controller_generator_test.rb          |   22 ++++-----
 .../test/generators/scaffold_generator_test.rb     |   44 +++++++++-----------
 3 files changed, 39 insertions(+), 46 deletions(-)

diff --git a/railties/lib/rails/generators/rails/scaffold_controller/templates/controller.rb b/railties/lib/rails/generators/rails/scaffold_controller/templates/controller.rb
index 699fa1b..756f0f6 100644
--- a/railties/lib/rails/generators/rails/scaffold_controller/templates/controller.rb
+++ b/railties/lib/rails/generators/rails/scaffold_controller/templates/controller.rb
@@ -1,4 +1,5 @@
 class <%= controller_class_name %>Controller < ApplicationController
+  before_filter :load_resource, :except => [:index]
   respond_to :html, :xml
   
   # GET <%= route_url %>
@@ -12,30 +13,23 @@ class <%= controller_class_name %>Controller < ApplicationController
   # GET <%= route_url %>/1
   # GET <%= route_url %>/1.xml
   def show
-    @<%= singular_table_name %> = <%= orm_class.find(class_name, "params[:id]") %>
-
     respond_with(@<%= singular_table_name %>)
   end
 
   # GET <%= route_url %>/new
   # GET <%= route_url %>/new.xml
   def new
-    @<%= singular_table_name %> = <%= orm_class.build(class_name) %>
-
     respond_with(@<%= singular_table_name %>)
   end
 
   # GET <%= route_url %>/1/edit
   def edit
-    @<%= singular_table_name %> = <%= orm_class.find(class_name, "params[:id]") %>
     respond_with(@<%= singular_table_name %>)
   end
 
   # POST <%= route_url %>
   # POST <%= route_url %>.xml
   def create
-    @<%= singular_table_name %> = <%= orm_class.build(class_name, "params[:#{singular_table_name}]") %>
-
     flash[:notice] = '<%= human_name %> was successfully created.' if @<%= singular_table_name %>.save
     respond_with(@<%= singular_table_name %>)
   end
@@ -43,8 +37,6 @@ class <%= controller_class_name %>Controller < ApplicationController
   # PUT <%= route_url %>/1
   # PUT <%= route_url %>/1.xml
   def update
-    @<%= singular_table_name %> = <%= orm_class.find(class_name, "params[:id]") %>
-
     flash[:notice] = '<%= human_name %> was successfully updated.' if @<%= singular_table_name %>.update_attributes(params[:<%= singular_table_name %>])
     respond_with(@<%= singular_table_name %>)
   end
@@ -52,9 +44,16 @@ class <%= controller_class_name %>Controller < ApplicationController
   # DELETE <%= route_url %>/1
   # DELETE <%= route_url %>/1.xml
   def destroy
-    @<%= singular_table_name %> = <%= orm_class.find(class_name, "params[:id]") %>
     @<%= orm_instance.destroy %>
 
     respond_with(@<%= singular_table_name %>)
   end
+  
+  protected
+  
+  def load_resource
+    @<%= singular_table_name %> = <%= orm_class.find(class_name, "params[:id]") %> if params[:id]
+    @<%= singular_table_name %> ||= <%= orm_class.build(class_name, "params[:#{singular_table_name}]") %> unless params[:id]
+    @<%= singular_table_name %> ||= <%= orm_class.build(class_name)
+  end  
 end
diff --git a/railties/test/generators/scaffold_controller_generator_test.rb b/railties/test/generators/scaffold_controller_generator_test.rb
index 09d6d0b..6379267 100644
--- a/railties/test/generators/scaffold_controller_generator_test.rb
+++ b/railties/test/generators/scaffold_controller_generator_test.rb
@@ -15,37 +15,35 @@ class ScaffoldControllerGeneratorTest < Rails::Generators::TestCase
 
     assert_file "app/controllers/users_controller.rb" do |content|
       assert_match /class UsersController < ApplicationController/, content
+      assert_match /before_filter :load_resource/, content
 
       assert_instance_method :index, content do |m|
         assert_match /@users = User\.all/, m
       end
 
-      assert_instance_method :show, content do |m|
-        assert_match /@user = User\.find\(params\[:id\]\)/, m
-      end
+      assert_instance_method :show, content
 
-      assert_instance_method :new, content do |m|
-        assert_match /@user = User\.new/, m
-      end
+      assert_instance_method :new, content
 
-      assert_instance_method :edit, content do |m|
-        assert_match /@user = User\.find\(params\[:id\]\)/, m
-      end
+      assert_instance_method :edit, content
 
       assert_instance_method :create, content do |m|
-        assert_match /@user = User\.new\(params\[:user\]\)/, m
         assert_match /@user\.save/, m
       end
 
       assert_instance_method :update, content do |m|
-        assert_match /@user = User\.find\(params\[:id\]\)/, m
         assert_match /@user\.update_attributes\(params\[:user\]\)/, m
       end
 
       assert_instance_method :destroy, content do |m|
-        assert_match /@user = User\.find\(params\[:id\]\)/, m
         assert_match /@user\.destroy/, m
       end
+      
+      assert_instance_method :load_resource, content do |m|
+        assert_match /@user = User\.find\(params\[:id\]\) if params\[:id\]/, m
+        assert_match /@user ||= User\.new\(params\[:user\]\) unless params\[:id\]/, m
+        assert_match /@user ||= User\.new/, m
+      end
     end
   end
 
diff --git a/railties/test/generators/scaffold_generator_test.rb b/railties/test/generators/scaffold_generator_test.rb
index cf0fbce..6dc5787 100644
--- a/railties/test/generators/scaffold_generator_test.rb
+++ b/railties/test/generators/scaffold_generator_test.rb
@@ -24,37 +24,35 @@ class ScaffoldGeneratorTest < Rails::Generators::TestCase
     # Controller
     assert_file "app/controllers/product_lines_controller.rb" do |content|
       assert_match /class ProductLinesController < ApplicationController/, content
+      assert_match /before_filter :load_resource/, content
 
       assert_instance_method :index, content do |m|
         assert_match /@product_lines = ProductLine\.all/, m
       end
 
-      assert_instance_method :show, content do |m|
-        assert_match /@product_line = ProductLine\.find\(params\[:id\]\)/, m
-      end
+      assert_instance_method :show, content
 
-      assert_instance_method :new, content do |m|
-        assert_match /@product_line = ProductLine\.new/, m
-      end
+      assert_instance_method :new, content
 
-      assert_instance_method :edit, content do |m|
-        assert_match /@product_line = ProductLine\.find\(params\[:id\]\)/, m
-      end
+      assert_instance_method :edit, content
 
       assert_instance_method :create, content do |m|
-        assert_match /@product_line = ProductLine\.new\(params\[:product_line\]\)/, m
         assert_match /@product_line\.save/, m
       end
 
       assert_instance_method :update, content do |m|
-        assert_match /@product_line = ProductLine\.find\(params\[:id\]\)/, m
         assert_match /@product_line\.update_attributes\(params\[:product_line\]\)/, m
       end
 
       assert_instance_method :destroy, content do |m|
-        assert_match /@product_line = ProductLine\.find\(params\[:id\]\)/, m
         assert_match /@product_line\.destroy/, m
       end
+      
+      assert_instance_method :load_resource, content do |m|
+        assert_match /@product_line = ProductLine\.find\(params\[:id\]\) if params\[:id\]/, m
+        assert_match /@product_line ||= ProductLine\.new\(params\[:product_line\]\) unless params\[:id\]/, m
+        assert_match /@product_line ||= ProductLine\.new/, m
+      end
     end
 
     assert_file "test/functional/product_lines_controller_test.rb",
@@ -127,37 +125,35 @@ class ScaffoldGeneratorTest < Rails::Generators::TestCase
     # Controller
     assert_file "app/controllers/admin/roles_controller.rb" do |content|
       assert_match /class Admin::RolesController < ApplicationController/, content
+      assert_match /before_filter :load_resource/, content
 
       assert_instance_method :index, content do |m|
         assert_match /@admin_roles = Admin::Role\.all/, m
       end
 
-      assert_instance_method :show, content do |m|
-        assert_match /@admin_role = Admin::Role\.find\(params\[:id\]\)/, m
-      end
+      assert_instance_method :show, content
 
-      assert_instance_method :new, content do |m|
-        assert_match /@admin_role = Admin::Role\.new/, m
-      end
+      assert_instance_method :new, content
 
-      assert_instance_method :edit, content do |m|
-        assert_match /@admin_role = Admin::Role\.find\(params\[:id\]\)/, m
-      end
+      assert_instance_method :edit, content
 
       assert_instance_method :create, content do |m|
-        assert_match /@admin_role = Admin::Role\.new\(params\[:admin_role\]\)/, m
         assert_match /@admin_role\.save/, m
       end
 
       assert_instance_method :update, content do |m|
-        assert_match /@admin_role = Admin::Role\.find\(params\[:id\]\)/, m
         assert_match /@admin_role\.update_attributes\(params\[:admin_role\]\)/, m
       end
 
       assert_instance_method :destroy, content do |m|
-        assert_match /@admin_role = Admin::Role\.find\(params\[:id\]\)/, m
         assert_match /@admin_role\.destroy/, m
       end
+      
+      assert_instance_method :load_resource, content do |m|
+        assert_match /@admin_role = Admin::Role\.find\(params\[:id\]\) if params\[:id\]/, m
+        assert_match /@admin_role ||= Admin::Role\.new\(params\[:admin_role\]\) unless params\[:id\]/, m
+        assert_match /@admin_role ||= Admin::Role\.new/, m
+      end
     end
 
     assert_file "test/functional/admin/roles_controller_test.rb",
-- 
1.7.2

