<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">40272</assigned-user-id>
  <attachments-count type="integer">2</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2011-01-08T23:56:42+00:00</created-at>
  <creator-id type="integer">18267</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer">71472</milestone-id>
  <number type="integer">6077</number>
  <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>committed</state>
  <tag>as_json encode_json json patch to_json</tag>
  <title>ActiveSupport::JSON.encode fails for Struct types</title>
  <updated-at type="datetime">2011-02-11T22:24:35+00:00</updated-at>
  <user-id type="integer">40272</user-id>
  <version type="integer">23</version>
  <user-name>Santiago Pastorino</user-name>
  <creator-name>Mark A. Richman</creator-name>
  <assigned-user-name>Santiago Pastorino</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
  <milestone-title>3.x</milestone-title>
  <priority-name>Low</priority-name>
  <original-body>I am using DataMapper's `repository.adapter.select` to retrieve results of an arbitrary query. The results are returned as an array of structs, each of which looks like the following:

@@@
#&lt;struct matches_id=52276, begin_date=Sun, 28 Nov 2010 20:30:00 -0500, windows_time_zone=&quot;E. South America Standard Time&quot;, team1_id=1430, team2_id=373, team1=&quot;Ava&#237; Futebol Clube&quot;, team2=&quot;Santos Futebol Clube&quot;, status=&quot;N&quot;, match_day_name=&quot;Rodada 37&quot;, season_name=&quot;Brasileir&#227;o S&#233;rie A&quot;, round_name=&quot;Brasileir&#227;o S&#233;rie A&quot;, competition_name=&quot;Brasileir&#227;o S&#233;rie A&quot;, group_name=&quot;&quot;, use_gsm=&quot;Y&quot;, team1_score=0, team2_score=0&gt;
@@@

Calling #to_json on this struct throws the following exception:

@@@
NoMethodError: undefined method `encode_json' for Sun, 28 Nov 2010 20:30:00 -0500:DateTime
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `block in encode_json'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `map'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `encode_json'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:47:in `block in encode'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:77:in `check_for_circular_references'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:45:in `encode'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:30:in `encode'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/core_ext/object/to_json.rb:20:in `to_json'
	from (irb):8
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands/console.rb:44:in `start'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands/console.rb:8:in `start'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands.rb:23:in `&lt;top (required)&gt;'
	from script/rails:6:in `require'
	from script/rails:6:in `&lt;main&gt;'
@@@

The exception does not seem to be related to the DateTime type, since I can convert this struct to a hash and that will serialize to JSON without error:

@@@
Hash[row.members.zip(row.values)] =&gt; 

{:matches_id=&gt;52276, :begin_date=&gt;Sun, 28 Nov 2010 20:30:00 -0500, :windows_time_zone=&gt;&quot;E. South America Standard Time&quot;, :team1_id=&gt;1430, :team2_id=&gt;373, :team1=&gt;&quot;Ava&#237; Futebol Clube&quot;, :team2=&gt;&quot;Santos Futebol Clube&quot;, :status=&gt;&quot;N&quot;, :match_day_name=&gt;&quot;Rodada 37&quot;, :season_name=&gt;&quot;Brasileir&#227;o S&#233;rie A&quot;, :round_name=&gt;&quot;Brasileir&#227;o S&#233;rie A&quot;, :competition_name=&gt;&quot;Brasileir&#227;o S&#233;rie A&quot;, :group_name=&gt;&quot;&quot;, :use_gsm=&gt;&quot;Y&quot;, :team1_score=&gt;0, :team2_score=&gt;0}
@@@

which produces correct JSON on #to_json:

@@@
=&gt; &quot;{\&quot;matches_id\&quot;:52276,\&quot;begin_date\&quot;:\&quot;2010-11-28T20:30:00-05:00\&quot;,\&quot;windows_time_zone\&quot;:\&quot;E. South America Standard Time\&quot;,\&quot;team1_id\&quot;:1430,\&quot;team2_id\&quot;:373,\&quot;team1\&quot;:\&quot;Ava\\u00ed Futebol Clube\&quot;,\&quot;team2\&quot;:\&quot;Santos Futebol Clube\&quot;,\&quot;status\&quot;:\&quot;N\&quot;,\&quot;match_day_name\&quot;:\&quot;Rodada 37\&quot;,\&quot;season_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;round_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;competition_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;group_name\&quot;:\&quot;\&quot;,\&quot;use_gsm\&quot;:\&quot;Y\&quot;,\&quot;team1_score\&quot;:0,\&quot;team2_score\&quot;:0}&quot; 
@@@

Struct support should be added *OR* perhaps a pointer to some documentation on how I can expect AS::JSON in my own project to work with Struct. I think it's ok to do a local hack like the one I did temporarily, but I'd rather see this handled in Rails, or at the very least in some project specific override.

Thanks,
Mark</original-body>
  <latest-body>I am using DataMapper's `repository.adapter.select` to retrieve results of an arbitrary query. The results are returned as an array of structs, each of which looks like the following:

@@@
#&lt;struct matches_id=52276, begin_date=Sun, 28 Nov 2010 20:30:00 -0500, windows_time_zone=&quot;E. South America Standard Time&quot;, team1_id=1430, team2_id=373, team1=&quot;Ava&#237; Futebol Clube&quot;, team2=&quot;Santos Futebol Clube&quot;, status=&quot;N&quot;, match_day_name=&quot;Rodada 37&quot;, season_name=&quot;Brasileir&#227;o S&#233;rie A&quot;, round_name=&quot;Brasileir&#227;o S&#233;rie A&quot;, competition_name=&quot;Brasileir&#227;o S&#233;rie A&quot;, group_name=&quot;&quot;, use_gsm=&quot;Y&quot;, team1_score=0, team2_score=0&gt;
@@@

Calling #to_json on this struct throws the following exception:

@@@
NoMethodError: undefined method `encode_json' for Sun, 28 Nov 2010 20:30:00 -0500:DateTime
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `block in encode_json'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `map'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `encode_json'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:47:in `block in encode'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:77:in `check_for_circular_references'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:45:in `encode'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:30:in `encode'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/core_ext/object/to_json.rb:20:in `to_json'
	from (irb):8
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands/console.rb:44:in `start'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands/console.rb:8:in `start'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands.rb:23:in `&lt;top (required)&gt;'
	from script/rails:6:in `require'
	from script/rails:6:in `&lt;main&gt;'
@@@

The exception does not seem to be related to the DateTime type, since I can convert this struct to a hash and that will serialize to JSON without error:

@@@
Hash[row.members.zip(row.values)] =&gt; 

{:matches_id=&gt;52276, :begin_date=&gt;Sun, 28 Nov 2010 20:30:00 -0500, :windows_time_zone=&gt;&quot;E. South America Standard Time&quot;, :team1_id=&gt;1430, :team2_id=&gt;373, :team1=&gt;&quot;Ava&#237; Futebol Clube&quot;, :team2=&gt;&quot;Santos Futebol Clube&quot;, :status=&gt;&quot;N&quot;, :match_day_name=&gt;&quot;Rodada 37&quot;, :season_name=&gt;&quot;Brasileir&#227;o S&#233;rie A&quot;, :round_name=&gt;&quot;Brasileir&#227;o S&#233;rie A&quot;, :competition_name=&gt;&quot;Brasileir&#227;o S&#233;rie A&quot;, :group_name=&gt;&quot;&quot;, :use_gsm=&gt;&quot;Y&quot;, :team1_score=&gt;0, :team2_score=&gt;0}
@@@

which produces correct JSON on #to_json:

@@@
=&gt; &quot;{\&quot;matches_id\&quot;:52276,\&quot;begin_date\&quot;:\&quot;2010-11-28T20:30:00-05:00\&quot;,\&quot;windows_time_zone\&quot;:\&quot;E. South America Standard Time\&quot;,\&quot;team1_id\&quot;:1430,\&quot;team2_id\&quot;:373,\&quot;team1\&quot;:\&quot;Ava\\u00ed Futebol Clube\&quot;,\&quot;team2\&quot;:\&quot;Santos Futebol Clube\&quot;,\&quot;status\&quot;:\&quot;N\&quot;,\&quot;match_day_name\&quot;:\&quot;Rodada 37\&quot;,\&quot;season_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;round_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;competition_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;group_name\&quot;:\&quot;\&quot;,\&quot;use_gsm\&quot;:\&quot;Y\&quot;,\&quot;team1_score\&quot;:0,\&quot;team2_score\&quot;:0}&quot; 
@@@

Struct support should be added *OR* perhaps a pointer to some documentation on how I can expect AS::JSON in my own project to work with Struct. I think it's ok to do a local hack like the one I did temporarily, but I'd rather see this handled in Rails, or at the very least in some project specific override.

Thanks,
Mark</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;I am using DataMapper's &lt;code&gt;repository.adapter.select&lt;/code&gt;
to retrieve results of an arbitrary query. The results are returned
as an array of structs, each of which looks like the following:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;#&amp;lt;struct matches_id=52276, begin_date=Sun, 28 Nov 2010 20:30:00 -0500, windows_time_zone=&quot;E. South America Standard Time&quot;, team1_id=1430, team2_id=373, team1=&quot;Ava&amp;iacute; Futebol Clube&quot;, team2=&quot;Santos Futebol Clube&quot;, status=&quot;N&quot;, match_day_name=&quot;Rodada 37&quot;, season_name=&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, round_name=&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, competition_name=&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, group_name=&quot;&quot;, use_gsm=&quot;Y&quot;, team1_score=0, team2_score=0&amp;gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Calling #to_json on this struct throws the following
exception:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;NoMethodError: undefined method `encode_json' for Sun, 28 Nov 2010 20:30:00 -0500:DateTime
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `block in encode_json'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `map'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `encode_json'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:47:in `block in encode'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:77:in `check_for_circular_references'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:45:in `encode'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:30:in `encode'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/core_ext/object/to_json.rb:20:in `to_json'
    from (irb):8
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands/console.rb:44:in `start'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands/console.rb:8:in `start'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands.rb:23:in `&amp;lt;top (required)&amp;gt;'
    from script/rails:6:in `require'
    from script/rails:6:in `&amp;lt;main&amp;gt;'&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;The exception does not seem to be related to the DateTime type,
since I can convert this struct to a hash and that will serialize
to JSON without error:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;Hash[row.members.zip(row.values)] =&amp;gt; 

{:matches_id=&amp;gt;52276, :begin_date=&amp;gt;Sun, 28 Nov 2010 20:30:00 -0500, :windows_time_zone=&amp;gt;&quot;E. South America Standard Time&quot;, :team1_id=&amp;gt;1430, :team2_id=&amp;gt;373, :team1=&amp;gt;&quot;Ava&amp;iacute; Futebol Clube&quot;, :team2=&amp;gt;&quot;Santos Futebol Clube&quot;, :status=&amp;gt;&quot;N&quot;, :match_day_name=&amp;gt;&quot;Rodada 37&quot;, :season_name=&amp;gt;&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, :round_name=&amp;gt;&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, :competition_name=&amp;gt;&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, :group_name=&amp;gt;&quot;&quot;, :use_gsm=&amp;gt;&quot;Y&quot;, :team1_score=&amp;gt;0, :team2_score=&amp;gt;0}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;which produces correct JSON on #to_json:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;=&amp;gt; &quot;{\&quot;matches_id\&quot;:52276,\&quot;begin_date\&quot;:\&quot;2010-11-28T20:30:00-05:00\&quot;,\&quot;windows_time_zone\&quot;:\&quot;E. South America Standard Time\&quot;,\&quot;team1_id\&quot;:1430,\&quot;team2_id\&quot;:373,\&quot;team1\&quot;:\&quot;Ava\\u00ed Futebol Clube\&quot;,\&quot;team2\&quot;:\&quot;Santos Futebol Clube\&quot;,\&quot;status\&quot;:\&quot;N\&quot;,\&quot;match_day_name\&quot;:\&quot;Rodada 37\&quot;,\&quot;season_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;round_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;competition_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;group_name\&quot;:\&quot;\&quot;,\&quot;use_gsm\&quot;:\&quot;Y\&quot;,\&quot;team1_score\&quot;:0,\&quot;team2_score\&quot;:0}&quot;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Struct support should be added &lt;em&gt;OR&lt;/em&gt; perhaps a pointer to
some documentation on how I can expect AS::JSON in my own project
to work with Struct. I think it's ok to do a local hack like the
one I did temporarily, but I'd rather see this handled in Rails, or
at the very least in some project specific override.&lt;/p&gt;
&lt;p&gt;Thanks,&lt;br&gt;
Mark&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I am using DataMapper's `repository.adapter.select` to retrieve results of an arbitrary query. The results are returned as an array of structs, each of which looks like the following:

@@@
#&lt;struct matches_id=52276, begin_date=Sun, 28 Nov 2010 20:30:00 -0500, windows_time_zone=&quot;E. South America Standard Time&quot;, team1_id=1430, team2_id=373, team1=&quot;Ava&#237; Futebol Clube&quot;, team2=&quot;Santos Futebol Clube&quot;, status=&quot;N&quot;, match_day_name=&quot;Rodada 37&quot;, season_name=&quot;Brasileir&#227;o S&#233;rie A&quot;, round_name=&quot;Brasileir&#227;o S&#233;rie A&quot;, competition_name=&quot;Brasileir&#227;o S&#233;rie A&quot;, group_name=&quot;&quot;, use_gsm=&quot;Y&quot;, team1_score=0, team2_score=0&gt;
@@@

Calling #to_json on this struct throws the following exception:

@@@
NoMethodError: undefined method `encode_json' for Sun, 28 Nov 2010 20:30:00 -0500:DateTime
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `block in encode_json'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `map'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `encode_json'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:47:in `block in encode'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:77:in `check_for_circular_references'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:45:in `encode'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:30:in `encode'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/core_ext/object/to_json.rb:20:in `to_json'
	from (irb):8
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands/console.rb:44:in `start'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands/console.rb:8:in `start'
	from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands.rb:23:in `&lt;top (required)&gt;'
	from script/rails:6:in `require'
	from script/rails:6:in `&lt;main&gt;'
@@@

The exception does not seem to be related to the DateTime type, since I can convert this struct to a hash and that will serialize to JSON without error:

@@@
Hash[row.members.zip(row.values)] =&gt; 

{:matches_id=&gt;52276, :begin_date=&gt;Sun, 28 Nov 2010 20:30:00 -0500, :windows_time_zone=&gt;&quot;E. South America Standard Time&quot;, :team1_id=&gt;1430, :team2_id=&gt;373, :team1=&gt;&quot;Ava&#237; Futebol Clube&quot;, :team2=&gt;&quot;Santos Futebol Clube&quot;, :status=&gt;&quot;N&quot;, :match_day_name=&gt;&quot;Rodada 37&quot;, :season_name=&gt;&quot;Brasileir&#227;o S&#233;rie A&quot;, :round_name=&gt;&quot;Brasileir&#227;o S&#233;rie A&quot;, :competition_name=&gt;&quot;Brasileir&#227;o S&#233;rie A&quot;, :group_name=&gt;&quot;&quot;, :use_gsm=&gt;&quot;Y&quot;, :team1_score=&gt;0, :team2_score=&gt;0}
@@@

which produces correct JSON on #to_json:

@@@
=&gt; &quot;{\&quot;matches_id\&quot;:52276,\&quot;begin_date\&quot;:\&quot;2010-11-28T20:30:00-05:00\&quot;,\&quot;windows_time_zone\&quot;:\&quot;E. South America Standard Time\&quot;,\&quot;team1_id\&quot;:1430,\&quot;team2_id\&quot;:373,\&quot;team1\&quot;:\&quot;Ava\\u00ed Futebol Clube\&quot;,\&quot;team2\&quot;:\&quot;Santos Futebol Clube\&quot;,\&quot;status\&quot;:\&quot;N\&quot;,\&quot;match_day_name\&quot;:\&quot;Rodada 37\&quot;,\&quot;season_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;round_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;competition_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;group_name\&quot;:\&quot;\&quot;,\&quot;use_gsm\&quot;:\&quot;Y\&quot;,\&quot;team1_score\&quot;:0,\&quot;team2_score\&quot;:0}&quot; 
@@@

Struct support should be added *OR* perhaps a pointer to some documentation on how I can expect AS::JSON in my own project to work with Struct. I think it's ok to do a local hack like the one I did temporarily, but I'd rather see this handled in Rails, or at the very least in some project specific override.

Thanks,
Mark</body>
      <body-html>&lt;div&gt;&lt;p&gt;I am using DataMapper's &lt;code&gt;repository.adapter.select&lt;/code&gt;
to retrieve results of an arbitrary query. The results are returned
as an array of structs, each of which looks like the following:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;#&amp;lt;struct matches_id=52276, begin_date=Sun, 28 Nov 2010 20:30:00 -0500, windows_time_zone=&quot;E. South America Standard Time&quot;, team1_id=1430, team2_id=373, team1=&quot;Ava&amp;iacute; Futebol Clube&quot;, team2=&quot;Santos Futebol Clube&quot;, status=&quot;N&quot;, match_day_name=&quot;Rodada 37&quot;, season_name=&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, round_name=&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, competition_name=&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, group_name=&quot;&quot;, use_gsm=&quot;Y&quot;, team1_score=0, team2_score=0&amp;gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Calling #to_json on this struct throws the following
exception:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;NoMethodError: undefined method `encode_json' for Sun, 28 Nov 2010 20:30:00 -0500:DateTime
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `block in encode_json'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `map'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `encode_json'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:47:in `block in encode'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:77:in `check_for_circular_references'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:45:in `encode'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/json/encoding.rb:30:in `encode'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/activesupport-3.0.3/lib/active_support/core_ext/object/to_json.rb:20:in `to_json'
    from (irb):8
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands/console.rb:44:in `start'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands/console.rb:8:in `start'
    from /Users/mark/.rvm/gems/ruby-1.9.2-head/gems/railties-3.0.3/lib/rails/commands.rb:23:in `&amp;lt;top (required)&amp;gt;'
    from script/rails:6:in `require'
    from script/rails:6:in `&amp;lt;main&amp;gt;'&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;The exception does not seem to be related to the DateTime type,
since I can convert this struct to a hash and that will serialize
to JSON without error:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;Hash[row.members.zip(row.values)] =&amp;gt; 

{:matches_id=&amp;gt;52276, :begin_date=&amp;gt;Sun, 28 Nov 2010 20:30:00 -0500, :windows_time_zone=&amp;gt;&quot;E. South America Standard Time&quot;, :team1_id=&amp;gt;1430, :team2_id=&amp;gt;373, :team1=&amp;gt;&quot;Ava&amp;iacute; Futebol Clube&quot;, :team2=&amp;gt;&quot;Santos Futebol Clube&quot;, :status=&amp;gt;&quot;N&quot;, :match_day_name=&amp;gt;&quot;Rodada 37&quot;, :season_name=&amp;gt;&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, :round_name=&amp;gt;&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, :competition_name=&amp;gt;&quot;Brasileir&amp;atilde;o S&amp;eacute;rie A&quot;, :group_name=&amp;gt;&quot;&quot;, :use_gsm=&amp;gt;&quot;Y&quot;, :team1_score=&amp;gt;0, :team2_score=&amp;gt;0}&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;which produces correct JSON on #to_json:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;=&amp;gt; &quot;{\&quot;matches_id\&quot;:52276,\&quot;begin_date\&quot;:\&quot;2010-11-28T20:30:00-05:00\&quot;,\&quot;windows_time_zone\&quot;:\&quot;E. South America Standard Time\&quot;,\&quot;team1_id\&quot;:1430,\&quot;team2_id\&quot;:373,\&quot;team1\&quot;:\&quot;Ava\\u00ed Futebol Clube\&quot;,\&quot;team2\&quot;:\&quot;Santos Futebol Clube\&quot;,\&quot;status\&quot;:\&quot;N\&quot;,\&quot;match_day_name\&quot;:\&quot;Rodada 37\&quot;,\&quot;season_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;round_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;competition_name\&quot;:\&quot;Brasileir\\u00e3o S\\u00e9rie A\&quot;,\&quot;group_name\&quot;:\&quot;\&quot;,\&quot;use_gsm\&quot;:\&quot;Y\&quot;,\&quot;team1_score\&quot;:0,\&quot;team2_score\&quot;:0}&quot;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Struct support should be added &lt;em&gt;OR&lt;/em&gt; perhaps a pointer to
some documentation on how I can expect AS::JSON in my own project
to work with Struct. I think it's ok to do a local hack like the
one I did temporarily, but I'd rather see this handled in Rails, or
at the very least in some project specific override.&lt;/p&gt;
&lt;p&gt;Thanks,&lt;br&gt;
Mark&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-28T05:46:54+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>&quot;json to_json encode struct&quot;</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2010-11-28T14:01:26+00:00</updated-at>
      <user-id type="integer">18267</user-id>
      <version type="integer">1</version>
      <user-name>Mark A. Richman</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>+1

It's not really a problem with Structs, but with classes included in native structures.

A test case:


    class Sub
      def as_json(*)
        { :foo =&gt; &quot;bar&quot; }
      end
    end

    class Base
      def as_json(*)
        [ Sub.new ]
      end
    end

    puts Base.new.to_json

Resulting in the error reported:



    [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `encode_json': undefined method `encode_json' for #&lt;Sub:0x102a02a78&gt; (NoMethodError)
      from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `map'
      from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `encode_json'
      from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:47:in `encode'
      from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:77:in `check_for_circular_references'
      from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:45:in `encode'
      from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:30:in `encode'
      from [GEM_HOME]/activesupport-3.0.3/lib/active_support/core_ext/object/to_json.rb:15:in `to_json'
      from json_test.rb:15</body>
      <body-html>&lt;div&gt;&lt;p&gt;+1&lt;/p&gt;
&lt;p&gt;It's not really a problem with Structs, but with classes
included in native structures.&lt;/p&gt;
&lt;p&gt;A test case:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class Sub
  def as_json(*)
    { :foo =&amp;gt; &quot;bar&quot; }
  end
end

class Base
  def as_json(*)
    [ Sub.new ]
  end
end

puts Base.new.to_json&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Resulting in the error reported:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;[GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `encode_json': undefined method `encode_json' for #&amp;lt;Sub:0x102a02a78&amp;gt; (NoMethodError)
  from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `map'
  from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:214:in `encode_json'
  from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:47:in `encode'
  from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:77:in `check_for_circular_references'
  from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:45:in `encode'
  from [GEM_HOME]/activesupport-3.0.3/lib/active_support/json/encoding.rb:30:in `encode'
  from [GEM_HOME]/activesupport-3.0.3/lib/active_support/core_ext/object/to_json.rb:15:in `to_json'
  from json_test.rb:15&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-08T20:37:31+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: &quot;\&quot;json to_json encode struct\&quot;&quot;
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2010-12-08T20:37:38+00:00</updated-at>
      <user-id type="integer">27931</user-id>
      <version type="integer">2</version>
      <user-name>iain</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>BTW: this issue was introduced in Rails 3.0.2, the above code works fine in Rails 3.0.1</body>
      <body-html>&lt;div&gt;&lt;p&gt;BTW: this issue was introduced in Rails 3.0.2, the above code
works fine in Rails 3.0.1&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-08T20:42:19+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2010-12-08T20:42:27+00:00</updated-at>
      <user-id type="integer">27931</user-id>
      <version type="integer">3</version>
      <user-name>iain</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Thanks Iain! How do we get this fixed in 3.0.4?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Thanks Iain! How do we get this fixed in 3.0.4?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-08T21:00:45+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2010-12-08T21:00:49+00:00</updated-at>
      <user-id type="integer">18267</user-id>
      <version type="integer">4</version>
      <user-name>Mark A. Richman</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Would you mind pasting your json_test.rb so I can see what you did?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Would you mind pasting your json_test.rb so I can see what you
did?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-08T21:02:13+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2010-12-08T21:02:16+00:00</updated-at>
      <user-id type="integer">18267</user-id>
      <version type="integer">5</version>
      <user-name>Mark A. Richman</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>json_test.rb is the code I showed (minus a &quot;require 'config/environment'&quot; line to load my Rails app).
To fix it, we need to dig in activesupport/lib/active_support/json/encoding.rb and see what has been changed.</body>
      <body-html>&lt;div&gt;&lt;p&gt;json_test.rb is the code I showed (minus a &quot;require
'config/environment'&quot; line to load my Rails app).&lt;br&gt;
To fix it, we need to dig in
activesupport/lib/active_support/json/encoding.rb and see what has
been changed.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-08T21:33:29+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2010-12-08T21:33:37+00:00</updated-at>
      <user-id type="integer">27931</user-id>
      <version type="integer">6</version>
      <user-name>iain</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>A custom #as_json definition should usually call Array#as_json or Hash#as_json itself. For example, the correct definition in the example above is:

    class Base
      def as_json(*args)
        [ Sub.new ].as_json(*args)
      end
    end

Object#as_json has a similar bug, which is causing Mark's exception. It should call #as_json on the result of #to_hash or #instance_values:

    class Object
      def as_json(options = nil) #:nodoc:
        if respond_to?(:to_hash)
          to_hash
        else
          instance_values
        end.as_json(options)
      end
    end</body>
      <body-html>&lt;div&gt;&lt;p&gt;A custom #as_json definition should usually call Array#as_json
or Hash#as_json itself. For example, the correct definition in the
example above is:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class Base
  def as_json(*args)
    [ Sub.new ].as_json(*args)
  end
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Object#as_json has a similar bug, which is causing Mark's
exception. It should call #as_json on the result of #to_hash or
#instance_values:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class Object
  def as_json(options = nil) #:nodoc:
    if respond_to?(:to_hash)
      to_hash
    else
      instance_values
    end.as_json(options)
  end
end&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-09T00:58:48+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2010-12-09T00:58:54+00:00</updated-at>
      <user-id type="integer">72273</user-id>
      <version type="integer">7</version>
      <user-name>John Firebaugh</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I cannot reproduce this, however, it is not behaving as expected.

@@@ ruby
Struct.new(&quot;StructTest&quot;, :name, :address)
puts Struct::StructTest.new(&quot;Dave&quot;, &quot;value&quot;).to_json # =&gt; [&quot;Dave&quot;,&quot;121 Main st.&quot;]
@@@

I would have expected: { &quot;name&quot;: &quot;Dave&quot;, &quot;address&quot;: &quot;121 Main st.&quot; }</body>
      <body-html>&lt;div&gt;&lt;p&gt;I cannot reproduce this, however, it is not behaving as
expected.&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;Struct.new(&quot;StructTest&quot;, :name, :address)
puts Struct::StructTest.new(&quot;Dave&quot;, &quot;value&quot;).to_json # =&amp;gt; [&quot;Dave&quot;,&quot;121 Main st.&quot;]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;I would have expected: { &quot;name&quot;: &quot;Dave&quot;, &quot;address&quot;: &quot;121 Main
st.&quot; }&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-12-11T21:54:44+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2010-12-11T21:54:52+00:00</updated-at>
      <user-id type="integer">128585</user-id>
      <version type="integer">8</version>
      <user-name>bgallet</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>This brand &lt;a href=&quot;http://www.wholesalenflstore.com/new-york-giants-jerseys-c-82.html&quot;&gt;new york giants nfl&lt;/a&gt; is not common in America. With regard to the president wear their shoes, the Onitsuka Tiger is naturally flattered. The spokesman of the Asics shoes says &#8220; Obama performed very &lt;a href=&quot;http://www.wholesalenflstore.com/jacksonville-jaguars-jerseys-c-71.html&quot;&gt;jacksonville jaguars jerseys&lt;/a&gt; well during the campaign, he has his &lt;a href=&quot;http://www.wholesalenflstore.com/miami-dolphins-jerseys-c-66.html&quot;&gt;miami dolphins jerseys&lt;/a&gt; own political &lt;a href=&quot;http://www.wholesalenflstore.com/kansas-city-chiefs-jerseys-c-74.html&quot;&gt;kc chiefs jerseys&lt;/a&gt; principles and charm. The selection of the footwear is also different and excellent.&#8221; This action &lt;a href=&quot;http://www.wholesalenflstore.com/denver-broncos-jerseys-c-73.html&quot;&gt;denver broncos jerseys&lt;/a&gt; increases the &lt;a href=&quot;http://www.wholesalenflstore.com/new-york-jets-jerseys-c-68.html&quot;&gt;new york jets jerseys&lt;/a&gt; reputation of &lt;a href=&quot;http://www.wholesalenflstore.com/indianapolis-colts-jerseys-c-70.html&quot;&gt;indy colts jerseys&lt;/a&gt; the Asics in the America &lt;a href=&quot;http://www.wholesalenflstore.com/nfl-caps-c-104.html&quot;&gt;wholesale nfl caps&lt;/a&gt; and makes more people notice &lt;a href=&quot;http://www.wholesalenflstore.com/minnesota-vikings-jerseys-c-96.html&quot;&gt;minnesota vikings jerseys&lt;/a&gt; &lt;a href=&quot;http://www.wholesalenflstore.com/houston-texans-jerseys-c-69.html&quot;&gt;houston texans jerseys&lt;/a&gt; about. &lt;a href=&quot;http://www.wholesalenflstore.com/tennessee-titans-jerseys-c-72.html&quot;&gt;tennessee titans jerseys&lt;/a&gt; Certainly this brand is perfect enough and has its own &lt;a href=&quot;http://www.wholesalenflstore.com/san-francisco-49ers-jerseys-c-90.html&quot;&gt;san francisco 49ers jerseys&lt;/a&gt; personality that makes the president choose it. Just &lt;a href=&quot;http://www.wholesalenflstore.com/jacksonville-jaguars-jerseys-c-71.html&quot;&gt;nfl jaguars jerseys&lt;/a&gt; like the Asics Onitsuka Tiger Mexico 66 &lt;a href=&quot;http://www.wholesalenflstore.com/oakland-raiders-jerseys-c-107.html&quot;&gt;oakland raiders jerseys&lt;/a&gt; is loved by Bruce Lee.</body>
      <body-html>&lt;div&gt;&lt;p&gt;This brand &lt;a href=
&quot;http://www.wholesalenflstore.com/new-york-giants-jerseys-c-82.html&quot;&gt;
new york giants nfl&lt;/a&gt; is not common in America. With regard to
the president wear their shoes, the Onitsuka Tiger is naturally
flattered. The spokesman of the Asics shoes says &amp;#8220; Obama
performed very &lt;a href=
&quot;http://www.wholesalenflstore.com/jacksonville-jaguars-jerseys-c-71.html&quot;&gt;
jacksonville jaguars jerseys&lt;/a&gt; well during the campaign, he has
his &lt;a href=
&quot;http://www.wholesalenflstore.com/miami-dolphins-jerseys-c-66.html&quot;&gt;
miami dolphins jerseys&lt;/a&gt; own political &lt;a href=
&quot;http://www.wholesalenflstore.com/kansas-city-chiefs-jerseys-c-74.html&quot;&gt;
kc chiefs jerseys&lt;/a&gt; principles and charm. The selection of the
footwear is also different and excellent.&amp;#8221; This action
&lt;a href=
&quot;http://www.wholesalenflstore.com/denver-broncos-jerseys-c-73.html&quot;&gt;
denver broncos jerseys&lt;/a&gt; increases the &lt;a href=
&quot;http://www.wholesalenflstore.com/new-york-jets-jerseys-c-68.html&quot;&gt;new
york jets jerseys&lt;/a&gt; reputation of &lt;a href=
&quot;http://www.wholesalenflstore.com/indianapolis-colts-jerseys-c-70.html&quot;&gt;
indy colts jerseys&lt;/a&gt; the Asics in the America &lt;a href=
&quot;http://www.wholesalenflstore.com/nfl-caps-c-104.html&quot;&gt;wholesale
nfl caps&lt;/a&gt; and makes more people notice &lt;a href=
&quot;http://www.wholesalenflstore.com/minnesota-vikings-jerseys-c-96.html&quot;&gt;
minnesota vikings jerseys&lt;/a&gt; &lt;a href=
&quot;http://www.wholesalenflstore.com/houston-texans-jerseys-c-69.html&quot;&gt;
houston texans jerseys&lt;/a&gt; about. &lt;a href=
&quot;http://www.wholesalenflstore.com/tennessee-titans-jerseys-c-72.html&quot;&gt;
tennessee titans jerseys&lt;/a&gt; Certainly this brand is perfect enough
and has its own &lt;a href=
&quot;http://www.wholesalenflstore.com/san-francisco-49ers-jerseys-c-90.html&quot;&gt;
san francisco 49ers jerseys&lt;/a&gt; personality that makes the
president choose it. Just &lt;a href=
&quot;http://www.wholesalenflstore.com/jacksonville-jaguars-jerseys-c-71.html&quot;&gt;
nfl jaguars jerseys&lt;/a&gt; like the Asics Onitsuka Tiger Mexico 66
&lt;a href=
&quot;http://www.wholesalenflstore.com/oakland-raiders-jerseys-c-107.html&quot;&gt;
oakland raiders jerseys&lt;/a&gt; is loved by Bruce Lee.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-08T02:17:09+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-08T23:56:41+00:00</updated-at>
      <user-id type="integer">131700</user-id>
      <version type="integer">9</version>
      <user-name>xxchenjialong</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I have same problem.
Use mongoid and try respond_to :json

In rails 3.0.1 it work nice. higher versions broken.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I have same problem.&lt;br&gt;
Use mongoid and try respond_to :json&lt;/p&gt;
&lt;p&gt;In rails 3.0.1 it work nice. higher versions broken.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-11T13:49:43+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-11T13:49:53+00:00</updated-at>
      <user-id type="integer">132033</user-id>
      <version type="integer">10</version>
      <user-name>jasereja</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Failing test</body>
      <body-html>&lt;div&gt;&lt;p&gt;Failing test&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-13T00:18:47+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-13T00:19:01+00:00</updated-at>
      <user-id type="integer">86215</user-id>
      <version type="integer">11</version>
      <user-name>Alexey Nayden</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>A patch to fix complex structures #as_json and #to_json</body>
      <body-html>&lt;div&gt;&lt;p&gt;A patch to fix complex structures #as_json and #to_json&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-13T00:22:49+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-13T00:23:05+00:00</updated-at>
      <user-id type="integer">86215</user-id>
      <version type="integer">12</version>
      <user-name>Alexey Nayden</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-13T00:35:39+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: as_json encode_json json to_json
:assigned_user: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>as_json encode_json json patch to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-13T00:35:55+00:00</updated-at>
      <user-id type="integer">86215</user-id>
      <version type="integer">13</version>
      <user-name>Alexey Nayden</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Here is a patch with test.

https://github.com/neerajdotname/rails/commit/e9931f1df28eb97c53a9209c19f1a809b95ea7d0</body>
      <body-html>&lt;div&gt;&lt;p&gt;Here is a patch with test.&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;https://github.com/neerajdotname/rails/commit/e9931f1df28eb97c53a9209c19f1a809b95ea7d0&quot;&gt;
https://github.com/neerajdotname/rails/commit/e9931f1df28eb97c53a92...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-13T02:46:29+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
:priority: 0
:milestone: 
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>as_json encode_json json patch to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-13T02:46:44+00:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">14</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>sorry I did not see there was already a patch for it. Ignore me.</body>
      <body-html>&lt;div&gt;&lt;p&gt;sorry I did not see there was already a patch for it. Ignore
me.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-13T14:01:08+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>as_json encode_json json patch to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-13T14:01:24+00:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">15</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>@Neeraj no problem. So are you going to apply my patch? Or maybe I shall reassign the ticket to someone else?</body>
      <body-html>&lt;div&gt;&lt;p&gt;@Neeraj no problem. So are you going to apply my patch? Or maybe
I shall reassign the ticket to someone else?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-13T20:47:39+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>as_json encode_json json patch to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-13T20:47:54+00:00</updated-at>
      <user-id type="integer">86215</user-id>
      <version type="integer">16</version>
      <user-name>Alexey Nayden</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">85</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>I can't apply your patch. Only core team can do that. I can +1 this ticket.

+1</body>
      <body-html>&lt;div&gt;&lt;p&gt;I can't apply your patch. Only core team can do that. I can +1
this ticket.&lt;/p&gt;
&lt;p&gt;+1&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-13T22:57:33+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>as_json encode_json json patch to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-13T22:57:53+00:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">17</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name>Jeremy Kemper</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-13T23:21:55+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- 
:assigned_user: 85
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>as_json encode_json json patch to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-13T23:22:14+00:00</updated-at>
      <user-id type="integer">86215</user-id>
      <version type="integer">18</version>
      <user-name>Alexey Nayden</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Santiago, would you please apply my patch? It seems to be useful bugfix.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Santiago, would you please apply my patch? It seems to be useful
bugfix.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-01-13T23:23:47+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>as_json encode_json json patch to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-13T23:24:07+00:00</updated-at>
      <user-id type="integer">86215</user-id>
      <version type="integer">19</version>
      <user-name>Alexey Nayden</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>(from [a9163b547c7cfd4861c814371fa9d1a6bdb31231]) Complex struct encoding fix

[#6077 state:committed]

Signed-off-by: Santiago Pastorino &lt;santiago@wyeworks.com&gt;
https://github.com/rails/rails/commit/a9163b547c7cfd4861c814371fa9d1a6bdb31231</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from &lt;a href=
&quot;/projects/8994/changesets/a9163b547c7cfd4861c814371fa9d1a6bdb31231&quot;
title=
&quot;Changeset [a9163b547c7cfd4861c814371fa9d1a6bdb31231]&quot;&gt;[a9163b547c7cfd4861c814371fa9d1a6bdb31231]&lt;/a&gt;)
Complex struct encoding fix&lt;/p&gt;
&lt;p&gt;[&lt;a href=&quot;/projects/8994/tickets/6077&quot; title=
&quot;Ticket #6077&quot;&gt;#6077&lt;/a&gt; state:committed]&lt;/p&gt;
&lt;p&gt;Signed-off-by: Santiago Pastorino &lt;a href=
&quot;mailto:santiago@wyeworks.com&quot;&gt;santiago@wyeworks.com&lt;/a&gt;&lt;br&gt;
&lt;a href=
&quot;https://github.com/rails/rails/commit/a9163b547c7cfd4861c814371fa9d1a6bdb31231&quot;&gt;
https://github.com/rails/rails/commit/a9163b547c7cfd4861c814371fa9d...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-01-15T02:07:49+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>as_json encode_json json patch to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-15T02:08:11+00:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">20</version>
      <user-name>Repository</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>I'm getting a test failure on this in 1.9.2-p136, due to hash ordering:

@@@
test_struct_encoding(TestJSONEncoding) [test/json/encoding_test.rb:239]:
&lt;&quot;{\&quot;sub\&quot;:{\&quot;name\&quot;:\&quot;David\&quot;,\&quot;date\&quot;:\&quot;2010/01/01\&quot;},\&quot;name\&quot;:\&quot;David\&quot;}&quot;&gt; expected but was
&lt;&quot;{\&quot;name\&quot;:\&quot;David\&quot;,\&quot;sub\&quot;:{\&quot;name\&quot;:\&quot;David\&quot;,\&quot;date\&quot;:\&quot;2010/01/01\&quot;}}&quot;&gt;.
@@@

Should the expected struct ordering be canonical? If not, I've patched the expected ordering in the test at https://github.com/bkerley/rails/commit/b9d05c3fff974e59b4e06da68d9c3e3ad86ca629 .</body>
      <body-html>&lt;div&gt;&lt;p&gt;I'm getting a test failure on this in 1.9.2-p136, due to hash
ordering:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;test_struct_encoding(TestJSONEncoding) [test/json/encoding_test.rb:239]:
&amp;lt;&quot;{\&quot;sub\&quot;:{\&quot;name\&quot;:\&quot;David\&quot;,\&quot;date\&quot;:\&quot;2010/01/01\&quot;},\&quot;name\&quot;:\&quot;David\&quot;}&quot;&amp;gt; expected but was
&amp;lt;&quot;{\&quot;name\&quot;:\&quot;David\&quot;,\&quot;sub\&quot;:{\&quot;name\&quot;:\&quot;David\&quot;,\&quot;date\&quot;:\&quot;2010/01/01\&quot;}}&quot;&amp;gt;.&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Should the expected struct ordering be canonical? If not, I've
patched the expected ordering in the test at &lt;a href=
&quot;https://github.com/bkerley/rails/commit/b9d05c3fff974e59b4e06da68d9c3e3ad86ca629&quot;&gt;
https://github.com/bkerley/rails/commit/b9d05c3fff974e59b4e06da68d9...&lt;/a&gt;
.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-01-17T04:24:46+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>as_json encode_json json patch to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-01-17T04:25:10+00:00</updated-at>
      <user-id type="integer">26262</user-id>
      <version type="integer">21</version>
      <user-name>Bryce Kerley</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>This is still failing for me with Rails 3.0.4

To replicate, try using Mongoid or MongoMapper with anything higher than Rails 3.0.1</body>
      <body-html>&lt;div&gt;&lt;p&gt;This is still failing for me with Rails 3.0.4&lt;/p&gt;
&lt;p&gt;To replicate, try using Mongoid or MongoMapper with anything
higher than Rails 3.0.1&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-11T20:28:34+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>as_json encode_json json patch to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-02-11T20:28:53+00:00</updated-at>
      <user-id type="integer">47545</user-id>
      <version type="integer">22</version>
      <user-name>Mike (at coverallcrew)</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">40272</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Have you tried this against master?
I guess we haven't backported to 3-0-stable?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Have you tried this against master?&lt;br&gt;
I guess we haven't backported to 3-0-stable?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-11T22:24:17+00:00</created-at>
      <creator-id type="integer">18267</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">6077</number>
      <permalink>activesupportjsonencode-fails-for-struct-types</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>committed</state>
      <tag>as_json encode_json json patch to_json</tag>
      <title>ActiveSupport::JSON.encode fails for Struct types</title>
      <updated-at type="datetime">2011-02-11T22:24:35+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">23</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Mark A. Richman</creator-name>
      <assigned-user-name>Santiago Pastorino</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/6077</url>
      <milestone-title>3.x</milestone-title>
      <priority-name>Low</priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>4c99bdc7b2ca0c62479c47208c342a5a70e2fade</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2011-01-13T00:18:47+00:00</created-at>
      <filename>complex_struct_json_encoding_test.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">858643</id>
      <size type="integer">1642</size>
      <uploader-id type="integer">86215</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/858643/complex_struct_json_encoding_test.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>b73b89ea0fc3c283a3bb61559366aeccd0363e4f</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2011-01-13T00:22:49+00:00</created-at>
      <filename>complex_struct_json_encoding.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">858648</id>
      <size type="integer">2518</size>
      <uploader-id type="integer">86215</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/858648/complex_struct_json_encoding.diff</url>
    </attachment>
  </attachments>
</ticket>
