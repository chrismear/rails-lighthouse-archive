<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">1366</assigned-user-id>
  <attachments-count type="integer">5</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2009-02-18T09:59:25+00:00</created-at>
  <creator-id type="integer">681</creator-id>
  <milestone-due-on type="datetime">2009-01-31T00:00:00+00:00</milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">2006</number>
  <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
  <priority type="integer">5</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>resolved</state>
  <tag>2.3-rc1 activerecord having with_scope</tag>
  <title>with_scope &amp; :having option bug with 2.3 RC1</title>
  <updated-at type="datetime">2009-04-21T13:35:23+01:00</updated-at>
  <user-id type="integer">1366</user-id>
  <version type="integer">18</version>
  <user-name>Pratik</user-name>
  <creator-name>Thibaud Guillaume-Gentil</creator-name>
  <assigned-user-name>Pratik</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
  <priority-name nil="true"></priority-name>
  <original-body>I have a bug when using find :having option (and :group option) with with_scope.
with_scope doesn't support :having yet or it's another problem?

@@@ Ruby
with_scope :find =&gt; { :group =&gt; '...', :having =&gt; '...', .... } do
  find(:all)
end
@@@

@@@
NameError (undefined local variable or method `scoped_having' for #&lt;Class:0x689e634&gt;):
  activerecord (2.3.0) lib/active_record/base.rb:1963:in `method_missing_without_paginate'
  activerecord (2.3.0) lib/active_record/base.rb:1759:in `add_group!'
  activerecord (2.3.0) lib/active_record/base.rb:1695:in `construct_finder_sql'
  activerecord (2.3.0) lib/active_record/base.rb:1554:in `find_every'
  activerecord (2.3.0) lib/active_record/base.rb:615:in `find'
  ...
  activerecord (2.3.0) lib/active_record/base.rb:2141:in `with_scope'
@@@</original-body>
  <latest-body>I have a bug when using find :having option (and :group option) with with_scope.
with_scope doesn't support :having yet or it's another problem?

@@@ Ruby
with_scope :find =&gt; { :group =&gt; '...', :having =&gt; '...', .... } do
  find(:all)
end
@@@

@@@
NameError (undefined local variable or method `scoped_having' for #&lt;Class:0x689e634&gt;):
  activerecord (2.3.0) lib/active_record/base.rb:1963:in `method_missing_without_paginate'
  activerecord (2.3.0) lib/active_record/base.rb:1759:in `add_group!'
  activerecord (2.3.0) lib/active_record/base.rb:1695:in `construct_finder_sql'
  activerecord (2.3.0) lib/active_record/base.rb:1554:in `find_every'
  activerecord (2.3.0) lib/active_record/base.rb:615:in `find'
  ...
  activerecord (2.3.0) lib/active_record/base.rb:2141:in `with_scope'
@@@</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;I have a bug when using find :having option (and :group option)
with with_scope. with_scope doesn't support :having yet or it's
another problem?&lt;/p&gt;
&lt;p&gt;@@@ Ruby with_scope :find =&amp;gt; { :group =&amp;gt; '...', :having
=&amp;gt; '...', .... } do find(:all) end&lt;/p&gt;


&lt;pre&gt;&lt;code&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;NameError (undefined local variable or method
&lt;code&gt;scoped_having' for #&amp;lt;Class:0x689e634&amp;gt;): activerecord
(2.3.0)
lib/active_record/base.rb:1963:in&lt;/code&gt;method_missing_without_paginate'
activerecord (2.3.0) lib/active_record/base.rb:1759:in
&lt;code&gt;add_group!' activerecord (2.3.0)
lib/active_record/base.rb:1695:in&lt;/code&gt;construct_finder_sql'
activerecord (2.3.0) lib/active_record/base.rb:1554:in
&lt;code&gt;find_every' activerecord (2.3.0)
lib/active_record/base.rb:615:in&lt;/code&gt;find' ... activerecord
(2.3.0) lib/active_record/base.rb:2141:in
&lt;code&gt;with_scope'&lt;/code&gt;&lt;/p&gt;


&lt;pre&gt;&lt;code&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I have a bug when using find :having option (and :group option) with with_scope.
with_scope doesn't support :having yet or it's another problem?

@@@ Ruby
with_scope :find =&gt; { :group =&gt; '...', :having =&gt; '...', .... } do
  find(:all)
end
@@@

@@@
NameError (undefined local variable or method `scoped_having' for #&lt;Class:0x689e634&gt;):
  activerecord (2.3.0) lib/active_record/base.rb:1963:in `method_missing_without_paginate'
  activerecord (2.3.0) lib/active_record/base.rb:1759:in `add_group!'
  activerecord (2.3.0) lib/active_record/base.rb:1695:in `construct_finder_sql'
  activerecord (2.3.0) lib/active_record/base.rb:1554:in `find_every'
  activerecord (2.3.0) lib/active_record/base.rb:615:in `find'
  ...
  activerecord (2.3.0) lib/active_record/base.rb:2141:in `with_scope'
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;I have a bug when using find :having option (and :group option)
with with_scope. with_scope doesn't support :having yet or it's
another problem?&lt;/p&gt;
&lt;p&gt;@@@ Ruby with_scope :find =&amp;gt; { :group =&amp;gt; '...', :having
=&amp;gt; '...', .... } do find(:all) end&lt;/p&gt;


&lt;pre&gt;&lt;code&gt;

&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;NameError (undefined local variable or method
&lt;code&gt;scoped_having' for #&amp;lt;Class:0x689e634&amp;gt;): activerecord
(2.3.0)
lib/active_record/base.rb:1963:in&lt;/code&gt;method_missing_without_paginate'
activerecord (2.3.0) lib/active_record/base.rb:1759:in
&lt;code&gt;add_group!' activerecord (2.3.0)
lib/active_record/base.rb:1695:in&lt;/code&gt;construct_finder_sql'
activerecord (2.3.0) lib/active_record/base.rb:1554:in
&lt;code&gt;find_every' activerecord (2.3.0)
lib/active_record/base.rb:615:in&lt;/code&gt;find' ... activerecord
(2.3.0) lib/active_record/base.rb:2141:in
&lt;code&gt;with_scope'&lt;/code&gt;&lt;/p&gt;


&lt;pre&gt;&lt;code&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-02-18T09:59:26+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">9903</milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-18T09:59:29+00:00</updated-at>
      <user-id type="integer">681</user-id>
      <version type="integer">1</version>
      <user-name>Thibaud Guillaume-Gentil</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title>2.x</milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>oops

@@@ ruby
with_scope :find =&gt; { :group =&gt; '...', :having =&gt; '...', .... } do
  find(:all)
end
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;oops&lt;/p&gt;


&lt;pre&gt;&lt;code class=&quot;ruby&quot;&gt;
with_scope :find =&amp;gt; { :group =&amp;gt; '...', :having =&amp;gt; '...', .... } do
  find(:all)
end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-02-18T10:01:30+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">9903</milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-18T10:01:32+00:00</updated-at>
      <user-id type="integer">681</user-id>
      <version type="integer">2</version>
      <user-name>Thibaud Guillaume-Gentil</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title>2.x</milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>nobody use :having &amp; with_scope together?</body>
      <body-html>&lt;div&gt;&lt;p&gt;nobody use :having &amp;amp; with_scope together?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-02-25T15:52:08+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">9903</milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-25T15:52:11+00:00</updated-at>
      <user-id type="integer">681</user-id>
      <version type="integer">3</version>
      <user-name>Thibaud Guillaume-Gentil</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title>2.x</milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I am, and have also noticed this bug. It's a bug with variable assignment within a conditional modifier and trying to use that variable in the statement.

I've manually fixed this in mine by changing line 1759 in lib/active_record/base.rb from:

sql &lt;&lt; &quot; HAVING #{scoped_having}&quot; if (scoped_having = scope[:having])

to:

if(scoped_having = scope[:having])
  sql &lt;&lt; &quot; HAVING #{scoped_having}&quot;
end


I'm not sure what the purpose of doing those assignments is (scoped_group, scoped_having). If they're unnecessary, that line could simply be&quot;

sql &lt;&lt; &quot; HAVING #{scope[:having]}&quot; if scope[:having]</body>
      <body-html>&lt;div&gt;&lt;p&gt;I am, and have also noticed this bug. It's a bug with variable
assignment within a conditional modifier and trying to use that
variable in the statement.&lt;/p&gt;
&lt;p&gt;I've manually fixed this in mine by changing line 1759 in
lib/active_record/base.rb from:&lt;/p&gt;
&lt;p&gt;sql &amp;lt;&amp;lt; &quot; HAVING #{scoped_having}&quot; if (scoped_having =
scope[:having])&lt;/p&gt;
&lt;p&gt;to:&lt;/p&gt;
&lt;p&gt;if(scoped_having = scope[:having]) sql &amp;lt;&amp;lt; &quot; HAVING
#{scoped_having}&quot; end&lt;/p&gt;
&lt;p&gt;I'm not sure what the purpose of doing those assignments is
(scoped_group, scoped_having). If they're unnecessary, that line
could simply be&quot;&lt;/p&gt;
&lt;p&gt;sql &amp;lt;&amp;lt; &quot; HAVING #{scope[:having]}&quot; if scope[:having]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-02-25T18:40:06+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">9903</milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-25T18:40:08+00:00</updated-at>
      <user-id type="integer">45858</user-id>
      <version type="integer">4</version>
      <user-name>Blane Dabney</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title>2.x</milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>scoped_having seems to be needed, your first proposition fix the bug for me, thanks Blane!

here the diff:</body>
      <body-html>&lt;div&gt;&lt;p&gt;scoped_having seems to be needed, your first proposition fix the
bug for me, thanks Blane!&lt;/p&gt;
&lt;p&gt;here the diff:&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-02-26T07:25:14+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">9903</milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-26T07:25:17+00:00</updated-at>
      <user-id type="integer">681</user-id>
      <version type="integer">5</version>
      <user-name>Thibaud Guillaume-Gentil</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title>2.x</milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-02-27T13:48:24+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- 
:milestone: 9903
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-27T13:48:26+00:00</updated-at>
      <user-id type="integer">83</user-id>
      <version type="integer">6</version>
      <user-name>DHH</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Ran into the same issue; patch works for me (though might be worthwhile to add a quick test case for this).</body>
      <body-html>&lt;div&gt;&lt;p&gt;Ran into the same issue; patch works for me (though might be
worthwhile to add a quick test case for this).&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-02-27T19:42:43+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-27T19:42:47+00:00</updated-at>
      <user-id type="integer">6262</user-id>
      <version type="integer">7</version>
      <user-name>Zach Holman</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>-1 on this fix without some more work. Patch works on MySQL and on SQLite 3 but *fails* on PostgreSQL.

Here's the patch with some tests attached, run the AR Postgres tests to see them fail. There's some deeper underlying problem here, in addition to the obvious one that this patch fixes.

This should not be applied until someone fixes the PostgreSQL case.</body>
      <body-html>&lt;div&gt;&lt;p&gt;-1 on this fix without some more work. Patch works on MySQL and
on SQLite 3 but &lt;em&gt;fails&lt;/em&gt; on PostgreSQL.&lt;/p&gt;
&lt;p&gt;Here's the patch with some tests attached, run the AR Postgres
tests to see them fail. There's some deeper underlying problem
here, in addition to the obvious one that this patch fixes.&lt;/p&gt;
&lt;p&gt;This should not be applied until someone fixes the PostgreSQL
case.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-02-28T15:10:13+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-28T15:10:14+00:00</updated-at>
      <user-id type="integer">7211</user-id>
      <version type="integer">8</version>
      <user-name>CancelProfileIsBroken</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-02-28T15:49:07+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- 
:assigned_user: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-28T15:49:08+00:00</updated-at>
      <user-id type="integer">1366</user-id>
      <version type="integer">9</version>
      <user-name>Pratik</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>OK, we can't fix the world on one patch, my bad.

Here's a more targeted test for just this patch. Passes under MySQL, PostgreSQL, SQLite3.

Will open a new ticket for the simple group by case that's still failing under PG.</body>
      <body-html>&lt;div&gt;&lt;p&gt;OK, we can't fix the world on one patch, my bad.&lt;/p&gt;
&lt;p&gt;Here's a more targeted test for just this patch. Passes under
MySQL, PostgreSQL, SQLite3.&lt;/p&gt;
&lt;p&gt;Will open a new ticket for the simple group by case that's still
failing under PG.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-02-28T17:03:18+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-28T17:03:23+00:00</updated-at>
      <user-id type="integer">7211</user-id>
      <version type="integer">10</version>
      <user-name>CancelProfileIsBroken</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>(from [c653f700d3afb1208b15fb7fec6250bf3a3f0321]) Fix that scoped find with :group and :having [#2006 state:resolved]

Signed-off-by: Pratik Naik &lt;pratiknaik@gmail.com&gt;
http://github.com/rails/rails/commit/c653f700d3afb1208b15fb7fec6250bf3a3f0321</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from [c653f700d3afb1208b15fb7fec6250bf3a3f0321]) Fix that
scoped find with :group and :having [&lt;a href=&quot;/projects/8994/tickets/2006&quot; title=&quot;Ticket #2006&quot;&gt;#2006&lt;/a&gt;
state:resolved]&lt;/p&gt;
&lt;p&gt;Signed-off-by: Pratik Naik &lt;a href=&quot;mailto:pratiknaik@gmail.com&quot;&gt;pratiknaik@gmail.com&lt;/a&gt; &lt;a href=&quot;http://github.com/rails/rails/commit/c653f700d3afb1208b15fb7fec6250bf3a3f0321&quot;&gt;
http://github.com/rails/rails/co...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2009-02-28T17:43:41+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-28T17:43:42+00:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">11</version>
      <user-name>Repository</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>Great! Thank you!</body>
      <body-html>&lt;div&gt;&lt;p&gt;Great! Thank you!&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2009-02-28T23:38:12+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-02-28T23:38:12+00:00</updated-at>
      <user-id type="integer">681</user-id>
      <version type="integer">12</version>
      <user-name>Thibaud Guillaume-Gentil</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>This doesn't work with Ruby1.9.1:
You will get:
aggregate functions are not allowed in the GROUP BY clause (SQLite3::SQLException)

I don't know if this is related
to sqlite3, sqlite3-ruby gem or ruby
and i don't even know if it is 
a bug or a feature or whatever, but 
I wanted to mention it.

I have added a script that you can eval with 
ruby1.8 =&gt; works
ruby1.9 =&gt; fails

Matthias</body>
      <body-html>&lt;div&gt;&lt;p&gt;This doesn't work with Ruby1.9.1: You will get: aggregate
functions are not allowed in the GROUP BY clause
(SQLite3::SQLException)&lt;/p&gt;
&lt;p&gt;I don't know if this is related to sqlite3, sqlite3-ruby gem or
ruby and i don't even know if it is a bug or a feature or whatever,
but I wanted to mention it.&lt;/p&gt;
&lt;p&gt;I have added a script that you can eval with ruby1.8 =&amp;gt; works
ruby1.9 =&amp;gt; fails&lt;/p&gt;
&lt;p&gt;Matthias&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2009-03-01T13:04:28+00:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-03-01T13:04:33+00:00</updated-at>
      <user-id type="integer">36635</user-id>
      <version type="integer">13</version>
      <user-name>Matthias Hennemeyer</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>Actually this fails for SQLite3 on my Ruby 1.8.7 system.

sleep:~/src/rails/activerecord $ ruby -v
ruby 1.8.7 (2008-08-11 patchlevel 72) [x86_64-linux]
sleep:~/src/rails/activerecord $ sqlite3 --version
3.6.11

Test output:

  1) Error:
test_scoped_find_with_group_and_having(BasicsTest):
ActiveRecord::StatementInvalid: SQLite3::SQLException: aggregate functions are not allowed in the GROUP BY clause: SELECT SUM(salary) as salary FROM &quot;developers&quot;  GROUP BY salary HAVING SUM(salary) &gt; 10000</body>
      <body-html>&lt;div&gt;&lt;p&gt;Actually this fails for SQLite3 on my Ruby 1.8.7 system.&lt;/p&gt;
&lt;p&gt;sleep:~/src/rails/activerecord $ ruby -v ruby 1.8.7 (2008-08-11
patchlevel 72) [x86_64-linux] sleep:~/src/rails/activerecord $
sqlite3 --version 3.6.11&lt;/p&gt;
&lt;p&gt;Test output:&lt;/p&gt;
&lt;p&gt;1) Error: test_scoped_find_with_group_and_having(BasicsTest):
ActiveRecord::StatementInvalid: SQLite3::SQLException: aggregate
functions are not allowed in the GROUP BY clause: SELECT
SUM(salary) as salary FROM &quot;developers&quot; GROUP BY salary HAVING
SUM(salary) &amp;gt; 10000&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2009-03-30T11:55:53+01:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-03-30T11:55:56+01:00</updated-at>
      <user-id type="integer">7654</user-id>
      <version type="integer">14</version>
      <user-name>Bj&#248;rn Arild M&#230;land</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>Reopening for investigation. Version issues, perhaps?

Working for me on:

OS X, Ruby 1.8.6, sqlite3 3.6.6.2, sqlite3-ruby 1.2.4

Ubuntu, ruby 1.8.6, sqlite3 3.4.2, sqlite3-ruby 1.2.4

Ubuntu, ruby 1.9.1, sqlite3 3.4.2, sqlite3-ruby 1.2.4</body>
      <body-html>&lt;div&gt;&lt;p&gt;Reopening for investigation. Version issues, perhaps?&lt;/p&gt;
&lt;p&gt;Working for me on:&lt;/p&gt;
&lt;p&gt;OS X, Ruby 1.8.6, sqlite3 3.6.6.2, sqlite3-ruby 1.2.4&lt;/p&gt;
&lt;p&gt;Ubuntu, ruby 1.8.6, sqlite3 3.4.2, sqlite3-ruby 1.2.4&lt;/p&gt;
&lt;p&gt;Ubuntu, ruby 1.9.1, sqlite3 3.4.2, sqlite3-ruby 1.2.4&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-03-30T13:29:10+01:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- 
:state: resolved
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-03-30T13:29:15+01:00</updated-at>
      <user-id type="integer">7211</user-id>
      <version type="integer">15</version>
      <user-name>CancelProfileIsBroken</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>I'd like to confirm Chrononaut's error.

Configuration:

OS: ubuntu 8.10
ruby 1.8.6 (2008-08-11 patchlevel 287) [i686-linux]
sqlite3 --version =&gt; 3.5.9
gem list | grep sqlite3 =&gt; sqlite3-ruby (1.2.4)

I attached the full error.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I'd like to confirm Chrononaut's error.&lt;/p&gt;
&lt;p&gt;Configuration:&lt;/p&gt;
&lt;p&gt;OS: ubuntu 8.10 ruby 1.8.6 (2008-08-11 patchlevel 287)
[i686-linux] sqlite3 --version =&amp;gt; 3.5.9 gem list | grep sqlite3
=&amp;gt; sqlite3-ruby (1.2.4)&lt;/p&gt;
&lt;p&gt;I attached the full error.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-03-30T23:43:03+01:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-03-30T23:43:04+01:00</updated-at>
      <user-id type="integer">43942</user-id>
      <version type="integer">16</version>
      <user-name>Dmitry Ratnikov</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">5</attachments-count>
      <body>I think the problem is in SQLite3.

If we look to the query it has some ambiguity because it is aliasing SUM(salary) to salary but the table has a salary column too. In MySQL it even outputs this message:

1052 Column 'salary' in group statement is ambiguous

Output doing the query from the sqlite console:
@@@ sql
sqlite&gt; SELECT SUM(salary) AS salary FROM developers GROUP BY salary HAVING SUM(salary) &gt; 10000;
SQL error: aggregate functions are not allowed in the GROUP BY clause
@@@
Output doing the query but qualifying the field in the GROUP BY clause:
@@@ sql
sqlite&gt; SELECT SUM(salary) AS salary FROM developers GROUP BY developers.salary HAVING SUM(salary) &gt; 10000;
80000
800000
150000
@@@

I think there was a change from 3.4.2 (used in ci.rubyonrails.org) to 3.6.12 (my version) where the default qualification now locks to SUM(salary) when before it locked to developers.salary</body>
      <body-html>&lt;div&gt;&lt;p&gt;I think the problem is in SQLite3.&lt;/p&gt;
&lt;p&gt;If we look to the query it has some ambiguity because it is
aliasing SUM(salary) to salary but the table has a salary column
too. In MySQL it even outputs this message:&lt;/p&gt;
&lt;p&gt;1052 Column 'salary' in group statement is ambiguous&lt;/p&gt;
&lt;p&gt;Output doing the query from the sqlite console:&lt;/p&gt;


&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;
sqlite&amp;gt; SELECT SUM(salary) AS salary FROM developers GROUP BY salary HAVING SUM(salary) &amp;gt; 10000;
SQL error: aggregate functions are not allowed in the GROUP BY clause
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Output doing the query but qualifying the field in the GROUP BY
clause:&lt;/p&gt;


&lt;pre&gt;&lt;code class=&quot;sql&quot;&gt;
sqlite&amp;gt; SELECT SUM(salary) AS salary FROM developers GROUP BY developers.salary HAVING SUM(salary) &amp;gt; 10000;
80000
800000
150000
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;I think there was a change from 3.4.2 (used in
ci.rubyonrails.org) to 3.6.12 (my version) where the default
qualification now locks to SUM(salary) when before it locked to
developers.salary&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-04-10T20:48:29+01:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-04-10T20:48:32+01:00</updated-at>
      <user-id type="integer">47299</user-id>
      <version type="integer">17</version>
      <user-name>Hector E. Gomez Morales</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">5</attachments-count>
      <body>http://github.com/rails/rails/commit/6513dde490ac35aa6974d85377ecc9af4d2e20fd</body>
      <body-html>&lt;div&gt;&lt;p&gt;&lt;a href=&quot;http://github.com/rails/rails/commit/6513dde490ac35aa6974d85377ecc9af4d2e20fd&quot;&gt;
http://github.com/rails/rails/co...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2009-04-21T13:35:20+01:00</created-at>
      <creator-id type="integer">681</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">2006</number>
      <permalink>with_scope-having-option-bug-with-23-rc1</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>2.3-rc1 activerecord having with_scope</tag>
      <title>with_scope &amp; :having option bug with 2.3 RC1</title>
      <updated-at type="datetime">2009-04-21T13:35:23+01:00</updated-at>
      <user-id type="integer">1366</user-id>
      <version type="integer">18</version>
      <user-name>Pratik</user-name>
      <creator-name>Thibaud Guillaume-Gentil</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/2006</url>
      <priority-name nil="true"></priority-name>
      <milestone-title nil="true"></milestone-title>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>b4eaf46ea4eab0cd49b43fcf5714e92733574d07</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2009-02-26T07:25:14+00:00</created-at>
      <filename>having.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">93243</id>
      <size type="integer">725</size>
      <uploader-id type="integer">681</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/93243/having.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>df7a55e6913b7c3e27602da4b85bc7127b26aa97</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2009-02-28T15:10:13+00:00</created-at>
      <filename>having.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">94284</id>
      <size type="integer">1912</size>
      <uploader-id type="integer">7211</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/94284/having.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>7d9cfd6b6e53299a5a17ab61c390ae8d7583d6b7</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2009-02-28T17:03:18+00:00</created-at>
      <filename>having.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">94297</id>
      <size type="integer">1739</size>
      <uploader-id type="integer">7211</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/94297/having.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>dd608d732cfee1e8c6f208696831a3f5a463057d</code>
      <content-type>text/x-ruby-script</content-type>
      <created-at type="datetime">2009-03-01T13:04:28+00:00</created-at>
      <filename>sqlite_test.rb</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">94525</id>
      <size type="integer">1073</size>
      <uploader-id type="integer">36635</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/94525/sqlite_test.rb</url>
    </attachment>
    <attachment type="Attachment">
      <code>0cb9090b62374225b4933421827bc6fe54b89f6b</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2009-03-30T23:43:03+01:00</created-at>
      <filename>sqlite_error.txt</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">105770</id>
      <size type="integer">25820</size>
      <uploader-id type="integer">43942</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/105770/sqlite_error.txt</url>
    </attachment>
  </attachments>
</ticket>
