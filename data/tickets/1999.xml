<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer" nil="true"></assigned-user-id>
  <attachments-count type="integer">1</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2009-02-17T16:26:55+00:00</created-at>
  <creator-id type="integer">47160</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer">71472</milestone-id>
  <number type="integer">1999</number>
  <permalink>rails-23-rc1-engine-problem-with-load-order-when-used-with-restful_authentication-and-role_requirement</permalink>
  <priority type="integer">1246</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>stale</state>
  <tag>23-rc1 engines load-order restful_authentication role_requirement</tag>
  <title>Rails 2.3 RC1 engine problem with load-order when used with restful_authentication and role_requirement</title>
  <updated-at type="datetime">2011-02-02T18:34:14+00:00</updated-at>
  <user-id type="integer">40272</user-id>
  <version type="integer">8</version>
  <user-name>Santiago Pastorino</user-name>
  <creator-name>Bj&#246;rn Grossmann</creator-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/1999</url>
  <milestone-title>3.x</milestone-title>
  <priority-name nil="true"></priority-name>
  <original-body>I set up a rails app with restful_authentication and role_requirement.

I create a simple engine (&quot;plugin&quot;) with an app-directory and a controller with one action and a view for this action.

In the view, I access the &quot;current_user&quot; method of restful_authentication.

The first time this loads fine (in most cases).
When I reload the page in my browser, I get this error:

&quot;A copy of AuthenticatedSystem has been removed from the module tree but is still active!&quot;

Now comes the strange thing:
When I move the controller from vendor/plugins/welcome/app/controllers/ over to my regular app/controllers/ directory, everything works fine (even for reloads)!

I have attached a template, so you can create a rails app using 
rails testapp -m /path/to/rails-template.rb

Thanks for the great work you are doing!</original-body>
  <latest-body>I set up a rails app with restful_authentication and role_requirement.

I create a simple engine (&quot;plugin&quot;) with an app-directory and a controller with one action and a view for this action.

In the view, I access the &quot;current_user&quot; method of restful_authentication.

The first time this loads fine (in most cases).
When I reload the page in my browser, I get this error:

&quot;A copy of AuthenticatedSystem has been removed from the module tree but is still active!&quot;

Now comes the strange thing:
When I move the controller from vendor/plugins/welcome/app/controllers/ over to my regular app/controllers/ directory, everything works fine (even for reloads)!

I have attached a template, so you can create a rails app using 
rails testapp -m /path/to/rails-template.rb

Thanks for the great work you are doing!</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;I set up a rails app with restful_authentication and
role_requirement.&lt;/p&gt;
&lt;p&gt;I create a simple engine (&quot;plugin&quot;) with an app-directory and a
controller with one action and a view for this action.&lt;/p&gt;
&lt;p&gt;In the view, I access the &quot;current_user&quot; method of
restful_authentication.&lt;/p&gt;
&lt;p&gt;The first time this loads fine (in most cases). When I reload
the page in my browser, I get this error:&lt;/p&gt;
&lt;p&gt;&quot;A copy of AuthenticatedSystem has been removed from the module
tree but is still active!&quot;&lt;/p&gt;
&lt;p&gt;Now comes the strange thing: When I move the controller from
vendor/plugins/welcome/app/controllers/ over to my regular
app/controllers/ directory, everything works fine (even for
reloads)!&lt;/p&gt;
&lt;p&gt;I have attached a template, so you can create a rails app using
rails testapp -m /path/to/rails-template.rb&lt;/p&gt;
&lt;p&gt;Thanks for the great work you are doing!&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I set up a rails app with restful_authentication and role_requirement.

I create a simple engine (&quot;plugin&quot;) with an app-directory and a controller with one action and a view for this action.

In the view, I access the &quot;current_user&quot; method of restful_authentication.

The first time this loads fine (in most cases).
When I reload the page in my browser, I get this error:

&quot;A copy of AuthenticatedSystem has been removed from the module tree but is still active!&quot;

Now comes the strange thing:
When I move the controller from vendor/plugins/welcome/app/controllers/ over to my regular app/controllers/ directory, everything works fine (even for reloads)!

I have attached a template, so you can create a rails app using 
rails testapp -m /path/to/rails-template.rb

Thanks for the great work you are doing!</body>
      <body-html>&lt;div&gt;&lt;p&gt;I set up a rails app with restful_authentication and
role_requirement.&lt;/p&gt;
&lt;p&gt;I create a simple engine (&quot;plugin&quot;) with an app-directory and a
controller with one action and a view for this action.&lt;/p&gt;
&lt;p&gt;In the view, I access the &quot;current_user&quot; method of
restful_authentication.&lt;/p&gt;
&lt;p&gt;The first time this loads fine (in most cases). When I reload
the page in my browser, I get this error:&lt;/p&gt;
&lt;p&gt;&quot;A copy of AuthenticatedSystem has been removed from the module
tree but is still active!&quot;&lt;/p&gt;
&lt;p&gt;Now comes the strange thing: When I move the controller from
vendor/plugins/welcome/app/controllers/ over to my regular
app/controllers/ directory, everything works fine (even for
reloads)!&lt;/p&gt;
&lt;p&gt;I have attached a template, so you can create a rails app using
rails testapp -m /path/to/rails-template.rb&lt;/p&gt;
&lt;p&gt;Thanks for the great work you are doing!&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-02-17T16:26:58+00:00</created-at>
      <creator-id type="integer">47160</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">9903</milestone-id>
      <number type="integer">1999</number>
      <permalink>rails-23-rc1-engine-problem-with-load-order-when-used-with-restful_authentication-and-role_requirement</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 engines load-order restful_authentication role_requirement</tag>
      <title>Rails 2.3 RC1 engine problem with load-order when used with restful_authentication and role_requirement</title>
      <updated-at type="datetime">2009-02-17T16:37:17+00:00</updated-at>
      <user-id type="integer">47160</user-id>
      <version type="integer">1</version>
      <user-name>Bj&#246;rn Grossmann</user-name>
      <creator-name>Bj&#246;rn Grossmann</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1999</url>
      <milestone-title>2.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>I just got bit by this as well.  In my case I had a controller inside my engine plugin that subclassed ApplicationController (as most controllers do).  This forces ApplicationController - and any modules it includes - to be loaded with the plugin on the first request.  

The problem comes on the next request when (in development) Rails tries to unload most constants in the application, including ApplicationController and the modules it included (if they were in /lib).  Since plugins don't get reloaded between requests, though, my plugin was trying to hold on to these constants, producing the &quot;removed from the module tree but is still active&quot; error message.

I fixed the problem by adding this to the init.rb for my plugin:

@@@ ruby
ActiveSupport::Dependencies.load_once_paths.delete(
  File.expand_path(File.dirname(__FILE__))+'/app/controllers')
@@@

The scenario and how it all works is explained better [here](http://www.spacevatican.org/2008/5/28/reload-me-reload-me-not).</body>
      <body-html>&lt;div&gt;&lt;p&gt;I just got bit by this as well. In my case I had a controller
inside my engine plugin that subclassed ApplicationController (as
most controllers do). This forces ApplicationController - and any
modules it includes - to be loaded with the plugin on the first
request.&lt;br&gt;&lt;/p&gt;
&lt;p&gt;The problem comes on the next request when (in development)
Rails tries to unload most constants in the application, including
ApplicationController and the modules it included (if they were in
/lib). Since plugins don't get reloaded between requests, though,
my plugin was trying to hold on to these constants, producing the
&quot;removed from the module tree but is still active&quot; error
message.&lt;/p&gt;
&lt;p&gt;I fixed the problem by adding this to the init.rb for my
plugin:&lt;/p&gt;


&lt;pre&gt;&lt;code class=&quot;ruby&quot;&gt;
ActiveSupport::Dependencies.load_once_paths.delete(
  File.expand_path(File.dirname(__FILE__))+'/app/controllers')
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The scenario and how it all works is explained better &lt;a href=&quot;http://www.spacevatican.org/2008/5/28/reload-me-reload-me-not&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-04-02T18:16:12+01:00</created-at>
      <creator-id type="integer">47160</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">9903</milestone-id>
      <number type="integer">1999</number>
      <permalink>rails-23-rc1-engine-problem-with-load-order-when-used-with-restful_authentication-and-role_requirement</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 engines load-order restful_authentication role_requirement</tag>
      <title>Rails 2.3 RC1 engine problem with load-order when used with restful_authentication and role_requirement</title>
      <updated-at type="datetime">2009-04-02T18:16:13+01:00</updated-at>
      <user-id type="integer">43500</user-id>
      <version type="integer">2</version>
      <user-name>Adam McCrea</user-name>
      <creator-name>Bj&#246;rn Grossmann</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1999</url>
      <milestone-title>2.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>I should also add that I'm not sure this is something that needs &quot;fixed&quot; in Rails, but it could certainly use some documentation.  I'm not even sure if what I did is a good way to fix the problem, or if I'm trying to do something I shouldn't.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I should also add that I'm not sure this is something that needs
&quot;fixed&quot; in Rails, but it could certainly use some documentation.
I'm not even sure if what I did is a good way to fix the problem,
or if I'm trying to do something I shouldn't.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-04-02T18:17:33+01:00</created-at>
      <creator-id type="integer">47160</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">9903</milestone-id>
      <number type="integer">1999</number>
      <permalink>rails-23-rc1-engine-problem-with-load-order-when-used-with-restful_authentication-and-role_requirement</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 engines load-order restful_authentication role_requirement</tag>
      <title>Rails 2.3 RC1 engine problem with load-order when used with restful_authentication and role_requirement</title>
      <updated-at type="datetime">2009-04-02T18:17:38+01:00</updated-at>
      <user-id type="integer">43500</user-id>
      <version type="integer">3</version>
      <user-name>Adam McCrea</user-name>
      <creator-name>Bj&#246;rn Grossmann</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1999</url>
      <milestone-title>2.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>I can't replicate this using your template. I generate the application, start script/server (in development mode), and then hit `http://localhost:3000/welcome` as many times as I can.

Should I try to log in using the restful_auth you've installed?</body>
      <body-html>&lt;div&gt;&lt;p&gt;I can't replicate this using your template. I generate the
application, start script/server (in development mode), and then
hit &lt;code&gt;&lt;a href=&quot;http://localhost:3000/welcome&quot;&gt;http://localhost:3000/welcome&lt;/a&gt;&lt;/code&gt;
as many times as I can.&lt;/p&gt;
&lt;p&gt;Should I try to log in using the restful_auth you've
installed?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-04-03T16:36:31+01:00</created-at>
      <creator-id type="integer">47160</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">9903</milestone-id>
      <number type="integer">1999</number>
      <permalink>rails-23-rc1-engine-problem-with-load-order-when-used-with-restful_authentication-and-role_requirement</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 engines load-order restful_authentication role_requirement</tag>
      <title>Rails 2.3 RC1 engine problem with load-order when used with restful_authentication and role_requirement</title>
      <updated-at type="datetime">2009-04-03T16:36:35+01:00</updated-at>
      <user-id type="integer">137</user-id>
      <version type="integer">4</version>
      <user-name>James Adam</user-name>
      <creator-name>Bj&#246;rn Grossmann</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1999</url>
      <milestone-title>2.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>We get around this problem in Clearance by using the &lt;code&gt;unloadable&lt;/code&gt; method:

http://github.com/thoughtbot/clearance/blob/ccc7d98137c525a7c5c492dcdc11db935d1c2aae/app/controllers/clearance/sessions_controller.rb

http://apidock.com/rails/ActiveSupport/Dependencies/Loadable/unloadable</body>
      <body-html>&lt;div&gt;&lt;p&gt;We get around this problem in Clearance by using the
&lt;code&gt;unloadable&lt;/code&gt; method:&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://github.com/thoughtbot/clearance/blob/ccc7d98137c525a7c5c492dcdc11db935d1c2aae/app/controllers/clearance/sessions_controller.rb&quot;&gt;
http://github.com/thoughtbot/cle...&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;http://apidock.com/rails/ActiveSupport/Dependencies/Loadable/unloadable&quot;&gt;
http://apidock.com/rails/ActiveS...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-04-23T03:54:03+01:00</created-at>
      <creator-id type="integer">47160</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">9903</milestone-id>
      <number type="integer">1999</number>
      <permalink>rails-23-rc1-engine-problem-with-load-order-when-used-with-restful_authentication-and-role_requirement</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 engines load-order restful_authentication role_requirement</tag>
      <title>Rails 2.3 RC1 engine problem with load-order when used with restful_authentication and role_requirement</title>
      <updated-at type="datetime">2009-04-23T03:54:06+01:00</updated-at>
      <user-id type="integer">10900</user-id>
      <version type="integer">5</version>
      <user-name>Dan Croak</user-name>
      <creator-name>Bj&#246;rn Grossmann</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1999</url>
      <milestone-title>2.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>[[bulk edit](/projects/8994/bulk_edits/19097)]</body>
      <body-html>&lt;div&gt;&lt;p&gt;[&lt;a href=&quot;/projects/8994/bulk_edits/19097&quot;&gt;bulk edit&lt;/a&gt;]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-05-04T18:48:40+01:00</created-at>
      <creator-id type="integer">47160</creator-id>
      <diffable-attributes type="yaml">--- 
:milestone: 9903
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">1999</number>
      <permalink>rails-23-rc1-engine-problem-with-load-order-when-used-with-restful_authentication-and-role_requirement</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3-rc1 engines load-order restful_authentication role_requirement</tag>
      <title>Rails 2.3 RC1 engine problem with load-order when used with restful_authentication and role_requirement</title>
      <updated-at type="datetime">2010-05-04T18:48:40+01:00</updated-at>
      <user-id type="integer">85</user-id>
      <version type="integer">6</version>
      <user-name>Jeremy Kemper</user-name>
      <creator-name>Bj&#246;rn Grossmann</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1999</url>
      <milestone-title>3.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>This issue has been automatically marked as stale because it has not been commented on for at least three months.

The resources of the Rails core team are limited, and so we are asking for your help. If you can still reproduce this error on the 3-0-stable branch or on master, please reply with all of the information you have about it and add &quot;[state:open]&quot; to your comment. This will reopen the ticket for review. Likewise, if you feel that this is a very important feature for Rails to include, please reply with your explanation so we can consider it.

Thank you for all your contributions, and we hope you will understand this step to focus our efforts where they are most helpful.</body>
      <body-html>&lt;div&gt;&lt;p&gt;This issue has been automatically marked as stale because it has
not been commented on for at least three months.&lt;/p&gt;
&lt;p&gt;The resources of the Rails core team are limited, and so we are
asking for your help. If you can still reproduce this error on the
3-0-stable branch or on master, please reply with all of the
information you have about it and add &quot;[state:open]&quot; to your
comment. This will reopen the ticket for review. Likewise, if you
feel that this is a very important feature for Rails to include,
please reply with your explanation so we can consider it.&lt;/p&gt;
&lt;p&gt;Thank you for all your contributions, and we hope you will
understand this step to focus our efforts where they are most
helpful.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-02-02T16:54:09+00:00</created-at>
      <creator-id type="integer">47160</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3-rc1 engines load-order restful_authentication role_requirement
:priority: 0
:state: new
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">1999</number>
      <permalink>rails-23-rc1-engine-problem-with-load-order-when-used-with-restful_authentication-and-role_requirement</permalink>
      <priority type="integer">1246</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>23-rc1 engines load-order restful_authentication role_requirement</tag>
      <title>Rails 2.3 RC1 engine problem with load-order when used with restful_authentication and role_requirement</title>
      <updated-at type="datetime">2011-02-02T18:33:47+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">7</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Bj&#246;rn Grossmann</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1999</url>
      <milestone-title>3.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body nil="true"></body>
      <body-html nil="true"></body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-02T16:54:10+00:00</created-at>
      <creator-id type="integer">47160</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">1999</number>
      <permalink>rails-23-rc1-engine-problem-with-load-order-when-used-with-restful_authentication-and-role_requirement</permalink>
      <priority type="integer">1246</priority>
      <project-id type="integer">8994</project-id>
      <state>stale</state>
      <tag>23-rc1 engines load-order restful_authentication role_requirement</tag>
      <title>Rails 2.3 RC1 engine problem with load-order when used with restful_authentication and role_requirement</title>
      <updated-at type="datetime">2011-02-02T18:34:14+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">8</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Bj&#246;rn Grossmann</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/1999</url>
      <milestone-title>3.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>4a7350cc63201b822aa8553a91592fb6f836c9a5</code>
      <content-type>application/octet-stream</content-type>
      <created-at type="datetime">2009-02-17T16:26:58+00:00</created-at>
      <filename>rails-template.rb</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">89669</id>
      <size type="integer">2243</size>
      <uploader-id type="integer">47160</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/89669/rails-template.rb</url>
    </attachment>
  </attachments>
</ticket>
