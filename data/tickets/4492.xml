<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">19965</assigned-user-id>
  <attachments-count type="integer">0</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2010-04-28T00:19:07+01:00</created-at>
  <creator-id type="integer">20836</creator-id>
  <milestone-due-on type="datetime">2010-11-15T00:00:00+00:00</milestone-due-on>
  <milestone-id type="integer">88038</milestone-id>
  <number type="integer">4492</number>
  <permalink>rake-middleware-not-working-in-rails3-beta-3</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>resolved</state>
  <tag>middleware</tag>
  <title>rake middleware not working  in rails3 beta 3</title>
  <updated-at type="datetime">2010-10-15T23:01:52+01:00</updated-at>
  <user-id type="integer">85</user-id>
  <version type="integer">9</version>
  <user-name>Jeremy Kemper</user-name>
  <creator-name>Lawrence Pit</creator-name>
  <assigned-user-name>Jos&#233; Valim</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/4492</url>
  <milestone-title>3.0.2</milestone-title>
  <priority-name>Low</priority-name>
  <original-body>I'm on rails 3 beta 3, and defined to use a middleware in environment.rb:

@@@ ruby
    MyApp::Application.configure do
       config.middleware.use '::ExceptionNotifier'
    end

    # Initialize the rails application
    MyApp::Application.initialize!
@@@

The middleware works fine. However, when I run rake middleware to see where it's sitting at, it is not mentioned in the list of middlewares. I also tried defining it within config.ru, no difference.</original-body>
  <latest-body>I'm on rails 3 beta 3, and defined to use a middleware in environment.rb:

@@@ ruby
    MyApp::Application.configure do
       config.middleware.use '::ExceptionNotifier'
    end

    # Initialize the rails application
    MyApp::Application.initialize!
@@@

The middleware works fine. However, when I run rake middleware to see where it's sitting at, it is not mentioned in the list of middlewares. I also tried defining it within config.ru, no difference.</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;I'm on rails 3 beta 3, and defined to use a middleware in
environment.rb:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;    MyApp::Application.configure do
       config.middleware.use '::ExceptionNotifier'
    end

    # Initialize the rails application
    MyApp::Application.initialize!&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;The middleware works fine. However, when I run rake middleware
to see where it's sitting at, it is not mentioned in the list of
middlewares. I also tried defining it within config.ru, no
difference.&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I'm on rails 3 beta 3, and defined to use a middleware in environment.rb:

@@@ ruby
    MyApp::Application.configure do
       config.middleware.use '::ExceptionNotifier'
    end

    # Initialize the rails application
    MyApp::Application.initialize!
@@@

The middleware works fine. However, when I run rake middleware to see where it's sitting at, it is not mentioned in the list of middlewares. I also tried defining it within config.ru, no difference.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I'm on rails 3 beta 3, and defined to use a middleware in
environment.rb:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;    MyApp::Application.configure do
       config.middleware.use '::ExceptionNotifier'
    end

    # Initialize the rails application
    MyApp::Application.initialize!&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;The middleware works fine. However, when I run rake middleware
to see where it's sitting at, it is not mentioned in the list of
middlewares. I also tried defining it within config.ru, no
difference.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-04-28T00:19:07+01:00</created-at>
      <creator-id type="integer">20836</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4492</number>
      <permalink>rake-middleware-not-working-in-rails3-beta-3</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>middleware</tag>
      <title>rake middleware not working  in rails3 beta 3</title>
      <updated-at type="datetime">2010-04-28T00:19:08+01:00</updated-at>
      <user-id type="integer">20836</user-id>
      <version type="integer">1</version>
      <user-name>Lawrence Pit</user-name>
      <creator-name>Lawrence Pit</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4492</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-04-28T00:38:25+01:00</created-at>
      <creator-id type="integer">20836</creator-id>
      <diffable-attributes type="yaml">--- 
:milestone: 
:assigned_user: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4492</number>
      <permalink>rake-middleware-not-working-in-rails3-beta-3</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>middleware</tag>
      <title>rake middleware not working  in rails3 beta 3</title>
      <updated-at type="datetime">2010-04-28T00:38:28+01:00</updated-at>
      <user-id type="integer">85</user-id>
      <version type="integer">2</version>
      <user-name>Jeremy Kemper</user-name>
      <creator-name>Lawrence Pit</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4492</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>The issue here is that rake tasks do not necessarily initialize your application. I.e. They load config/application but may not load config/environment or any of the initializers unless explicitly asked.

That said, you should add the middleware to your app inside config/application.

However there is always the chance this problem will happen in other circumtances, so the long term fix would make rake middleware always load the environment. The downside is the task becomes slower.

Jeremy, wdyt?</body>
      <body-html>&lt;div&gt;&lt;p&gt;The issue here is that rake tasks do not necessarily initialize
your application. I.e. They load config/application but may not
load config/environment or any of the initializers unless
explicitly asked.&lt;/p&gt;
&lt;p&gt;That said, you should add the middleware to your app inside
config/application.&lt;/p&gt;
&lt;p&gt;However there is always the chance this problem will happen in
other circumtances, so the long term fix would make rake middleware
always load the environment. The downside is the task becomes
slower.&lt;/p&gt;
&lt;p&gt;Jeremy, wdyt?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-04-28T07:06:50+01:00</created-at>
      <creator-id type="integer">20836</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4492</number>
      <permalink>rake-middleware-not-working-in-rails3-beta-3</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>middleware</tag>
      <title>rake middleware not working  in rails3 beta 3</title>
      <updated-at type="datetime">2010-04-28T07:06:54+01:00</updated-at>
      <user-id type="integer">19965</user-id>
      <version type="integer">3</version>
      <user-name>Jos&#233; Valim</user-name>
      <creator-name>Lawrence Pit</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4492</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I've moved it to config/application.rb, and now I see the stack. Thnx.

The reason I'd put it in environment.rb is because that's what's being advertised everywhere I looked (e.g. http://guides.rails.info/rails_on_rack.html and http://asciicasts.com/episodes/151-rack-middleware).

I can imagine wanting middlewares that are only used within e.g. environments/development.rb. I think it would be good if you could see the complete stack then too. A slower task isn't an issue, displaying correct information is, imo.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I've moved it to config/application.rb, and now I see the stack.
Thnx.&lt;/p&gt;
&lt;p&gt;The reason I'd put it in environment.rb is because that's what's
being advertised everywhere I looked (e.g. &lt;a href=
&quot;http://guides.rails.info/rails_on_rack.html&quot;&gt;http://guides.rails.info/rails_on_rack.html&lt;/a&gt;
and &lt;a href=
&quot;http://asciicasts.com/episodes/151-rack-middleware)&quot;&gt;http://asciicasts.com/episodes/151-rack-middleware)&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I can imagine wanting middlewares that are only used within e.g.
environments/development.rb. I think it would be good if you could
see the complete stack then too. A slower task isn't an issue,
displaying correct information is, imo.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-04-28T08:06:26+01:00</created-at>
      <creator-id type="integer">20836</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4492</number>
      <permalink>rake-middleware-not-working-in-rails3-beta-3</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>middleware</tag>
      <title>rake middleware not working  in rails3 beta 3</title>
      <updated-at type="datetime">2010-04-28T08:06:28+01:00</updated-at>
      <user-id type="integer">20836</user-id>
      <version type="integer">4</version>
      <user-name>Lawrence Pit</user-name>
      <creator-name>Lawrence Pit</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4492</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>If you put in environments/development.rb it will still work. It won't  work if you add them in any of config/initializers/* and config/environment.rb. And I totally agree that displaying correct information should be the priority.</body>
      <body-html>&lt;div&gt;&lt;p&gt;If you put in environments/development.rb it will still work. It
won't work if you add them in any of config/initializers/* and
config/environment.rb. And I totally agree that displaying correct
information should be the priority.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-04-28T08:09:37+01:00</created-at>
      <creator-id type="integer">20836</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4492</number>
      <permalink>rake-middleware-not-working-in-rails3-beta-3</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>middleware</tag>
      <title>rake middleware not working  in rails3 beta 3</title>
      <updated-at type="datetime">2010-04-28T08:09:38+01:00</updated-at>
      <user-id type="integer">19965</user-id>
      <version type="integer">5</version>
      <user-name>Jos&#233; Valim</user-name>
      <creator-name>Lawrence Pit</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4492</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>+1 to loading the env</body>
      <body-html>&lt;div&gt;&lt;p&gt;+1 to loading the env&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-04-28T16:41:01+01:00</created-at>
      <creator-id type="integer">20836</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4492</number>
      <permalink>rake-middleware-not-working-in-rails3-beta-3</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>middleware</tag>
      <title>rake middleware not working  in rails3 beta 3</title>
      <updated-at type="datetime">2010-04-28T16:41:03+01:00</updated-at>
      <user-id type="integer">85</user-id>
      <version type="integer">6</version>
      <user-name>Jeremy Kemper</user-name>
      <creator-name>Lawrence Pit</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4492</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Actually, rails was loading the environment, but rake tasks were doing it by itself (calling Rails::Application.initialize!) instead of loading the file at config/environment.rb. This was probably also the cause some rake tasks were loading the environment twice. A patch is coming soon.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Actually, rails was loading the environment, but rake tasks were
doing it by itself (calling Rails::Application.initialize!) instead
of loading the file at config/environment.rb. This was probably
also the cause some rake tasks were loading the environment twice.
A patch is coming soon.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-04-29T07:36:05+01:00</created-at>
      <creator-id type="integer">20836</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4492</number>
      <permalink>rake-middleware-not-working-in-rails3-beta-3</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>middleware</tag>
      <title>rake middleware not working  in rails3 beta 3</title>
      <updated-at type="datetime">2010-04-29T07:36:08+01:00</updated-at>
      <user-id type="integer">19965</user-id>
      <version type="integer">7</version>
      <user-name>Jos&#233; Valim</user-name>
      <creator-name>Lawrence Pit</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4492</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>(from [1b816d502444ce2b3153d8c689d0057f1c257eee]) The rake task :environment now loads config/environment.rb instead of initializing the application on its own. This fixes [#4492 state:resolved] and also avoids the application being initialized twice in some rake tasks.
http://github.com/rails/rails/commit/1b816d502444ce2b3153d8c689d0057f1c257eee</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from &lt;a href=
&quot;/projects/8994/changesets/1b816d502444ce2b3153d8c689d0057f1c257eee&quot;
title=
&quot;Changeset [1b816d502444ce2b3153d8c689d0057f1c257eee]&quot;&gt;[1b816d502444ce2b3153d8c689d0057f1c257eee]&lt;/a&gt;)
The rake task :environment now loads config/environment.rb instead
of initializing the application on its own. This fixes [&lt;a href=
&quot;/projects/8994/tickets/4492&quot; title=&quot;Ticket #4492&quot;&gt;#4492&lt;/a&gt;
state:resolved] and also avoids the application being initialized
twice in some rake tasks. &lt;a href=
&quot;http://github.com/rails/rails/commit/1b816d502444ce2b3153d8c689d0057f1c257eee&quot;&gt;
http://github.com/rails/rails/commit/1b816d502444ce2b3153d8c689d005...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-04-29T07:50:12+01:00</created-at>
      <creator-id type="integer">20836</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">4492</number>
      <permalink>rake-middleware-not-working-in-rails3-beta-3</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>middleware</tag>
      <title>rake middleware not working  in rails3 beta 3</title>
      <updated-at type="datetime">2010-04-29T07:50:13+01:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">8</version>
      <user-name>Repository</user-name>
      <creator-name>Lawrence Pit</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4492</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>[[bulk edit](/projects/8994/bulk_edits/31647)]</body>
      <body-html>&lt;div&gt;&lt;p&gt;[&lt;a href=&quot;/projects/8994/bulk_edits/31647&quot;&gt;bulk edit&lt;/a&gt;]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-10-15T23:01:52+01:00</created-at>
      <creator-id type="integer">20836</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
:milestone: 27004
</diffable-attributes>
      <milestone-id type="integer">88038</milestone-id>
      <number type="integer">4492</number>
      <permalink>rake-middleware-not-working-in-rails3-beta-3</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>middleware</tag>
      <title>rake middleware not working  in rails3 beta 3</title>
      <updated-at type="datetime">2010-10-15T23:01:52+01:00</updated-at>
      <user-id type="integer">85</user-id>
      <version type="integer">9</version>
      <user-name>Jeremy Kemper</user-name>
      <creator-name>Lawrence Pit</creator-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/4492</url>
      <milestone-title>3.0.2</milestone-title>
      <priority-name>Low</priority-name>
    </version>
  </versions>
</ticket>
