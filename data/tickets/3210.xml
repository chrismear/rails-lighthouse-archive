<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer" nil="true"></assigned-user-id>
  <attachments-count type="integer">0</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2009-09-15T12:21:28+01:00</created-at>
  <creator-id type="integer">69773</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">3210</number>
  <permalink>rails-postgres-issue</permalink>
  <priority type="integer">30</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>invalid</state>
  <tag>2.3.4 bugmash postgres</tag>
  <title>Rails Postgres Issue </title>
  <updated-at type="datetime">2010-09-08T19:12:19+01:00</updated-at>
  <user-id type="integer">112002</user-id>
  <version type="integer">9</version>
  <user-name>Mo Morsi</user-name>
  <creator-name>Biju Devassy</creator-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/3210</url>
  <priority-name nil="true"></priority-name>
  <original-body>undefined method `quote_ident' for PGconn:Class 

The above error occurs when calling rake db:migrate.

This can be solved by adding following lines to new_rails_defaults.rb

def PGconn.quote_ident(name)
  %(&quot;#{name}&quot;)
end 

Will this issue already solved in coming rails.</original-body>
  <latest-body>undefined method `quote_ident' for PGconn:Class 

The above error occurs when calling rake db:migrate.

This can be solved by adding following lines to new_rails_defaults.rb

def PGconn.quote_ident(name)
  %(&quot;#{name}&quot;)
end 

Will this issue already solved in coming rails.</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;undefined method &lt;code&gt;quote_ident' for PGconn:Class&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;The above error occurs when calling rake db:migrate.&lt;/p&gt;
&lt;p&gt;This can be solved by adding following lines to
new_rails_defaults.rb&lt;/p&gt;
&lt;p&gt;def PGconn.quote_ident(name)&lt;br&gt;
%(&quot;#{name}&quot;) end&lt;/p&gt;
&lt;p&gt;Will this issue already solved in coming rails.&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer">3890</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>undefined method `quote_ident' for PGconn:Class 

The above error occurs when calling rake db:migrate.

This can be solved by adding following lines to new_rails_defaults.rb

def PGconn.quote_ident(name)
  %(&quot;#{name}&quot;)
end 

Will this issue already solved in coming rails.</body>
      <body-html>&lt;div&gt;&lt;p&gt;undefined method &lt;code&gt;quote_ident' for PGconn:Class&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;The above error occurs when calling rake db:migrate.&lt;/p&gt;
&lt;p&gt;This can be solved by adding following lines to
new_rails_defaults.rb&lt;/p&gt;
&lt;p&gt;def PGconn.quote_ident(name)&lt;br&gt;
%(&quot;#{name}&quot;) end&lt;/p&gt;
&lt;p&gt;Will this issue already solved in coming rails.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-09-15T12:21:28+01:00</created-at>
      <creator-id type="integer">69773</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3210</number>
      <permalink>rails-postgres-issue</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.4 postgres</tag>
      <title>Rails Postgres Issue </title>
      <updated-at type="datetime">2009-09-15T12:21:34+01:00</updated-at>
      <user-id type="integer">69773</user-id>
      <version type="integer">1</version>
      <user-name>Biju Devassy</user-name>
      <creator-name>Biju Devassy</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3210</url>
      <priority-name nil="true"></priority-name>
      <assigned-user-name>Matt Aimonetti (mattetti)</assigned-user-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body nil="true"></body>
      <body-html nil="true"></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-09-25T12:08:38+01:00</created-at>
      <creator-id type="integer">69773</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3.4 postgres
:assigned_user: 3890
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3210</number>
      <permalink>rails-postgres-issue</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.4 bugmash postgres</tag>
      <title>Rails Postgres Issue </title>
      <updated-at type="datetime">2009-09-25T12:48:16+01:00</updated-at>
      <user-id type="integer">7211</user-id>
      <version type="integer">2</version>
      <user-name>CancelProfileIsBroken</user-name>
      <creator-name>Biju Devassy</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3210</url>
      <priority-name nil="true"></priority-name>
      <assigned-user-name nil="true"></assigned-user-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">19965</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-10-05T10:38:47+01:00</created-at>
      <creator-id type="integer">69773</creator-id>
      <diffable-attributes type="yaml">--- 
:assigned_user: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3210</number>
      <permalink>rails-postgres-issue</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.4 bugmash postgres</tag>
      <title>Rails Postgres Issue </title>
      <updated-at type="datetime">2009-10-05T11:22:13+01:00</updated-at>
      <user-id type="integer">69773</user-id>
      <version type="integer">3</version>
      <user-name>Biju Devassy</user-name>
      <creator-name>Biju Devassy</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3210</url>
      <priority-name nil="true"></priority-name>
      <assigned-user-name>Jos&#233; Valim</assigned-user-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-10-05T15:57:42+01:00</created-at>
      <creator-id type="integer">69773</creator-id>
      <diffable-attributes type="yaml">--- 
:assigned_user: 19965
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3210</number>
      <permalink>rails-postgres-issue</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.4 bugmash postgres</tag>
      <title>Rails Postgres Issue </title>
      <updated-at type="datetime">2009-10-05T16:46:23+01:00</updated-at>
      <user-id type="integer">19965</user-id>
      <version type="integer">4</version>
      <user-name>Jos&#233; Valim</user-name>
      <creator-name>Biju Devassy</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3210</url>
      <priority-name nil="true"></priority-name>
      <assigned-user-name nil="true"></assigned-user-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-29T09:45:21+00:00</created-at>
      <creator-id type="integer">69773</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3210</number>
      <permalink>rails-postgres-issue</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.4 bugmash postgres</tag>
      <title>Rails Postgres Issue </title>
      <updated-at type="datetime">2010-01-29T09:45:24+00:00</updated-at>
      <user-id type="integer">69773</user-id>
      <version type="integer">5</version>
      <user-name>Biju Devassy</user-name>
      <creator-name>Biju Devassy</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3210</url>
      <priority-name nil="true"></priority-name>
      <assigned-user-name nil="true"></assigned-user-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>This problem was fixed: http://github.com/mneumann/postgres-pr/issues/closed/#issue/1

Update your postgres-pr gem to version 0.6.3 and all will work fine.</body>
      <body-html>&lt;div&gt;&lt;p&gt;This problem was fixed: &lt;a href=
&quot;http://github.com/mneumann/postgres-pr/issues/closed/#issue/1&quot;&gt;http://github.com/mneumann/postgres-pr/issues/closed/#issue/1&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Update your postgres-pr gem to version 0.6.3 and all will work
fine.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-29T11:58:37+00:00</created-at>
      <creator-id type="integer">69773</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3210</number>
      <permalink>rails-postgres-issue</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.4 bugmash postgres</tag>
      <title>Rails Postgres Issue </title>
      <updated-at type="datetime">2010-01-29T11:58:38+00:00</updated-at>
      <user-id type="integer">55755</user-id>
      <version type="integer">6</version>
      <user-name>Lucas de Castro</user-name>
      <creator-name>Biju Devassy</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3210</url>
      <priority-name nil="true"></priority-name>
      <assigned-user-name nil="true"></assigned-user-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-01-29T23:50:54+00:00</created-at>
      <creator-id type="integer">69773</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3210</number>
      <permalink>rails-postgres-issue</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>invalid</state>
      <tag>2.3.4 bugmash postgres</tag>
      <title>Rails Postgres Issue </title>
      <updated-at type="datetime">2010-01-29T23:50:56+00:00</updated-at>
      <user-id type="integer">85</user-id>
      <version type="integer">7</version>
      <user-name>Jeremy Kemper</user-name>
      <creator-name>Biju Devassy</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3210</url>
      <priority-name nil="true"></priority-name>
      <assigned-user-name nil="true"></assigned-user-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Is this issue really invalid? We are still running into this problem w/ Rails 2.3.8.

Here's the thing, the activerecord postgres adapter claims to work w/ both the native C postgres adapter as well as the pure ruby one (postgres-pr)

http://github.com/rails/rails/blob/master/activerecord/lib/active_record/connection_adapters/postgresql_adapter.rb#L176
http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/PostgreSQLAdapter.html

So even if one isn't using postgres-pr (which we are not) this should work. 

Postgres-pr defines the necessary PGconn methods which the activerecord postgres adapter uses. The thing is, activerecord still checks to see if these methods are present on the PGconn class (via PGconn.respond_to?(:method_name)) before invoking them. That way if those methods don't exist (which I'm guessing they don't in the native postgres interface), no error is raised.

The problem is, this check never gets performed before the PGconn.quote_ident call.

The following patch adds this check around quote_ident, bringing it inline with the other PGconn method invocations, and resolving this issue:

@@@
--- activerecord-2.3.8/lib/active_record/connection_adapters/postgresql_adapter.rb.orig  2010-08-16 21:14:25.710395992 -0400
+++ activerecord-2.3.8/lib/active_record/connection_adapters/postgresql_adapter.rb 2010-08-16 21:15:33.091702801 -0400
@@ -407,7 +407,11 @@ module ActiveRecord
 
       # Quotes column names for use in SQL queries.
       def quote_column_name(name) #:nodoc:
-        PGconn.quote_ident(name.to_s)
+        if PGconn.respond_to?(:quote_ident)
+          PGconn.quote_ident(name.to_s)
+        else
+          %(&quot;#{name}&quot;)
+        end
       end 
 
       # Quote date/time values for use in SQL input. Includes microseconds
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;Is this issue really invalid? We are still running into this
problem w/ Rails 2.3.8.&lt;/p&gt;
&lt;p&gt;Here's the thing, the activerecord postgres adapter claims to
work w/ both the native C postgres adapter as well as the pure ruby
one (postgres-pr)&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;http://github.com/rails/rails/blob/master/activerecord/lib/active_record/connection_adapters/postgresql_adapter.rb#L176&quot;&gt;
http://github.com/rails/rails/blob/master/activerecord/lib/active_r...&lt;/a&gt;&lt;br&gt;
&lt;a href=
&quot;http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/PostgreSQLAdapter.html&quot;&gt;
http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/...&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;So even if one isn't using postgres-pr (which we are not) this
should work.&lt;/p&gt;
&lt;p&gt;Postgres-pr defines the necessary PGconn methods which the
activerecord postgres adapter uses. The thing is, activerecord
still checks to see if these methods are present on the PGconn
class (via PGconn.respond_to?(:method_name)) before invoking them.
That way if those methods don't exist (which I'm guessing they
don't in the native postgres interface), no error is raised.&lt;/p&gt;
&lt;p&gt;The problem is, this check never gets performed before the
PGconn.quote_ident call.&lt;/p&gt;
&lt;p&gt;The following patch adds this check around quote_ident, bringing
it inline with the other PGconn method invocations, and resolving
this issue:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;--- activerecord-2.3.8/lib/active_record/connection_adapters/postgresql_adapter.rb.orig  2010-08-16 21:14:25.710395992 -0400
+++ activerecord-2.3.8/lib/active_record/connection_adapters/postgresql_adapter.rb 2010-08-16 21:15:33.091702801 -0400
@@ -407,7 +407,11 @@ module ActiveRecord
 
       # Quotes column names for use in SQL queries.
       def quote_column_name(name) #:nodoc:
-        PGconn.quote_ident(name.to_s)
+        if PGconn.respond_to?(:quote_ident)
+          PGconn.quote_ident(name.to_s)
+        else
+          %(&quot;#{name}&quot;)
+        end
       end 
 
       # Quote date/time values for use in SQL input. Includes microseconds&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-08-17T20:26:39+01:00</created-at>
      <creator-id type="integer">69773</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3210</number>
      <permalink>rails-postgres-issue</permalink>
      <priority type="integer">30</priority>
      <project-id type="integer">8994</project-id>
      <state>invalid</state>
      <tag>2.3.4 bugmash postgres</tag>
      <title>Rails Postgres Issue </title>
      <updated-at type="datetime">2010-08-17T20:26:42+01:00</updated-at>
      <user-id type="integer">112002</user-id>
      <version type="integer">8</version>
      <user-name>Mo Morsi</user-name>
      <creator-name>Biju Devassy</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3210</url>
      <priority-name nil="true"></priority-name>
      <assigned-user-name nil="true"></assigned-user-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>So apparently fixing this with the patch I described opens a security vulnerability as quote_ident escapes strings passed in to prevent sql injection attacks and such. 

Here is an updated patch which simply just fails with a better error if quote_ident is not defined (the same thing you are doing with unescape_bytea). 

We are shipping this patch with rubygem-activerecord-2.3.8 in the upcoming Fedora 14.

http://pkgs.fedoraproject.org/gitweb/?p=rubygem-activerecord.git;a=blob;f=activerecord-2.3.8-postgres-fix.patch


@@@
--- activerecord-2.3.8/lib/active_record/connection_adapters/postgresql_adapter.rb.orig	2010-09-08 13:41:46.000000000 -0400
+++ activerecord-2.3.8/lib/active_record/connection_adapters/postgresql_adapter.rb	2010-09-08 13:42:39.000000000 -0400
@@ -407,6 +407,9 @@ module ActiveRecord
 
       # Quotes column names for use in SQL queries.
       def quote_column_name(name) #:nodoc:
+        unless PGconn.respond_to?(:quote_ident)
+           raise 'Your PostgreSQL connection does not support quote_ident. Try upgrading pg.'
+        end
         PGconn.quote_ident(name.to_s)
       end
@@@


Note this issue has been fixed in the upstream ruby-postgres project as well, whose updated version we will be shipping in Fedora 14 as well. This patch is for consistancy's sake, and in case any other postgres adapter doesn't implement this method.</body>
      <body-html>&lt;div&gt;&lt;p&gt;So apparently fixing this with the patch I described opens a
security vulnerability as quote_ident escapes strings passed in to
prevent sql injection attacks and such.&lt;/p&gt;
&lt;p&gt;Here is an updated patch which simply just fails with a better
error if quote_ident is not defined (the same thing you are doing
with unescape_bytea).&lt;/p&gt;
&lt;p&gt;We are shipping this patch with rubygem-activerecord-2.3.8 in
the upcoming Fedora 14.&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;http://pkgs.fedoraproject.org/gitweb/?p=rubygem-activerecord.git;a=blob;f=activerecord-2.3.8-postgres-fix.patch&quot;&gt;
http://pkgs.fedoraproject.org/gitweb/?p=rubygem-activerecord.git;a=...&lt;/a&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;--- activerecord-2.3.8/lib/active_record/connection_adapters/postgresql_adapter.rb.orig  2010-09-08 13:41:46.000000000 -0400
+++ activerecord-2.3.8/lib/active_record/connection_adapters/postgresql_adapter.rb  2010-09-08 13:42:39.000000000 -0400
@@ -407,6 +407,9 @@ module ActiveRecord
 
       # Quotes column names for use in SQL queries.
       def quote_column_name(name) #:nodoc:
+        unless PGconn.respond_to?(:quote_ident)
+           raise 'Your PostgreSQL connection does not support quote_ident. Try upgrading pg.'
+        end
         PGconn.quote_ident(name.to_s)
       end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Note this issue has been fixed in the upstream ruby-postgres
project as well, whose updated version we will be shipping in
Fedora 14 as well. This patch is for consistancy's sake, and in
case any other postgres adapter doesn't implement this method.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-09-08T19:12:17+01:00</created-at>
      <creator-id type="integer">69773</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3210</number>
      <permalink>rails-postgres-issue</permalink>
      <priority type="integer">30</priority>
      <project-id type="integer">8994</project-id>
      <state>invalid</state>
      <tag>2.3.4 bugmash postgres</tag>
      <title>Rails Postgres Issue </title>
      <updated-at type="datetime">2010-09-08T19:12:19+01:00</updated-at>
      <user-id type="integer">112002</user-id>
      <version type="integer">9</version>
      <user-name>Mo Morsi</user-name>
      <creator-name>Biju Devassy</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3210</url>
      <priority-name nil="true"></priority-name>
      <assigned-user-name nil="true"></assigned-user-name>
    </version>
  </versions>
</ticket>
