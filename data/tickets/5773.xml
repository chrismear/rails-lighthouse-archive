<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer" nil="true"></assigned-user-id>
  <attachments-count type="integer">1</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2010-10-08T21:33:18+01:00</created-at>
  <creator-id type="integer">27932</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">5773</number>
  <permalink>actioncontroller-crashes-when-trying-to-render-head-406-with-caches_action</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>duplicate</state>
  <tag>actioncontroller caches_action caching &quot;rails 300&quot;</tag>
  <title>ActionController crashes when trying to render head 406 with caches_action</title>
  <updated-at type="datetime">2011-03-01T15:09:23+00:00</updated-at>
  <user-id type="integer">135943</user-id>
  <version type="integer">10</version>
  <user-name>Wayne See</user-name>
  <creator-name>Simone Carletti</creator-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/5773</url>
  <priority-name>Low</priority-name>
  <original-body>To reproduce the bug:

1. create an action and return `head 406`
2. add `caches_action` for that specific action
3. enable action caching

Example

@@@ ruby
class MainController &lt; ActionController::Base
  caches_action :index
  def index
    head 406
  end
end
@@@

Here's the backtrace

@@@

[ pid=1515 thr=2148381100 file=utils.rb:176 time=2010-10-08 22:15:38.714 ]: *** Exception NoMethodError in application (You have a nil object when you didn't expect it!
You might have expected an instance of Array.
The error occurred while evaluating nil.each) (process 1515, thread #&lt;Thread:0x1001b6358&gt;):
	from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/actionpack-3.0.0/lib/action_dispatch/http/response.rb:155:in `each'
	from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/actionpack-3.0.0/lib/action_dispatch/http/response.rb:102:in `body'
	from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/rack-1.2.1/lib/rack/response.rb:102:in `close'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/request_handler.rb:136:in `process_request'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_request_handler.rb:513:in `accept_and_process_next_request'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_request_handler.rb:274:in `main_loop'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:205:in `start_request_handler'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:170:in `send'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:170:in `handle_spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/utils.rb:479:in `safe_fork'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:165:in `handle_spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `__send__'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `server_main_loop'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:206:in `start_synchronously'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:180:in `start'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:128:in `start'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:253:in `spawn_rack_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:132:in `lookup_or_add'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:246:in `spawn_rack_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:82:in `synchronize'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:79:in `synchronize'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:244:in `spawn_rack_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:137:in `spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:275:in `handle_spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `__send__'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `server_main_loop'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:206:in `start_synchronously'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/helper-scripts/passenger-spawn-server:99
@@@</original-body>
  <latest-body>To reproduce the bug:

1. create an action and return `head 406`
2. add `caches_action` for that specific action
3. enable action caching

Example

@@@ ruby
class MainController &lt; ActionController::Base
  caches_action :index
  def index
    head 406
  end
end
@@@

Here's the backtrace

@@@

[ pid=1515 thr=2148381100 file=utils.rb:176 time=2010-10-08 22:15:38.714 ]: *** Exception NoMethodError in application (You have a nil object when you didn't expect it!
You might have expected an instance of Array.
The error occurred while evaluating nil.each) (process 1515, thread #&lt;Thread:0x1001b6358&gt;):
	from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/actionpack-3.0.0/lib/action_dispatch/http/response.rb:155:in `each'
	from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/actionpack-3.0.0/lib/action_dispatch/http/response.rb:102:in `body'
	from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/rack-1.2.1/lib/rack/response.rb:102:in `close'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/request_handler.rb:136:in `process_request'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_request_handler.rb:513:in `accept_and_process_next_request'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_request_handler.rb:274:in `main_loop'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:205:in `start_request_handler'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:170:in `send'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:170:in `handle_spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/utils.rb:479:in `safe_fork'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:165:in `handle_spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `__send__'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `server_main_loop'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:206:in `start_synchronously'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:180:in `start'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:128:in `start'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:253:in `spawn_rack_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:132:in `lookup_or_add'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:246:in `spawn_rack_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:82:in `synchronize'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:79:in `synchronize'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:244:in `spawn_rack_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:137:in `spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:275:in `handle_spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `__send__'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `server_main_loop'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:206:in `start_synchronously'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/helper-scripts/passenger-spawn-server:99
@@@</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;To reproduce the bug:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;create an action and return &lt;code&gt;head 406&lt;/code&gt;&lt;br&gt;&lt;/li&gt;
&lt;li&gt;add &lt;code&gt;caches_action&lt;/code&gt; for that specific
action&lt;br&gt;&lt;/li&gt;
&lt;li&gt;enable action caching&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Example&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;class MainController &amp;lt; ActionController::Base
  caches_action :index
  def index
    head 406
  end
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Here's the backtrace&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;
[ pid=1515 thr=2148381100 file=utils.rb:176 time=2010-10-08 22:15:38.714 ]: *** Exception NoMethodError in application (You have a nil object when you didn't expect it!
You might have expected an instance of Array.
The error occurred while evaluating nil.each) (process 1515, thread #&amp;lt;Thread:0x1001b6358&amp;gt;):
    from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/actionpack-3.0.0/lib/action_dispatch/http/response.rb:155:in `each'
    from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/actionpack-3.0.0/lib/action_dispatch/http/response.rb:102:in `body'
    from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/rack-1.2.1/lib/rack/response.rb:102:in `close'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/request_handler.rb:136:in `process_request'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_request_handler.rb:513:in `accept_and_process_next_request'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_request_handler.rb:274:in `main_loop'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:205:in `start_request_handler'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:170:in `send'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:170:in `handle_spawn_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/utils.rb:479:in `safe_fork'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:165:in `handle_spawn_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `__send__'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `server_main_loop'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:206:in `start_synchronously'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:180:in `start'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:128:in `start'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:253:in `spawn_rack_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:132:in `lookup_or_add'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:246:in `spawn_rack_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:82:in `synchronize'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:79:in `synchronize'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:244:in `spawn_rack_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:137:in `spawn_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:275:in `handle_spawn_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `__send__'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `server_main_loop'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:206:in `start_synchronously'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/helper-scripts/passenger-spawn-server:99&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>To reproduce the bug:

1. create an action and return `head 406`
2. add `caches_action` for that specific action
3. enable action caching

Example

@@@ ruby
class MainController &lt; ActionController::Base
  caches_action :index
  def index
    head 406
  end
end
@@@

Here's the backtrace

@@@

[ pid=1515 thr=2148381100 file=utils.rb:176 time=2010-10-08 22:15:38.714 ]: *** Exception NoMethodError in application (You have a nil object when you didn't expect it!
You might have expected an instance of Array.
The error occurred while evaluating nil.each) (process 1515, thread #&lt;Thread:0x1001b6358&gt;):
	from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/actionpack-3.0.0/lib/action_dispatch/http/response.rb:155:in `each'
	from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/actionpack-3.0.0/lib/action_dispatch/http/response.rb:102:in `body'
	from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/rack-1.2.1/lib/rack/response.rb:102:in `close'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/request_handler.rb:136:in `process_request'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_request_handler.rb:513:in `accept_and_process_next_request'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_request_handler.rb:274:in `main_loop'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:205:in `start_request_handler'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:170:in `send'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:170:in `handle_spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/utils.rb:479:in `safe_fork'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:165:in `handle_spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `__send__'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `server_main_loop'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:206:in `start_synchronously'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:180:in `start'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:128:in `start'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:253:in `spawn_rack_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:132:in `lookup_or_add'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:246:in `spawn_rack_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:82:in `synchronize'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:79:in `synchronize'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:244:in `spawn_rack_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:137:in `spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:275:in `handle_spawn_application'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `__send__'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `server_main_loop'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:206:in `start_synchronously'
	from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/helper-scripts/passenger-spawn-server:99
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;To reproduce the bug:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;create an action and return &lt;code&gt;head 406&lt;/code&gt;&lt;br&gt;&lt;/li&gt;
&lt;li&gt;add &lt;code&gt;caches_action&lt;/code&gt; for that specific
action&lt;br&gt;&lt;/li&gt;
&lt;li&gt;enable action caching&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Example&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;class MainController &amp;lt; ActionController::Base
  caches_action :index
  def index
    head 406
  end
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Here's the backtrace&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;
[ pid=1515 thr=2148381100 file=utils.rb:176 time=2010-10-08 22:15:38.714 ]: *** Exception NoMethodError in application (You have a nil object when you didn't expect it!
You might have expected an instance of Array.
The error occurred while evaluating nil.each) (process 1515, thread #&amp;lt;Thread:0x1001b6358&amp;gt;):
    from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/actionpack-3.0.0/lib/action_dispatch/http/response.rb:155:in `each'
    from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/actionpack-3.0.0/lib/action_dispatch/http/response.rb:102:in `body'
    from /Users/weppos/.rvm/gems/ruby-1.8.7-p249/gems/rack-1.2.1/lib/rack/response.rb:102:in `close'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/request_handler.rb:136:in `process_request'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_request_handler.rb:513:in `accept_and_process_next_request'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_request_handler.rb:274:in `main_loop'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:205:in `start_request_handler'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:170:in `send'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:170:in `handle_spawn_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/utils.rb:479:in `safe_fork'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:165:in `handle_spawn_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `__send__'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `server_main_loop'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:206:in `start_synchronously'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:180:in `start'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/rack/application_spawner.rb:128:in `start'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:253:in `spawn_rack_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:132:in `lookup_or_add'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:246:in `spawn_rack_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:82:in `synchronize'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server_collection.rb:79:in `synchronize'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:244:in `spawn_rack_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:137:in `spawn_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/spawn_manager.rb:275:in `handle_spawn_application'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `__send__'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:357:in `server_main_loop'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/lib/phusion_passenger/abstract_server.rb:206:in `start_synchronously'
    from /Users/weppos/.passenger/standalone/3.0.0.pre4-x86_64-ruby1.8.7-macosx-10.6/support/helper-scripts/passenger-spawn-server:99&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-08T21:33:18+01:00</created-at>
      <creator-id type="integer">27932</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5773</number>
      <permalink>actioncontroller-crashes-when-trying-to-render-head-406-with-caches_action</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>actioncontroller caches_action caching &quot;rails 3.0.0&quot;</tag>
      <title>ActionController crashes when trying to render head 406 with caches_action</title>
      <updated-at type="datetime">2010-10-08T21:33:21+01:00</updated-at>
      <user-id type="integer">27932</user-id>
      <version type="integer">1</version>
      <user-name>Simone Carletti</user-name>
      <creator-name>Simone Carletti</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5773</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I investigate the issue and here's what I discovered.

When the cache doesn't exist, &quot;read_fragment&quot;:http://github.com/rails/rails/blob/master/actionpack/lib/action_controller/caching/actions.rb#L127 returns `nil` and `body` is set to nil.

When the content of the `unless` condition is executed, &quot;_safe_fragment&quot;:http://github.com/rails/rails/blob/master/actionpack/lib/action_controller/caching/actions.rb#L133 returns `nil` because the `caching_allowed?` check &quot;evaluates to false&quot;:http://github.com/rails/rails/blob/master/actionpack/lib/action_controller/caching/actions.rb#L92 (remember, the status code is 406).

&quot;render_to_string&quot;:http://github.com/rails/rails/blob/master/actionpack/lib/action_controller/caching/actions.rb#L136 is skipped because `head` doesn't want any layout and a `nil` body is passed to rack, which expects body to be a String.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I investigate the issue and here's what I discovered.&lt;/p&gt;
&lt;p&gt;When the cache doesn't exist, &lt;a href=
&quot;http://github.com/rails/rails/blob/master/actionpack/lib/action_controller/caching/actions.rb#L127&quot;&gt;
read_fragment&lt;/a&gt; returns &lt;code&gt;nil&lt;/code&gt; and &lt;code&gt;body&lt;/code&gt; is
set to nil.&lt;/p&gt;
&lt;p&gt;When the content of the &lt;code&gt;unless&lt;/code&gt; condition is
executed, &lt;a href=
&quot;http://github.com/rails/rails/blob/master/actionpack/lib/action_controller/caching/actions.rb#L133&quot;&gt;
_safe_fragment&lt;/a&gt; returns &lt;code&gt;nil&lt;/code&gt; because the
&lt;code&gt;caching_allowed?&lt;/code&gt; check &lt;a href=
&quot;http://github.com/rails/rails/blob/master/actionpack/lib/action_controller/caching/actions.rb#L92&quot;&gt;
evaluates to false&lt;/a&gt; (remember, the status code is 406).&lt;/p&gt;
&lt;p&gt;&lt;a href=
&quot;http://github.com/rails/rails/blob/master/actionpack/lib/action_controller/caching/actions.rb#L136&quot;&gt;
render_to_string&lt;/a&gt; is skipped because &lt;code&gt;head&lt;/code&gt; doesn't
want any layout and a &lt;code&gt;nil&lt;/code&gt; body is passed to rack,
which expects body to be a String.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-08T21:39:57+01:00</created-at>
      <creator-id type="integer">27932</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5773</number>
      <permalink>actioncontroller-crashes-when-trying-to-render-head-406-with-caches_action</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>actioncontroller caches_action caching &quot;rails 3.0.0&quot;</tag>
      <title>ActionController crashes when trying to render head 406 with caches_action</title>
      <updated-at type="datetime">2010-10-08T21:39:59+01:00</updated-at>
      <user-id type="integer">27932</user-id>
      <version type="integer">2</version>
      <user-name>Simone Carletti</user-name>
      <creator-name>Simone Carletti</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5773</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Can you provide a test case to Rails suite? Or even a patch with tests fixing the issue?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Can you provide a test case to Rails suite? Or even a patch with
tests fixing the issue?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-08T23:21:15+01:00</created-at>
      <creator-id type="integer">27932</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5773</number>
      <permalink>actioncontroller-crashes-when-trying-to-render-head-406-with-caches_action</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>actioncontroller caches_action caching &quot;rails 3.0.0&quot;</tag>
      <title>ActionController crashes when trying to render head 406 with caches_action</title>
      <updated-at type="datetime">2010-10-08T23:21:18+01:00</updated-at>
      <user-id type="integer">19965</user-id>
      <version type="integer">3</version>
      <user-name>Jos&#233; Valim</user-name>
      <creator-name>Simone Carletti</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5773</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I tried to reproduce the error without success. I can't understand why but the test doesn't fail.
I need to verify where edge Rails fixes the issue.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I tried to reproduce the error without success. I can't
understand why but the test doesn't fail.&lt;br&gt;
I need to verify where edge Rails fixes the issue.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-09T11:56:05+01:00</created-at>
      <creator-id type="integer">27932</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5773</number>
      <permalink>actioncontroller-crashes-when-trying-to-render-head-406-with-caches_action</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>actioncontroller caches_action caching &quot;rails 3.0.0&quot;</tag>
      <title>ActionController crashes when trying to render head 406 with caches_action</title>
      <updated-at type="datetime">2010-10-09T11:56:09+01:00</updated-at>
      <user-id type="integer">27932</user-id>
      <version type="integer">4</version>
      <user-name>Simone Carletti</user-name>
      <creator-name>Simone Carletti</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5773</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Confirmed on edge Rails:

@@@
$ script/rails g controller foos index
...
@@@

Controller:

@@@ ruby
class FoosController &lt; ApplicationController
  caches_action :index

  def index
    head 406
  end
end
@@@

Routes:

@@@ ruby
Ticket5773::Application.routes.draw do
  resources :foos
end
@@@

Request to `http://localhost:3000/foos` results in Internal Server Error and log displays the following:

@@@
Started GET &quot;/foos&quot; for 127.0.0.1 at 2010-10-09 13:02:28 +0200
  Processing by FoosController#index as HTML
Read fragment views/localhost:3000/foos (0.1ms)
Completed 406 Not Acceptable in 3ms
[2010-10-09 13:02:28] ERROR NoMethodError: You have a nil object when you didn't expect it!
You might have expected an instance of Array.
The error occurred while evaluating nil.each
	/Users/dtrasbo/.rvm/gems/ruby-1.9.2-p0@edge_rails_app/bundler/gems/rails-b439c1451642/actionpack/lib/action_dispatch/http/response.rb:153:in `each'
	...
cache: [GET /favicon.ico] miss, store
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;Confirmed on edge Rails:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;$ script/rails g controller foos index
...&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Controller:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;class FoosController &amp;lt; ApplicationController
  caches_action :index

  def index
    head 406
  end
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Routes:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;Ticket5773::Application.routes.draw do
  resources :foos
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Request to &lt;code&gt;http://localhost:3000/foos&lt;/code&gt; results in
Internal Server Error and log displays the following:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;Started GET &quot;/foos&quot; for 127.0.0.1 at 2010-10-09 13:02:28 +0200
  Processing by FoosController#index as HTML
Read fragment views/localhost:3000/foos (0.1ms)
Completed 406 Not Acceptable in 3ms
[2010-10-09 13:02:28] ERROR NoMethodError: You have a nil object when you didn't expect it!
You might have expected an instance of Array.
The error occurred while evaluating nil.each
    /Users/dtrasbo/.rvm/gems/ruby-1.9.2-p0@edge_rails_app/bundler/gems/rails-b439c1451642/actionpack/lib/action_dispatch/http/response.rb:153:in `each'
    ...
cache: [GET /favicon.ico] miss, store&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-09T12:06:11+01:00</created-at>
      <creator-id type="integer">27932</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5773</number>
      <permalink>actioncontroller-crashes-when-trying-to-render-head-406-with-caches_action</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>actioncontroller caches_action caching &quot;rails 3.0.0&quot;</tag>
      <title>ActionController crashes when trying to render head 406 with caches_action</title>
      <updated-at type="datetime">2010-10-09T12:06:13+01:00</updated-at>
      <user-id type="integer">65050</user-id>
      <version type="integer">5</version>
      <user-name>David Trasbo</user-name>
      <creator-name>Simone Carletti</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5773</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>This issue has been automatically marked as stale because it has not been commented on for at least three months.

The resources of the Rails core team are limited, and so we are asking for your help. If you can still reproduce this error on the 3-0-stable branch or on master, please reply with all of the information you have about it and add &quot;[state:open]&quot; to your comment. This will reopen the ticket for review. Likewise, if you feel that this is a very important feature for Rails to include, please reply with your explanation so we can consider it.

Thank you for all your contributions, and we hope you will understand this step to focus our efforts where they are most helpful.</body>
      <body-html>&lt;div&gt;&lt;p&gt;This issue has been automatically marked as stale because it has
not been commented on for at least three months.&lt;/p&gt;
&lt;p&gt;The resources of the Rails core team are limited, and so we are
asking for your help. If you can still reproduce this error on the
3-0-stable branch or on master, please reply with all of the
information you have about it and add &quot;[state:open]&quot; to your
comment. This will reopen the ticket for review. Likewise, if you
feel that this is a very important feature for Rails to include,
please reply with your explanation so we can consider it.&lt;/p&gt;
&lt;p&gt;Thank you for all your contributions, and we hope you will
understand this step to focus our efforts where they are most
helpful.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-02-02T16:58:12+00:00</created-at>
      <creator-id type="integer">27932</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: actioncontroller caches_action caching &quot;rails 3.0.0&quot;
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5773</number>
      <permalink>actioncontroller-crashes-when-trying-to-render-head-406-with-caches_action</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>actioncontroller caches_action caching &quot;rails 300&quot;</tag>
      <title>ActionController crashes when trying to render head 406 with caches_action</title>
      <updated-at type="datetime">2011-02-02T18:42:59+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">6</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Simone Carletti</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5773</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body nil="true"></body>
      <body-html nil="true"></body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-02T16:58:14+00:00</created-at>
      <creator-id type="integer">27932</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5773</number>
      <permalink>actioncontroller-crashes-when-trying-to-render-head-406-with-caches_action</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>stale</state>
      <tag>actioncontroller caches_action caching &quot;rails 300&quot;</tag>
      <title>ActionController crashes when trying to render head 406 with caches_action</title>
      <updated-at type="datetime">2011-02-02T18:42:25+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">7</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Simone Carletti</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5773</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I've encountered this in production and as Simone pointed out, rendering a non-200 http status code response in an action that is cached using caches_action will cause rack to throw an exception. As Simone said earlier, this is because the response body is set to nil, but I'm not sure if rack should be able to handle a nil response body or action caching should not set it to nil.

I've been using the attached patch in production to get rid of this error. Also included a test checking for nil response body.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I've encountered this in production and as Simone pointed out,
rendering a non-200 http status code response in an action that is
cached using caches_action will cause rack to throw an exception.
As Simone said earlier, this is because the response body is set to
nil, but I'm not sure if rack should be able to handle a nil
response body or action caching should not set it to nil.&lt;/p&gt;
&lt;p&gt;I've been using the attached patch in production to get rid of
this error. Also included a test checking for nil response
body.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-12T15:39:47+00:00</created-at>
      <creator-id type="integer">27932</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5773</number>
      <permalink>actioncontroller-crashes-when-trying-to-render-head-406-with-caches_action</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>stale</state>
      <tag>actioncontroller caches_action caching &quot;rails 300&quot;</tag>
      <title>ActionController crashes when trying to render head 406 with caches_action</title>
      <updated-at type="datetime">2011-02-12T15:39:56+00:00</updated-at>
      <user-id type="integer">135943</user-id>
      <version type="integer">8</version>
      <user-name>Wayne See</user-name>
      <creator-name>Simone Carletti</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5773</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>[state:open]</body>
      <body-html>&lt;div&gt;&lt;p&gt;[state:open]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-02-12T15:47:56+00:00</created-at>
      <creator-id type="integer">27932</creator-id>
      <diffable-attributes type="yaml">--- 
:state: stale
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5773</number>
      <permalink>actioncontroller-crashes-when-trying-to-render-head-406-with-caches_action</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>actioncontroller caches_action caching &quot;rails 300&quot;</tag>
      <title>ActionController crashes when trying to render head 406 with caches_action</title>
      <updated-at type="datetime">2011-02-12T15:48:08+00:00</updated-at>
      <user-id type="integer">135943</user-id>
      <version type="integer">9</version>
      <user-name>Wayne See</user-name>
      <creator-name>Simone Carletti</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5773</url>
      <priority-name>Low</priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Duplicate of #6480

[state:duplicate]</body>
      <body-html>&lt;div&gt;&lt;p&gt;Duplicate of &lt;a href=&quot;/projects/8994/tickets/6480&quot; title=
&quot;Ticket #6480&quot;&gt;#6480&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;[state:duplicate]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-03-01T15:09:14+00:00</created-at>
      <creator-id type="integer">27932</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5773</number>
      <permalink>actioncontroller-crashes-when-trying-to-render-head-406-with-caches_action</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>duplicate</state>
      <tag>actioncontroller caches_action caching &quot;rails 300&quot;</tag>
      <title>ActionController crashes when trying to render head 406 with caches_action</title>
      <updated-at type="datetime">2011-03-01T15:09:23+00:00</updated-at>
      <user-id type="integer">135943</user-id>
      <version type="integer">10</version>
      <user-name>Wayne See</user-name>
      <creator-name>Simone Carletti</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5773</url>
      <priority-name>Low</priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>096120cfc8774d5eb311d2d9f019e45667745cf0</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2011-02-12T15:39:47+00:00</created-at>
      <filename>patch_5773.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">909540</id>
      <size type="integer">1652</size>
      <uploader-id type="integer">135943</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/909540/patch_5773.diff</url>
    </attachment>
  </attachments>
</ticket>
