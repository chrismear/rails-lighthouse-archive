<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer" nil="true"></assigned-user-id>
  <attachments-count type="integer">0</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2010-11-01T20:31:47+00:00</created-at>
  <creator-id type="integer">70301</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">5853</number>
  <permalink>associationtypemismatch-different-versions-of-a-class-loaded</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>resolved</state>
  <tag>3.0.0 associations default_scope development has_and_belongs_to_many reloading</tag>
  <title>AssociationTypeMismatch, different versions of a class loaded</title>
  <updated-at type="datetime">2010-12-12T02:26:53+00:00</updated-at>
  <user-id type="integer">89656</user-id>
  <version type="integer">9</version>
  <user-name>Rohit Arondekar</user-name>
  <creator-name>Matt D</creator-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/5853</url>
  <priority-name>Low</priority-name>
  <original-body>Relevant bits of relevant models:

    class Job &lt; ActiveRecord::Base
      has_and_belongs_to_many :job_titles
  
      attr_accessible :job_title_ids
    end

    class JobTitle &lt; ActiveRecord::Base
      has_and_belongs_to_many :jobs
    end

I have a form that sets `job[job_title_ids]`. On first submit, it acts as expected, saving the associations. On future submissions, I get error messages of type ActiveRecord::AssociationTypeMismatch along the lines of:

    JobTitle(#84881490) expected, got JobTitle(#85299540)

These errors persist until I restart the server, or sometimes if I wait a few minutes, then I'm good for one more form submission. The number of the expected JobTitle class changes each refresh, whereas the second number remains constant.

I suspect it has to do with class reloading, and, if I cache classes, the issue ends. However, that's a messy workaround. Am I just missing something?</original-body>
  <latest-body>Relevant bits of relevant models:

    class Job &lt; ActiveRecord::Base
      has_and_belongs_to_many :job_titles
  
      attr_accessible :job_title_ids
    end

    class JobTitle &lt; ActiveRecord::Base
      has_and_belongs_to_many :jobs
    end

I have a form that sets `job[job_title_ids]`. On first submit, it acts as expected, saving the associations. On future submissions, I get error messages of type ActiveRecord::AssociationTypeMismatch along the lines of:

    JobTitle(#84881490) expected, got JobTitle(#85299540)

These errors persist until I restart the server, or sometimes if I wait a few minutes, then I'm good for one more form submission. The number of the expected JobTitle class changes each refresh, whereas the second number remains constant.

I suspect it has to do with class reloading, and, if I cache classes, the issue ends. However, that's a messy workaround. Am I just missing something?</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;Relevant bits of relevant models:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class Job &amp;lt; ActiveRecord::Base
  has_and_belongs_to_many :job_titles

  attr_accessible :job_title_ids
end

class JobTitle &amp;lt; ActiveRecord::Base
  has_and_belongs_to_many :jobs
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;I have a form that sets &lt;code&gt;job[job_title_ids]&lt;/code&gt;. On
first submit, it acts as expected, saving the associations. On
future submissions, I get error messages of type
ActiveRecord::AssociationTypeMismatch along the lines of:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;JobTitle(#84881490) expected, got JobTitle(#85299540)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;These errors persist until I restart the server, or sometimes if
I wait a few minutes, then I'm good for one more form submission.
The number of the expected JobTitle class changes each refresh,
whereas the second number remains constant.&lt;/p&gt;
&lt;p&gt;I suspect it has to do with class reloading, and, if I cache
classes, the issue ends. However, that's a messy workaround. Am I
just missing something?&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Relevant bits of relevant models:

    class Job &lt; ActiveRecord::Base
      has_and_belongs_to_many :job_titles
  
      attr_accessible :job_title_ids
    end

    class JobTitle &lt; ActiveRecord::Base
      has_and_belongs_to_many :jobs
    end

I have a form that sets `job[job_title_ids]`. On first submit, it acts as expected, saving the associations. On future submissions, I get error messages of type ActiveRecord::AssociationTypeMismatch along the lines of:

    JobTitle(#84881490) expected, got JobTitle(#85299540)

These errors persist until I restart the server, or sometimes if I wait a few minutes, then I'm good for one more form submission. The number of the expected JobTitle class changes each refresh, whereas the second number remains constant.

I suspect it has to do with class reloading, and, if I cache classes, the issue ends. However, that's a messy workaround. Am I just missing something?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Relevant bits of relevant models:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class Job &amp;lt; ActiveRecord::Base
  has_and_belongs_to_many :job_titles

  attr_accessible :job_title_ids
end

class JobTitle &amp;lt; ActiveRecord::Base
  has_and_belongs_to_many :jobs
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;I have a form that sets &lt;code&gt;job[job_title_ids]&lt;/code&gt;. On
first submit, it acts as expected, saving the associations. On
future submissions, I get error messages of type
ActiveRecord::AssociationTypeMismatch along the lines of:&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;JobTitle(#84881490) expected, got JobTitle(#85299540)&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;These errors persist until I restart the server, or sometimes if
I wait a few minutes, then I'm good for one more form submission.
The number of the expected JobTitle class changes each refresh,
whereas the second number remains constant.&lt;/p&gt;
&lt;p&gt;I suspect it has to do with class reloading, and, if I cache
classes, the issue ends. However, that's a messy workaround. Am I
just missing something?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-21T21:56:34+01:00</created-at>
      <creator-id type="integer">70301</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5853</number>
      <permalink>associationtypemismatch-different-versions-of-a-class-loaded</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0.0 associations has_and_belongs_to_many reloading</tag>
      <title>AssociationTypeMismatch, different versions of a class loaded</title>
      <updated-at type="datetime">2010-10-21T21:57:45+01:00</updated-at>
      <user-id type="integer">70301</user-id>
      <version type="integer">1</version>
      <user-name>Matt D</user-name>
      <creator-name>Matt D</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5853</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Once &lt;a href=&quot;http://www.gamevive.com/ffxiv-power-leveling.php&quot;&gt;&lt;strong&gt;cheap ffxiv power leveling&lt;/strong&gt;&lt;/a&gt; the kids have gone to bed, adults  can get the party started at the Adventure of the Seas' numerous clubs and  bars. Check out a show at the &lt;a href=&quot;http://www.buyff14gil-au.com/ff14-account.html&quot;&gt;ff14 account&lt;/a&gt;Lyric Theater  or hit the Imperial &lt;a href=&quot;http://www.power2level.com/aoc-pwl.html&quot;&gt;aoc power leveling&lt;/a&gt; Lounge for  dancing and cabaret. The 360 Sports Bar is the perfect place to catch a game,  or you can enjoy a cigar at the Connoisseur Club. For travelers seeking their  Vegas fix, the Casino Royale &lt;a href=&quot;http://www.power2level.com/aoc-pwl-eu.html&quot;&gt;age of conan power leveling&lt;/a&gt; has slots, blackjack, craps and roulette if you're &lt;a href=&quot;http://www.cheapgoldlive.com/aion-gold-eu.html&quot;&gt;aion online gold&lt;/a&gt; willing  to roll the dice.
  When it comes to the time for food, that &lt;a href=&quot;http://www.gocataclysm.com/&quot;&gt;&lt;strong&gt;cataclysm  cd key&lt;/strong&gt;&lt;/a&gt;&lt;strong&gt; &lt;/strong&gt;time can really be  any time at all with the ship's complimentary 24-hour room service. Or, check  out one of the vessel's many restaurants and bars. There are the Olympus,  Gotham &amp;amp; Metropolis&lt;strong&gt; &lt;/strong&gt;dining rooms &lt;a href=&quot;http://www.gamevive.com/ffxiv-gil.php&quot;&gt;&lt;strong&gt;buy ffxiv gil&lt;/strong&gt;&lt;/a&gt; for three-tiered seating and sit-down meals. Or try the Windjammer or Island  Grill for more casual dining. &lt;a href=&quot;http://www.gocataclysm.com/&quot;&gt;&lt;strong&gt;wow cataclysm cd key&lt;/strong&gt;&lt;/a&gt; If cruising  through Europe has you hankering for pasta, check out Portofino for a romantic  dinner. Other drinking and dining options include &lt;a href=&quot;http://www.gamevive.com/ffxiv-power-leveling.php&quot;&gt;&lt;strong&gt;ffxiv leveling&lt;/strong&gt;&lt;/a&gt; Johnny Rocket's Diner, The Aquarium &lt;a href=&quot;http://www.gamevive.com/ffxiv-gil.php&quot;&gt;&lt;strong&gt;cheap ffxiv gold&lt;/strong&gt;&lt;/a&gt; Bar, Palace Arms, and the Champagne Bar.
  Cruise travelers seeking a destination that  explores &lt;a href=&quot;http://www.cheapgoldlive.com/wow-gold-eu.html&quot;&gt;&lt;strong&gt;cheapest wow gold&lt;/strong&gt;&lt;/a&gt; the wonders of  nature will enjoy Norwegian Cruise Line's 7-Night Alaska Cruise on their  Norwegian Pearl ship. This cruise &lt;a href=&quot;http://www.gamevive.com/ffxiv-cdkey.php&quot;&gt;&lt;strong&gt;ff14 cd key&lt;/strong&gt;&lt;/a&gt; departs from Vancouver and stops in Ketchikan,  Juneau, Skagway and Prince Rupert, BC, &lt;a href=&quot;http://www.cheapgoldlive.com/aion-gold-eu.html&quot;&gt;cheap aion gold&lt;/a&gt; Canada.
  The Norwegian Pearl is a brand new ship &lt;a href=&quot;http://www.cheapgoldlive.com/war-gold-us.html&quot;&gt;warhammer gold&lt;/a&gt; that  boasts a rock climbing wall, bowling alley, Broadway-style shows, a  state-of-the-art fitness center, waterslides, pools, hot tubs, and kid and teen  activities. There are also 11 bars and lounges for &lt;a href=&quot;http://www.gamevive.com/ffxiv-cdkey.php&quot;&gt;&lt;strong&gt;final fantasy 14 time card&lt;/strong&gt;&lt;/a&gt; hanging out and 12 different places  to eat. Food choices include Asian dishes at Lotus Garden, tapas at &lt;a href=&quot;http://www.cheapgoldlive.com/war-gold-eu.html&quot;&gt;warhammer gold for sale&lt;/a&gt; Mambos, French cuisine at Le Bistro and steak at Cagney's.
  Accommodations on the Norwegian Pearl are  stunning. &lt;a href=&quot;http://www.power2level.com/wow-pwl-eu.html&quot;&gt;cheap wow power level&lt;/a&gt; Choose  from the opulent Courtyard or Garden Villas or &lt;a href=&quot;http://www.cheapgoldlive.com/aoc-gold-us.html&quot;&gt;cheap aoc gold&lt;/a&gt; their  family-friendly connecting staterooms and &lt;a href=&quot;http://www.buyff14gil-au.com/ff14-item.html&quot;&gt;buy ffxiv item&lt;/a&gt; suites.
  With so many different destinations to  choose from and state of the &lt;a href=&quot;http://www.cheapgoldlive.com/aoc-gold-eu.html&quot;&gt;age of conan gold&lt;/a&gt; art  ships with more amenities than you can imagine, cruise vacations are a much  hipper option than they once &lt;a href=&quot;http://www.power2level.com/aion-pwl.html&quot;&gt;aion  power level&lt;/a&gt; were. The old idea of passengers being trapped on a ship just  waiting to get to their next port of call is over. With &lt;a href=&quot;http://www.gamevive.com/ffxiv-account.php&quot;&gt;&lt;strong&gt;ff14 account&lt;/strong&gt;&lt;/a&gt; cruises today, getting there is half the fun.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Once &lt;a href=
&quot;http://www.gamevive.com/ffxiv-power-leveling.php&quot;&gt;&lt;strong&gt;cheap
ffxiv power leveling&lt;/strong&gt;&lt;/a&gt; the kids have gone to bed, adults
can get the party started at the Adventure of the Seas' numerous
clubs and bars. Check out a show at the &lt;a href=
&quot;http://www.buyff14gil-au.com/ff14-account.html&quot;&gt;ff14
account&lt;/a&gt;Lyric Theater or hit the Imperial &lt;a href=
&quot;http://www.power2level.com/aoc-pwl.html&quot;&gt;aoc power leveling&lt;/a&gt;
Lounge for dancing and cabaret. The 360 Sports Bar is the perfect
place to catch a game, or you can enjoy a cigar at the Connoisseur
Club. For travelers seeking their Vegas fix, the Casino Royale
&lt;a href=&quot;http://www.power2level.com/aoc-pwl-eu.html&quot;&gt;age of conan
power leveling&lt;/a&gt; has slots, blackjack, craps and roulette if
you're &lt;a href=
&quot;http://www.cheapgoldlive.com/aion-gold-eu.html&quot;&gt;aion online
gold&lt;/a&gt; willing to roll the dice.&lt;br&gt;
When it comes to the time for food, that &lt;a href=
&quot;http://www.gocataclysm.com/&quot;&gt;&lt;strong&gt;cataclysm cd key&lt;/strong&gt;&lt;/a&gt;
time can really be any time at all with the ship's complimentary
24-hour room service. Or, check out one of the vessel's many
restaurants and bars. There are the Olympus, Gotham &amp;amp;
Metropolis dining rooms &lt;a href=
&quot;http://www.gamevive.com/ffxiv-gil.php&quot;&gt;&lt;strong&gt;buy ffxiv
gil&lt;/strong&gt;&lt;/a&gt; for three-tiered seating and sit-down meals. Or
try the Windjammer or Island Grill for more casual dining. &lt;a href=
&quot;http://www.gocataclysm.com/&quot;&gt;&lt;strong&gt;wow cataclysm cd
key&lt;/strong&gt;&lt;/a&gt; If cruising through Europe has you hankering for
pasta, check out Portofino for a romantic dinner. Other drinking
and dining options include &lt;a href=
&quot;http://www.gamevive.com/ffxiv-power-leveling.php&quot;&gt;&lt;strong&gt;ffxiv
leveling&lt;/strong&gt;&lt;/a&gt; Johnny Rocket's Diner, The Aquarium &lt;a href=
&quot;http://www.gamevive.com/ffxiv-gil.php&quot;&gt;&lt;strong&gt;cheap ffxiv
gold&lt;/strong&gt;&lt;/a&gt; Bar, Palace Arms, and the Champagne Bar. Cruise
travelers seeking a destination that explores &lt;a href=
&quot;http://www.cheapgoldlive.com/wow-gold-eu.html&quot;&gt;&lt;strong&gt;cheapest
wow gold&lt;/strong&gt;&lt;/a&gt; the wonders of nature will enjoy Norwegian
Cruise Line's 7-Night Alaska Cruise on their Norwegian Pearl ship.
This cruise &lt;a href=
&quot;http://www.gamevive.com/ffxiv-cdkey.php&quot;&gt;&lt;strong&gt;ff14 cd
key&lt;/strong&gt;&lt;/a&gt; departs from Vancouver and stops in Ketchikan,
Juneau, Skagway and Prince Rupert, BC, &lt;a href=
&quot;http://www.cheapgoldlive.com/aion-gold-eu.html&quot;&gt;cheap aion
gold&lt;/a&gt; Canada. The Norwegian Pearl is a brand new ship &lt;a href=
&quot;http://www.cheapgoldlive.com/war-gold-us.html&quot;&gt;warhammer gold&lt;/a&gt;
that boasts a rock climbing wall, bowling alley, Broadway-style
shows, a state-of-the-art fitness center, waterslides, pools, hot
tubs, and kid and teen activities. There are also 11 bars and
lounges for &lt;a href=
&quot;http://www.gamevive.com/ffxiv-cdkey.php&quot;&gt;&lt;strong&gt;final fantasy 14
time card&lt;/strong&gt;&lt;/a&gt; hanging out and 12 different places to eat.
Food choices include Asian dishes at Lotus Garden, tapas at
&lt;a href=&quot;http://www.cheapgoldlive.com/war-gold-eu.html&quot;&gt;warhammer
gold for sale&lt;/a&gt; Mambos, French cuisine at Le Bistro and steak at
Cagney's. Accommodations on the Norwegian Pearl are stunning.
&lt;a href=&quot;http://www.power2level.com/wow-pwl-eu.html&quot;&gt;cheap wow
power level&lt;/a&gt; Choose from the opulent Courtyard or Garden Villas
or &lt;a href=&quot;http://www.cheapgoldlive.com/aoc-gold-us.html&quot;&gt;cheap
aoc gold&lt;/a&gt; their family-friendly connecting staterooms and
&lt;a href=&quot;http://www.buyff14gil-au.com/ff14-item.html&quot;&gt;buy ffxiv
item&lt;/a&gt; suites. With so many different destinations to choose from
and state of the &lt;a href=
&quot;http://www.cheapgoldlive.com/aoc-gold-eu.html&quot;&gt;age of conan
gold&lt;/a&gt; art ships with more amenities than you can imagine, cruise
vacations are a much hipper option than they once &lt;a href=
&quot;http://www.power2level.com/aion-pwl.html&quot;&gt;aion power level&lt;/a&gt;
were. The old idea of passengers being trapped on a ship just
waiting to get to their next port of call is over. With &lt;a href=
&quot;http://www.gamevive.com/ffxiv-account.php&quot;&gt;&lt;strong&gt;ff14
account&lt;/strong&gt;&lt;/a&gt; cruises today, getting there is half the
fun.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-23T07:20:01+01:00</created-at>
      <creator-id type="integer">70301</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5853</number>
      <permalink>associationtypemismatch-different-versions-of-a-class-loaded</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0.0 associations has_and_belongs_to_many reloading</tag>
      <title>AssociationTypeMismatch, different versions of a class loaded</title>
      <updated-at type="datetime">2010-10-24T17:45:04+01:00</updated-at>
      <user-id type="integer">121508</user-id>
      <version type="integer">2</version>
      <user-name>ffxivgil</user-name>
      <creator-name>Matt D</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5853</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Could you share your view and controller code please ?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Could you share your view and controller code please ?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-24T09:26:16+01:00</created-at>
      <creator-id type="integer">70301</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5853</number>
      <permalink>associationtypemismatch-different-versions-of-a-class-loaded</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0.0 associations has_and_belongs_to_many reloading</tag>
      <title>AssociationTypeMismatch, different versions of a class loaded</title>
      <updated-at type="datetime">2010-10-24T09:26:18+01:00</updated-at>
      <user-id type="integer">52024</user-id>
      <version type="integer">3</version>
      <user-name>Robert Pankowecki</user-name>
      <creator-name>Matt D</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5853</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Making use of CanCan and Formtastic:

**app/controllers/jobs_controller.rb:**

    class JobsController &lt; ApplicationController
      before_filter :authenticate_user!, :require_user_has_a_company, :only =&gt; [:new, :create]
      load_and_authorize_resource :company
      load_and_authorize_resource :through =&gt; :company
      
      def index
        @jobs = Job.new_to_old.all :include =&gt; :company
      end
      
      def new
        @company = current_user.company
      end
      
      def create
        @job.company = current_user.company
        if @job.save
          redirect_to [@company, @job], :notice =&gt; &quot;Job successfully saved&quot;
        else
          render :action =&gt; :new
        end
      end
      
      def update
        if @job.update_attributes(params[:job])
          redirect_to [@company, @job], :notice =&gt; &quot;Job successfully saved&quot;
        else
          render :action =&gt; :edit
        end
      end
    end

**app/views/jobs/edit.html.haml:**

    - title &quot;Edit a job&quot;
    = render 'form'

**app/views/jobs/_form.html.haml:**

    = semantic_form_for [@church, @job] do |form|
      = form.inputs do
        = form.input :tagline, :hint =&gt; &quot;Describe what you're looking for in one sentence&quot;
        = form.input :job_titles, :as =&gt; :check_boxes
        = form.input :description
      = form.buttons do
        = form.commit_button 'Save job'

**HTML output of app/views/edit.html.haml:**

    &lt;form accept-charset=&quot;UTF-8&quot; action=&quot;/churches/14/jobs/16&quot; class=&quot;formtastic job&quot; id=&quot;edit_job_16&quot; method=&quot;post&quot;&gt;&lt;div style=&quot;margin:0;padding:0;display:inline&quot;&gt;&lt;input name=&quot;utf8&quot; type=&quot;hidden&quot; value=&quot;&amp;#x2713;&quot; /&gt;&lt;input name=&quot;_method&quot; type=&quot;hidden&quot; value=&quot;put&quot; /&gt;&lt;input name=&quot;authenticity_token&quot; type=&quot;hidden&quot; value=&quot;f/aSr9QKidvCVv0+83HoI7Za+6PdXPQBL3aQpR5KQGY=&quot; /&gt;&lt;/div&gt; 
        &lt;fieldset class=&quot;inputs&quot;&gt;&lt;ol&gt;&lt;li class=&quot;string optional&quot; id=&quot;job_tagline_input&quot;&gt;&lt;label for=&quot;job_tagline&quot;&gt;Tagline&lt;/label&gt;&lt;input id=&quot;job_tagline&quot; maxlength=&quot;255&quot; name=&quot;job[tagline]&quot; size=&quot;50&quot; type=&quot;text&quot; value=&quot;Awesome job of awesome! :)&quot; /&gt; 
      &lt;p class=&quot;inline-hints&quot;&gt;Describe what you're looking for in one sentence&lt;/p&gt;&lt;/li&gt; 
      &lt;li class=&quot;check_boxes optional&quot; id=&quot;job_job_titles_input&quot;&gt;&lt;fieldset&gt;&lt;legend class=&quot;label&quot;&gt;&lt;label&gt;Job titles&lt;/label&gt;&lt;/legend&gt;&lt;input id=&quot;job_job_title_ids_&quot; name=&quot;job[job_title_ids][]&quot; type=&quot;hidden&quot; value=&quot;&quot; /&gt;&lt;ol&gt;&lt;li&gt;&lt;label for=&quot;job_job_title_ids_3&quot;&gt;&lt;input id=&quot;job_job_title_ids_3&quot; name=&quot;job[job_title_ids][]&quot; type=&quot;checkbox&quot; value=&quot;3&quot; /&gt; Big boss&lt;/label&gt;&lt;/li&gt;&lt;li&gt;&lt;label for=&quot;job_job_title_ids_4&quot;&gt;&lt;input checked=&quot;checked&quot; id=&quot;job_job_title_ids_4&quot; name=&quot;job[job_title_ids][]&quot; type=&quot;checkbox&quot; value=&quot;4&quot; /&gt; Secretary&lt;/label&gt;&lt;/li&gt;&lt;li&gt;&lt;label for=&quot;job_job_title_ids_1&quot;&gt;&lt;input checked=&quot;checked&quot; id=&quot;job_job_title_ids_1&quot; name=&quot;job[job_title_ids][]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&gt; Code monkey&lt;/label&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/fieldset&gt;&lt;/li&gt; 
      &lt;li class=&quot;text required&quot; id=&quot;job_description_input&quot;&gt;&lt;label for=&quot;job_description&quot;&gt;Description&lt;abbr title=&quot;required&quot;&gt;*&lt;/abbr&gt;&lt;/label&gt;&lt;textarea cols=&quot;50&quot; id=&quot;job_description&quot; name=&quot;job[description]&quot; rows=&quot;20&quot;&gt;You better be awesome to get this job. Just saying.&lt;/textarea&gt;&lt;/li&gt; 
      &lt;/ol&gt;&lt;/fieldset&gt; 
      &lt;fieldset class=&quot;buttons&quot;&gt;&lt;ol&gt;&lt;li class=&quot;commit&quot;&gt;&lt;input class=&quot;update&quot; id=&quot;job_submit&quot; name=&quot;commit&quot; type=&quot;submit&quot; value=&quot;Save job&quot; /&gt;&lt;/li&gt; 
      &lt;/ol&gt;&lt;/fieldset&gt; 
    &lt;/form&gt;

It's tempting to say that CanCan or Formtastic is the culprit, but Formtastic produces the form HTML I'd expect, and the relevant bit of the `update` action in the controller is still `@job.update_attributes(params[:job])`. (CanCan doesn't perform the update on its own in `load_and_authorize_resource` as it does for the initialization; I used the Rails logger to confirm.)

I also, just for testing purposes, added `@job.job_title_ids = ['', '1', '3']` to the top of the `update` action. The error was thrown from that line, instead. This helps narrow down where the issue is by confirmed that it's the actual `job_title_ids` setter that is the issue, and confirms that it doesn't have to do with the params object performing any strange magic.

Thanks!</body>
      <body-html>&lt;div&gt;&lt;p&gt;Making use of CanCan and Formtastic:&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;app/controllers/jobs_controller.rb:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;class JobsController &amp;lt; ApplicationController
  before_filter :authenticate_user!, :require_user_has_a_company, :only =&amp;gt; [:new, :create]
  load_and_authorize_resource :company
  load_and_authorize_resource :through =&amp;gt; :company

  def index
    @jobs = Job.new_to_old.all :include =&amp;gt; :company
  end

  def new
    @company = current_user.company
  end

  def create
    @job.company = current_user.company
    if @job.save
      redirect_to [@company, @job], :notice =&amp;gt; &quot;Job successfully saved&quot;
    else
      render :action =&amp;gt; :new
    end
  end

  def update
    if @job.update_attributes(params[:job])
      redirect_to [@company, @job], :notice =&amp;gt; &quot;Job successfully saved&quot;
    else
      render :action =&amp;gt; :edit
    end
  end
end&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;app/views/jobs/edit.html.haml:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;- title &quot;Edit a job&quot;
= render 'form'&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;app/views/jobs/_form.html.haml:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;= semantic_form_for [@church, @job] do |form|
  = form.inputs do
    = form.input :tagline, :hint =&amp;gt; &quot;Describe what you're looking for in one sentence&quot;
    = form.input :job_titles, :as =&amp;gt; :check_boxes
    = form.input :description
  = form.buttons do
    = form.commit_button 'Save job'&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;&lt;strong&gt;HTML output of app/views/edit.html.haml:&lt;/strong&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;&amp;lt;form accept-charset=&quot;UTF-8&quot; action=&quot;/churches/14/jobs/16&quot; class=&quot;formtastic job&quot; id=&quot;edit_job_16&quot; method=&quot;post&quot;&amp;gt;&amp;lt;div style=&quot;margin:0;padding:0;display:inline&quot;&amp;gt;&amp;lt;input name=&quot;utf8&quot; type=&quot;hidden&quot; value=&quot;&amp;amp;#x2713;&quot; /&amp;gt;&amp;lt;input name=&quot;_method&quot; type=&quot;hidden&quot; value=&quot;put&quot; /&amp;gt;&amp;lt;input name=&quot;authenticity_token&quot; type=&quot;hidden&quot; value=&quot;f/aSr9QKidvCVv0+83HoI7Za+6PdXPQBL3aQpR5KQGY=&quot; /&amp;gt;&amp;lt;/div&amp;gt;
    &amp;lt;fieldset class=&quot;inputs&quot;&amp;gt;&amp;lt;ol&amp;gt;&amp;lt;li class=&quot;string optional&quot; id=&quot;job_tagline_input&quot;&amp;gt;&amp;lt;label for=&quot;job_tagline&quot;&amp;gt;Tagline&amp;lt;/label&amp;gt;&amp;lt;input id=&quot;job_tagline&quot; maxlength=&quot;255&quot; name=&quot;job[tagline]&quot; size=&quot;50&quot; type=&quot;text&quot; value=&quot;Awesome job of awesome! :)&quot; /&amp;gt; 
  &amp;lt;p class=&quot;inline-hints&quot;&amp;gt;Describe what you're looking for in one sentence&amp;lt;/p&amp;gt;&amp;lt;/li&amp;gt; 
  &amp;lt;li class=&quot;check_boxes optional&quot; id=&quot;job_job_titles_input&quot;&amp;gt;&amp;lt;fieldset&amp;gt;&amp;lt;legend class=&quot;label&quot;&amp;gt;&amp;lt;label&amp;gt;Job titles&amp;lt;/label&amp;gt;&amp;lt;/legend&amp;gt;&amp;lt;input id=&quot;job_job_title_ids_&quot; name=&quot;job[job_title_ids][]&quot; type=&quot;hidden&quot; value=&quot;&quot; /&amp;gt;&amp;lt;ol&amp;gt;&amp;lt;li&amp;gt;&amp;lt;label for=&quot;job_job_title_ids_3&quot;&amp;gt;&amp;lt;input id=&quot;job_job_title_ids_3&quot; name=&quot;job[job_title_ids][]&quot; type=&quot;checkbox&quot; value=&quot;3&quot; /&amp;gt; Big boss&amp;lt;/label&amp;gt;&amp;lt;/li&amp;gt;&amp;lt;li&amp;gt;&amp;lt;label for=&quot;job_job_title_ids_4&quot;&amp;gt;&amp;lt;input checked=&quot;checked&quot; id=&quot;job_job_title_ids_4&quot; name=&quot;job[job_title_ids][]&quot; type=&quot;checkbox&quot; value=&quot;4&quot; /&amp;gt; Secretary&amp;lt;/label&amp;gt;&amp;lt;/li&amp;gt;&amp;lt;li&amp;gt;&amp;lt;label for=&quot;job_job_title_ids_1&quot;&amp;gt;&amp;lt;input checked=&quot;checked&quot; id=&quot;job_job_title_ids_1&quot; name=&quot;job[job_title_ids][]&quot; type=&quot;checkbox&quot; value=&quot;1&quot; /&amp;gt; Code monkey&amp;lt;/label&amp;gt;&amp;lt;/li&amp;gt;&amp;lt;/ol&amp;gt;&amp;lt;/fieldset&amp;gt;&amp;lt;/li&amp;gt; 
  &amp;lt;li class=&quot;text required&quot; id=&quot;job_description_input&quot;&amp;gt;&amp;lt;label for=&quot;job_description&quot;&amp;gt;Description&amp;lt;abbr title=&quot;required&quot;&amp;gt;*&amp;lt;/abbr&amp;gt;&amp;lt;/label&amp;gt;&amp;lt;textarea cols=&quot;50&quot; id=&quot;job_description&quot; name=&quot;job[description]&quot; rows=&quot;20&quot;&amp;gt;You better be awesome to get this job. Just saying.&amp;lt;/textarea&amp;gt;&amp;lt;/li&amp;gt; 
  &amp;lt;/ol&amp;gt;&amp;lt;/fieldset&amp;gt; 
  &amp;lt;fieldset class=&quot;buttons&quot;&amp;gt;&amp;lt;ol&amp;gt;&amp;lt;li class=&quot;commit&quot;&amp;gt;&amp;lt;input class=&quot;update&quot; id=&quot;job_submit&quot; name=&quot;commit&quot; type=&quot;submit&quot; value=&quot;Save job&quot; /&amp;gt;&amp;lt;/li&amp;gt; 
  &amp;lt;/ol&amp;gt;&amp;lt;/fieldset&amp;gt; 
&amp;lt;/form&amp;gt;&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;It's tempting to say that CanCan or Formtastic is the culprit,
but Formtastic produces the form HTML I'd expect, and the relevant
bit of the &lt;code&gt;update&lt;/code&gt; action in the controller is still
&lt;code&gt;@job.update_attributes(params[:job])&lt;/code&gt;. (CanCan doesn't
perform the update on its own in
&lt;code&gt;load_and_authorize_resource&lt;/code&gt; as it does for the
initialization; I used the Rails logger to confirm.)&lt;/p&gt;
&lt;p&gt;I also, just for testing purposes, added
&lt;code&gt;@job.job_title_ids = ['', '1', '3']&lt;/code&gt; to the top of the
&lt;code&gt;update&lt;/code&gt; action. The error was thrown from that line,
instead. This helps narrow down where the issue is by confirmed
that it's the actual &lt;code&gt;job_title_ids&lt;/code&gt; setter that is the
issue, and confirms that it doesn't have to do with the params
object performing any strange magic.&lt;/p&gt;
&lt;p&gt;Thanks!&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-24T14:48:40+01:00</created-at>
      <creator-id type="integer">70301</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5853</number>
      <permalink>associationtypemismatch-different-versions-of-a-class-loaded</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0.0 associations has_and_belongs_to_many reloading</tag>
      <title>AssociationTypeMismatch, different versions of a class loaded</title>
      <updated-at type="datetime">2010-10-24T14:48:42+01:00</updated-at>
      <user-id type="integer">70301</user-id>
      <version type="integer">4</version>
      <user-name>Matt D</user-name>
      <creator-name>Matt D</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5853</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Are you using default_scope anywhere? After much digging, I came across [this ticket](https://rails.lighthouseapp.com/projects/8994/tickets/5497-default-scope-and-class-reloading).

Commenting out my uses of default_scope seems to have resolved this issue for me.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Are you using default_scope anywhere? After much digging, I came
across &lt;a href=
&quot;https://rails.lighthouseapp.com/projects/8994/tickets/5497-default-scope-and-class-reloading&quot;&gt;
this ticket&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Commenting out my uses of default_scope seems to have resolved
this issue for me.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-31T05:53:27+00:00</created-at>
      <creator-id type="integer">70301</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 3.0.0 associations has_and_belongs_to_many reloading
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5853</number>
      <permalink>associationtypemismatch-different-versions-of-a-class-loaded</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0.0 associations default_scope development has_and_belongs_to_many reloading</tag>
      <title>AssociationTypeMismatch, different versions of a class loaded</title>
      <updated-at type="datetime">2010-10-31T05:53:29+00:00</updated-at>
      <user-id type="integer">14178</user-id>
      <version type="integer">5</version>
      <user-name>J.D. Hollis</user-name>
      <creator-name>Matt D</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5853</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Wow, yes. Didn't expect that to be a factor.

Good to see that there's an official patch, and that I'm not just totally going crazy. Ticket ready to be closed.

Thanks!</body>
      <body-html>&lt;div&gt;&lt;p&gt;Wow, yes. Didn't expect that to be a factor.&lt;/p&gt;
&lt;p&gt;Good to see that there's an official patch, and that I'm not
just totally going crazy. Ticket ready to be closed.&lt;/p&gt;
&lt;p&gt;Thanks!&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-31T21:25:04+00:00</created-at>
      <creator-id type="integer">70301</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5853</number>
      <permalink>associationtypemismatch-different-versions-of-a-class-loaded</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0.0 associations default_scope development has_and_belongs_to_many reloading</tag>
      <title>AssociationTypeMismatch, different versions of a class loaded</title>
      <updated-at type="datetime">2010-10-31T21:25:05+00:00</updated-at>
      <user-id type="integer">70301</user-id>
      <version type="integer">6</version>
      <user-name>Matt D</user-name>
      <creator-name>Matt D</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5853</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-10-31T21:25:49+00:00</created-at>
      <creator-id type="integer">70301</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5853</number>
      <permalink>associationtypemismatch-different-versions-of-a-class-loaded</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0.0 associations default_scope development has_and_belongs_to_many reloading</tag>
      <title>AssociationTypeMismatch, different versions of a class loaded</title>
      <updated-at type="datetime">2010-10-31T21:25:50+00:00</updated-at>
      <user-id type="integer">70301</user-id>
      <version type="integer">7</version>
      <user-name>Matt D</user-name>
      <creator-name>Matt D</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5853</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Wide range of web hosting services are accessible, such as &lt;a href=&quot;http://www.ucvhost.com&quot;&gt;cheap vps&lt;/a&gt; , email hosting, Unix hosting, &lt;a href=&quot;http://www.ucvhost.com/VPS/Forex/ForexVps.aspx&quot;&gt;forex vps&lt;/a&gt; , Windows hosting, &lt;a href=&quot;http://www.ucvhost.com/VPS/EntryLevelVPS/EntryLevelVps.aspx&quot;&gt;windows vps&lt;/a&gt; etc.We hope you will find a  &lt;a href=&quot;http://www.ucvhost.com/&quot;&gt;cheap hosting&lt;/a&gt; company.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Wide range of web hosting services are accessible, such as
&lt;a href=&quot;http://www.ucvhost.com&quot;&gt;cheap vps&lt;/a&gt; , email hosting,
Unix hosting, &lt;a href=
&quot;http://www.ucvhost.com/VPS/Forex/ForexVps.aspx&quot;&gt;forex vps&lt;/a&gt; ,
Windows hosting, &lt;a href=
&quot;http://www.ucvhost.com/VPS/EntryLevelVPS/EntryLevelVps.aspx&quot;&gt;windows
vps&lt;/a&gt; etc.We hope you will find a &lt;a href=
&quot;http://www.ucvhost.com/&quot;&gt;cheap hosting&lt;/a&gt; company.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-11-01T09:56:52+00:00</created-at>
      <creator-id type="integer">70301</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5853</number>
      <permalink>associationtypemismatch-different-versions-of-a-class-loaded</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>3.0.0 associations default_scope development has_and_belongs_to_many reloading</tag>
      <title>AssociationTypeMismatch, different versions of a class loaded</title>
      <updated-at type="datetime">2010-11-01T20:31:47+00:00</updated-at>
      <user-id type="integer">122702</user-id>
      <version type="integer">8</version>
      <user-name>piter</user-name>
      <creator-name>Matt D</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5853</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-12-12T02:26:42+00:00</created-at>
      <creator-id type="integer">70301</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
:priority: 0
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">5853</number>
      <permalink>associationtypemismatch-different-versions-of-a-class-loaded</permalink>
      <priority type="integer">3</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>3.0.0 associations default_scope development has_and_belongs_to_many reloading</tag>
      <title>AssociationTypeMismatch, different versions of a class loaded</title>
      <updated-at type="datetime">2010-12-12T02:26:53+00:00</updated-at>
      <user-id type="integer">89656</user-id>
      <version type="integer">9</version>
      <user-name>Rohit Arondekar</user-name>
      <creator-name>Matt D</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/5853</url>
      <priority-name>Low</priority-name>
    </version>
  </versions>
</ticket>
