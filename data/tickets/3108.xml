<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer" nil="true"></assigned-user-id>
  <attachments-count type="integer">7</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2009-08-27T20:26:50+01:00</created-at>
  <creator-id type="integer">26521</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer">71472</milestone-id>
  <number type="integer">3108</number>
  <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
  <priority type="integer">135191</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>stale</state>
  <tag>233 activerecord bugmash</tag>
  <title>Eager loading uniq habtm association is broken</title>
  <updated-at type="datetime">2011-02-02T17:11:25+00:00</updated-at>
  <user-id type="integer">40272</user-id>
  <version type="integer">19</version>
  <user-name>Santiago Pastorino</user-name>
  <creator-name>Niels Meersschaert</creator-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
  <milestone-title>3.x</milestone-title>
  <priority-name nil="true"></priority-name>
  <original-body>Loading a model thru eager loading or simple loading should return same results for associations.  That is not the case with habtm with uniq option.

I have a model Foo with a habtm relationship to Bar that is uniq.  

class Foo &lt; ActiveRecord::Base
  has_and_belongs_to_many :bars, :uniq =&gt; true
end

class Bar &lt; ActiveRecord::Base
end

Let's build 2 models, one of each type:

foo = Foo.create(:name =&gt; &quot;foo_test&quot;) #ID 13
bar = Bar.create(:name =&gt; &quot;bar_test&quot;) #ID 87

I add the same instance of Bar to a Foo multiple times:

5.times do 
foo.bars &lt;&lt; bar
end

If I do a clean load of foo &amp; then ask for bars, I get 1 as expected:

foo2 = Foo.find(13)

foo2.bars 
[#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;]

However, if I eager load the bars:

foo3 = Foo.find(13, :include =&gt; :bars)
foo3.bars
[#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;]

The returned array isn't uniq, but shows all 5 instances of the duplicate bar.</original-body>
  <latest-body>Loading a model thru eager loading or simple loading should return same results for associations.  That is not the case with habtm with uniq option.

I have a model Foo with a habtm relationship to Bar that is uniq.  

class Foo &lt; ActiveRecord::Base
  has_and_belongs_to_many :bars, :uniq =&gt; true
end

class Bar &lt; ActiveRecord::Base
end

Let's build 2 models, one of each type:

foo = Foo.create(:name =&gt; &quot;foo_test&quot;) #ID 13
bar = Bar.create(:name =&gt; &quot;bar_test&quot;) #ID 87

I add the same instance of Bar to a Foo multiple times:

5.times do 
foo.bars &lt;&lt; bar
end

If I do a clean load of foo &amp; then ask for bars, I get 1 as expected:

foo2 = Foo.find(13)

foo2.bars 
[#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;]

However, if I eager load the bars:

foo3 = Foo.find(13, :include =&gt; :bars)
foo3.bars
[#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;]

The returned array isn't uniq, but shows all 5 instances of the duplicate bar.</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;Loading a model thru eager loading or simple loading should
return same results for associations. That is not the case with
habtm with uniq option.&lt;/p&gt;
&lt;p&gt;I have a model Foo with a habtm relationship to Bar that is
uniq.&lt;br&gt;&lt;/p&gt;
&lt;p&gt;class Foo &amp;lt; ActiveRecord::Base has_and_belongs_to_many :bars,
:uniq =&amp;gt; true end&lt;/p&gt;
&lt;p&gt;class Bar &amp;lt; ActiveRecord::Base end&lt;/p&gt;
&lt;p&gt;Let's build 2 models, one of each type:&lt;/p&gt;
&lt;p&gt;foo = Foo.create(:name =&amp;gt; &quot;foo_test&quot;) #ID 13 bar =
Bar.create(:name =&amp;gt; &quot;bar_test&quot;) #ID 87&lt;/p&gt;
&lt;p&gt;I add the same instance of Bar to a Foo multiple times:&lt;/p&gt;
&lt;p&gt;5.times do foo.bars &amp;lt;&amp;lt; bar end&lt;/p&gt;
&lt;p&gt;If I do a clean load of foo &amp;amp; then ask for bars, I get 1 as
expected:&lt;/p&gt;
&lt;p&gt;foo2 = Foo.find(13)&lt;/p&gt;
&lt;p&gt;foo2.bars [#]&lt;/p&gt;
&lt;p&gt;However, if I eager load the bars:&lt;/p&gt;
&lt;p&gt;foo3 = Foo.find(13, :include =&amp;gt; :bars) foo3.bars
[#,#,#,#,#]&lt;/p&gt;
&lt;p&gt;The returned array isn't uniq, but shows all 5 instances of the
duplicate bar.&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Loading a model thru eager loading or simple loading should return same results for associations.  That is not the case with habtm with uniq option.

I have a model Foo with a habtm relationship to Bar that is uniq.  

class Foo &lt; ActiveRecord::Base
  has_and_belongs_to_many :bars, :uniq =&gt; true
end

class Bar &lt; ActiveRecord::Base
end

Let's build 2 models, one of each type:

foo = Foo.create(:name =&gt; &quot;foo_test&quot;) #ID 13
bar = Bar.create(:name =&gt; &quot;bar_test&quot;) #ID 87

I add the same instance of Bar to a Foo multiple times:

5.times do 
foo.bars &lt;&lt; bar
end

If I do a clean load of foo &amp; then ask for bars, I get 1 as expected:

foo2 = Foo.find(13)

foo2.bars 
[#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;]

However, if I eager load the bars:

foo3 = Foo.find(13, :include =&gt; :bars)
foo3.bars
[#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;,#&lt;Bar id:87 name: &quot;bar_test&quot;&gt;]

The returned array isn't uniq, but shows all 5 instances of the duplicate bar.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Loading a model thru eager loading or simple loading should
return same results for associations. That is not the case with
habtm with uniq option.&lt;/p&gt;
&lt;p&gt;I have a model Foo with a habtm relationship to Bar that is
uniq.&lt;br&gt;&lt;/p&gt;
&lt;p&gt;class Foo &amp;lt; ActiveRecord::Base&lt;br&gt;
has_and_belongs_to_many :bars, :uniq =&amp;gt; true end&lt;/p&gt;
&lt;p&gt;class Bar &amp;lt; ActiveRecord::Base&lt;br&gt;
end&lt;/p&gt;
&lt;p&gt;Let's build 2 models, one of each type:&lt;/p&gt;
&lt;p&gt;foo = Foo.create(:name =&amp;gt; &quot;foo_test&quot;) #ID 13&lt;br&gt;
bar = Bar.create(:name =&amp;gt; &quot;bar_test&quot;) #ID 87&lt;/p&gt;
&lt;p&gt;I add the same instance of Bar to a Foo multiple times:&lt;/p&gt;
&lt;p&gt;5.times do&lt;br&gt;
foo.bars &amp;lt;&amp;lt; bar&lt;br&gt;
end&lt;/p&gt;
&lt;p&gt;If I do a clean load of foo &amp;amp; then ask for bars, I get 1 as
expected:&lt;/p&gt;
&lt;p&gt;foo2 = Foo.find(13)&lt;/p&gt;
&lt;p&gt;foo2.bars&lt;br&gt;
[#]&lt;/p&gt;
&lt;p&gt;However, if I eager load the bars:&lt;/p&gt;
&lt;p&gt;foo3 = Foo.find(13, :include =&amp;gt; :bars)&lt;br&gt;
foo3.bars&lt;br&gt;
[#,#,#,#,#]&lt;/p&gt;
&lt;p&gt;The returned array isn't uniq, but shows all 5 instances of the
duplicate bar.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-08-27T20:26:50+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2009-08-27T20:26:58+01:00</updated-at>
      <user-id type="integer">26521</user-id>
      <version type="integer">1</version>
      <user-name>Niels Meersschaert</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body nil="true"></body>
      <body-html nil="true"></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-09-25T12:39:51+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3.3 activerecord
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2009-09-25T12:50:12+01:00</updated-at>
      <user-id type="integer">7211</user-id>
      <version type="integer">2</version>
      <user-name>CancelProfileIsBroken</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>+1 verified and reproduced on master and 2-3-stable. i've attached a failing test.</body>
      <body-html>&lt;div&gt;&lt;p&gt;+1 verified and reproduced on master and 2-3-stable. i've
attached a failing test.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-09-26T04:38:24+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2009-09-26T04:38:30+01:00</updated-at>
      <user-id type="integer">36381</user-id>
      <version type="integer">3</version>
      <user-name>Elad Meidar</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>the failing test if for master.</body>
      <body-html>&lt;div&gt;&lt;p&gt;the failing test if for master.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-09-26T04:40:20+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2009-09-26T04:40:24+01:00</updated-at>
      <user-id type="integer">36381</user-id>
      <version type="integer">4</version>
      <user-name>Elad Meidar</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>-1 changing the `developers.yml` somehow introduced failures in other tests.

I rewrote it using `dev_3` instead. I've attached the edited failing test.</body>
      <body-html>&lt;div&gt;&lt;p&gt;-1 changing the &lt;code&gt;developers.yml&lt;/code&gt; somehow introduced
failures in other tests.&lt;/p&gt;
&lt;p&gt;I rewrote it using &lt;code&gt;dev_3&lt;/code&gt; instead. I've attached the
edited failing test.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-09-26T10:07:16+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2009-09-26T10:07:24+01:00</updated-at>
      <user-id type="integer">51191</user-id>
      <version type="integer">5</version>
      <user-name>hsume2 (Henry)</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Also, this is my take on patching the issue. I thought of adding something like (-190,6 +190,7):

@@@
+  associated_records.uniq! if options[:uniq]
   set_association_collection_records(id_to_record_map, reflection.name, associated_records, 'the_parent_record_id')
@@@

to `#preload_has_and_belongs_to_many_association`, but I think this is a more general issue. Instead, it seems that when `#load_target` is called by `#count_records`, the target is already loaded. I've attached a patch. (Applies to master and 2-3-stable).

I'm also unsure if this is the optimal way (alternative, `options[:select] = 'DISTINCT *'`).</body>
      <body-html>&lt;div&gt;&lt;p&gt;Also, this is my take on patching the issue. I thought of adding
something like (-190,6 +190,7):&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;+  associated_records.uniq! if options[:uniq]
   set_association_collection_records(id_to_record_map, reflection.name, associated_records, 'the_parent_record_id')&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;to &lt;code&gt;#preload_has_and_belongs_to_many_association&lt;/code&gt;,
but I think this is a more general issue. Instead, it seems that
when &lt;code&gt;#load_target&lt;/code&gt; is called by
&lt;code&gt;#count_records&lt;/code&gt;, the target is already loaded. I've
attached a patch. (Applies to master and 2-3-stable).&lt;/p&gt;
&lt;p&gt;I'm also unsure if this is the optimal way (alternative,
&lt;code&gt;options[:select] = 'DISTINCT *'&lt;/code&gt;).&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-09-26T10:38:33+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2009-09-26T10:38:38+01:00</updated-at>
      <user-id type="integer">51191</user-id>
      <version type="integer">6</version>
      <user-name>hsume2 (Henry)</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2009-09-28T10:25:42+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3.3 activerecord bugmash
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash bugmash-review</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2009-09-28T10:25:43+01:00</updated-at>
      <user-id type="integer">51191</user-id>
      <version type="integer">7</version>
      <user-name>hsume2 (Henry)</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>[[bulk edit](/projects/8994/bulk_edits/13645)]</body>
      <body-html>&lt;div&gt;&lt;p&gt;[&lt;a href=&quot;/projects/8994/bulk_edits/13645&quot;&gt;bulk edit&lt;/a&gt;]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-02-12T12:46:16+00:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3.3 activerecord bugmash bugmash-review
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash-review</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2010-02-12T12:46:16+00:00</updated-at>
      <user-id type="integer">65556</user-id>
      <version type="integer">8</version>
      <user-name>Rizwan Reza</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>[[bulk edit](/projects/8994/bulk_edits/20085)]</body>
      <body-html>&lt;div&gt;&lt;p&gt;[&lt;a href=&quot;/projects/8994/bulk_edits/20085&quot;&gt;bulk edit&lt;/a&gt;]&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-05-15T18:45:39+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3.3 activerecord bugmash-review
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2010-05-15T18:45:39+01:00</updated-at>
      <user-id type="integer">65556</user-id>
      <version type="integer">9</version>
      <user-name>Rizwan Reza</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>Henry can you update your patch it seems your patch link is broken.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Henry can you update your patch it seems your patch link is
broken.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-07-17T14:14:26+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- 
:priority: 0
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">135191</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2010-07-17T14:14:28+01:00</updated-at>
      <user-id type="integer">54456</user-id>
      <version type="integer">10</version>
      <user-name>Subba</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>I've attached reworked patches for master and 2-3-stable. The implementation is slightly different than previously specified. Instead of 

@@@ ruby
associated_records.uniq! if options[:uniq]
@@@

I've gone the `DISTINCT` method, because that seems to be the behavior for `has_many :through` with `:uniq =&gt; true` and custom `:select` (see `construct_select` in `through_association_scope.rb:48`).</body>
      <body-html>&lt;div&gt;&lt;p&gt;I've attached reworked patches for master and 2-3-stable. The
implementation is slightly different than previously specified.
Instead of&lt;/p&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;associated_records.uniq! if options[:uniq]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;I've gone the &lt;code&gt;DISTINCT&lt;/code&gt; method, because that seems
to be the behavior for &lt;code&gt;has_many :through&lt;/code&gt; with
&lt;code&gt;:uniq =&amp;gt; true&lt;/code&gt; and custom &lt;code&gt;:select&lt;/code&gt; (see
&lt;code&gt;construct_select&lt;/code&gt; in
&lt;code&gt;through_association_scope.rb:48&lt;/code&gt;).&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-07-17T19:29:04+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">135191</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2010-07-17T19:29:06+01:00</updated-at>
      <user-id type="integer">51191</user-id>
      <version type="integer">11</version>
      <user-name>hsume2 (Henry)</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title nil="true"></milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">5</attachments-count>
      <body>@Henry looks like you were not in the rails root directory while creating the patch. I tried applying rails edge patch and it failed.

Could you please create that patch again. thanks.</body>
      <body-html>&lt;div&gt;&lt;p&gt;@Henry looks like you were not in the rails root directory while
creating the patch. I tried applying rails edge patch and it
failed.&lt;/p&gt;
&lt;p&gt;Could you please create that patch again. thanks.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-07-18T14:27:25+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- 
:milestone: 
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">135191</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2010-07-18T14:27:29+01:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">12</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title>3.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">5</attachments-count>
      <body>Sure, here are the patches created from rails root.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Sure, here are the patches created from rails root.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-07-18T18:15:18+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">135191</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2010-07-18T18:15:21+01:00</updated-at>
      <user-id type="integer">51191</user-id>
      <version type="integer">13</version>
      <user-name>hsume2 (Henry)</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title>3.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">7</attachments-count>
      <body>not sure why but I am still getting the error while applying your patch

@@@ ruby
(master)$ git am &lt; patch.txt 
Applying: Fix a bug where eager loading of a :uniq =&gt; true has_and_belongs_to_many returns duplicate entries
error: activerecord/lib/active_record/association_preload.rb: does not match index
error: activerecord/test/cases/associations/has_and_belongs_to_many_associations_test.rb: does not match index
Patch failed at 0001 Fix a bug where eager loading of a :uniq =&gt; true has_and_belongs_to_many returns duplicate entries
When you have resolved this problem run &quot;git am --resolved&quot;.
If you would prefer to skip this patch, instead run &quot;git am --skip&quot;.
To restore the original branch and stop patching run &quot;git am --abort&quot;.

@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;not sure why but I am still getting the error while applying
your patch&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;(master)$ git am &amp;lt; patch.txt 
Applying: Fix a bug where eager loading of a :uniq =&amp;gt; true has_and_belongs_to_many returns duplicate entries
error: activerecord/lib/active_record/association_preload.rb: does not match index
error: activerecord/test/cases/associations/has_and_belongs_to_many_associations_test.rb: does not match index
Patch failed at 0001 Fix a bug where eager loading of a :uniq =&amp;gt; true has_and_belongs_to_many returns duplicate entries
When you have resolved this problem run &quot;git am --resolved&quot;.
If you would prefer to skip this patch, instead run &quot;git am --skip&quot;.
To restore the original branch and stop patching run &quot;git am --abort&quot;.&lt;/code&gt;
&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-07-18T20:41:02+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">135191</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2010-07-18T20:41:04+01:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">14</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title>3.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">7</attachments-count>
      <body>@Neeraj, I'm not sure why either. I've applied the patch multiple times today at different commits, most recently on [387036609268c4cf68401a1333715f2ee4aecffc], and it's worked.

It looks like you've had a few patches accepted recently, did you reset the branch and pull from master before you applied my patch? Or do you have any unstaged changes on `association_preload.rb` or `has_and_belongs_to_many_associations_test.rb`?</body>
      <body-html>&lt;div&gt;&lt;p&gt;@Neeraj, I'm not sure why either. I've applied the patch
multiple times today at different commits, most recently on
&lt;a href=&quot;/projects/8994/changesets/387036609268c4cf68401a1333715f2ee4aecffc&quot;
title=
&quot;Changeset [387036609268c4cf68401a1333715f2ee4aecffc]&quot;&gt;[387036609268c4cf68401a1333715f2ee4aecffc]&lt;/a&gt;,
and it's worked.&lt;/p&gt;
&lt;p&gt;It looks like you've had a few patches accepted recently, did
you reset the branch and pull from master before you applied my
patch? Or do you have any unstaged changes on
&lt;code&gt;association_preload.rb&lt;/code&gt; or
&lt;code&gt;has_and_belongs_to_many_associations_test.rb&lt;/code&gt;?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-07-18T21:03:14+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">135191</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2010-07-18T21:03:17+01:00</updated-at>
      <user-id type="integer">51191</user-id>
      <version type="integer">15</version>
      <user-name>hsume2 (Henry)</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title>3.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">7</attachments-count>
      <body>I checked out brand new rails app before applying the patch. Well someone else will verify your patch.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I checked out brand new rails app before applying the patch.
Well someone else will verify your patch.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-07-18T21:15:31+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">135191</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2010-07-18T21:15:32+01:00</updated-at>
      <user-id type="integer">40263</user-id>
      <version type="integer">16</version>
      <user-name>Neeraj Singh</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title>3.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">7</attachments-count>
      <body>Okay, that's pretty weird. Well thanks anyway.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Okay, that's pretty weird. Well thanks anyway.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-07-18T22:04:09+01:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">135191</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>2.3.3 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2010-07-18T22:04:10+01:00</updated-at>
      <user-id type="integer">51191</user-id>
      <version type="integer">17</version>
      <user-name>hsume2 (Henry)</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title>3.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">7</attachments-count>
      <body>This issue has been automatically marked as stale because it has not been commented on for at least three months.

The resources of the Rails core team are limited, and so we are asking for your help. If you can still reproduce this error on the 3-0-stable branch or on master, please reply with all of the information you have about it and add &quot;[state:open]&quot; to your comment. This will reopen the ticket for review. Likewise, if you feel that this is a very important feature for Rails to include, please reply with your explanation so we can consider it.

Thank you for all your contributions, and we hope you will understand this step to focus our efforts where they are most helpful.</body>
      <body-html>&lt;div&gt;&lt;p&gt;This issue has been automatically marked as stale because it has
not been commented on for at least three months.&lt;/p&gt;
&lt;p&gt;The resources of the Rails core team are limited, and so we are
asking for your help. If you can still reproduce this error on the
3-0-stable branch or on master, please reply with all of the
information you have about it and add &quot;[state:open]&quot; to your
comment. This will reopen the ticket for review. Likewise, if you
feel that this is a very important feature for Rails to include,
please reply with your explanation so we can consider it.&lt;/p&gt;
&lt;p&gt;Thank you for all your contributions, and we hope you will
understand this step to focus our efforts where they are most
helpful.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2011-02-02T16:35:44+00:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 2.3.3 activerecord bugmash
:state: new
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">135191</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>233 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2011-02-02T17:11:15+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">18</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title>3.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">7</attachments-count>
      <body nil="true"></body>
      <body-html nil="true"></body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2011-02-02T16:35:45+00:00</created-at>
      <creator-id type="integer">26521</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer">71472</milestone-id>
      <number type="integer">3108</number>
      <permalink>eager-loading-uniq-habtm-association-is-broken</permalink>
      <priority type="integer">135191</priority>
      <project-id type="integer">8994</project-id>
      <state>stale</state>
      <tag>233 activerecord bugmash</tag>
      <title>Eager loading uniq habtm association is broken</title>
      <updated-at type="datetime">2011-02-02T17:11:25+00:00</updated-at>
      <user-id type="integer">40272</user-id>
      <version type="integer">19</version>
      <user-name>Santiago Pastorino</user-name>
      <creator-name>Niels Meersschaert</creator-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3108</url>
      <milestone-title>3.x</milestone-title>
      <priority-name nil="true"></priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>a4511fc1ba2f0bfc474088b99db8db3be4b93905</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2009-09-26T04:38:24+01:00</created-at>
      <filename>LH3108-eager_loading_uniq_habtm_with_duplicate_entries_test.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">279328</id>
      <size type="integer">1992</size>
      <uploader-id type="integer">36381</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/279328/LH3108-eager_loading_uniq_habtm_with_duplicate_entries_test.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>e138f253fb49108a611c580aa48a07b2271c590b</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2009-09-26T10:07:17+01:00</created-at>
      <filename>LH3108-eager_loading_uniq_habtm_with_duplicate_entries_test2.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">279351</id>
      <size type="integer">1451</size>
      <uploader-id type="integer">51191</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/279351/LH3108-eager_loading_uniq_habtm_with_duplicate_entries_test2.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>ff1424adb55e6a0d2d09f6559a2e4e96384d71fe</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2009-09-26T10:38:33+01:00</created-at>
      <filename>LH3108-eager_loading_uniq_habtm_with_duplicate_entries_master.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">279354</id>
      <size type="integer">2190</size>
      <uploader-id type="integer">51191</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/279354/LH3108-eager_loading_uniq_habtm_with_duplicate_entries_master.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>91d80b96323eb929b2f0c190df92f664ad879e9d</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-07-17T19:29:04+01:00</created-at>
      <filename>lh3108-eager_loading_uniq_habtm_with_duplicate_entries_2_3_stable.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">595682</id>
      <size type="integer">2861</size>
      <uploader-id type="integer">51191</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/595682/lh3108-eager_loading_uniq_habtm_with_duplicate_entries_2_3_stable.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>e4e619ce9096fd62f62edc87a1d22b10e942f4c2</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-07-17T19:29:04+01:00</created-at>
      <filename>lh3108-eager_loading_uniq_habtm_with_duplicate_entries_master.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">595683</id>
      <size type="integer">2778</size>
      <uploader-id type="integer">51191</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/595683/lh3108-eager_loading_uniq_habtm_with_duplicate_entries_master.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>168ae3617e11ff8f959a6a8b175e9ab57156a978</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-07-18T18:15:18+01:00</created-at>
      <filename>lh3108-eager_loading_uniq_habtm_with_duplicate_entries_master.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">595800</id>
      <size type="integer">2778</size>
      <uploader-id type="integer">51191</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/595800/lh3108-eager_loading_uniq_habtm_with_duplicate_entries_master.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>c4e7fc9d586a0a7ff1edcc2bcf63231ffbc7d947</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2010-07-18T18:15:18+01:00</created-at>
      <filename>lh3108-eager_loading_uniq_habtm_with_duplicate_entries_2_3_stable.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">595801</id>
      <size type="integer">2861</size>
      <uploader-id type="integer">51191</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/595801/lh3108-eager_loading_uniq_habtm_with_duplicate_entries_2_3_stable.diff</url>
    </attachment>
  </attachments>
</ticket>
