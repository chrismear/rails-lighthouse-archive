<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">15159</assigned-user-id>
  <attachments-count type="integer">1</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2010-01-24T22:17:22+00:00</created-at>
  <creator-id type="integer">83789</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">3783</number>
  <permalink>saving-object-with-nested-attributes-results-in-duplicates</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>duplicate</state>
  <tag>associations duplicate &quot;nested attributes&quot;</tag>
  <title>Saving object with nested attributes results in duplicates</title>
  <updated-at type="datetime">2010-02-16T23:29:20+00:00</updated-at>
  <user-id type="integer">19965</user-id>
  <version type="integer">6</version>
  <user-name>Jos&#233; Valim</user-name>
  <creator-name>FrankPinto</creator-name>
  <assigned-user-name>Mikel Lindsaar</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/3783</url>
  <priority-name>Low</priority-name>
  <original-body>I've looked for this problem in other tickets but nobody seems to have run across it.

# Problem/Issue Description #
I use forms and nested attributes to create an Album. An album has many tracks, a track has many artists. When the Album gets saved (not on instantiation), each artist gets attached to its corresponding track twice. Here's my code, I've included relevant fields:

@@@ ruby
class Album &lt; ActiveRecord::Base
  has_many :tracks, :dependent =&gt; :destroy

  accepts_nested_attributes_for :tracks
end

class Track &lt; ActiveRecord::Base
  belongs_to :album
  has_and_belongs_to_many :artists
  has_and_belongs_to_many :composers

  accepts_nested_attributes_for :artists, :composers
end

#Fields: first_name:string last_name:string
class Artist &lt; ActiveRecord::Base
  has_and_belongs_to_many :tracks
end
@@@

## Testing in console: ##
@@@ ruby
&gt;&gt; a = Album.new(&quot;tracks_attributes&quot;=&gt;{&quot;0&quot;=&gt;{&quot;artists_attributes&quot;=&gt;{&quot;0&quot;=&gt;{&quot;first_name&quot;=&gt;&quot;F
rank&quot;,&quot;last_name&quot;=&gt;&quot;Pinto&quot;},&quot;1&quot;=&gt;{&quot;first_name&quot;=&gt;&quot;Kevin&quot;,&quot;last_name&quot;=&gt;&quot;Anthony&quot;}}}})
=&gt; #&lt;Album id: nil, title: nil, release_date: nil, release_location: nil, group_size: nil,
 kind: nil, personnel: nil, notes: nil, created_at: nil, updated_at: nil, cover_file_name:
 nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks
=&gt; [#&lt;Track id: nil, album_id: nil, number: nil, title: nil, duration_in_seconds: nil, cre
ated_at: nil, updated_at: nil&gt;]
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: nil, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: nil,
updated_at: nil&gt;, #&lt;Artist id: nil, first_name: &quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, c
reated_at: nil, updated_at: nil&gt;]
&gt;&gt; a.save
=&gt; true
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.reload
=&gt; #&lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;, #&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&gt;]
@@@

# Attempts to Fix #
Any attempt to assign a modified array to the object doesn't work: 
@@@
&gt;&gt; new_artists = a.tracks.first.artists[0,a.tracks.first.artists.length/2]
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.tracks.first.artists = new_artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.save
=&gt; true
&gt;&gt; a.reload
=&gt; #&lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;, #&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&gt;]
@@@
or:
@@@
&gt;&gt; a.tracks.first.artists.uniq!
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.save
=&gt; true
&gt;&gt; a.reload
=&gt; #&lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;, #&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&gt;]
@@@

Any insight into where the issue might be would be much appreciated.

-Frank</original-body>
  <latest-body>I've looked for this problem in other tickets but nobody seems to have run across it.

# Problem/Issue Description #
I use forms and nested attributes to create an Album. An album has many tracks, a track has many artists. When the Album gets saved (not on instantiation), each artist gets attached to its corresponding track twice. Here's my code, I've included relevant fields:

@@@ ruby
class Album &lt; ActiveRecord::Base
  has_many :tracks, :dependent =&gt; :destroy

  accepts_nested_attributes_for :tracks
end

class Track &lt; ActiveRecord::Base
  belongs_to :album
  has_and_belongs_to_many :artists
  has_and_belongs_to_many :composers

  accepts_nested_attributes_for :artists, :composers
end

#Fields: first_name:string last_name:string
class Artist &lt; ActiveRecord::Base
  has_and_belongs_to_many :tracks
end
@@@

## Testing in console: ##
@@@ ruby
&gt;&gt; a = Album.new(&quot;tracks_attributes&quot;=&gt;{&quot;0&quot;=&gt;{&quot;artists_attributes&quot;=&gt;{&quot;0&quot;=&gt;{&quot;first_name&quot;=&gt;&quot;F
rank&quot;,&quot;last_name&quot;=&gt;&quot;Pinto&quot;},&quot;1&quot;=&gt;{&quot;first_name&quot;=&gt;&quot;Kevin&quot;,&quot;last_name&quot;=&gt;&quot;Anthony&quot;}}}})
=&gt; #&lt;Album id: nil, title: nil, release_date: nil, release_location: nil, group_size: nil,
 kind: nil, personnel: nil, notes: nil, created_at: nil, updated_at: nil, cover_file_name:
 nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks
=&gt; [#&lt;Track id: nil, album_id: nil, number: nil, title: nil, duration_in_seconds: nil, cre
ated_at: nil, updated_at: nil&gt;]
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: nil, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: nil,
updated_at: nil&gt;, #&lt;Artist id: nil, first_name: &quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, c
reated_at: nil, updated_at: nil&gt;]
&gt;&gt; a.save
=&gt; true
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.reload
=&gt; #&lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;, #&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&gt;]
@@@

# Attempts to Fix #
Any attempt to assign a modified array to the object doesn't work: 
@@@
&gt;&gt; new_artists = a.tracks.first.artists[0,a.tracks.first.artists.length/2]
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.tracks.first.artists = new_artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.save
=&gt; true
&gt;&gt; a.reload
=&gt; #&lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;, #&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&gt;]
@@@
or:
@@@
&gt;&gt; a.tracks.first.artists.uniq!
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.save
=&gt; true
&gt;&gt; a.reload
=&gt; #&lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;, #&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&gt;]
@@@

Any insight into where the issue might be would be much appreciated.

-Frank</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;I've looked for this problem in other tickets but nobody seems
to have run across it.&lt;/p&gt;
&lt;h1&gt;Problem/Issue Description&lt;/h1&gt;
&lt;p&gt;I use forms and nested attributes to create an Album. An album
has many tracks, a track has many artists. When the Album gets
saved (not on instantiation), each artist gets attached to its
corresponding track twice. Here's my code, I've included relevant
fields:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;class Album &amp;lt; ActiveRecord::Base
  has_many :tracks, :dependent =&amp;gt; :destroy

  accepts_nested_attributes_for :tracks
end

class Track &amp;lt; ActiveRecord::Base
  belongs_to :album
  has_and_belongs_to_many :artists
  has_and_belongs_to_many :composers

  accepts_nested_attributes_for :artists, :composers
end

#Fields: first_name:string last_name:string
class Artist &amp;lt; ActiveRecord::Base
  has_and_belongs_to_many :tracks
end&lt;/code&gt;
&lt;/pre&gt;
&lt;h2&gt;Testing in console:&lt;/h2&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;&amp;gt;&amp;gt; a = Album.new(&quot;tracks_attributes&quot;=&amp;gt;{&quot;0&quot;=&amp;gt;{&quot;artists_attributes&quot;=&amp;gt;{&quot;0&quot;=&amp;gt;{&quot;first_name&quot;=&amp;gt;&quot;F
rank&quot;,&quot;last_name&quot;=&amp;gt;&quot;Pinto&quot;},&quot;1&quot;=&amp;gt;{&quot;first_name&quot;=&amp;gt;&quot;Kevin&quot;,&quot;last_name&quot;=&amp;gt;&quot;Anthony&quot;}}}})
=&amp;gt; #&amp;lt;Album id: nil, title: nil, release_date: nil, release_location: nil, group_size: nil,
 kind: nil, personnel: nil, notes: nil, created_at: nil, updated_at: nil, cover_file_name:
 nil, cover_content_type: nil&amp;gt;
&amp;gt;&amp;gt; a.tracks
=&amp;gt; [#&amp;lt;Track id: nil, album_id: nil, number: nil, title: nil, duration_in_seconds: nil, cre
ated_at: nil, updated_at: nil&amp;gt;]
&amp;gt;&amp;gt; a.tracks.first.artists
=&amp;gt; [#&amp;lt;Artist id: nil, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: nil,
updated_at: nil&amp;gt;, #&amp;lt;Artist id: nil, first_name: &quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, c
reated_at: nil, updated_at: nil&amp;gt;]
&amp;gt;&amp;gt; a.save
=&amp;gt; true
&amp;gt;&amp;gt; a.tracks.first.artists
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;]
&amp;gt;&amp;gt; a.reload
=&amp;gt; #&amp;lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&amp;gt;
&amp;gt;&amp;gt; a.tracks.first.artists
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&amp;gt;]&lt;/code&gt;
&lt;/pre&gt;
&lt;h1&gt;Attempts to Fix&lt;/h1&gt;
&lt;p&gt;Any attempt to assign a modified array to the object doesn't
work:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;&amp;gt;&amp;gt; new_artists = a.tracks.first.artists[0,a.tracks.first.artists.length/2]
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;]
&amp;gt;&amp;gt; a.tracks.first.artists = new_artists
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;]
&amp;gt;&amp;gt; a.save
=&amp;gt; true
&amp;gt;&amp;gt; a.reload
=&amp;gt; #&amp;lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&amp;gt;
&amp;gt;&amp;gt; a.tracks.first.artists
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&amp;gt;]&lt;/code&gt;
&lt;/pre&gt;
or:&lt;br&gt;
&lt;pre&gt;
&lt;code&gt;&amp;gt;&amp;gt; a.tracks.first.artists.uniq!
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;]
&amp;gt;&amp;gt; a.save
=&amp;gt; true
&amp;gt;&amp;gt; a.reload
=&amp;gt; #&amp;lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&amp;gt;
&amp;gt;&amp;gt; a.tracks.first.artists
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&amp;gt;]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Any insight into where the issue might be would be much
appreciated.&lt;/p&gt;
&lt;p&gt;-Frank&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>I've looked for this problem in other tickets but nobody seems to have run across it.

# Problem/Issue Description #
I use forms and nested attributes to create an Album. An album has many tracks, a track has many artists. When the Album gets saved (not on instantiation), each artist gets attached to its corresponding track twice. Here's my code, I've included relevant fields:

@@@ ruby
class Album &lt; ActiveRecord::Base
  has_many :tracks, :dependent =&gt; :destroy

  accepts_nested_attributes_for :tracks
end

class Track &lt; ActiveRecord::Base
  belongs_to :album
  has_and_belongs_to_many :artists
  has_and_belongs_to_many :composers

  accepts_nested_attributes_for :artists, :composers
end

#Fields: first_name:string last_name:string
class Artist &lt; ActiveRecord::Base
  has_and_belongs_to_many :tracks
end
@@@

## Testing in console: ##
@@@ ruby
&gt;&gt; a = Album.new(&quot;tracks_attributes&quot;=&gt;{&quot;0&quot;=&gt;{&quot;artists_attributes&quot;=&gt;{&quot;0&quot;=&gt;{&quot;first_name&quot;=&gt;&quot;F
rank&quot;,&quot;last_name&quot;=&gt;&quot;Pinto&quot;},&quot;1&quot;=&gt;{&quot;first_name&quot;=&gt;&quot;Kevin&quot;,&quot;last_name&quot;=&gt;&quot;Anthony&quot;}}}})
=&gt; #&lt;Album id: nil, title: nil, release_date: nil, release_location: nil, group_size: nil,
 kind: nil, personnel: nil, notes: nil, created_at: nil, updated_at: nil, cover_file_name:
 nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks
=&gt; [#&lt;Track id: nil, album_id: nil, number: nil, title: nil, duration_in_seconds: nil, cre
ated_at: nil, updated_at: nil&gt;]
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: nil, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: nil,
updated_at: nil&gt;, #&lt;Artist id: nil, first_name: &quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, c
reated_at: nil, updated_at: nil&gt;]
&gt;&gt; a.save
=&gt; true
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.reload
=&gt; #&lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;, #&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&gt;]
@@@

# Attempts to Fix #
Any attempt to assign a modified array to the object doesn't work: 
@@@
&gt;&gt; new_artists = a.tracks.first.artists[0,a.tracks.first.artists.length/2]
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.tracks.first.artists = new_artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.save
=&gt; true
&gt;&gt; a.reload
=&gt; #&lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;, #&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&gt;]
@@@
or:
@@@
&gt;&gt; a.tracks.first.artists.uniq!
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;]
&gt;&gt; a.save
=&gt; true
&gt;&gt; a.reload
=&gt; #&lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&gt;
&gt;&gt; a.tracks.first.artists
=&gt; [#&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&gt;, #&lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&gt;, #&lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&gt;]
@@@

Any insight into where the issue might be would be much appreciated.

-Frank</body>
      <body-html>&lt;div&gt;&lt;p&gt;I've looked for this problem in other tickets but nobody seems
to have run across it.&lt;/p&gt;
&lt;h1&gt;Problem/Issue Description&lt;/h1&gt;
&lt;p&gt;I use forms and nested attributes to create an Album. An album
has many tracks, a track has many artists. When the Album gets
saved (not on instantiation), each artist gets attached to its
corresponding track twice. Here's my code, I've included relevant
fields:&lt;/p&gt;
&lt;pre&gt;
&lt;code class=&quot;ruby&quot;&gt;class Album &amp;lt; ActiveRecord::Base
  has_many :tracks, :dependent =&amp;gt; :destroy

  accepts_nested_attributes_for :tracks
end

class Track &amp;lt; ActiveRecord::Base
  belongs_to :album
  has_and_belongs_to_many :artists
  has_and_belongs_to_many :composers

  accepts_nested_attributes_for :artists, :composers
end

#Fields: first_name:string last_name:string
class Artist &amp;lt; ActiveRecord::Base
  has_and_belongs_to_many :tracks
end&lt;/code&gt;
&lt;/pre&gt;
&lt;h2&gt;Testing in console:&lt;/h2&gt;
&lt;pre&gt;
&lt;code class=
&quot;ruby&quot;&gt;&amp;gt;&amp;gt; a = Album.new(&quot;tracks_attributes&quot;=&amp;gt;{&quot;0&quot;=&amp;gt;{&quot;artists_attributes&quot;=&amp;gt;{&quot;0&quot;=&amp;gt;{&quot;first_name&quot;=&amp;gt;&quot;F
rank&quot;,&quot;last_name&quot;=&amp;gt;&quot;Pinto&quot;},&quot;1&quot;=&amp;gt;{&quot;first_name&quot;=&amp;gt;&quot;Kevin&quot;,&quot;last_name&quot;=&amp;gt;&quot;Anthony&quot;}}}})
=&amp;gt; #&amp;lt;Album id: nil, title: nil, release_date: nil, release_location: nil, group_size: nil,
 kind: nil, personnel: nil, notes: nil, created_at: nil, updated_at: nil, cover_file_name:
 nil, cover_content_type: nil&amp;gt;
&amp;gt;&amp;gt; a.tracks
=&amp;gt; [#&amp;lt;Track id: nil, album_id: nil, number: nil, title: nil, duration_in_seconds: nil, cre
ated_at: nil, updated_at: nil&amp;gt;]
&amp;gt;&amp;gt; a.tracks.first.artists
=&amp;gt; [#&amp;lt;Artist id: nil, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: nil,
updated_at: nil&amp;gt;, #&amp;lt;Artist id: nil, first_name: &quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, c
reated_at: nil, updated_at: nil&amp;gt;]
&amp;gt;&amp;gt; a.save
=&amp;gt; true
&amp;gt;&amp;gt; a.tracks.first.artists
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;]
&amp;gt;&amp;gt; a.reload
=&amp;gt; #&amp;lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&amp;gt;
&amp;gt;&amp;gt; a.tracks.first.artists
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&amp;gt;]&lt;/code&gt;
&lt;/pre&gt;
&lt;h1&gt;Attempts to Fix&lt;/h1&gt;
&lt;p&gt;Any attempt to assign a modified array to the object doesn't
work:&lt;br&gt;&lt;/p&gt;
&lt;pre&gt;
&lt;code&gt;&amp;gt;&amp;gt; new_artists = a.tracks.first.artists[0,a.tracks.first.artists.length/2]
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;]
&amp;gt;&amp;gt; a.tracks.first.artists = new_artists
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;]
&amp;gt;&amp;gt; a.save
=&amp;gt; true
&amp;gt;&amp;gt; a.reload
=&amp;gt; #&amp;lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&amp;gt;
&amp;gt;&amp;gt; a.tracks.first.artists
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&amp;gt;]&lt;/code&gt;
&lt;/pre&gt;
or:&lt;br&gt;
&lt;pre&gt;
&lt;code&gt;&amp;gt;&amp;gt; a.tracks.first.artists.uniq!
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;]
&amp;gt;&amp;gt; a.save
=&amp;gt; true
&amp;gt;&amp;gt; a.reload
=&amp;gt; #&amp;lt;Album id: 9, title: nil, release_date: nil, release_location: nil, group_size: nil, k
ind: nil, personnel: nil, notes: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010
-01-24 22:03:59&quot;, cover_file_name: nil, cover_content_type: nil&amp;gt;
&amp;gt;&amp;gt; a.tracks.first.artists
=&amp;gt; [#&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at: &quot;2010-0
1-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name: &quot;Kevin&quot;,
last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24
 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 9, first_name: &quot;Frank&quot;, last_name: &quot;Pinto&quot;, bio: nil, created_at
: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2010-01-24 22:03:59&quot;&amp;gt;, #&amp;lt;Artist id: 10, first_name:
&quot;Kevin&quot;, last_name: &quot;Anthony&quot;, bio: nil, created_at: &quot;2010-01-24 22:03:59&quot;, updated_at: &quot;2
010-01-24 22:03:59&quot;&amp;gt;]&lt;/code&gt;
&lt;/pre&gt;
&lt;p&gt;Any insight into where the issue might be would be much
appreciated.&lt;/p&gt;
&lt;p&gt;-Frank&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-24T22:17:22+00:00</created-at>
      <creator-id type="integer">83789</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3783</number>
      <permalink>saving-object-with-nested-attributes-results-in-duplicates</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>associations duplicate &quot;nested attributes&quot;</tag>
      <title>Saving object with nested attributes results in duplicates</title>
      <updated-at type="datetime">2010-01-24T22:17:24+00:00</updated-at>
      <user-id type="integer">83789</user-id>
      <version type="integer">1</version>
      <user-name>FrankPinto</user-name>
      <creator-name>FrankPinto</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3783</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15159</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Hi Frank,

Thanks for the bug report.  But we need to know what version of rails and ruby you are running this on as well.

Also, a failing test case would help this get resolved.

Mikel</body>
      <body-html>&lt;div&gt;&lt;p&gt;Hi Frank,&lt;/p&gt;
&lt;p&gt;Thanks for the bug report. But we need to know what version of
rails and ruby you are running this on as well.&lt;/p&gt;
&lt;p&gt;Also, a failing test case would help this get resolved.&lt;/p&gt;
&lt;p&gt;Mikel&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-24T22:23:49+00:00</created-at>
      <creator-id type="integer">83789</creator-id>
      <diffable-attributes type="yaml">--- 
:assigned_user: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3783</number>
      <permalink>saving-object-with-nested-attributes-results-in-duplicates</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>associations duplicate &quot;nested attributes&quot;</tag>
      <title>Saving object with nested attributes results in duplicates</title>
      <updated-at type="datetime">2010-01-24T22:23:52+00:00</updated-at>
      <user-id type="integer">15159</user-id>
      <version type="integer">2</version>
      <user-name>Mikel Lindsaar</user-name>
      <creator-name>FrankPinto</creator-name>
      <assigned-user-name>Mikel Lindsaar</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3783</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15159</assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>Hi Mikel,

I can confirm this bug:
- Rails 2.3.5 
- ruby 1.8.6 (2008-08-11 patchlevel 287) [i386-mswin32] 

Cannot provide test case but you can find a simple test app attached - please run rake. It's a simple has many through association, created via nested forms (User has many Accounts through AccountUsers). It will create two AccountUsers instead of one.

This worked perfectly with Rails 2.3.4.

Zoltan</body>
      <body-html>&lt;div&gt;&lt;p&gt;Hi Mikel,&lt;/p&gt;
&lt;p&gt;I can confirm this bug:&lt;br&gt;
- Rails 2.3.5 - ruby 1.8.6 (2008-08-11 patchlevel 287)
[i386-mswin32]&lt;/p&gt;
&lt;p&gt;Cannot provide test case but you can find a simple test app
attached - please run rake. It's a simple has many through
association, created via nested forms (User has many Accounts
through AccountUsers). It will create two AccountUsers instead of
one.&lt;/p&gt;
&lt;p&gt;This worked perfectly with Rails 2.3.4.&lt;/p&gt;
&lt;p&gt;Zoltan&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-25T13:36:49+00:00</created-at>
      <creator-id type="integer">83789</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3783</number>
      <permalink>saving-object-with-nested-attributes-results-in-duplicates</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>associations duplicate &quot;nested attributes&quot;</tag>
      <title>Saving object with nested attributes results in duplicates</title>
      <updated-at type="datetime">2010-01-25T13:36:52+00:00</updated-at>
      <user-id type="integer">83872</user-id>
      <version type="integer">3</version>
      <user-name>Zoli</user-name>
      <creator-name>FrankPinto</creator-name>
      <assigned-user-name>Mikel Lindsaar</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3783</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15159</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Hi Mikel,

Sorry for the delay by Zoltan got it right. My specs are also:
Rails 2.3.5
ruby 1.8.6 (2008-08-11 patchlevel 287)[i386-mswin32]

Let me know what else I could do to get this fixed.

Thanks,
Frank</body>
      <body-html>&lt;div&gt;&lt;p&gt;Hi Mikel,&lt;/p&gt;
&lt;p&gt;Sorry for the delay by Zoltan got it right. My specs are
also:&lt;br&gt;
Rails 2.3.5&lt;br&gt;
ruby 1.8.6 (2008-08-11 patchlevel 287)[i386-mswin32]&lt;/p&gt;
&lt;p&gt;Let me know what else I could do to get this fixed.&lt;/p&gt;
&lt;p&gt;Thanks,&lt;br&gt;
Frank&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-01-26T23:39:30+00:00</created-at>
      <creator-id type="integer">83789</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3783</number>
      <permalink>saving-object-with-nested-attributes-results-in-duplicates</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>associations duplicate &quot;nested attributes&quot;</tag>
      <title>Saving object with nested attributes results in duplicates</title>
      <updated-at type="datetime">2010-01-26T23:39:33+00:00</updated-at>
      <user-id type="integer">83789</user-id>
      <version type="integer">4</version>
      <user-name>FrankPinto</user-name>
      <creator-name>FrankPinto</creator-name>
      <assigned-user-name>Mikel Lindsaar</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3783</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15159</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>OK, this ticket is a duplicate, the original one:
https://rails.lighthouseapp.com/projects/8994/tickets/3575-multiple-join-records-when-using-nested_attributes-in-habtm</body>
      <body-html>&lt;div&gt;&lt;p&gt;OK, this ticket is a duplicate, the original one:&lt;br&gt;
&lt;a href=
&quot;https://rails.lighthouseapp.com/projects/8994/tickets/3575-multiple-join-records-when-using-nested_attributes-in-habtm&quot;&gt;
https://rails.lighthouseapp.com/projects/8994/tickets/3575-multiple...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2010-02-12T18:11:12+00:00</created-at>
      <creator-id type="integer">83789</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3783</number>
      <permalink>saving-object-with-nested-attributes-results-in-duplicates</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag>associations duplicate &quot;nested attributes&quot;</tag>
      <title>Saving object with nested attributes results in duplicates</title>
      <updated-at type="datetime">2010-02-12T18:11:14+00:00</updated-at>
      <user-id type="integer">83872</user-id>
      <version type="integer">5</version>
      <user-name>Zoli</user-name>
      <creator-name>FrankPinto</creator-name>
      <assigned-user-name>Mikel Lindsaar</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3783</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">15159</assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2010-02-16T23:29:16+00:00</created-at>
      <creator-id type="integer">83789</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">3783</number>
      <permalink>saving-object-with-nested-attributes-results-in-duplicates</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>duplicate</state>
      <tag>associations duplicate &quot;nested attributes&quot;</tag>
      <title>Saving object with nested attributes results in duplicates</title>
      <updated-at type="datetime">2010-02-16T23:29:20+00:00</updated-at>
      <user-id type="integer">19965</user-id>
      <version type="integer">6</version>
      <user-name>Jos&#233; Valim</user-name>
      <creator-name>FrankPinto</creator-name>
      <assigned-user-name>Mikel Lindsaar</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/3783</url>
      <priority-name nil="true"></priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>9355c25f6e45884addbdbb941baf688652dbd3f0</code>
      <content-type>application/x-download</content-type>
      <created-at type="datetime">2010-01-25T13:36:49+00:00</created-at>
      <filename>duplicate_records_with_nested_forms.zip</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">388542</id>
      <size type="integer">95150</size>
      <uploader-id type="integer">83872</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/388542/duplicate_records_with_nested_forms.zip</url>
    </attachment>
  </attachments>
</ticket>
