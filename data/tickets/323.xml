<?xml version="1.0" encoding="UTF-8"?>
<ticket>
  <assigned-user-id type="integer">1366</assigned-user-id>
  <attachments-count type="integer">6</attachments-count>
  <closed type="boolean">true</closed>
  <created-at type="datetime">2008-06-03T21:05:56+01:00</created-at>
  <creator-id type="integer">14510</creator-id>
  <milestone-due-on type="datetime" nil="true"></milestone-due-on>
  <milestone-id type="integer" nil="true"></milestone-id>
  <number type="integer">323</number>
  <permalink>has_many-through-belongs_to_association-bug</permalink>
  <priority type="integer">3</priority>
  <project-id type="integer">8994</project-id>
  <raw-data type="binary" nil="true" encoding="base64"></raw-data>
  <state>resolved</state>
  <tag>activerecord bug patch</tag>
  <title>has_many :through =&gt; belongs_to_association bug</title>
  <updated-at type="datetime">2009-02-10T21:03:52+00:00</updated-at>
  <user-id type="integer">2877</user-id>
  <version type="integer">29</version>
  <user-name>Corey</user-name>
  <creator-name>Zach Dennis</creator-name>
  <assigned-user-name>Pratik</assigned-user-name>
  <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
  <priority-name>Low</priority-name>
  <original-body>If you declare a has many association through a belongs_to association it will generate invalid SQL and your database will complain.

For example the below has many association would die.

@@@ ruby
class Day
   belongs_to :trip
   has_many :expenses, :through =&gt; :trip
end

Day.first.expenses # dies without the attached patch. 

# Failing output:
SQLite3::SQLException: no such column: trips.trip_id: SELECT &quot;expenses&quot;.* FROM &quot;expenses&quot; INNER JOIN trips ON exp
enses.trip_id = trips.id WHERE ((&quot;trips&quot;.trip_id = 1) AND ((&quot;expenses&quot;.&quot;date&quot; = 'today')))
@@@

In the context of a has many through association when the through association is a belongs_to, the primary key that needs to be the through table's primary key. This only needs to happen in the context of a has many :through though. 

Attached is a patch which fixes the issue. It is a very simple and straightforward patch.  Thoughts?</original-body>
  <latest-body>If you declare a has many association through a belongs_to association it will generate invalid SQL and your database will complain.

For example the below has many association would die.

@@@ ruby
class Day
   belongs_to :trip
   has_many :expenses, :through =&gt; :trip
end

Day.first.expenses # dies without the attached patch. 

# Failing output:
SQLite3::SQLException: no such column: trips.trip_id: SELECT &quot;expenses&quot;.* FROM &quot;expenses&quot; INNER JOIN trips ON exp
enses.trip_id = trips.id WHERE ((&quot;trips&quot;.trip_id = 1) AND ((&quot;expenses&quot;.&quot;date&quot; = 'today')))
@@@

In the context of a has many through association when the through association is a belongs_to, the primary key that needs to be the through table's primary key. This only needs to happen in the context of a has many :through though. 

Attached is a patch which fixes the issue. It is a very simple and straightforward patch.  Thoughts?</latest-body>
  <original-body-html>&lt;div&gt;&lt;p&gt;
If you declare a has many association through a belongs_to association it will generate invalid SQL and your database will complain.
&lt;/p&gt;&lt;p&gt;
For example the below has many association would die.
&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;ruby&quot;&gt;class Day
   belongs_to :trip
   has_many :expenses, :through =&amp;gt; :trip
end

Day.first.expenses # dies without the attached patch. 

# Failing output:
SQLite3::SQLException: no such column: trips.trip_id: SELECT &amp;quot;expenses&amp;quot;.* FROM &amp;quot;expenses&amp;quot; INNER JOIN trips ON exp
enses.trip_id = trips.id WHERE ((&amp;quot;trips&amp;quot;.trip_id = 1) AND ((&amp;quot;expenses&amp;quot;.&amp;quot;date&amp;quot; = 'today')))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;
In the context of a has many through association when the through association is a belongs_to, the primary key that needs to be the through table's primary key. This only needs to happen in the context of a has many :through though.
&lt;/p&gt;&lt;p&gt;
Attached is a patch which fixes the issue. It is a very simple and straightforward patch.  Thoughts?
&lt;/p&gt;&lt;/div&gt;</original-body-html>
  <versions type="array">
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">0</attachments-count>
      <body>If you declare a has many association through a belongs_to association it will generate invalid SQL and your database will complain.

For example the below has many association would die.

@@@ ruby
class Day
   belongs_to :trip
   has_many :expenses, :through =&gt; :trip
end

Day.first.expenses # dies without the attached patch. 

# Failing output:
SQLite3::SQLException: no such column: trips.trip_id: SELECT &quot;expenses&quot;.* FROM &quot;expenses&quot; INNER JOIN trips ON exp
enses.trip_id = trips.id WHERE ((&quot;trips&quot;.trip_id = 1) AND ((&quot;expenses&quot;.&quot;date&quot; = 'today')))
@@@

In the context of a has many through association when the through association is a belongs_to, the primary key that needs to be the through table's primary key. This only needs to happen in the context of a has many :through though. 

Attached is a patch which fixes the issue. It is a very simple and straightforward patch.  Thoughts?</body>
      <body-html>&lt;div&gt;&lt;p&gt;
If you declare a has many association through a belongs_to association it will generate invalid SQL and your database will complain.
&lt;/p&gt;&lt;p&gt;
For example the below has many association would die.
&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;ruby&quot;&gt;class Day
   belongs_to :trip
   has_many :expenses, :through =&amp;gt; :trip
end

Day.first.expenses # dies without the attached patch. 

# Failing output:
SQLite3::SQLException: no such column: trips.trip_id: SELECT &amp;quot;expenses&amp;quot;.* FROM &amp;quot;expenses&amp;quot; INNER JOIN trips ON exp
enses.trip_id = trips.id WHERE ((&amp;quot;trips&amp;quot;.trip_id = 1) AND ((&amp;quot;expenses&amp;quot;.&amp;quot;date&amp;quot; = 'today')))&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;
In the context of a has many through association when the through association is a belongs_to, the primary key that needs to be the through table's primary key. This only needs to happen in the context of a has many :through though.
&lt;/p&gt;&lt;p&gt;
Attached is a patch which fixes the issue. It is a very simple and straightforward patch.  Thoughts?
&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-06-03T21:05:57+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-06-03T21:05:57+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">1</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>+1 tests all passing and looks like a valid use of the has_many :through</body>
      <body-html>&lt;div&gt;&lt;p&gt;
+1 tests all passing and looks like a valid use of the has_many :through
&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-06-03T21:16:05+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-06-03T21:16:05+01:00</updated-at>
      <user-id type="integer">1607</user-id>
      <version type="integer">2</version>
      <user-name>Mark Van Holstyn</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>The above output is:

@@@ ruby
SQLite3::SQLException: no such column: trips.trip_id: SELECT &quot;expenses&quot;.* FROM &quot;expenses&quot; INNER JOIN trips ON expenses.trip_id = trips.id WHERE ((&quot;trips&quot;.trip_id = 1)
@@@

The additional conditions was from testing different variations until I found the source of the problem.</body>
      <body-html>&lt;div&gt;&lt;p&gt;
The above output is:
&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;ruby&quot;&gt;SQLite3::SQLException: no such column: trips.trip_id: SELECT &amp;quot;expenses&amp;quot;.* FROM &amp;quot;expenses&amp;quot; INNER JOIN trips ON expenses.trip_id = trips.id WHERE ((&amp;quot;trips&amp;quot;.trip_id = 1)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;
The additional conditions was from testing different variations until I found the source of the problem.
&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-06-03T21:16:15+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-06-03T21:16:15+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">3</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">1</attachments-count>
      <body>Attached is an updated patch. Rather than relying on fixtures this patch creates what it needs inside the test. This forces the implementation to be be updated as well to be correct. 

Apply the attached patch &quot;has_many_through_belongs_to_association.2.diff&quot; by itself, not on top of the original patch. If you have applied the original patch then reset that and apply the latest patch.</body>
      <body-html>&lt;div&gt;&lt;p&gt;
Attached is an updated patch. Rather than relying on fixtures this patch creates what it needs inside the test. This forces the implementation to be be updated as well to be correct.
&lt;/p&gt;&lt;p&gt;
Apply the attached patch &quot;has_many_through_belongs_to_association.2.diff&quot; by itself, not on top of the original patch. If you have applied the original patch then reset that and apply the latest patch.
&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-06-03T22:21:09+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-06-03T22:21:09+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">4</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">2</attachments-count>
      <body>Attached is another update to the patch to cover the below scenario:

@@@ ruby
class Day
  belongs_to :trip
  has_many :expenses, :through =&gt; :trip
end

# - this would blow up since it has no trip, but it should return an empty array
# - this patch has this return an empty array if the day doesn't have a trip_id
Day.new.expenses 
@@@</body>
      <body-html>&lt;div&gt;&lt;p&gt;
Attached is another update to the patch to cover the below scenario:
&lt;/p&gt;
&lt;pre&gt;&lt;code class=&quot;ruby&quot;&gt;class Day
  belongs_to :trip
  has_many :expenses, :through =&amp;gt; :trip
end

# - this would blow up since it has no trip, but it should return an empty array
# - this patch has this return an empty array if the day doesn't have a trip_id
Day.new.expenses &lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-06-04T00:05:17+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-06-04T00:05:17+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">5</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>+1 Tested on mysql.  Approach looks sound.</body>
      <body-html>&lt;div&gt;&lt;p&gt;
+1 Tested on mysql.  Approach looks sound.
&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-06-04T00:58:50+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-06-04T00:58:50+01:00</updated-at>
      <user-id type="integer">8505</user-id>
      <version type="integer">6</version>
      <user-name>Gabe da Silveira</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer" nil="true"></assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>I believe you will need to make some changes to that you can eager load such an association.</body>
      <body-html>&lt;div&gt;&lt;p&gt;
I believe you will need to make some changes to that you can eager load such an association.
&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-06-09T09:06:48+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>new</state>
      <tag nil="true"></tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-06-09T09:06:48+01:00</updated-at>
      <user-id type="integer">17477</user-id>
      <version type="integer">7</version>
      <user-name>Frederick Cheung</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name nil="true"></assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>What fred said. Could you add tests for preloading as well ?

Thanks.</body>
      <body-html>&lt;div&gt;&lt;p&gt;
What fred said. Could you add tests for preloading as well ?
&lt;/p&gt;&lt;p&gt;
Thanks.
&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2008-06-09T11:23:35+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- 
:state: new
:assigned_user: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag nil="true"></tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-06-09T11:23:35+01:00</updated-at>
      <user-id type="integer">1366</user-id>
      <version type="integer">8</version>
      <user-name>Pratik</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>I'm working on updating the patch to incorporate a test for eager loading. I think some refactoring will be underway since the way has many through associations work assumes the structure of a has_one or has_many structure, and using a belongs_to changes things around, at least in regard to what table has the primary key to use, what the primary key field is, etc.

Diligently working on it though,</body>
      <body-html>&lt;div&gt;&lt;p&gt;
I'm working on updating the patch to incorporate a test for eager loading. I think some refactoring will be underway since the way has many through associations work assumes the structure of a has_one or has_many structure, and using a belongs_to changes things around, at least in regard to what table has the primary key to use, what the primary key field is, etc.
&lt;/p&gt;&lt;p&gt;
Diligently working on it though,
&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2008-06-13T03:18:20+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag nil="true"></tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-06-13T03:18:20+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">9</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>The eager loading test is working, but I need to go back and refactor now that everything is working and I understand the code a little better. Here's the current WIP state of things:

http://github.com/zdennis/rails/tree/t323

I'll post an updated patch this weekend. Thanks,</body>
      <body-html>&lt;div&gt;&lt;p&gt;
The eager loading test is working, but I need to go back and refactor now that everything is working and I understand the code a little better. Here's the current WIP state of things:
&lt;/p&gt;&lt;p&gt;
&lt;a href=&quot;http://github.com/zdennis/rails/tree/t323&quot;&gt;http://github.com/zdennis/rails/...&lt;/a&gt;
&lt;/p&gt;&lt;p&gt;
I'll post an updated patch this weekend. Thanks,
&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2008-06-13T04:27:43+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag nil="true"></tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-06-13T04:27:43+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">10</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">3</attachments-count>
      <body>Attached is an updated patch (which replaces the previous ones, don't use them anymore). 

This adds test for eager loading and introduces a simple strategy object for has many associations so the conditional logic for choosing a primary key name or primary key are limited to a single spot.

The association preloading could be refactored into using different preload objects which handle preloading records based on the type of association. This would clean up and simplify how preloading is done IMO. I almost went that route until Craig Demyanovich suggested going the strategy route first since it was much simpler and had less impact on the overall preloading code.</body>
      <body-html>&lt;div&gt;&lt;p&gt;
Attached is an updated patch (which replaces the previous ones, don't use them anymore).
&lt;/p&gt;&lt;p&gt;
This adds test for eager loading and introduces a simple strategy object for has many associations so the conditional logic for choosing a primary key name or primary key are limited to a single spot.
&lt;/p&gt;&lt;p&gt;
The association preloading could be refactored into using different preload objects which handle preloading records based on the type of association. This would clean up and simplify how preloading is done IMO. I almost went that route until Craig Demyanovich suggested going the strategy route first since it was much simpler and had less impact on the overall preloading code.
&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2008-06-20T03:52:39+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag nil="true"></tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-06-20T03:52:39+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">11</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>Ping, any love on this pratik?</body>
      <body-html>&lt;div&gt;&lt;p&gt;
Ping, any love on this pratik?
&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2008-07-10T20:22:27+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- 
:tag: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>incomplete</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-07-10T20:22:27+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">12</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-07-10T20:40:15+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- 
:state: incomplete
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-07-10T20:40:15+01:00</updated-at>
      <user-id type="integer">1366</user-id>
      <version type="integer">13</version>
      <user-name>Pratik</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>I believe the 4th patch is out of date.
Is anyone working on integrating a fix into the core?</body>
      <body-html>&lt;div&gt;&lt;p&gt;I believe the 4th patch is out of date.
Is anyone working on integrating a fix into the core?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-08-07T16:46:45+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-08-07T16:46:45+01:00</updated-at>
      <user-id type="integer">27185</user-id>
      <version type="integer">14</version>
      <user-name>Glenn Powell</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>This does seem like a fairly important bug to be resolved ASAP.  I personally continuously run into a brick wall regarding this, since I opted to bypass the outdated patch and await a core fix (but to no avail).  What is the status of this now?</body>
      <body-html>&lt;div&gt;&lt;p&gt;This does seem like a fairly important bug to be resolved ASAP.  I personally continuously run into a brick wall regarding this, since I opted to bypass the outdated patch and await a core fix (but to no avail).  What is the status of this now?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-08-11T08:15:31+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-08-11T08:15:31+01:00</updated-at>
      <user-id type="integer">27185</user-id>
      <version type="integer">15</version>
      <user-name>Glenn Powell</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>I know core is a busy group of folks and when they're going to give this patch a look I'll update it again. All they need to do is ping the ticket.</body>
      <body-html>&lt;div&gt;&lt;p&gt;I know core is a busy group of folks and when they're going to give this patch a look I'll update it again. All they need to do is ping the ticket.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-08-11T13:30:03+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-08-11T13:30:03+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">16</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">4</attachments-count>
      <body>Can't hurt to ping the rails-core list.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Can't hurt to ping the rails-core list.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-08-11T13:57:14+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-08-11T13:57:14+01:00</updated-at>
      <user-id type="integer">17477</user-id>
      <version type="integer">17</version>
      <user-name>Frederick Cheung</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">5</attachments-count>
      <body>Here's an updated patch to work against Rails today. Please include.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Here's an updated patch to work against Rails today. Please include.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-08-18T21:06:24+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-08-18T21:06:24+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">18</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">5</attachments-count>
      <body>Hey Zach,

I see a lot of tests are commented in your latest patch. Is that intentional ?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Hey Zach,&lt;/p&gt;

&lt;p&gt;I see a lot of tests are commented in your latest patch. Is that intentional ?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-08-19T17:51:46+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-08-19T17:51:46+01:00</updated-at>
      <user-id type="integer">1366</user-id>
      <version type="integer">19</version>
      <user-name>Pratik</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body>Sorry about that. I squashed my several commits into one clean commit. See the latest diff. Thanks,</body>
      <body-html>&lt;div&gt;&lt;p&gt;Sorry about that. I squashed my several commits into one clean commit. See the latest diff. Thanks,&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-08-19T18:29:37+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-08-19T18:29:37+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">20</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body>Pratik,

Any chance you can a look at this?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Pratik,&lt;/p&gt;

&lt;p&gt;Any chance you can a look at this?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-08-23T15:19:01+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-08-23T15:19:01+01:00</updated-at>
      <user-id type="integer">14510</user-id>
      <version type="integer">21</version>
      <user-name>Zach Dennis</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body>Hey,

Sorry for the delay. I don't like this patch a lot. So I've been trying to put this logic inside reflection. Turns out, that'll need me a little more time.

Thanks.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Hey,&lt;/p&gt;
&lt;p&gt;Sorry for the delay. I don't like this patch a lot. So I've been
trying to put this logic inside reflection. Turns out, that'll need
me a little more time.&lt;/p&gt;
&lt;p&gt;Thanks.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-08-29T12:18:10+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug-2</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-08-29T12:18:10+01:00</updated-at>
      <user-id type="integer">1366</user-id>
      <version type="integer">22</version>
      <user-name>Pratik</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body></body>
      <body-html></body-html>
      <closed type="boolean">false</closed>
      <created-at type="datetime">2008-09-15T10:13:30+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- 
:milestone: 
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>open</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-09-15T13:05:26+01:00</updated-at>
      <user-id type="integer">1366</user-id>
      <version type="integer">23</version>
      <user-name>Pratik</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body>(from [95e1cf4812d4b964d7ab0fdf4bfa31177d27909c]) Fix has_many :through when the source is a belongs_to association. [#323 state:resolved]

Signed-off-by: Pratik Naik &lt;pratiknaik@gmail.com&gt;
http://github.com/rails/rails/commit/95e1cf4812d4b964d7ab0fdf4bfa31177d27909c</body>
      <body-html>&lt;div&gt;&lt;p&gt;(from [95e1cf4812d4b964d7ab0fdf4bfa31177d27909c]) Fix has_many
:through when the source is a belongs_to association. [&lt;a href=&quot;/projects/8994/tickets/323&quot; title=&quot;Ticket #323&quot;&gt;#323&lt;/a&gt;
state:resolved]&lt;/p&gt;
&lt;p&gt;Signed-off-by: Pratik Naik &lt;a href=&quot;mailto:pratiknaik@gmail.com&quot;&gt;pratiknaik@gmail.com&lt;/a&gt; &lt;a href=&quot;http://github.com/rails/rails/commit/95e1cf4812d4b964d7ab0fdf4bfa31177d27909c&quot;&gt;
http://github.com/rails/rails/co...&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2008-10-04T17:51:59+01:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- 
:state: open
</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2008-10-04T17:52:03+01:00</updated-at>
      <user-id type="integer">17393</user-id>
      <version type="integer">24</version>
      <user-name>Repository</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body>I'm actually still seeing something which I believe is a result of this problem.  (I am on 2.2, perhaps it's fixed in 2.3)

I have this relationship:

@@@ ruby
class Foo &lt; ActiveRecord::Base
end

class Bar &lt; ActiveRecord::Base
  belongs_to :foo
end

class Bat &lt; ActiveRecord::Base
  belongs_to :bar
  has_one :foo, :through =&gt; :bar
end
@@@

If I call the through attribute directly, then it works:

@@@ ruby
&gt;&gt; Bat.first.foo
=&gt; #&lt;Foo id:1&gt;
@@@

But if I try to include the :foo association in any find conditions, then I get a similar error to the one above.

@@@ ruby
&gt;&gt; Bat.all(:include =&gt; :foo, :conditions =&gt; { 'foos.id' =&gt; 1 })
ActiveRecord::StatementInvalid: Mysql::Error: Unknown column 'bars.bar_id' in 'on clause': SELECT `bats`.`id` AS t0_r0, `bat`.`bar_id` AS t0_r1, `foos`.`id` AS t1_r0 FROM `bats`  LEFT OUTER JOIN `bars` ON (`bats`.`id` = `bars`.`bar_id`)  LEFT OUTER JOIN `foos` ON (`foos`.`id` = `bats`.`foo_id`) WHERE (`foos`.`id` = 1) 
@@@

It seems as though the join on condition (`bats`.`id` = `bars`.`bar_id`) has simply reversed the foreign/primary keys here.  So it should be:
`bats`.`bar_id` = `bars`.`id`
Correct?</body>
      <body-html>&lt;div&gt;&lt;p&gt;I'm actually still seeing something which I believe is a result
of this problem. (I am on 2.2, perhaps it's fixed in 2.3)&lt;/p&gt;
&lt;p&gt;I have this relationship:&lt;/p&gt;


&lt;pre&gt;&lt;code class=&quot;ruby&quot;&gt;
class Foo &amp;lt; ActiveRecord::Base
end

class Bar &amp;lt; ActiveRecord::Base
  belongs_to :foo
end

class Bat &amp;lt; ActiveRecord::Base
  belongs_to :bar
  has_one :foo, :through =&amp;gt; :bar
end
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If I call the through attribute directly, then it works:&lt;/p&gt;


&lt;pre&gt;&lt;code class=&quot;ruby&quot;&gt;
&amp;gt;&amp;gt; Bat.first.foo
=&amp;gt; #&amp;lt;Foo id:1&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;But if I try to include the :foo association in any find
conditions, then I get a similar error to the one above.&lt;/p&gt;


&lt;pre&gt;&lt;code class=&quot;ruby&quot;&gt;
&amp;gt;&amp;gt; Bat.all(:include =&amp;gt; :foo, :conditions =&amp;gt; { 'foos.id' =&amp;gt; 1 })
ActiveRecord::StatementInvalid: Mysql::Error: Unknown column 'bars.bar_id' in 'on clause': SELECT `bats`.`id` AS t0_r0, `bat`.`bar_id` AS t0_r1, `foos`.`id` AS t1_r0 FROM `bats`  LEFT OUTER JOIN `bars` ON (`bats`.`id` = `bars`.`bar_id`)  LEFT OUTER JOIN `foos` ON (`foos`.`id` = `bats`.`foo_id`) WHERE (`foos`.`id` = 1) 
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;It seems as though the join on condition
(&lt;code&gt;bats&lt;/code&gt;.&lt;code&gt;id&lt;/code&gt; =
&lt;code&gt;bars&lt;/code&gt;.&lt;code&gt;bar_id&lt;/code&gt;) has simply reversed the
foreign/primary keys here. So it should be:
&lt;code&gt;bats&lt;/code&gt;.&lt;code&gt;bar_id&lt;/code&gt; =
&lt;code&gt;bars&lt;/code&gt;.&lt;code&gt;id&lt;/code&gt; Correct?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2009-02-02T16:06:22+00:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2009-02-02T16:06:25+00:00</updated-at>
      <user-id type="integer">27185</user-id>
      <version type="integer">25</version>
      <user-name>Glenn Powell</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body>I definitely remember a patch not too long ago to do with  :include in a similar case - certainly worth checking out 2.3</body>
      <body-html>&lt;div&gt;&lt;p&gt;I definitely remember a patch not too long ago to do with
:include in a similar case - certainly worth checking out 2.3&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2009-02-02T16:13:12+00:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2009-02-02T16:13:14+00:00</updated-at>
      <user-id type="integer">17477</user-id>
      <version type="integer">26</version>
      <user-name>Frederick Cheung</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body>Yes, now I've gone ahead and tried it out in Rails Edge 2.3, but it still fails with the same error.

Frederick, do you still have a link to that patch?  I'd be interested to check it out.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Yes, now I've gone ahead and tried it out in Rails Edge 2.3, but
it still fails with the same error.&lt;/p&gt;
&lt;p&gt;Frederick, do you still have a link to that patch? I'd be
interested to check it out.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2009-02-02T18:08:06+00:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2009-02-02T18:08:09+00:00</updated-at>
      <user-id type="integer">27185</user-id>
      <version type="integer">27</version>
      <user-name>Glenn Powell</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body>Not off the top of my head. Now that I think about it, was has_one :though that was looking at.</body>
      <body-html>&lt;div&gt;&lt;p&gt;Not off the top of my head. Now that I think about it, was
has_one :though that was looking at.&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2009-02-02T18:11:19+00:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2009-02-02T18:11:24+00:00</updated-at>
      <user-id type="integer">17477</user-id>
      <version type="integer">28</version>
      <user-name>Frederick Cheung</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
    <version type="Ticket::Version">
      <assigned-user-id type="integer">1366</assigned-user-id>
      <attachments-count type="integer">6</attachments-count>
      <body>Any update on the eager loading in a single query case of 2.2?</body>
      <body-html>&lt;div&gt;&lt;p&gt;Any update on the eager loading in a single query case of
2.2?&lt;/p&gt;&lt;/div&gt;</body-html>
      <closed type="boolean">true</closed>
      <created-at type="datetime">2009-02-10T21:03:48+00:00</created-at>
      <creator-id type="integer">14510</creator-id>
      <diffable-attributes type="yaml">--- {}

</diffable-attributes>
      <milestone-id type="integer" nil="true"></milestone-id>
      <number type="integer">323</number>
      <permalink>has_many-through-belongs_to_association-bug</permalink>
      <priority type="integer">0</priority>
      <project-id type="integer">8994</project-id>
      <state>resolved</state>
      <tag>activerecord bug patch</tag>
      <title>has_many :through =&gt; belongs_to_association bug</title>
      <updated-at type="datetime">2009-02-10T21:03:52+00:00</updated-at>
      <user-id type="integer">2877</user-id>
      <version type="integer">29</version>
      <user-name>Corey</user-name>
      <creator-name>Zach Dennis</creator-name>
      <assigned-user-name>Pratik</assigned-user-name>
      <url>http://rails.lighthouseapp.com/projects/8994/tickets/323</url>
      <priority-name nil="true"></priority-name>
    </version>
  </versions>
  <attachments type="array">
    <attachment type="Attachment">
      <code>ee97f08d4d8ac3233a9886c1a1a07815b1922918</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2008-06-03T21:05:57+01:00</created-at>
      <filename>has_many_through_belongs_to_association.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">25738</id>
      <size type="integer">2460</size>
      <uploader-id type="integer">14510</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/25738/has_many_through_belongs_to_association.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>95e28dda81603d6503337e8931841214a3ee47e0</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2008-06-03T22:21:09+01:00</created-at>
      <filename>has_many_through_belongs_to_association.2.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">25754</id>
      <size type="integer">3746</size>
      <uploader-id type="integer">14510</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/25754/has_many_through_belongs_to_association.2.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>8c057526a94e2c7b84ca7f7d37949c44a129c01b</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2008-06-04T00:05:17+01:00</created-at>
      <filename>has_many_through_belongs_to_association.3.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">25769</id>
      <size type="integer">4792</size>
      <uploader-id type="integer">14510</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/25769/has_many_through_belongs_to_association.3.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>1318c8bc230d4e69a44b9f11b947f1e2eacd793b</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2008-06-20T03:52:39+01:00</created-at>
      <filename>has_many_through_belongs_to_association.4.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">28465</id>
      <size type="integer">9673</size>
      <uploader-id type="integer">14510</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/28465/has_many_through_belongs_to_association.4.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>9bd876db19e1a1f27f4a647f038b41c67e91864f</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2008-08-18T21:06:23+01:00</created-at>
      <filename>has_many_through_belongs_to_association.5.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">39908</id>
      <size type="integer">132144</size>
      <uploader-id type="integer">14510</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/39908/has_many_through_belongs_to_association.5.diff</url>
    </attachment>
    <attachment type="Attachment">
      <code>3c6da0abe82dde1423e2200dc023c9906d67fd4d</code>
      <content-type>text/plain</content-type>
      <created-at type="datetime">2008-08-19T18:29:37+01:00</created-at>
      <filename>has_many_through_belongs_to_association.6.diff</filename>
      <height type="integer" nil="true"></height>
      <id type="integer">40202</id>
      <size type="integer">9622</size>
      <uploader-id type="integer">14510</uploader-id>
      <width type="integer" nil="true"></width>
      <url>http://rails.lighthouseapp.com/attachments/40202/has_many_through_belongs_to_association.6.diff</url>
    </attachment>
  </attachments>
</ticket>
